<!-- Tab de Historial de Movimientos (Recargas y Consumos) -->

<!-- Filtros -->
<div class="filter-card">
    <div class="filter-title">
        <i class="bi bi-funnel-fill"></i>
        Filtros de Búsqueda
    </div>
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label fw-bold">Rango de Fechas</label>
            <select class="form-select" id="movimientos-dias-filter">
                <option value="7">Últimos 7 días</option>
                <option value="30" selected>Últimos 30 días</option>
                <option value="90">Últimos 90 días</option>
                <option value="180">Últimos 6 meses</option>
                <option value="365">Último año</option>
                <option value="all">Todo el historial</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Tipo de Movimiento</label>
            <select class="form-select" id="movimientos-tipo-filter">
                <option value="todos">Todos</option>
                <option value="recarga">Solo Recargas</option>
                <option value="consumo">Solo Consumos</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Producto</label>
            <select class="form-select" id="movimientos-producto-filter">
                <option value="">Todos los productos</option>
                {% for producto in productos %}
                <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">&nbsp;</label>
            <button class="btn btn-filter w-100" onclick="cargarMovimientos()">
                <i class="bi bi-search me-2"></i>Buscar
            </button>
        </div>
    </div>
</div>

<!-- Estadísticas -->
<div class="stats-row" id="movimientos-stats">
    <div class="stat-card">
        <div class="stat-label">Total Movimientos</div>
        <div class="stat-value" id="stat-total-movimientos">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Recargas</div>
        <div class="stat-value" id="stat-recargas">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Consumos</div>
        <div class="stat-value" id="stat-consumos">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Volumen Neto (BBL)</div>
        <div class="stat-value" id="stat-volumen-neto">0</div>
    </div>
</div>

<!-- Tabla de Movimientos -->
<div class="table-responsive table-modern">
    <table class="table mb-0">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Producto</th>
                <th class="text-end">Volumen (BBL)</th>
                <th>Usuario</th>
                <th>Observación</th>
                {% if es_gestor %}
                <th class="text-center">Acciones</th>
                {% endif %}
            </tr>
        </thead>
        <tbody id="movimientos-table-body">
            <tr>
                <td colspan="{% if es_gestor %}7{% else %}6{% endif %}" class="text-center">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-3 text-muted">Cargando movimientos...</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Modal para Editar Movimiento -->
{% if es_gestor %}
<div class="modal fade" id="modalEditarMovimiento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px 16px 0 0;">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-pencil-fill me-2"></i>Editar <span id="edit-tipo-text"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarMovimiento" method="POST">
                <div class="modal-body" style="padding: 2rem;">
                    <input type="hidden" id="edit-movimiento-id">
                    <input type="hidden" id="edit-movimiento-tipo">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Producto</label>
                        <input type="text" class="form-control" id="edit-producto" readonly
                            style="background: #f8f9fa;">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Volumen (BBL) *</label>
                        <input type="number" step="0.001" class="form-control" id="edit-volumen" name="volumen" required
                            min="0.001" style="font-size: 1.2rem; font-weight: 700;">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Observación</label>
                        <textarea class="form-control" id="edit-observacion" name="observacion" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border: none; padding: 1.5rem; background: #f8f9fa;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    const esGestor = {{ 'true' if es_gestor else 'false' }};

    // Función para cargar movimientos
    function cargarMovimientos() {
        const dias = document.getElementById('movimientos-dias-filter').value;
        const tipo = document.getElementById('movimientos-tipo-filter').value;
        const productoId = document.getElementById('movimientos-producto-filter').value;

        const tbody = document.getElementById('movimientos-table-body');
        const colspan = esGestor ? '7' : '6';
        tbody.innerHTML = `
        <tr>
            <td colspan="${colspan}" class="text-center">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-3 text-muted">Cargando movimientos...</p>
            </td>
        </tr>
    `;

        // Construir URL con parámetros
        let url = '/siza/historial-movimientos?';
        if (dias !== 'all') url += `dias=${dias}&`;
        if (tipo !== 'todos') url += `tipo=${tipo}&`;
        if (productoId) url += `producto_id=${productoId}&`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderMovimientos(data.movimientos);
                    actualizarEstadisticasMovimientos(data.movimientos);
                } else {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                            <p class="mt-3">Error al cargar movimientos: ${data.error}</p>
                        </td>
                    </tr>
                `;
                }
            })
            .catch(error => {
                tbody.innerHTML = `
                <tr>
                    <td colspan="${colspan}" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                        <p class="mt-3">Error de conexión: ${error.message}</p>
                    </td>
                </tr>
            `;
            });
    }

    function renderMovimientos(movimientos) {
        const tbody = document.getElementById('movimientos-table-body');
        const colspan = esGestor ? '7' : '6';

        if (movimientos.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="${colspan}">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>No se encontraron movimientos</h5>
                        <p>Intenta ajustar los filtros de búsqueda</p>
                    </div>
                </td>
            </tr>
        `;
            return;
        }

        tbody.innerHTML = movimientos.map(mov => {
            const esRecarga = mov.tipo === 'recarga';
            const badgeClass = esRecarga ? 'badge-recarga' : 'badge-consumo';
            const icon = esRecarga ? 'arrow-up-circle-fill' : 'arrow-down-circle-fill';
            const signo = esRecarga ? '+' : '-';

            let accionesHtml = '';
            if (esGestor) {
                const obsEscapada = (mov.observacion || '-').replace(/'/g, "\\'").replace(/"/g, '\\"');
                accionesHtml = `
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-sm btn-outline-primary" onclick='abrirModalEditar("${mov.tipo}", ${mov.id}, ${mov.volumen}, "${obsEscapada}", "${mov.producto}")' title="Editar">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick='eliminarMovimiento("${mov.tipo}", ${mov.id}, "${mov.producto}", ${mov.volumen})' title="Eliminar">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </td>
            `;
            }

            return `
            <tr>
                <td>${mov.fecha}</td>
                <td>
                    <span class="badge-estado ${badgeClass}">
                        <i class="bi bi-${icon} me-1"></i>${mov.tipo.toUpperCase()}
                    </span>
                </td>
                <td><span class="badge bg-primary">${mov.producto}</span></td>
                <td class="text-end fw-bold ${esRecarga ? 'text-success' : 'text-danger'}">
                    ${signo}${mov.volumen.toLocaleString('es-CO', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}
                </td>
                <td>${mov.usuario}</td>
                <td><small class="text-muted">${mov.observacion}</small></td>
                ${accionesHtml}
            </tr>
        `;
        }).join('');
    }

    function abrirModalEditar(tipo, id, volumen, observacion, producto) {
        document.getElementById('edit-movimiento-id').value = id;
        document.getElementById('edit-movimiento-tipo').value = tipo;
        document.getElementById('edit-tipo-text').textContent = tipo === 'recarga' ? 'Recarga' : 'Consumo';
        document.getElementById('edit-producto').value = producto;
        document.getElementById('edit-volumen').value = volumen;
        document.getElementById('edit-observacion').value = observacion === '-' ? '' : observacion;

        // Configurar action del formulario
        const form = document.getElementById('formEditarMovimiento');
        if (tipo === 'recarga') {
            form.action = `/siza/editar-recarga/${id}`;
            document.getElementById('edit-volumen').name = 'volumen_recargado';
        } else {
            form.action = `/siza/editar-consumo/${id}`;
            document.getElementById('edit-volumen').name = 'volumen_consumido';
        }

        new bootstrap.Modal(document.getElementById('modalEditarMovimiento')).show();
    }

    function eliminarMovimiento(tipo, id, producto, volumen) {
        const tipoTexto = tipo === 'recarga' ? 'recarga' : 'consumo';
        if (confirm(`¿Estás seguro de eliminar este ${tipoTexto} de ${producto} por ${volumen.toLocaleString('es-CO', { minimumFractionDigits: 3 })} BBL?\n\nEsta acción ajustará automáticamente el inventario.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/siza/eliminar-movimiento/${tipo}/${id}`;
            document.body.appendChild(form);
            form.submit();
        }
    }

    function actualizarEstadisticasMovimientos(movimientos) {
        const recargas = movimientos.filter(m => m.tipo === 'recarga');
        const consumos = movimientos.filter(m => m.tipo === 'consumo');

        const volumenRecargas = recargas.reduce((sum, m) => sum + m.volumen, 0);
        const volumenConsumos = consumos.reduce((sum, m) => sum + m.volumen, 0);
        const volumenNeto = volumenRecargas - volumenConsumos;

        document.getElementById('stat-total-movimientos').textContent = movimientos.length;
        document.getElementById('stat-recargas').textContent = recargas.length;
        document.getElementById('stat-consumos').textContent = consumos.length;
        document.getElementById('stat-volumen-neto').textContent = volumenNeto.toLocaleString('es-CO', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    // Cargar movimientos cuando se active el tab
    document.querySelector('a[href="#movimientos-tab"]').addEventListener('shown.bs.tab', function () {
        if (document.getElementById('movimientos-table-body').querySelector('.loading-spinner')) {
            cargarMovimientos();
        }
    });
</script>