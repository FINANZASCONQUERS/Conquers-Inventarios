{% extends "base.html" %}

{# Bloque para el título de la página #}
{% block title %}Planilla de Precios con Mapa Interactivo{% endblock %}

{# Bloque para el contenido principal (el mapa y el formulario) #}
{% block content %}
<div class="container-fluid my-4">

    <div class="page-header-container d-flex justify-content-between align-items-center mb-4">
        <div class="page-title d-flex align-items-center">
            <i class="bi bi-geo-alt-fill page-title-icon"></i>
            <h1 class="page-title-text h3 mb-0">Planilla de Precios Georreferenciados</h1>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Mapa Interactivo de Destinos</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 650px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Configuración de Ruta</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="origin-input" class="form-label">Origen</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                            <input type="text" class="form-control" id="origin-input" value="Cartagena, Bolívar" readonly>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="destination-select" class="form-label">Destino</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-geo-fill"></i></span>
                            <select class="form-select" id="destination-select">
                                <option selected disabled value="">Seleccione departamento...</option>
                                {% for fila in planilla %}
                                <option value="{{ fila.LAT }},{{ fila.LNG }}">{{ fila.DEPARTAMENTO }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="calculate-route-btn" class="btn btn-primary">
                            <i class="bi bi-signpost-2-fill me-2"></i>Calcular Ruta
                        </button>
                        <button id="clear-route-btn" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-2"></i>Limpiar Ruta
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Información de Distancia</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                            <i class="bi bi-arrow-left-right text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Distancia Total</h6>
                            <p class="mb-0 text-muted">Desde origen a destino</p>
                        </div>
                    </div>
                    <div class="alert alert-primary" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <span id="distance-output" class="fw-bold">Seleccione un destino</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos mejorados */
    .page-title-icon {
        font-size: 1.75rem;
        color: #2c3e50;
        margin-right: 0.75rem;
    }
    .page-title-text {
        color: #2c3e50;
        font-weight: 600;
    }
    .card {
        border-radius: 10px;
        overflow: hidden;
    }
    #map {
        border-radius: 0 0 10px 10px;
    }
    .leaflet-routing-container {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .leaflet-routing-alt {
        max-height: 200px;
    }
    .leaflet-control-attribution {
        font-size: 11px;
    }
    .input-group-text {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{# Bloque para el JavaScript adicional (la lógica del mapa) #}
{% block scripts  %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración inicial del mapa centrado en Colombia
    const map = L.map('map').setView([4.5709, -74.2973], 6);
    
    // Capa base profesional con más contraste
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Capa de relieve opcional (descomentar si se desea)
    /*
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri',
        maxZoom: 13
    }).addTo(map);
    */

    let routingControl = null;
    let destinationMarker = null;

    // Función para formatear la distancia
    function formatDistance(meters) {
        if (meters >= 1000) {
            return (meters / 1000).toFixed(1) + ' km';
        } else {
            return meters.toFixed(0) + ' m';
        }
    }

    // Botón para calcular ruta
    document.getElementById('calculate-route-btn').addEventListener('click', function() {
        const destinationSelect = document.getElementById('destination-select');
        const selectedOption = destinationSelect.value;

        if (!selectedOption) {
            alert('Por favor, seleccione un destino válido.');
            return;
        }

        // Limpiar ruta anterior si existe
        if (routingControl) {
            map.removeControl(routingControl);
        }
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }

        const originCoords = L.latLng(10.3910, -75.4794); // Cartagena
        const [lat, lng] = selectedOption.split(',');
        const destinationCoords = L.latLng(parseFloat(lat), parseFloat(lng));

        // Añadir marcador de destino con estilo profesional
        destinationMarker = L.marker(destinationCoords, {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<i class="bi bi-geo-alt-fill" style="color: #e74c3c; font-size: 1.5rem;"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            })
        }).addTo(map);

        // Calcular y mostrar la ruta
        routingControl = L.Routing.control({
            waypoints: [originCoords, destinationCoords],
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            lineOptions: {
                styles: [{ color: '#3498db', opacity: 0.9, weight: 5 }]
            },
            createMarker: function(i, waypoint, n) {
                if (i === 0) { // Solo marcador de origen
                    return L.marker(waypoint.latLng, {
                        icon: L.divIcon({
                            className: 'origin-marker',
                            html: '<i class="bi bi-geo-fill" style="color: #2ecc71; font-size: 1.5rem;"></i>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    });
                }
                return null; // No mostrar marcador de destino (ya lo tenemos personalizado)
            },
            fitSelectedRoutes: 'smart',
            altLineOptions: {
                styles: [{ color: '#3498db', opacity: 0.5, weight: 3 }]
            }
        }).on('routesfound', function(e) {
            const route = e.routes[0];
            const distance = formatDistance(route.summary.totalDistance);
            document.getElementById('distance-output').textContent = distance;
            
            // Ajustar el zoom para mostrar toda la ruta con margen
            map.fitBounds(route.coordinates, { 
                padding: [50, 50],
                maxZoom: 7
            });
        }).addTo(map);
    });

    // Botón para limpiar ruta
    document.getElementById('clear-route-btn').addEventListener('click', function() {
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        document.getElementById('distance-output').textContent = 'Seleccione un destino';
        document.getElementById('destination-select').value = '';
    });
});
</script>
{% endblock %}