{% extends 'base.html' %}

{% block container_class %}container-fluid px-3 px-lg-4 py-4{% endblock %}

{% block content %}
<style>
    /* Variables para modo claro y oscuro */
    :root {
        --dashboard-bg: #f8f9fa;
        --card-bg: #ffffff;
        --card-border: #e9ecef;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --text-muted: #adb5bd;
        --chart-grid: #e7e7e7;
        --table-stripe: #f8f9fa;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    [data-bs-theme="dark"] {
        --dashboard-bg: #1a1d21;
        --card-bg: #25292e;
        --card-border: #3a3f47;
        --text-primary: #e9ecef;
        --text-secondary: #adb5bd;
        --text-muted: #6c757d;
        --chart-grid: #3a3f47;
        --table-stripe: #2c3034;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    body {
        background-color: var(--dashboard-bg);
    }

    /* Cards personalizadas */
    .dashboard-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
    }

    .dashboard-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    /* Header mejorado */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
    }

    /* Filtros con tabs */
    .filter-tabs {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
    }

    .filter-tab {
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
    }

    .filter-tab:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }

    .filter-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* Botones mejorados */
    .btn-dashboard {
        padding: 0.6rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-dashboard:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    /* Tablas mejoradas */
    .dashboard-table {
        font-size: 0.85rem;
        color: var(--text-primary);
    }

    .dashboard-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--card-bg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .dashboard-table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding: 1rem 0.75rem;
        color: var(--text-secondary);
        border-color: var(--card-border);
    }

    .dashboard-table td {
        padding: 0.85rem 0.75rem;
        vertical-align: middle;
        border-color: var(--card-border);
    }

    .dashboard-table tbody tr {
        transition: background-color 0.2s;
    }

    .dashboard-table tbody tr:hover {
        background-color: var(--table-stripe);
    }

    /* Badges mejorados */
    .trend-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    /* Chart container */
    .chart-wrapper {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        position: relative;
    }

    /* Accordion mejorado */
    .dashboard-accordion .accordion-button {
        background: var(--card-bg);
        color: var(--text-primary);
        font-weight: 600;
        border-radius: 12px !important;
        padding: 1.25rem 1.5rem;
        box-shadow: none;
    }

    .dashboard-accordion .accordion-button:not(.collapsed) {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        color: #667eea;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 1.5rem;
        }

        .filter-tabs {
            padding: 0.75rem;
        }

        .btn-dashboard {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
    }

    /* Loading state */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        z-index: 1000;
    }

    [data-bs-theme="dark"] .loading-overlay {
        background: rgba(37, 41, 46, 0.9);
    }

    /* Select mejorados */
    .form-select-dashboard {
        border: 2px solid var(--card-border);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        background: var(--card-bg);
        color: var(--text-primary);
        font-weight: 500;
        transition: all 0.2s;
    }

    .form-select-dashboard:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
</style>

<!-- Header Principal -->
<div class="dashboard-header">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-white bg-opacity-25 p-3 rounded-3">
                <i class="bi bi-graph-up-arrow fs-2 text-white"></i>
            </div>
            <div>
                <h2 class="fw-bold text-white mb-1">Dashboard Gerencial</h2>
                <p class="text-white text-opacity-75 mb-0 fs-6">Ecopetrol - Análisis de Premiums y Diferenciales</p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <form method="POST" action="{{ url_for('pricing_bp.reset_prices') }}"
                onsubmit="return confirm('¿Está seguro de eliminar TODO el historial? Esta acción no se puede deshacer.')">
                <button type="submit" class="btn btn-danger btn-dashboard">
                    <i class="bi bi-trash3"></i>
                    <span class="d-none d-sm-inline">Reset</span>
                </button>
            </form>
            <form method="POST" action="{{ url_for('pricing_bp.update_prices') }}">
                <button type="submit" class="btn btn-light btn-dashboard">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span class="d-none d-sm-inline">Actualizar</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Mensajes Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="mb-4">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show dashboard-card border-0" role="alert">
        <i class="bi bi-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<!-- Sección de Gráfica -->
<div class="dashboard-card mb-4">
    <!-- Filtros con Tabs -->
    <div class="filter-tabs">
        <div class="row g-3 align-items-center">
            <!-- Vista (Granularidad) -->
            <div class="col-12 col-lg-auto">
                <label class="form-label text-muted small fw-semibold mb-2">VISTA</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="filter-tab active" id="viewYear" data-view="year">
                        <i class="bi bi-calendar3 me-1"></i>Año
                    </button>
                    <button type="button" class="filter-tab" id="viewQuarter" data-view="quarter">
                        <i class="bi bi-calendar2-range me-1"></i>Trim
                    </button>
                    <button type="button" class="filter-tab" id="viewMonth" data-view="month">
                        <i class="bi bi-calendar2-month me-1"></i>Mes
                    </button>
                    <button type="button" class="filter-tab" id="viewDay" data-view="day">
                        <i class="bi bi-calendar-day me-1"></i>Día
                    </button>
                </div>
            </div>

            <div class="col-auto d-none d-lg-block">
                <div class="vr" style="height: 60px; opacity: 0.2;"></div>
            </div>

            <!-- Moneda -->
            <div class="col-12 col-sm-6 col-lg-auto">
                <label class="form-label text-muted small fw-semibold mb-2">MONEDA</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="filter-tab active" id="btnUSD" data-currency="USD">
                        USD
                    </button>
                    <button type="button" class="filter-tab" id="btnCOP" data-currency="COP">
                        COP
                    </button>
                </div>
            </div>

            <div class="col-auto d-none d-lg-block">
                <div class="vr" style="height: 60px; opacity: 0.2;"></div>
            </div>

            <!-- Año Global -->
            <div class="col-12 col-sm-6 col-lg-auto" id="globalYearSelector">
                <label class="form-label text-muted small fw-semibold mb-2">AÑO</label>
                <select class="form-select form-select-dashboard" id="yearSelect">
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="all">Todos</option>
                </select>
            </div>

            <!-- Selectores de Período -->
            <div class="col-12 col-lg-auto flex-grow-1" id="periodSelectorContainer">
                <!-- Quarter -->
                <div id="quarterSelector" class="d-none">
                    <label class="form-label text-muted small fw-semibold mb-2">TRIMESTRE</label>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="filter-tab" data-quarter="q1">Q1</button>
                        <button type="button" class="filter-tab" data-quarter="q2">Q2</button>
                        <button type="button" class="filter-tab" data-quarter="q3">Q3</button>
                        <button type="button" class="filter-tab" data-quarter="q4">Q4</button>
                    </div>
                </div>

                <!-- Month -->
                <div id="monthSelector" class="d-none">
                    <label class="form-label text-muted small fw-semibold mb-2">MES</label>
                    <select class="form-select form-select-dashboard" id="monthSelect">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>

                <!-- Day -->
                <div id="daySelector" class="d-none">
                    <label class="form-label text-muted small fw-semibold mb-2">FECHA</label>
                    <input type="date" class="form-control form-select-dashboard" id="dayInput" value="2025-01-19">
                </div>
            </div>

            <div class="col-auto d-none d-lg-block">
                <div class="vr" style="height: 60px; opacity: 0.2;"></div>
            </div>

            <!-- Acciones -->
            <div class="col-12 col-lg-auto">
                <label class="form-label text-muted small fw-semibold mb-2 d-none d-lg-block">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-dashboard flex-grow-1" id="btnApplyFilter">
                        <i class="bi bi-check-circle"></i> Aplicar
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-dashboard" id="btnResetFilter"
                        title="Resetear vista">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfica -->
    <div class="chart-wrapper position-relative">
        <!-- Logo Watermark -->
        <div class="position-absolute"
            style="bottom: 60px; right: 25px; z-index: 5; opacity: 0.15; pointer-events: none;">
            <img src="{{ url_for('static', filename='Logo_de_empresa.jpeg') }}" alt="Conquers Trading"
                style="width: 120px; height: auto; filter: grayscale(100%);">
        </div>

        <div id="premiumChart" style="height: 600px; width: 100%;"></div>
    </div>

    <div class="text-center py-3 border-top" style="border-color: var(--card-border) !important;">
        <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Seleccione filtros y presione "Aplicar" • Use el mouse para hacer zoom en el gráfico
        </small>
    </div>
</div>

<!-- Tablas Detalladas (Collapsible) -->
<div class="accordion dashboard-accordion" id="accordionTables">
    <div class="accordion-item dashboard-card border-0">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseTables">
                <i class="bi bi-table me-2"></i>
                Tablas Detalladas de Datos
                <span class="badge bg-primary bg-opacity-10 text-primary ms-3">3 tablas</span>
            </button>
        </h2>
        <div id="collapseTables" class="accordion-collapse collapse">
            <div class="accordion-body p-3 p-lg-4">
                <div class="row g-4">
                    <!-- Tabla 1: Diferenciales USD -->
                    <div class="col-lg-6">
                        <div class="dashboard-card h-100">
                            <div class="card-header bg-primary bg-opacity-10 border-0 py-3">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-currency-dollar text-primary me-2"></i>
                                    Diferenciales (Premium USD)
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px;">
                                    <table class="table dashboard-table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Brent</th>
                                                <th class="text-primary">F04 Base</th>
                                                <th class="text-primary">F04 + IVA</th>
                                                <th class="text-danger">Fuel Oil</th>
                                                <th class="text-success">BPI</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for r in records %}
                                            {% set prev_r = records[loop.index] if loop.index < records|length else None
                                                %} <tr>
                                                <td class="fw-semibold text-nowrap">{{ r.fecha.strftime('%d/%m/%Y') }}
                                                </td>
                                                <td class="font-monospace text-muted">{{ "{:,.2f}".format(r.brent) }}
                                                </td>

                                                {% macro render_trend(curr_val, prev_val) %}
                                                {% set curr = curr_val or 0.0 %}
                                                {% if prev_val is none %}
                                                <span class="fw-semibold font-monospace">{{ "{:,.2f}".format(curr)
                                                    }}</span>
                                                {% else %}
                                                {% set prev = prev_val or 0.0 %}
                                                {% set delta = curr - prev %}
                                                <div class="d-flex align-items-center gap-1">
                                                    <span class="fw-semibold font-monospace">{{ "{:,.2f}".format(curr)
                                                        }}</span>
                                                    {% if delta > 0.001 %}
                                                    <span class="trend-badge bg-success bg-opacity-10 text-success">
                                                        <i class="bi bi-arrow-up-short"></i>
                                                    </span>
                                                    {% elif delta < -0.001 %} <span
                                                        class="trend-badge bg-danger bg-opacity-10 text-danger">
                                                        <i class="bi bi-arrow-down-short"></i>
                                                        </span>
                                                        {% endif %}
                                                </div>
                                                {% endif %}
                                                {% endmacro %}

                                                <td>{{ render_trend(r.diff_f04_base, prev_r.diff_f04_base if prev_r else
                                                    None) }}</td>
                                                <td>{{ render_trend(r.diff_f04_total, prev_r.diff_f04_total if prev_r
                                                    else None) }}</td>
                                                <td>{{ render_trend(r.diff_fuel_oil, prev_r.diff_fuel_oil if prev_r else
                                                    None) }}</td>
                                                <td>{{ render_trend(r.diff_bpi, prev_r.diff_bpi if prev_r else None) }}
                                                </td>
                                                </tr>
                                                {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla 2: Diferenciales COP -->
                    <div class="col-lg-6">
                        <div class="dashboard-card h-100">
                            <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-cash-coin text-success me-2"></i>
                                    Diferenciales Premium (COP / Galón)
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px;">
                                    <table class="table dashboard-table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>TRM</th>
                                                <th class="text-primary">F04 Base</th>
                                                <th class="text-primary">F04 Total</th>
                                                <th class="text-danger">Fuel Oil</th>
                                                <th class="text-success">BPI</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for r in records %}
                                            <tr>
                                                <td class="fw-semibold text-nowrap">{{ r.fecha.strftime('%d/%m/%Y') }}
                                                </td>
                                                <td class="font-monospace text-muted small">$ {{
                                                    "{:,.2f}".format(r.trm_mensual_used or 0) }}</td>
                                                <td class="fw-semibold font-monospace">$ {{
                                                    "{:,.2f}".format(r.premium_cop_f04_base or 0) }}</td>
                                                <td class="fw-semibold font-monospace">$ {{
                                                    "{:,.2f}".format(r.premium_cop_f04_total or 0) }}</td>
                                                <td class="font-monospace text-danger">$ {{
                                                    "{:,.2f}".format(r.premium_cop_fuel_oil or 0) }}</td>
                                                <td class="font-monospace text-success">$ {{
                                                    "{:,.2f}".format(r.premium_cop_bpi or 0) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla 3: Precios Base (Full Width) -->
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-header bg-light border-0 py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="fw-bold mb-0">
                                        <i class="bi bi-receipt text-dark me-2"></i>
                                        Precios Base (Detalle Ecopetrol)
                                    </h6>
                                    <span class="badge bg-dark">Última: {{ records[0].fecha.strftime('%d/%m/%Y') if
                                        records else 'N/A' }}</span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 600px;">
                                    <table class="table dashboard-table mb-0">
                                        <thead>
                                            <tr>
                                                <th rowspan="2">FECHA</th>
                                                <th rowspan="2">TRM</th>
                                                <th rowspan="2">BRENT</th>
                                                <th colspan="5" class="text-center bg-primary bg-opacity-10">F04</th>
                                                <th rowspan="2">FUEL OIL</th>
                                                <th colspan="4" class="text-center bg-info bg-opacity-10">BPI</th>
                                            </tr>
                                            <tr>
                                                <th class="small">COP/BLL</th>
                                                <th class="small">IVA+IMP</th>
                                                <th class="small">TOTAL COP</th>
                                                <th class="small">USD/BLL</th>
                                                <th class="small">TOTAL USD</th>
                                                <th class="small">COP/KG</th>
                                                <th class="small">USD/KG</th>
                                                <th class="small">USD/MT</th>
                                                <th class="small">USD/BLL</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for r in records %}
                                            <tr>
                                                <td class="fw-semibold text-nowrap">{{ r.fecha.strftime('%d/%m/%Y') }}
                                                </td>
                                                <td class="font-monospace">$ {{ "{:,.2f}".format(r.trm) }}</td>
                                                <td class="fw-bold font-monospace">{{ "{:,.2f}".format(r.brent) }}</td>
                                                <td class="font-monospace">$ {{ "{:,.0f}".format(r.f04_base_cop or 0) }}
                                                </td>
                                                <td class="font-monospace">$ {{ "{:,.0f}".format(r.f04_impuesto_cop or
                                                    0) }}</td>
                                                <td class="fw-semibold font-monospace">$ {{
                                                    "{:,.0f}".format(r.f04_total_cop or 0) }}</td>
                                                <td class="font-monospace">$ {{ "{:,.2f}".format(r.f04_base_usd or 0) }}
                                                </td>
                                                <td class="fw-semibold font-monospace">$ {{
                                                    "{:,.2f}".format(r.f04_total_usd or 0) }}</td>
                                                <td class="fw-bold font-monospace">$ {{ "{:,.2f}".format(r.fuel_oil_usd
                                                    or 0) }}</td>
                                                <td class="font-monospace">$ {{ "{:,.0f}".format(r.bpi_cop_kg or 0) }}
                                                </td>
                                                <td class="font-monospace">{{ "{:,.2f}".format(r.bpi_usd_kg or 0) }}
                                                </td>
                                                <td class="font-monospace">{{ "{:,.2f}".format(r.bpi_usd_mt or 0) }}
                                                </td>
                                                <td class="fw-semibold font-monospace">$ {{
                                                    "{:,.2f}".format(r.bpi_usd_bll or 0) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts Script -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Detectar tema actual
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';

        // Colores adaptables al tema
        const colors = {
            text: isDarkMode ? '#e9ecef' : '#212529',
            textSecondary: isDarkMode ? '#adb5bd' : '#6c757d',
            grid: isDarkMode ? '#3a3f47' : '#e7e7e7',
            background: isDarkMode ? '#25292e' : '#ffffff'
        };

        // Preparar datos
        const dates = [];
        const f04BaseUSD = [], f04TotalUSD = [], bpiUSD = [], fuelOilUSD = [];
        const f04BaseCOP = [], f04TotalCOP = [], bpiCOP = [], fuelOilCOP = [];

        {% for r in records | reverse %}
        var ts = new Date("{{ r.fecha.isoformat() }}T00:00:00").getTime();
        dates.push("{{ r.fecha.isoformat() }}T00:00:00");

        f04BaseUSD.push([ts, {{ r.diff_f04_base or 0 }}]);
    f04TotalUSD.push([ts, {{ r.diff_f04_total or 0 }}]);
    bpiUSD.push([ts, {{ r.diff_bpi or 0 }}]);
    fuelOilUSD.push([ts, {{ r.diff_fuel_oil or 0 }}]);

    f04BaseCOP.push([ts, {{ r.premium_cop_f04_base or 0 }}]);
    f04TotalCOP.push([ts, {{ r.premium_cop_f04_total or 0 }}]);
    bpiCOP.push([ts, {{ r.premium_cop_bpi or 0 }}]);
    fuelOilCOP.push([ts, {{ r.premium_cop_fuel_oil or 0 }}]);
    {% endfor %}

    // Configuración de idioma español
    const spanishLocale = {
        name: 'es',
        options: {
            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            shortMonths: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
            days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            shortDays: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
            toolbar: {
                download: 'Descargar SVG',
                selection: 'Selección',
                selectionZoom: 'Zoom',
                zoomIn: 'Acercar',
                zoomOut: 'Alejar',
                pan: 'Desplazar',
                reset: 'Resetear'
            }
        }
    };

    // Configuración del gráfico
    var options = {
        series: [
            { name: 'Premium F04', data: f04BaseUSD },
            { name: 'Premium F04+IVA', data: f04TotalUSD },
            { name: 'Premium BPI', data: bpiUSD },
            { name: 'Premium Fuel Oil', data: fuelOilUSD }
        ],
        chart: {
            type: 'area',
            height: 600,
            fontFamily: 'Inter, system-ui, sans-serif',
            defaultLocale: 'es',
            locales: [spanishLocale],
            background: 'transparent',
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: true,
                    zoom: true,
                    zoomin: true,
                    zoomout: true,
                    pan: true,
                    reset: true
                },
                autoSelected: 'zoom'
            },
            zoom: { autoScaleYaxis: true },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        colors: ['#667eea', '#0dcaf0', '#ff9800', '#dc3545'],
        dataLabels: { enabled: false },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.45,
                opacityTo: 0.05,
                stops: [0, 90, 100]
            }
        },
        xaxis: {
            type: 'datetime',
            labels: {
                style: { colors: colors.textSecondary, fontSize: '11px' },
                datetimeFormatter: {
                    year: 'yyyy',
                    month: "MMM 'yy",
                    day: 'dd MMM'
                }
            },
            axisBorder: { show: false },
            axisTicks: { show: false }
        },
        yaxis: {
            labels: {
                formatter: (val) => "$ " + val.toFixed(2),
                style: { colors: colors.textSecondary, fontSize: '11px' }
            },
            title: {
                text: "Diferencial (USD)",
                style: {
                    color: colors.text,
                    fontSize: '13px',
                    fontWeight: 600
                }
            }
        },
        tooltip: {
            theme: isDarkMode ? 'dark' : 'light',
            shared: true,
            intersect: false,
            x: { format: 'dd MMM yyyy' },
            custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                const dataIndex = dataPointIndex;
                const dateVal = dates[dataIndex];
                if (!dateVal) return '';

                const dateObj = new Date(dateVal);
                const day = dateObj.getDate();
                const month = spanishLocale.options.months[dateObj.getMonth()];
                const year = dateObj.getFullYear();
                const fullDate = `${day} ${month} ${year}`;

                const fmtUSD = (v) => v != null ? "$ " + v.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "N/A";
                const fmtCOP = (v) => v != null ? "$ " + v.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "N/A";

                const valBaseUSD = f04BaseUSD[dataIndex] ? f04BaseUSD[dataIndex][1] : null;
                const valBaseCOP = f04BaseCOP[dataIndex] ? f04BaseCOP[dataIndex][1] : null;
                const valTotalUSD = f04TotalUSD[dataIndex] ? f04TotalUSD[dataIndex][1] : null;
                const valTotalCOP = f04TotalCOP[dataIndex] ? f04TotalCOP[dataIndex][1] : null;
                const valBpiUSD = bpiUSD[dataIndex] ? bpiUSD[dataIndex][1] : null;
                const valBpiCOP = bpiCOP[dataIndex] ? bpiCOP[dataIndex][1] : null;
                const valFuelUSD = fuelOilUSD[dataIndex] ? fuelOilUSD[dataIndex][1] : null;
                const valFuelCOP = fuelOilCOP[dataIndex] ? fuelOilCOP[dataIndex][1] : null;

                const bgColor = isDarkMode ? '#25292e' : '#ffffff';
                const borderColor = isDarkMode ? '#3a3f47' : '#e9ecef';
                const textColor = isDarkMode ? '#e9ecef' : '#212529';
                const mutedColor = isDarkMode ? '#adb5bd' : '#6c757d';

                return `
                    <div class="px-3 py-2 rounded shadow-sm" style="background: ${bgColor}; border: 1px solid ${borderColor}; font-size: 12px; min-width: 300px;">
                        <div class="fw-bold border-bottom pb-2 mb-2 text-center" style="color: ${mutedColor};">${fullDate}</div>
                        
                        <div class="d-flex justify-content-between fw-bold mb-2" style="font-size: 10px; color: ${mutedColor};">
                            <span style="width: 40%;">Concepto</span>
                            <span style="width: 28%; text-align: right;">USD/Bbl</span>
                            <span style="width: 32%; text-align: right;">COP/Gal</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="d-flex align-items-center gap-2" style="width: 40%;">
                                <span style="width: 10px; height: 10px; border-radius: 50%; background-color: #667eea;"></span>
                                <span style="color: ${textColor};">F04 Base</span>
                            </div>
                            <span class="fw-bold font-monospace" style="width: 28%; text-align: right; color: ${textColor};">${fmtUSD(valBaseUSD)}</span>
                            <span class="fw-bold font-monospace" style="width: 32%; text-align: right; color: ${mutedColor};">${fmtCOP(valBaseCOP)}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="d-flex align-items-center gap-2" style="width: 40%;">
                                <span style="width: 10px; height: 10px; border-radius: 50%; background-color: #0dcaf0;"></span>
                                <span style="color: ${textColor};">F04 + IVA</span>
                            </div>
                            <span class="fw-bold font-monospace" style="width: 28%; text-align: right; color: ${textColor};">${fmtUSD(valTotalUSD)}</span>
                            <span class="fw-bold font-monospace" style="width: 32%; text-align: right; color: ${mutedColor};">${fmtCOP(valTotalCOP)}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="d-flex align-items-center gap-2" style="width: 40%;">
                                <span style="width: 10px; height: 10px; border-radius: 50%; background-color: #ff9800;"></span>
                                <span style="color: ${textColor};">BPI</span>
                            </div>
                            <span class="fw-bold font-monospace" style="width: 28%; text-align: right; color: ${textColor};">${fmtUSD(valBpiUSD)}</span>
                            <span class="fw-bold font-monospace" style="width: 32%; text-align: right; color: ${mutedColor};">${fmtCOP(valBpiCOP)}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2" style="width: 40%;">
                                <span style="width: 10px; height: 10px; border-radius: 50%; background-color: #dc3545;"></span>
                                <span style="color: ${textColor};">Fuel Oil</span>
                            </div>
                            <span class="fw-bold font-monospace" style="width: 28%; text-align: right; color: ${textColor};">${fmtUSD(valFuelUSD)}</span>
                            <span class="fw-bold font-monospace" style="width: 32%; text-align: right; color: ${mutedColor};">${fmtCOP(valFuelCOP)}</span>
                        </div>
                    </div>
                `;
            }
        },
        grid: {
            borderColor: colors.grid,
            strokeDashArray: 4,
            xaxis: { lines: { show: true } },
            yaxis: { lines: { show: true } },
            padding: { top: 0, right: 10, bottom: 0, left: 10 }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'center',
            floating: false,
            offsetY: 0,
            markers: { width: 12, height: 12, radius: 3 },
            itemMargin: { horizontal: 15, vertical: 8 },
            fontSize: '13px',
            fontWeight: 600,
            labels: { colors: colors.text }
        }
    };

    var chart = new ApexCharts(document.querySelector("#premiumChart"), options);
    chart.render();

    // ===== LÓGICA DE FILTROS =====

    // Cambiar moneda
    const btnUSD = document.getElementById('btnUSD');
    const btnCOP = document.getElementById('btnCOP');

    function updateChartCurrency(currency) {
        const isUSD = (currency === 'USD');

        // Actualizar botones
        document.querySelectorAll('[data-currency]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-currency="${currency}"]`).classList.add('active');

        // Actualizar datos del gráfico
        chart.updateSeries([
            { name: 'Premium F04', data: isUSD ? f04BaseUSD : f04BaseCOP },
            { name: 'Premium F04+IVA', data: isUSD ? f04TotalUSD : f04TotalCOP },
            { name: 'Premium BPI', data: isUSD ? bpiUSD : bpiCOP },
            { name: 'Premium Fuel Oil', data: isUSD ? fuelOilUSD : fuelOilCOP }
        ]);

        // Actualizar etiqueta del eje Y
        chart.updateOptions({
            yaxis: {
                labels: {
                    formatter: (val) => (isUSD ? "$ " : "$ ") + val.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 2 })
                },
                title: {
                    text: isUSD ? "Diferencial (USD)" : "Diferencial (COP)",
                    style: { color: colors.text, fontSize: '13px', fontWeight: 600 }
                }
            }
        });
    }

    btnUSD.addEventListener('click', () => updateChartCurrency('USD'));
    btnCOP.addEventListener('click', () => updateChartCurrency('COP'));

    // Cambiar vista (granularidad)
    let currentView = 'year';

    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const view = e.currentTarget.dataset.view;
            currentView = view;

            // Actualizar botones activos
            document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');

            // Mostrar/ocultar selectores
            document.getElementById('quarterSelector').classList.add('d-none');
            document.getElementById('monthSelector').classList.add('d-none');
            document.getElementById('daySelector').classList.add('d-none');

            const globalYear = document.getElementById('globalYearSelector');

            if (view === 'day') {
                globalYear.classList.add('d-none');
                document.getElementById('daySelector').classList.remove('d-none');
            } else {
                globalYear.classList.remove('d-none');
                if (view === 'quarter') {
                    document.getElementById('quarterSelector').classList.remove('d-none');
                } else if (view === 'month') {
                    document.getElementById('monthSelector').classList.remove('d-none');
                }

                // Asegurar que no esté en "Todos" para vistas específicas
                const yearSelect = document.getElementById('yearSelect');
                if ((view === 'quarter' || view === 'month') && yearSelect.value === 'all') {
                    yearSelect.value = '2025';
                }
            }
        });
    });

    // Selección de trimestre
    document.querySelectorAll('[data-quarter]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('[data-quarter]').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
        });
    });

    // Aplicar filtro
    document.getElementById('btnApplyFilter').addEventListener('click', () => {
        if (!dates || dates.length === 0) {
            alert("No hay datos disponibles para filtrar.");
            return;
        }

        const allDates = dates.map(d => new Date(d).getTime()).sort((a, b) => a - b);
        const earliestTimestamp = allDates[0];
        const latestTimestamp = allDates[allDates.length - 1];
        const latestDate = new Date(latestTimestamp);
        const currentYear = latestDate.getFullYear();

        let start, end;

        const yearSelectVal = document.getElementById('yearSelect').value;
        const selectedYearInt = parseInt(yearSelectVal);
        const resolvedYear = isNaN(selectedYearInt) ? currentYear : selectedYearInt;

        if (currentView === 'year') {
            if (yearSelectVal === 'all') {
                start = earliestTimestamp;
                end = latestTimestamp;
            } else {
                start = new Date(resolvedYear, 0, 1).getTime();
                end = new Date(resolvedYear, 11, 31, 23, 59, 59).getTime();
            }
        } else if (currentView === 'quarter') {
            const activeQ = document.querySelector('[data-quarter].active');
            if (!activeQ) {
                alert('Por favor seleccione un trimestre (Q1, Q2, Q3 o Q4)');
                return;
            }
            const quarter = parseInt(activeQ.dataset.quarter.substring(1));
            start = new Date(resolvedYear, (quarter - 1) * 3, 1).getTime();
            end = new Date(resolvedYear, quarter * 3, 0, 23, 59, 59).getTime();
        } else if (currentView === 'month') {
            const month = parseInt(document.getElementById('monthSelect').value);
            start = new Date(resolvedYear, month - 1, 1).getTime();
            end = new Date(resolvedYear, month, 0, 23, 59, 59).getTime();
        } else if (currentView === 'day') {
            const dayValue = document.getElementById('dayInput').value;
            if (!dayValue) {
                alert('Por favor seleccione una fecha');
                return;
            }
            const parts = dayValue.split('-');
            const dayDate = new Date(parts[0], parts[1] - 1, parts[2]);
            start = dayDate.getTime();
            const dayEnd = new Date(parts[0], parts[1] - 1, parts[2]);
            dayEnd.setHours(23, 59, 59, 999);
            end = dayEnd.getTime();
        }

        if (start && end && start < end) {
            chart.zoomX(start, end);
        }
    });

    // Resetear filtro
    document.getElementById('btnResetFilter').addEventListener('click', () => {
        chart.zoomX(new Date(dates[0]).getTime(), new Date(dates[dates.length - 1]).getTime());
    });
});
</script>
{% endblock %}