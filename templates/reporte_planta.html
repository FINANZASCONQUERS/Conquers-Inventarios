{% extends "base.html" %}

{% block title %}Reporte Visual de Planta{% endblock %}

{% block extra_css %}
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
    rel="stylesheet">
<style>
    :root {
        --primary: #0b8552;
        --primary-dark: #094d32;
        --primary-light: #0fa665;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #3b82f6;
        --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 15px 60px rgba(0, 0, 0, 0.12);
        --border-radius: 20px;
        --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.3);
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: #f8f9fa;
        color: #212529;
        min-height: 100vh;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Dark Mode Defaults */
    html.dark-mode body {
        background-color: #121212;
        color: #e0e0e0;
    }

    /* Gradient overlay removed for cleaner look, or subtle one for dark mode */
    html.dark-mode body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
        pointer-events: none;
        z-index: 0;
    }

    .report-container {
        position: relative;
        z-index: 1;
        padding: 2rem 0;
    }

    /* ==== ENCABEZADO GLASSMORPHISM ==== */
    .report-header-glass {
        background: var(--glass-bg);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-radius: var(--border-radius);
        border: 1px solid var(--glass-border);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        animation: slideDown 0.6s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .report-icon-mega {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        box-shadow: 0 8px 24px rgba(11, 133, 82, 0.4);
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    .report-title-main {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #1a202c 0%, var(--primary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
        letter-spacing: -1px;
    }

    .report-subtitle-main {
        color: #64748b;
        font-size: 1rem;
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .report-timestamp {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* ==== BOTONES PREMIUM ==== */
    .btn-glass {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 2px solid var(--glass-border);
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: var(--transition);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }

    .btn-glass::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.6s;
    }

    .btn-glass:hover::before {
        left: 100%;
    }

    .btn-glass:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .btn-primary-glass {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-color: transparent;
    }

    .btn-outline-glass {
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-outline-glass:hover {
        background: var(--primary);
        color: white;
    }

    /* ==== FILTROS MEJORADOS ==== */
    .filters-glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: var(--border-radius);
        border: 1px solid var(--glass-border);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        animation: fadeInUp 0.7s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .filter-select-premium {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
    }

    .filter-select-premium:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(11, 133, 82, 0.1);
        outline: none;
    }

    /* ==== GRID DE TANQUES ==== */
    .tanks-grid-premium {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    /* ==== TARJETA DE TANQUE PREMIUM ==== */
    .tank-card-premium {
        background: var(--glass-bg);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: var(--border-radius);
        border: 1px solid var(--glass-border);
        overflow: hidden;
        transition: var(--transition);
        box-shadow: var(--card-shadow);
        animation: scaleIn 0.5s ease backwards;
        animation-delay: calc(var(--animation-order) * 0.1s);
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .tank-card-premium:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--card-shadow-hover);
    }

    .tank-card-header-premium {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        padding: 1.25rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .tank-card-header-premium::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .tank-id-premium {
        font-size: 1.5rem;
        font-weight: 800;
        color: white;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        font-family: 'JetBrains Mono', monospace;
    }

    .tank-product-badge {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tank-card-body-premium {
        padding: 2rem 1.5rem;
        display: flex;
        gap: 2rem;
    }

    /* ==== VISUALIZACIÓN DEL TANQUE 3D ==== */
    .tank-visual-3d {
        width: 120px;
        height: 180px;
        position: relative;
        flex-shrink: 0;
        perspective: 1000px;
    }

    .tank-cylinder {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        box-shadow:
            inset 0 2px 8px rgba(0, 0, 0, 0.1),
            0 4px 12px rgba(0, 0, 0, 0.15);
        transform-style: preserve-3d;
    }

    .tank-cylinder::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
        border-radius: 50% 50% 0 0 / 100% 100% 0 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 2;
    }

    .tank-cylinder::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 15px;
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        border-radius: 0 0 8px 8px;
        box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.2);
    }

    .tank-liquid-premium {
        position: absolute;
        bottom: 15px;
        left: 0;
        right: 0;
        transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 0 0 8px 8px;
        overflow: hidden;
    }

    .tank-liquid-premium::before {
        content: '';
        position: absolute;
        top: -5px;
        left: 0;
        right: 0;
        height: 10px;
        background: inherit;
        filter: brightness(1.2);
        animation: wave 3s ease-in-out infinite;
    }

    @keyframes wave {

        0%,
        100% {
            transform: translateX(0%) scale(1, 1);
        }

        50% {
            transform: translateX(5%) scale(1.05, 0.95);
        }
    }

    .tank-liquid-premium.level-empty {
        background: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 100%);
    }

    .tank-liquid-premium.level-low {
        background: linear-gradient(180deg, #fca5a5 0%, #dc2626 100%);
        box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
    }

    .tank-liquid-premium.level-medium {
        background: linear-gradient(180deg, #fcd34d 0%, #f59e0b 100%);
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
    }

    .tank-liquid-premium.level-good {
        background: linear-gradient(180deg, #6ee7b7 0%, #10b981 100%);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
    }

    .tank-liquid-premium.level-full {
        background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .tank-full-alert {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(220, 38, 38, 0.95);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.75rem;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: blink 1.5s ease-in-out infinite;
    }

    @keyframes blink {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }
    }

    /* ==== INFORMACIÓN DEL TANQUE ==== */
    .tank-info-premium {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .tank-volume-display {
        font-size: 2rem;
        font-weight: 800;
        color: #1a202c;
        font-family: 'JetBrains Mono', monospace;
        letter-spacing: -1px;
    }

    .tank-volume-unit {
        font-size: 1rem;
        font-weight: 600;
        color: #64748b;
        margin-left: 0.5rem;
    }

    .tank-conversion-info {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e40af;
        margin-top: 0.25rem;
    }

    .tank-progress-premium {
        height: 14px;
        background: #f1f5f9;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .tank-progress-bar-premium {
        height: 100%;
        border-radius: 20px;
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .tank-progress-bar-premium::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }

    .tank-progress-bar-premium.level-empty {
        background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
    }

    .tank-progress-bar-premium.level-low {
        background: linear-gradient(90deg, #fca5a5 0%, #dc2626 100%);
    }

    .tank-progress-bar-premium.level-medium {
        background: linear-gradient(90deg, #fcd34d 0%, #f59e0b 100%);
    }

    .tank-progress-bar-premium.level-good {
        background: linear-gradient(90deg, #6ee7b7 0%, #10b981 100%);
    }

    .tank-progress-bar-premium.level-full {
        background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
    }

    .tank-percentage-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
    }

    .tank-percentage-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .tank-percentage-value.level-empty {
        color: #6b7280;
    }

    .tank-percentage-value.level-low {
        color: #dc2626;
    }

    .tank-percentage-value.level-medium {
        color: #f59e0b;
    }

    .tank-percentage-value.level-good {
        color: #10b981;
    }

    .tank-percentage-value.level-full {
        color: #3b82f6;
    }

    .tank-max-capacity {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 500;
    }

    /* ==== PIE DE TARJETA ==== */
    .tank-card-footer-premium {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 1rem 1.5rem;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        border-top: 1px solid #e2e8f0;
    }

    .tank-stat-premium {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .tank-stat-label {
        font-size: 0.7rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .tank-stat-value {
        font-size: 1rem;
        font-weight: 700;
        color: #1e293b;
        font-family: 'JetBrains Mono', monospace;
    }

    /* ==== MENSAJE SIN DATOS ==== */
    .no-data-premium {
        grid-column: 1 / -1;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        padding: 4rem 2rem;
        text-align: center;
        border: 2px dashed #cbd5e0;
    }

    .no-data-icon {
        font-size: 4rem;
        color: #cbd5e0;
        margin-bottom: 1rem;
        animation: float 3s ease-in-out infinite;
    }

    /* ==== TOTAL DE PRODUCTO ==== */
    .total-product-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        border: 1px solid var(--glass-border);
        padding: 2rem;
        text-align: center;
        box-shadow: var(--card-shadow);
        margin-top: 2rem;
        border-left: 5px solid var(--primary);
    }

    .total-product-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
        margin: 0;
    }

    .total-product-value {
        color: var(--primary);
        font-weight: 800;
    }

    /* ==== RESPONSIVE ==== */
    @media (max-width: 768px) {
        .tanks-grid-premium {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .report-title-main {
            font-size: 1.5rem;
        }

        .tank-card-body-premium {
            flex-direction: column;
            gap: 1.5rem;
        }

        .tank-visual-3d {
            width: 100px;
            height: 150px;
            margin: 0 auto;
        }

        .tank-card-footer-premium {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
    }

    /* ==== LEYENDA ==== */
    .legend-premium {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--dot-color);
        box-shadow: 0 0 0 3px rgba(var(--dot-color-rgb), 0.2);
    }

    /* ==== MODO OSCURO ADAPTACIONES ==== */
    html.dark-mode .report-header-glass,
    html.dark-mode .filters-glass-card,
    html.dark-mode .tank-card-premium,
    html.dark-mode .total-product-card {
        background: rgba(30, 30, 30, 0.8);
        border-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
    }

    html.dark-mode .report-title-main {
        background: linear-gradient(135deg, #ffffff 0%, var(--primary-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    html.dark-mode .report-subtitle-main,
    html.dark-mode .tank-max-capacity,
    html.dark-mode .tank-stat-label,
    html.dark-mode .tank-volume-unit {
        color: #adb5bd;
    }

    html.dark-mode .report-timestamp {
        background: rgba(255, 255, 255, 0.05);
        color: #e0e0e0;
    }

    html.dark-mode .filter-select-premium,
    html.dark-mode .form-control {
        background-color: #2c2c2c;
        border-color: #444;
        color: #fff;
    }

    html.dark-mode .form-label {
        color: #e0e0e0 !important;
    }

    html.dark-mode .tank-id-premium {
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    html.dark-mode .tank-volume-display,
    html.dark-mode .tank-percentage-value {
        color: #fff;
    }

    html.dark-mode .tank-cylinder {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3), 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    html.dark-mode .tank-cylinder::before {
        /* Tapa */
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
    }

    html.dark-mode .tank-cylinder::after {
        /* Base */
        background: linear-gradient(135deg, #1a202c 0%, #171923 100%);
    }

    html.dark-mode .tank-card-footer-premium {
        background: rgba(255, 255, 255, 0.03);
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    html.dark-mode .tank-stat-value {
        color: #e0e0e0;
    }

    html.dark-mode .legend-premium {
        background: #2c2c2c;
        color: #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    html.dark-mode .btn-glass.btn-outline-glass {
        color: var(--primary-light);
        border-color: var(--primary-light);
    }

    html.dark-mode .btn-glass.btn-outline-glass:hover {
        background: var(--primary-light);
        color: #fff;
    }

    html.dark-mode .total-product-title {
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="container">

        <!-- ENCABEZADO GLASSMORPHISM -->
        <div class="report-header-glass">
            <div class="row align-items-center g-3">
                <div class="col-auto">
                    <div class="report-icon-mega">
                        <i class="bi bi-buildings-fill"></i>
                    </div>
                </div>
                <div class="col">
                    <h1 class="report-title-main">Reporte Visual de Planta</h1>
                    <p class="report-subtitle-main mb-0">Monitoreo en Tiempo Real del Inventario de Tanques</p>
                    {% if fecha_actualizacion_info and "no disponible" not in fecha_actualizacion_info|lower and "error"
                    not in fecha_actualizacion_info|lower %}
                    <div class="mt-2">
                        <span class="report-timestamp">
                            <i class="bi bi-clock-history"></i>
                            {{ fecha_actualizacion_info }}
                        </span>
                    </div>
                    {% endif %}
                </div>
                <div class="col-auto ms-auto">
                    <div class="d-flex gap-2 flex-wrap justify-content-end">
                        <a href="{{ url_for('reporte_variaciones_tanques') }}" class="btn btn-glass btn-outline-glass">
                            <i class="bi bi-graph-up-arrow me-2"></i>Variaciones
                        </a>
                        <div class="btn-group">
                            <button type="button" class="btn btn-glass btn-primary-glass dropdown-toggle"
                                data-bs-toggle="dropdown">
                                <i class="bi bi-download me-2"></i>Descargar
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" data-filtro="dia">Por Día</a></li>
                                <li><a class="dropdown-item" href="#" data-filtro="mes">Por Mes</a></li>
                                <li><a class="dropdown-item" href="#" data-filtro="trimestre">Por Trimestre</a></li>
                                <li><a class="dropdown-item" href="#" data-filtro="anual">Todo el Año</a></li>
                            </ul>
                        </div>
                        {% if session.rol == 'admin' or 'planta' in session.area %}
                        <a href="{{ url_for('planta') }}" class="btn btn-glass btn-outline-glass">
                            <i class="bi bi-pencil-fill me-2"></i>Editar Planilla
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- FILTROS GLASSMORPHISM -->
        <div class="filters-glass-card">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-dark mb-2">
                        <i class="bi bi-box-seam me-2"></i>Filtrar por Producto
                    </label>
                    <select id="filtroProducto" class="form-select filter-select-premium">
                        <option value="todos" selected>Todos los productos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-dark mb-2">
                        <i class="bi bi-funnel me-2"></i>Filtrar por Tanque
                    </label>
                    <select id="filtroTanque" class="form-select filter-select-premium">
                        <option value="todos" selected>Todos los tanques</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <form method="GET" action="{{ url_for('reporte_planta') }}">
                        <label class="form-label fw-bold text-dark mb-2">
                            <i class="bi bi-calendar-date me-2"></i>Fecha del Reporte
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control filter-select-premium" id="fecha_filtro" name="fecha"
                                value="{{ fecha_seleccionada or '' }}" placeholder="YYYY-MM-DD"
                                data-fechas='{{ (fechas_con_registro or [])|tojson|safe }}'>
                            <button type="submit" class="btn btn-glass btn-primary-glass">
                                <i class="bi bi-funnel-fill"></i>
                            </button>
                            <a href="{{ url_for('reporte_planta') }}" class="btn btn-glass btn-outline-glass">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col d-flex gap-2 flex-wrap">
                    <div class="legend-premium">
                        <span class="legend-dot" style="--dot-color:#198754; --dot-color-rgb:25,135,84;"></span>
                        Días con registro
                    </div>
                    <div class="legend-premium">
                        <span class="legend-dot" style="--dot-color:#adb5bd; --dot-color-rgb:173,181,189;"></span>
                        Días sin registro
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID DE TANQUES PREMIUM -->
        <div id="contenedor-tanques" class="tanks-grid-premium">
            <!-- Los tanques se cargan dinámicamente -->
        </div>

        <!-- TOTAL DE PRODUCTO -->
        <div class="total-product-card" id="totalProductoContainer" style="display: none;">
            <h3 class="total-product-title" id="totalProducto"></h3>
        </div>

    </div>
</div>

<!-- MODAL DE OPCIONES DE DESCARGA -->
<div class="modal fade" id="opcionesDescargaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleccione una Opción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="inputDia" class="mb-3" style="display: none;">
                    <label for="fechaValor" class="form-label fw-bold">Día:</label>
                    <input type="date" id="fechaValor" class="form-control">
                </div>
                <div id="inputMes" class="mb-3" style="display: none;">
                    <label for="mesValor" class="form-label fw-bold">Mes:</label>
                    <input type="month" id="mesValor" class="form-control">
                </div>
                <div id="inputTrimestre" class="mb-3" style="display: none;">
                    <label for="trimestreValor" class="form-label fw-bold">Año y Trimestre:</label>
                    <div class="d-flex">
                        <input type="number" id="trimestreAno" class="form-control me-2" placeholder="Año" min="2020"
                            max="2099">
                        <select id="trimestreNum" class="form-select">
                            <option value="1">Q1 (Ene-Mar)</option>
                            <option value="2">Q2 (Abr-Jun)</option>
                            <option value="3">Q3 (Jul-Sep)</option>
                            <option value="4">Q4 (Oct-Dic)</option>
                        </select>
                    </div>
                </div>
                <div id="inputAnual" class="mb-3" style="display: none;">
                    <label for="anualValor" class="form-label fw-bold">Año:</label>
                    <input type="number" id="anualValor" class="form-control" placeholder="Año" min="2020" max="2099">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnGenerarPdf" class="btn btn-danger">
                    <i class="bi bi-file-earmark-pdf-fill me-1"></i> Generar PDF
                </button>
                <button type="button" id="btnGenerarExcel" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel-fill me-1"></i> Generar Excel
                </button>
            </div>
        </div>
    </div>
</div>

<script id="datos-planta" type="application/json">{{ datos_planta_para_js | default('[]') | tojson }}</script>
<script>
    const datosPlanta = JSON.parse(document.getElementById('datos-planta').textContent || '[]');

    // Elementos del DOM
    const contenedorTanques = document.getElementById("contenedor-tanques");
    const filtroProductoSelect = document.getElementById("filtroProducto");
    const filtroTanqueSelect = document.getElementById("filtroTanque");
    const totalProductoDisplay = document.getElementById("totalProducto");
    const totalProductoContainer = document.getElementById("totalProductoContainer");

    // Cargar filtros
    function cargarFiltros() {
        const productos = new Set();
        const tanques = new Set();

        if (Array.isArray(datosPlanta)) {
            datosPlanta.forEach(d => {
                if (d && typeof d === 'object') {
                    if (d.PRODUCTO) productos.add(d.PRODUCTO);
                    if (d.TK) tanques.add(d.TK);
                }
            });
        }

        filtroProductoSelect.innerHTML = '<option value="todos">Todos los productos</option>';
        filtroTanqueSelect.innerHTML = '<option value="todos">Todos los tanques</option>';

        productos.forEach(p => {
            const op = document.createElement("option");
            op.value = p;
            op.textContent = p;
            filtroProductoSelect.appendChild(op);
        });

        tanques.forEach(t => {
            const op = document.createElement("option");
            op.value = t;
            op.textContent = t;
            filtroTanqueSelect.appendChild(op);
        });

        filtroProductoSelect.addEventListener('change', filtrar);
        filtroTanqueSelect.addEventListener('change', filtrar);
    }

    // Determinar nivel
    function determinarNivel(porcentaje) {
        if (porcentaje >= 95) return 'full';
        if (porcentaje >= 60) return 'good';
        if (porcentaje >= 30) return 'medium';
        if (porcentaje > 0) return 'low';
        return 'empty';
    }

    // Crear tarjeta de tanque
    function crearTarjetaTanque(data, index) {
        if (typeof data !== 'object' || data === null) {
            console.error("Datos inválidos:", data);
            return document.createDocumentFragment();
        }

        const bls60 = parseFloat(data.BLS_60) || 0;
        const maxCap = parseFloat(data.MAX_CAP) || 0;
        const porcentaje = maxCap > 0 ? Math.min((bls60 / maxCap) * 100, 100) : 0;
        const nivel = determinarNivel(porcentaje);

        let conversionHTML = '';
        if (data.TK === "Consumo Interno") {
            const gals = (bls60 * 42).toFixed(2);
            conversionHTML = `
            <div class="tank-conversion-info">
                <i class="bi bi-droplet-fill"></i>
                <strong>${parseFloat(gals).toLocaleString('es-CO', { minimumFractionDigits: 2 })} GAL</strong>
            </div>`;
        } else {
            const allowedTonTanks = new Set(['TK-102', 'TK-110', 'TK-108']);
            if (allowedTonTanks.has(data.TK)) {
                const apiVal = parseFloat(data.API);
                let tons = 0;
                if (!isNaN(apiVal) && bls60 > 0) {
                    const sg = 141.5 / (apiVal + 131.5);
                    tons = bls60 * (sg / 6.2898);
                } else if (data.TK === 'TK-102') {
                    tons = bls60 > 0 ? (bls60 / 6.7) : 0;
                } else if (data.TK === 'TK-110') {
                    tons = bls60 > 0 ? (bls60 / 7.4) : 0;
                } else if (data.TK === 'TK-108') {
                    tons = bls60 > 0 ? (bls60 / 6.7) : 0;
                }
                if (tons > 0) {
                    conversionHTML = `
                    <div class="tank-conversion-info" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #047857;">
                        <i class="bi bi-box-seam"></i>
                        <strong>${tons.toFixed(2)} TON</strong>
                    </div>`;
                }
            }
        }

        const card = document.createElement("div");
        card.className = "tank-card-premium";
        card.setAttribute("data-tk", data.TK || '');
        card.setAttribute("data-producto", data.PRODUCTO || '');
        card.style.setProperty('--animation-order', index);

        let maxCapLabel = `${maxCap.toLocaleString('es-CO', { maximumFractionDigits: 0 })} BLS`;
        if (data.TK === "Consumo Interno") {
            maxCapLabel = `${maxCap.toLocaleString('es-CO', { maximumFractionDigits: 2 })} BLS (${(maxCap * 42).toFixed(2)} GAL)`;
        }

        card.innerHTML = `
        <div class="tank-card-header-premium">
            <div class="tank-id-premium">${data.TK || 'N/A'}</div>
            <div class="tank-product-badge">${data.PRODUCTO || 'N/A'}</div>
        </div>
        
        <div class="tank-card-body-premium">
            <div class="tank-visual-3d">
                <div class="tank-cylinder">
                    <div class="tank-liquid-premium level-${nivel}" style="height:${porcentaje}%"></div>
                    ${porcentaje >= 95 ? '<div class="tank-full-alert"><i class="bi bi-exclamation-triangle-fill me-1"></i>LLENO</div>' : ''}
                </div>
            </div>
            
            <div class="tank-info-premium">
                <div class="tank-volume-display">
                    ${bls60.toLocaleString('es-CO', { maximumFractionDigits: 2 })} 
                    <span class="tank-volume-unit">BLS</span>
                </div>
                ${conversionHTML}
                
                <div class="tank-progress-premium">
                    <div class="tank-progress-bar-premium level-${nivel}" style="width: ${porcentaje}%"></div>
                </div>
                
                <div class="tank-percentage-display">
                    <span class="tank-percentage-value level-${nivel}">${porcentaje.toFixed(1)}%</span>
                    <span class="tank-max-capacity">Max: ${maxCapLabel}</span>
                </div>
            </div>
        </div>
        
        <div class="tank-card-footer-premium">
            <div class="tank-stat-premium">
                <span class="tank-stat-label">API</span>
                <span class="tank-stat-value">${data.API || 'N/A'}</span>
            </div>
            <div class="tank-stat-premium">
                <span class="tank-stat-label">BSW</span>
                <span class="tank-stat-value">${data.TK === 'Consumo Interno' ? 'N/A' : (data.BSW ? data.BSW + '%' : 'N/A')}</span>
            </div>
            <div class="tank-stat-premium">
                <span class="tank-stat-label">%S</span>
                <span class="tank-stat-value">${data.TK === 'Consumo Interno' ? 'N/A' : (data.S ? data.S + '%' : 'N/A')}</span>
            </div>
        </div>
    `;

        return card;
    }

    // Filtrar tanques
    function filtrar() {
        const producto = filtroProductoSelect.value;
        const tanque = filtroTanqueSelect.value;

        contenedorTanques.innerHTML = "";
        let totalBLS = 0;
        let tanquesMostrados = 0;
        let productoFiltrado = "";

        if (Array.isArray(datosPlanta)) {
            datosPlanta.forEach((d, idx) => {
                if (typeof d !== 'object' || d === null) return;

                const coincideProducto = producto === "todos" || d.PRODUCTO === producto;
                const coincideTanque = tanque === "todos" || d.TK === tanque;

                if (coincideProducto && coincideTanque) {
                    contenedorTanques.appendChild(crearTarjetaTanque(d, idx));
                    tanquesMostrados++;

                    if (producto !== "todos" && tanque === "todos") {
                        totalBLS += (parseFloat(d.BLS_60) || 0);
                        productoFiltrado = producto;
                    }
                }
            });
        }

        // Mostrar total
        if (productoFiltrado) {
            totalProductoDisplay.innerHTML = `Volumen total de <span class="total-product-value">${productoFiltrado}</span>: ${totalBLS.toLocaleString('es-CO', { maximumFractionDigits: 2 })} BLS`;
            totalProductoContainer.style.display = 'block';
        } else {
            totalProductoContainer.style.display = 'none';
        }

        // Mensaje sin datos
        if (tanquesMostrados === 0) {
            const mensaje = document.createElement("div");
            mensaje.className = "no-data-premium";

            if (Array.isArray(datosPlanta) && datosPlanta.length > 0) {
                mensaje.innerHTML = `
                <div class="no-data-icon"><i class="bi bi-funnel"></i></div>
                <h3 class="h5 mb-2">No hay tanques que coincidan</h3>
                <p class="text-muted mb-0">Intente con otros filtros de búsqueda</p>
            `;
            } else {
                mensaje.innerHTML = `
                <div class="no-data-icon"><i class="bi bi-database-exclamation"></i></div>
                <h3 class="h5 mb-2">No hay datos disponibles</h3>
                <p class="text-muted mb-0">Por favor, guarde un registro en la planilla primero</p>
            `;
            }

            contenedorTanques.appendChild(mensaje);
        }
    }

    // Inicializar
    document.addEventListener("DOMContentLoaded", () => {
        // Calendario
        const input = document.getElementById('fecha_filtro');
        if (input) {
            const fechasConRegistro = input.getAttribute('data-fechas') ? JSON.parse(input.getAttribute('data-fechas')) : [];
            const setFechas = new Set(fechasConRegistro);

            const addCss = (href) => {
                const l = document.createElement('link');
                l.rel = 'stylesheet';
                l.href = href;
                document.head.appendChild(l);
            };
            const addJs = (src, cb) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = cb;
                document.body.appendChild(s);
            };

            addCss('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css');
            addCss('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/material_green.css');
            addJs('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', () => {
                flatpickr(input, {
                    dateFormat: 'Y-m-d',
                    defaultDate: input.value || new Date(),
                    allowInput: true,
                    onDayCreate: function (dObj, dStr, fp, dayElem) {
                        const dateStr = dayElem.dateObj.toISOString().slice(0, 10);
                        if (setFechas.has(dateStr)) {
                            dayElem.style.background = 'rgba(25, 135, 84, 0.2)';
                            dayElem.style.color = '#198754';
                            dayElem.setAttribute('title', 'Con registro');
                        } else {
                            dayElem.style.background = 'rgba(173,181,189,0.15)';
                            dayElem.style.color = '#6c757d';
                            dayElem.setAttribute('title', 'Sin registro');
                        }
                    }
                });
            });
        }

        cargarFiltros();
        filtrar();

        // Modal de descarga
        const modalElement = document.getElementById('opcionesDescargaModal');
        const descargaModal = new bootstrap.Modal(modalElement);
        let filtroSeleccionado = '';

        function prepararModal(filtro) {
            filtroSeleccionado = filtro;
            const hoy = new Date().toISOString();
            const anoActual = new Date().getFullYear();

            document.getElementById('inputDia').style.display = 'none';
            document.getElementById('inputMes').style.display = 'none';
            document.getElementById('inputTrimestre').style.display = 'none';
            document.getElementById('inputAnual').style.display = 'none';

            if (filtro === 'dia') {
                document.getElementById('inputDia').style.display = 'block';
                document.getElementById('fechaValor').value = hoy.slice(0, 10);
            } else if (filtro === 'mes') {
                document.getElementById('inputMes').style.display = 'block';
                document.getElementById('mesValor').value = hoy.slice(0, 7);
            } else if (filtro === 'trimestre') {
                document.getElementById('inputTrimestre').style.display = 'block';
                document.getElementById('trimestreAno').value = anoActual;
            } else if (filtro === 'anual') {
                document.getElementById('inputAnual').style.display = 'block';
                document.getElementById('anualValor').value = anoActual;
            }
        }

        document.querySelectorAll('.dropdown-item[data-filtro]').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const filtro = this.getAttribute('data-filtro');
                prepararModal(filtro);
                descargaModal.show();
            });
        });

        function descargar(formato) {
            let urlBase = '';
            if (formato === 'pdf') {
                urlBase = "{{ url_for('descargar_reporte_planta_pdf') }}";
            } else {
                urlBase = "{{ url_for('exportar_excel', nombre_reporte='planta') }}";
            }

            let params = new URLSearchParams();
            params.append('filtro_tipo', filtroSeleccionado);

            if (filtroSeleccionado === 'dia') {
                params.append('valor', document.getElementById('fechaValor').value);
            } else if (filtroSeleccionado === 'mes') {
                params.append('valor', document.getElementById('mesValor').value);
            } else if (filtroSeleccionado === 'trimestre') {
                const ano = document.getElementById('trimestreAno').value;
                const num = document.getElementById('trimestreNum').value;
                params.append('valor', `${ano}-Q${num}`);
            } else if (filtroSeleccionado === 'anual') {
                params.append('valor', document.getElementById('anualValor').value);
            }

            window.location.href = `${urlBase}?${params.toString()}`;
            descargaModal.hide();
        }

        document.getElementById('btnGenerarPdf').addEventListener('click', () => descargar('pdf'));
        document.getElementById('btnGenerarExcel').addEventListener('click', () => descargar('excel'));
    });
</script>
{% endblock %}