{% extends "base.html" %}

{% block title %}Simulador de Rendimiento de Crudo{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 text-primary"><i class="fas fa-chart-pie me-2"></i>Simulador de Rendimiento de Crudo</h2>
        <span class="text-muted">Bienvenido, {{ nombre }}</span>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                 <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Gestión de Crudos</h5>
                </div>
                <div class="card-body">
                    <label for="saved-crudes-select" class="form-label"><b>Cargar Crudo Guardado</b></label>
                    <div class="input-group">
                        <select class="form-select" id="saved-crudes-select" aria-label="Cargar Crudo Guardado">
                            <option selected disabled>Selecciona un crudo para cargar...</option>
                        </select>
                        <button class="btn btn-primary" type="button" id="btn-load-crude">Cargar</button>
                        <button class="btn btn-outline-danger" type="button" id="btn-delete-crude" title="Eliminar crudo seleccionado"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Paso 1: Define Propiedades y Cortes (°C)</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-md-3"><label for="crude-api" class="form-label"><b>API Crudo</b></label><input type="number" id="crude-api" class="form-control" value="32.0" step="0.1"></div>
                        <div class="col-6 col-md-3"><label for="crude-sulfur" class="form-label"><b>% Azufre</b></label><input type="number" id="crude-sulfur" class="form-control" value="1.2" step="0.01"></div>
                        <div class="col-6 col-md-3"><label for="crude-viscosity" class="form-label"><b>Viscosidad</b></label><input type="number" id="crude-viscosity" class="form-control" value="6.0" step="0.1" title="cSt @ 40°C"></div>
                        <div class="col-12"><hr></div>
                        <div class="col-4 col-md-4"><label for="cut-nafta" class="form-label"><b>NAFTA</b></label><input type="number" id="cut-nafta" class="form-control" value="150"></div>
                        <div class="col-4 col-md-4"><label for="cut-kero" class="form-label"><b>KERO</b></label><input type="number" id="cut-kero" class="form-control" value="240"></div>
                        <div class="col-4 col-md-4"><label for="cut-fo4" class="form-label"><b>FO4</b></label><input type="number" id="cut-fo4" class="form-control" value="350"></div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Paso 2: Curva de Destilación</h5>
                    <div>
                        <button id="btn-save-crude" class="btn btn-sm btn-warning me-2" title="Guardar la curva y propiedades actuales"><i class="fas fa-save me-1"></i>Guardar</button>
                        <button id="btn-add-point" class="btn btn-sm btn-light"><i class="fas fa-plus me-1"></i>Añadir Punto</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead><tr><th>% Destilado</th><th>Temp (°F)</th><th>Temp (°C)</th><th></th></tr></thead>
                            <tbody id="distillation-curve-body"></tbody>
                        </table>
                    </div>
                    <div class="d-grid mt-3"><button id="btn-calculate" class="btn btn-success btn-lg"><i class="fas fa-calculator me-2"></i>Calcular</button></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white"><h5 class="mb-0">Resultados del Cálculo</h5></div>
                <div class="card-body" id="results-container" style="display: none;">
                    <canvas id="yield-chart" class="mb-4"></canvas>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover">
                            <thead class="table-dark"><tr><th>Producto</th><th>Rendimiento (%)</th><th>API</th><th>Azufre (%S)</th><th>Viscosidad (cSt)</th></tr></thead>
                            <tbody id="results-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="message-initial" class="card-body text-center p-5"><i class="fas fa-cogs fa-3x text-muted mb-3"></i><p class="text-muted">Los resultados aparecerán aquí.</p></div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Selección de Elementos DOM ---
    const curveBody = document.getElementById('distillation-curve-body');
    const resultsTableBody = document.getElementById('results-table-body');
    const resultsContainer = document.getElementById('results-container');
    const initialMessage = document.getElementById('message-initial');
    const btnAddPoint = document.getElementById('btn-add-point');
    const btnCalculate = document.getElementById('btn-calculate');
    const btnLoadCrude = document.getElementById('btn-load-crude');
    const btnSaveCrude = document.getElementById('btn-save-crude');
    const btnDeleteCrude = document.getElementById('btn-delete-crude');
    const savedCrudesSelect = document.getElementById('saved-crudes-select');
    const crudeApiInput = document.getElementById('crude-api');
    const crudeSulfurInput = document.getElementById('crude-sulfur');
    const crudeViscosityInput = document.getElementById('crude-viscosity');
    const totalYieldCell = document.getElementById('total-yield');


    let yieldChart = null;
    let savedCrudesData = {};

    // --- LÓGICA DE LA INTERFAZ ---

    // ** FUNCIÓN CORREGIDA Y MEJORADA **
    // Arregla el error de sintaxis y calcula Fahrenheit a partir de Celsius.
    const addCurvePoint = (p = '', tC = '') => {
        const row = document.createElement('tr');
        const tF = tC !== '' ? ((parseFloat(tC) * 9/5) + 32).toFixed(1) : '';

        row.innerHTML = `
            <td><input type="number" class="form-control form-control-sm percent-input" value="${p}" placeholder="%"></td>
            <td><input type="number" class="form-control form-control-sm temp-f-input" value="${tF}" placeholder="°F"></td>
            <td><input type="number" class="form-control form-control-sm temp-c-input" value="${tC}" placeholder="°C"></td>
            <td><button class="btn btn-sm btn-outline-danger btn-remove-point"><i class="fas fa-times"></i></button></td>
        `;
        curveBody.appendChild(row);
    };

    const displayResults = (data) => {
        initialMessage.style.display = 'none';
        resultsContainer.style.display = 'block';

        const ctx = document.getElementById('yield-chart').getContext('2d');
        if (yieldChart) yieldChart.destroy();
        yieldChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.order,
                datasets: [{
                    label: '% Rendimiento',
                    data: data.order.map(p => data.yields[p]),
                    backgroundColor: ['#fd7e14', '#20c997', '#ffc107', '#0d6efd'],
                    borderWidth: 1
                }]
            },
            options: { plugins: { legend: { display: false }, title: { display: true, text: 'Rendimiento de Productos (%)' } } }
        });

        resultsTableBody.innerHTML = '';
        data.order.forEach(producto => {
            const row = `<tr>
                <td><b>${producto}</b></td>
                <td>${data.yields[producto]}</td>
                <td>${data.api_by_product[producto]}</td>
                <td>${data.sulfur_by_product[producto]}</td>
                <td>${data.viscosity_by_product[producto]}</td>
            </tr>`;
            resultsTableBody.innerHTML += row;
        });
    };
    
    // --- LÓGICA DE DATOS (API) ---

    const loadSavedCrudes = async () => {
        try {
            const response = await fetch('{{ url_for("get_crudos_guardados") }}');
            if (!response.ok) throw new Error('Network response was not ok');
            savedCrudesData = await response.json();
            savedCrudesSelect.innerHTML = '<option selected disabled>Selecciona un crudo...</option>';
            Object.keys(savedCrudesData).sort().forEach(name => savedCrudesSelect.add(new Option(name, name)));
        } catch (error) { console.error('Error al cargar crudos:', error); }
    };

    const getFormData = () => {
        const curvePoints = [];
        curveBody.querySelectorAll('tr').forEach(r => {
            const p = parseFloat(r.querySelector('.percent-input').value);
            const tC = parseFloat(r.querySelector('.temp-c-input').value);
            if (!isNaN(p) && !isNaN(tC)) curvePoints.push({ percent: p, tempC: tC });
        });
        return {
            api: parseFloat(crudeApiInput.value),
            sulfur: parseFloat(crudeSulfurInput.value),
            viscosity: parseFloat(crudeViscosityInput.value),
            curva: curvePoints
        };
    };

    // --- EVENT LISTENERS ---

    btnAddPoint.addEventListener('click', () => addCurvePoint());
    curveBody.addEventListener('click', (e) => { if (e.target.closest('.btn-remove-point')) e.target.closest('tr').remove(); });
    
    // ** LÓGICA DE CONVERSIÓN MEJORADA (USA EVENT DELEGATION) **
    // Un solo listener para toda la tabla, más eficiente.
    curveBody.addEventListener('input', (e) => {
        const target = e.target;
        if (!target.classList.contains('temp-f-input') && !target.classList.contains('temp-c-input')) return;
        
        const row = target.closest('tr');
        const fInput = row.querySelector('.temp-f-input');
        const cInput = row.querySelector('.temp-c-input');
        const fahrenheitToCelsius = (f) => (f - 32) * 5/9;
        const celsiusToFahrenheit = (c) => (c * 9/5) + 32;

        if (target === cInput) {
            const cValue = parseFloat(cInput.value);
            fInput.value = isNaN(cValue) ? '' : celsiusToFahrenheit(cValue).toFixed(1);
        } else if (target === fInput) {
            const fValue = parseFloat(fInput.value);
            cInput.value = isNaN(fValue) ? '' : fahrenheitToCelsius(fValue).toFixed(1);
        }
    });

    btnLoadCrude.addEventListener('click', () => {
        const data = savedCrudesData[savedCrudesSelect.value];
        if (data) {
            crudeApiInput.value = data.api || '';
            crudeSulfurInput.value = data.sulfur || '';
            crudeViscosityInput.value = data.viscosity || '';
            curveBody.innerHTML = '';
            if (data.curva) data.curva.forEach(p => addCurvePoint(p.percent, p.tempC));
        }
    });

    btnSaveCrude.addEventListener('click', async () => {
        const nombre = prompt("Introduce el nombre para guardar este crudo:", "");
        if (!nombre) return;
        const payload = { nombre: nombre.toUpperCase(), ...getFormData() };
        if (payload.curva.length < 1) { alert('No hay puntos en la curva para guardar.'); return; }
        
        const response = await fetch('{{ url_for("save_crudo") }}', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const result = await response.json();
        alert(result.message);
        if (result.success) await loadSavedCrudes();
    });

    btnDeleteCrude.addEventListener('click', async () => {
        const crudeName = savedCrudesSelect.value;
        if (!crudeName || crudeName.startsWith("Selecciona")) { alert("Selecciona un crudo para eliminar."); return; }
        if (confirm(`¿Seguro que quieres eliminar '${crudeName}'?`)) {
            const response = await fetch(`/api/crudos_guardados/${crudeName}`, { method: 'DELETE' });
            const result = await response.json();
            alert(result.message);
            if (result.success) await loadSavedCrudes();
        }
    });
    
    btnCalculate.addEventListener('click', async () => {
        const formData = getFormData();
        if (formData.curva.length < 2) { alert('Se necesitan al menos dos puntos válidos en la curva.'); return; }

        const payload = {
            distillationCurve: formData.curva,
            cutPoints: {
                nafta: parseFloat(document.getElementById('cut-nafta').value),
                kero: parseFloat(document.getElementById('cut-kero').value),
                fo4: parseFloat(document.getElementById('cut-fo4').value)
            },
            apiCrude: formData.api,
            sulfurCrude: formData.sulfur,
            viscosityCrude: formData.viscosity
        };

        const response = await fetch('{{ url_for("api_calcular_rendimiento") }}', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await response.json();
        if (data.success) displayResults(data); else alert('Error en el cálculo: ' + data.message);
    });

    // --- INICIALIZACIÓN ---
    loadSavedCrudes();
});
</script>
{% endblock %}