{% extends "base.html" %}

{% block title %}Simulador de Rendimiento de Crudo{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* ----- Paleta de Colores y Estilos Globales ----- */
    :root {
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --success-color: #198754;
        --warning-color: #ffc107;
        --light-gray: #f8f9fa;
        --border-color: #dee2e6;
        --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    body {
        background-color: var(--light-gray);
    }

    /* ----- Estilo de las Tarjetas (Cards) ----- */
    .card {
        border: 1px solid var(--border-color);
        box-shadow: var(--card-shadow);
        transition: box-shadow 0.3s ease-in-out;
    }

    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    .card-header {
        font-weight: 600;
    }
   
    .card-header .actions {
        display: flex;
        gap: 0.5rem;
    }

    /* ----- Estilo de la Tabla de Resultados Profesional ----- */
    .results-table {
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .results-table thead th {
        background-color: #343a40;
        color: white;
        text-align: center;
        vertical-align: middle;
        font-weight: 600;
        border-bottom: 2px solid var(--primary-color);
    }

    .results-table tbody tr.crude-header-row td {
        font-weight: bold;
        font-size: 1.1rem;
        padding: 0.75rem;
        border-top: 2px solid var(--border-color);
    }

    .results-table tbody tr:not(.crude-header-row):nth-child(odd) {
        background-color: #f8f9fa;
    }
   
    .results-table td, .results-table th {
        padding: 0.5rem;
        text-align: center;
    }
   
    .results-table td:first-child {
        text-align: left;
        font-weight: 500;
    }

    /* ----- Estilo para Indicadores de Carga ----- */
    .btn .spinner-border-sm {
        display: none;
    }
    .btn.loading .spinner-border-sm {
        display: inline-block;
    }
    .btn.loading .btn-text {
        display: none;
    }

    /* ----- Estilos para la sección de ensayo ----- */
    .assay-data-container {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.25rem;
    }
    .assay-data-table {
        font-size: 0.85rem;
        margin-bottom: 0;
    }
    .assay-data-table th {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }
    .assay-data-table td, .assay-data-table th {
        padding: 0.3rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 text-primary font-weight-bold"><i class="fas fa-chart-pie me-2"></i>Simulador de Rendimiento de Crudo</h2>
        <span class="text-muted">Bienvenido, {{ nombre }}</span>
    </div>

    <div class="row g-4">
        <div class="col-lg-6 d-flex flex-column gap-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Gestión de Crudos</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <label for="saved-crudes-select" class="input-group-text"><i class="fas fa-database me-2"></i>Cargar</label>
                        <select class="form-select" id="saved-crudes-select" aria-label="Cargar Crudo Guardado">
                            <option selected disabled>Selecciona un crudo...</option>
                        </select>
                        <button class="btn btn-primary" type="button" id="btn-load-crude" title="Cargar Crudo">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-outline-danger" type="button" id="btn-delete-crude" title="Eliminar crudo seleccionado">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nueva Card para Importar Datos de Ensayo -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Importar Datos de Ensayo</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label"><b>Tipo de Datos</b></label>
                            <select class="form-select" id="assay-data-type">
                                <option value="wt">Usar Cumulative Wt%</option>
                                <option value="vol">Usar Cumulative Vol%</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><b>IBP (°F)</b></label>
                            <input type="number" class="form-control" id="assay-ibp" placeholder="Ej: 79">
                        </div>
                        <div class="col-12">
                        </div>    

                        <div class="col-12">
                            <div class="assay-data-container">
                                <table class="table table-sm assay-data-table">
                                    <thead>
                                        <tr>
                                            <th>Rango °F</th>
                                            <th>Rango °C</th>
                                            <th>Cum Wt%</th>
                                            <th>Cum Vol%</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assay-data-body">
                                        <!-- Las filas se agregarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-sm btn-outline-primary mb-2" id="btn-add-assay-row">
                                <i class="fas fa-plus me-1"></i>Agregar Rango
                            </button>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary w-100" id="btn-import-assay">
                                <i class="fas fa-file-import me-2"></i>Generar Curva desde Ensayo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Paso 1: Propiedades y Cortes (°C)</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-4"><label for="crude-api" class="form-label"><b>API Crudo</b></label><input type="number" id="crude-api" class="form-control" value="32.0" step="0.1"></div>
                        <div class="col-sm-4"><label for="crude-sulfur" class="form-label"><b>% Azufre</b></label><input type="number" id="crude-sulfur" class="form-control" value="1.2" step="0.01"></div>
                        <div class="col-sm-4"><label for="crude-viscosity" class="form-label"><b>Viscosidad</b></label><input type="number" id="crude-viscosity" class="form-control" value="6.0" step="0.1" title="cSt @ 40°C"></div>
                        <div class="col-12"><hr class="my-2"></div>
                        <div class="col-4"><label for="cut-nafta" class="form-label"><b>NAFTA</b></label><input type="number" id="cut-nafta" class="form-control" value="150"></div>
                        <div class="col-4"><label for="cut-kero" class="form-label"><b>KERO</b></label><input type="number" id="cut-kero" class="form-control" value="240"></div>
                        <div class="col-4"><label for="cut-fo4" class="form-label"><b>FO4</b></label><input type="number" id="cut-fo4" class="form-control" value="350"></div>
                        <div class="col-12 mt-3 d-flex justify-content-center">
                            <div class="form-check form-switch fs-5">
                                <input class="form-check-input" type="checkbox" role="switch" id="toggle-kero" checked>
                                <label class="form-check-label" for="toggle-kero"><b>Incluir KERO</b></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Paso 2: Curva de Destilación</h5>
                    <div class="actions">
                        <button id="btn-save-crude" class="btn btn-sm btn-warning" title="Guardar la curva y propiedades actuales"><i class="fas fa-save me-1"></i>Guardar</button>
                        <button id="btn-add-point" class="btn btn-sm btn-light"><i class="fas fa-plus me-1"></i>Añadir Punto</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 280px;">
                        <table class="table table-sm table-hover">
                            <thead><tr><th>% Destilado</th><th>Temp (°F)</th><th>Temp (°C)</th><th></th></tr></thead>
                            <tbody id="distillation-curve-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Resultados de la Simulación</h5>
                </div>
                <div class="card-body p-2 p-md-3">
                     <div id="results-container" style="display: none;">
                        <canvas id="yield-chart" class="mb-4"></canvas>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered results-table">
                                <thead id="results-table-head"></thead>
                                <tbody id="results-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="message-initial" class="text-center p-5">
                        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Los resultados de la comparación aparecerán aquí.</p>
                    </div>
                </div>
                <div class="card-footer bg-light d-grid gap-2">
                    <button id="btn-calculate" class="btn btn-success btn-lg">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="btn-text"><i class="fas fa-calculator me-2"></i>Calcular y Comparar</span>
                    </button>
                    <button id="btn-clear-comparison" class="btn btn-outline-warning">
                        <i class="fas fa-eraser me-2"></i>Limpiar Comparación
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const CrudeSimulator = {
    state: {
        comparisonResults: [],
        savedCrudesData: {},
        yieldChart: null,
    },
    config: {
        CHART_COLORS: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#fd7e14', '#20c997', '#6f42c1'],
    },
    
    dom: {},
     isUpdating: false,

    init() {
        this._cacheDom();
        this._bindEvents();
        this.handleLoadSavedCrudes();
        this._addDefaultAssayRows();
    },

    _cacheDom() {
        this.dom.curveBody = document.getElementById('distillation-curve-body');
        this.dom.resultsTableBody = document.getElementById('results-table-body');
        this.dom.resultsTableHead = document.getElementById('results-table-head');
        this.dom.resultsContainer = document.getElementById('results-container');
        this.dom.initialMessage = document.getElementById('message-initial');
        this.dom.chartCanvas = document.getElementById('yield-chart');
        
        // Botones
        this.dom.btnAddPoint = document.getElementById('btn-add-point');
        this.dom.btnCalculate = document.getElementById('btn-calculate');
        this.dom.btnLoadCrude = document.getElementById('btn-load-crude');
        this.dom.btnSaveCrude = document.getElementById('btn-save-crude');
        this.dom.btnDeleteCrude = document.getElementById('btn-delete-crude');
        this.dom.btnClearComparison = document.getElementById('btn-clear-comparison');
        this.dom.btnAddAssayRow = document.getElementById('btn-add-assay-row');
        this.dom.btnImportAssay = document.getElementById('btn-import-assay');

        // Inputs
        this.dom.savedCrudesSelect = document.getElementById('saved-crudes-select');
        this.dom.crudeApiInput = document.getElementById('crude-api');
        this.dom.crudeSulfurInput = document.getElementById('crude-sulfur');
        this.dom.crudeViscosityInput = document.getElementById('crude-viscosity');
        this.dom.cutNaftaInput = document.getElementById('cut-nafta');
        this.dom.cutKeroInput = document.getElementById('cut-kero');
        this.dom.cutFo4Input = document.getElementById('cut-fo4');
        this.dom.toggleKero = document.getElementById('toggle-kero');
        this.dom.assayDataBody = document.getElementById('assay-data-body');
        this.dom.assayDataType = document.getElementById('assay-data-type');
        this.dom.assayIbpInput = document.getElementById('assay-ibp');
        this.dom.assayEndRange = document.getElementById('assay-end-range');
    },

    _bindEvents() {
        this.dom.btnAddPoint.addEventListener('click', () => this._addCurvePoint());
        this.dom.btnCalculate.addEventListener('click', () => this.handleCalculate());
        this.dom.btnClearComparison.addEventListener('click', () => this.clearComparison());
        this.dom.btnLoadCrude.addEventListener('click', () => this._loadSelectedCrude());
        this.dom.btnSaveCrude.addEventListener('click', () => this.handleSaveCrude());
        this.dom.btnDeleteCrude.addEventListener('click', () => this.handleDeleteCrude());
        this.dom.btnAddAssayRow.addEventListener('click', () => this._addAssayRow());
        this.dom.btnImportAssay.addEventListener('click', () => this.handleImportAssay());
        
        this.dom.curveBody.addEventListener('click', (e) => {
            if (e.target.closest('.btn-remove-point')) {
                e.target.closest('tr').remove();
            }
        });
        
        // Listeners para conversión de temperatura en AMBAS tablas
        this.dom.curveBody.addEventListener('input', (e) => this._handleTempConversion(e));
        this.dom.assayDataBody.addEventListener('input', (e) => this._handleTempConversion(e));
    },
    
    displayComparison() {
        if (this.state.comparisonResults.length === 0) {
            this.dom.initialMessage.style.display = 'block';
            this.dom.resultsContainer.style.display = 'none';
            if (this.state.yieldChart) this.state.yieldChart.destroy();
            return;
        }
        this.dom.initialMessage.style.display = 'none';
        this.dom.resultsContainer.style.display = 'block';
        
        this._renderChart();
        this._renderTable();
    },

    _renderChart() {
        if (this.state.yieldChart) this.state.yieldChart.destroy();
        
        const firstResult = this.state.comparisonResults[0];
        const productLabels = firstResult.order;
        const datasets = this.state.comparisonResults.map((result, index) => ({
            label: result.name,
            data: productLabels.map(p => result.yields[p]),
            backgroundColor: this.config.CHART_COLORS[index % this.config.CHART_COLORS.length],
            borderColor: this.config.CHART_COLORS[index % this.config.CHART_COLORS.length],
            borderWidth: 1,
            borderRadius: 4
        }));

        this.state.yieldChart = new Chart(this.dom.chartCanvas.getContext('2d'), {
            type: 'bar',
            data: { labels: productLabels, datasets: datasets },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Comparación de Rendimientos (%)', font: { size: 16 } }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    },

    _renderTable() {
        const productLabels = this.state.comparisonResults[0].order;
        
        let headerHtml = `<tr><th>Crudo / Propiedad</th>${productLabels.map(p => `<th>${p}</th>`).join('')}</tr>`;
        this.dom.resultsTableHead.innerHTML = headerHtml;

        let bodyHtml = '';
        this.state.comparisonResults.forEach((result, index) => {
            const color = this.config.CHART_COLORS[index % this.config.CHART_COLORS.length];
            bodyHtml += `<tr class="crude-header-row" style="background-color: ${color}20;">
                            <td colspan="${productLabels.length + 1}">
                                <strong style="color: ${color};"><i class="fas fa-vial me-2"></i>${result.name.toUpperCase()}</strong>
                            </td>
                         </tr>`;
            bodyHtml += `<tr><td><b>Rendimiento (%)</b></td>${productLabels.map(p => `<td>${result.yields[p]}</td>`).join('')}</tr>`;
            bodyHtml += `<tr><td><b>API</b></td>${productLabels.map(p => `<td>${result.api_by_product[p]}</td>`).join('')}</tr>`;
            bodyHtml += `<tr><td><b>Azufre (%S)</b></td>${productLabels.map(p => `<td>${result.sulfur_by_product[p]}</td>`).join('')}</tr>`;
            bodyHtml += `<tr><td><b>Viscosidad (cSt)</b></td>${productLabels.map(p => `<td>${result.viscosity_by_product[p]}</td>`).join('')}</tr>`;
        });
        this.dom.resultsTableBody.innerHTML = bodyHtml;
    },

    _addCurvePoint(p = '', tC = '') {
        const row = document.createElement('tr');
        const tF = tC !== '' ? ((parseFloat(tC) * 9 / 5) + 32).toFixed(1) : '';
        row.innerHTML = `
            <td><input type="number" class="form-control form-control-sm percent-input" value="${p}" placeholder="%"></td>
            <td><input type="number" class="form-control form-control-sm temp-f-input" value="${tF}" placeholder="°F"></td>
            <td><input type="number" class="form-control form-control-sm temp-c-input" value="${tC}" placeholder="°C"></td>
            <td><button class="btn btn-sm btn-outline-danger btn-remove-point" title="Eliminar punto"><i class="fas fa-times"></i></button></td>`;
        this.dom.curveBody.appendChild(row);
    },

    _addAssayRow(range = '', cumWt = '', cumVol = '') {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="text" class="form-control form-control-sm temp-f-input" value="${range}" placeholder="IBP-350"></td>
        <td><input type="text" class="form-control form-control-sm temp-c-input" placeholder="IBP-177"></td>
        <td><input type="number" class="form-control form-control-sm" value="${cumWt}" placeholder="Ej: 2.24" step="0.01"></td>
        <td><input type="number" class="form-control form-control-sm" value="${cumVol}" placeholder="Ej: 3.20" step="0.01"></td>
    `;
    this.dom.assayDataBody.appendChild(row);
},

    _addDefaultAssayRows() {
        for (let i = 0; i < 3; i++) {
            this._addAssayRow();
        }
    },

    _getAssayData() {
        const assayData = [];
        const rows = this.dom.assayDataBody.querySelectorAll('tr');
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const range = inputs[0].value.trim();
            const cumWt = parseFloat(inputs[2].value);
            const cumVol = parseFloat(inputs[3].value);
            if (range && (!isNaN(cumWt) || !isNaN(cumVol))) {
                assayData.push({
                    range,
                    cumWt: isNaN(cumWt) ? 0 : cumWt,
                    cumVol: isNaN(cumVol) ? 0 : cumVol
                });
            }
        });
        return assayData;
    },
    
    _interpolate(points, targetPercent) {
        let p1 = { percent: 0, tempC: 0 };
        let p2 = null;
        for (const point of points) {
            if (point.percent <= targetPercent) { p1 = point; }
            if (point.percent > targetPercent) { p2 = point; break; }
        }
        if (!p2) return p1.tempC;
        if (p2.percent === p1.percent) return p1.tempC;
        const temp = p1.tempC + (p2.tempC - p1.tempC) * ((targetPercent - p1.percent) / (p2.percent - p1.percent));
        return temp.toFixed(1);
    },

    async _generateCurveFromAssay() {
    // 1. Obtiene los datos de la tabla de ensayo
    const assayData = this._getAssayData();
    if (assayData.length < 2) {
        alert('Se necesitan al menos dos puntos de ensayo para generar la curva.');
        return;
    }

    const dataType = this.dom.assayDataType.value;
    // ===== LEE EL NUEVO CAMPO IBP =====
    const ibp_F = parseFloat(this.dom.assayIbpInput.value);

    // 2. Convierte los datos de ensayo en puntos base para la curva
    const baseCurvePoints = assayData.map(dataPoint => {
        let tempRange = dataPoint.range.trim();
        let pointTempF;
        const FBP_DEFAULT = 1050;

        if (tempRange.toUpperCase().startsWith("IBP-")) {
            pointTempF = parseFloat(tempRange.split('-')[1]);
        } else if (tempRange.includes('-')) {
            pointTempF = parseFloat(tempRange.split('-')[1]);
        } else if (tempRange.endsWith('+')) {
            pointTempF = FBP_DEFAULT;
        } else {
            pointTempF = parseFloat(tempRange);
        }
        
        const pointTempC = (pointTempF - 32) * 5 / 9;
        return {
            percent: dataType === 'wt' ? dataPoint.cumWt : dataPoint.cumVol,
            tempC: pointTempC
        };
    });
    
    // ===== LÓGICA MEJORADA PARA USAR EL IBP =====
    // Elimina cualquier punto 0% que pudiera existir para evitar duplicados
    const finalBaseCurve = baseCurvePoints.filter(p => p.percent > 0);
    
    if (!isNaN(ibp_F)) {
        // Si se especificó un IBP, úsalo como el punto 0%.
        const ibp_C = (ibp_F - 32) * 5 / 9;
        finalBaseCurve.unshift({ percent: 0, tempC: ibp_C });
    } else if (finalBaseCurve.length > 0 && finalBaseCurve[0].percent > 0) {
        // Si no, usa el método de estimación antiguo.
        finalBaseCurve.unshift({ percent: 0, tempC: finalBaseCurve[0].tempC / 2 });
    }

    // 3. Limpia la tabla y dibuja la nueva curva interpolada
    this.dom.curveBody.innerHTML = '';
    for (let percent = 0; percent <= 100; percent += 5) {
        // Usa finalBaseCurve para la interpolación
        const interpolatedTempC = this._interpolate(finalBaseCurve, percent);
        this._addCurvePoint(percent, interpolatedTempC);
    }

    alert('Curva de destilación generada e interpolada correctamente.');
},

    clearComparison() {
        if (confirm('¿Estás seguro de que quieres limpiar todos los resultados de la comparación?')) {
            this.state.comparisonResults = [];
            this.displayComparison();
        }
    },
    
    _setLoadingState(button, isLoading) {
        if (isLoading) {
            button.classList.add('loading');
            button.disabled = true;
        } else {
            button.classList.remove('loading');
            button.disabled = false;
        }
    },

    _getFormData() {
        const curvePoints = [];
        this.dom.curveBody.querySelectorAll('tr').forEach(r => {
            const p = parseFloat(r.querySelector('.percent-input').value);
            const tC = parseFloat(r.querySelector('.temp-c-input').value);
            if (!isNaN(p) && !isNaN(tC)) curvePoints.push({ percent: p, tempC: tC });
        });
        return {
            api: parseFloat(this.dom.crudeApiInput.value),
            sulfur: parseFloat(this.dom.crudeSulfurInput.value),
            viscosity: parseFloat(this.dom.crudeViscosityInput.value),
            curva: curvePoints
        };
    },

    _getAssayDataForSave() {
    const assayData = [];
    const rows = this.dom.assayDataBody.querySelectorAll('tr');
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const range = inputs[0].value.trim();
        const cumWt = inputs[2].value.trim();
        const cumVol = inputs[3].value.trim();
        // Guardamos solo si hay algún dato en la fila
        if (range || cumWt || cumVol) {
            assayData.push({ range, cumWt, cumVol });
        }
    });
    return assayData;
},
// Función para poblar la tabla de ensayo con datos cargados
    _populateAssayTable(assayData) {
    this.dom.assayDataBody.innerHTML = ''; // Limpiar tabla
    if (assayData && assayData.length > 0) {
        assayData.forEach(d => this._addAssayRow(d.range, d.cumWt, d.cumVol));
    } else {
        // Si no hay datos guardados, mostrar las filas por defecto
        this._addDefaultAssayRows();
    }
},
    _handleTempConversion(e) {
    // Si el código ya está actualizando un campo, no hagas nada para evitar un bucle.
    if (this.isUpdating) return;

    const target = e.target;
    const isFahrenheitInput = target.classList.contains('temp-f-input');
    const isCelsiusInput = target.classList.contains('temp-c-input');

    // Sal si el cambio no fue en un campo de temperatura
    if (!isFahrenheitInput && !isCelsiusInput) return;

    const row = target.closest('tr');
    const fInput = row.querySelector('.temp-f-input');
    const cInput = row.querySelector('.temp-c-input');
    if (!fInput || !cInput) return;

    const fahrenheitToCelsius = (f) => (f - 32) * 5 / 9;
    const celsiusToFahrenheit = (c) => (c * 9 / 5) + 32;

    const value = target.value.trim();
    // Conserva el prefijo "IBP-" si existe
    const prefix = value.toUpperCase().startsWith("IBP-") ? "IBP-" : "";
    const numberPart = value.replace(/ibp-/i, '').split('-').pop();
    const number = parseFloat(numberPart);
    
    // Activa la bandera para que el próximo cambio no active esta función de nuevo.
    this.isUpdating = true;

    if (isNaN(number)) {
        // Si el valor no es un número, limpia el otro campo.
        (isFahrenheitInput ? cInput : fInput).value = '';
    } else {
        if (isFahrenheitInput) {
            // Si cambiaste °F, actualiza °C.
            const tempC = fahrenheitToCelsius(number);
            cInput.value = prefix + tempC.toFixed(1);
        } else { // Si cambiaste °C, actualiza °F.
            const tempF = celsiusToFahrenheit(number);
            fInput.value = prefix + tempF.toFixed(1);
        }
    }
    
    // Desactiva la bandera.
    this.isUpdating = false;
},
    
    _loadSelectedCrude() {
        const data = this.state.savedCrudesData[this.dom.savedCrudesSelect.value];
        if (data) {
            this.dom.crudeApiInput.value = data.api || '';
            this.dom.crudeSulfurInput.value = data.sulfur || '';
            this.dom.crudeViscosityInput.value = data.viscosity || '';
            this.dom.curveBody.innerHTML = '';
            if (data.curva) data.curva.forEach(p => this._addCurvePoint(p.percent, p.tempC));

            this._populateAssayTable(data.assay);
        }
    },

    async _handleApiRequest(url, options, buttonToLoad = null) {
        if (buttonToLoad) this._setLoadingState(buttonToLoad, true);
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`Error de red: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Error en la petición a la API:', error);
            alert(`Hubo un error al comunicarse con el servidor: ${error.message}`);
            return null;
        } finally {
            if (buttonToLoad) this._setLoadingState(buttonToLoad, false);
        }
    },

    async handleCalculate() {
        const formData = this._getFormData();
        if (formData.curva.length < 2) {
            alert('Se necesitan al menos dos puntos válidos en la curva.');
            return;
        }
        const defaultName = this.dom.savedCrudesSelect.value.startsWith("Selecciona")
            ? `Corrida ${this.state.comparisonResults.length + 1}`
            : this.dom.savedCrudesSelect.value;
        const runName = prompt("Introduce un nombre para identificar este cálculo:", defaultName);
        if (!runName) return;

        const payload = {
            distillationCurve: formData.curva,
            cutPoints: {
                nafta: parseFloat(this.dom.cutNaftaInput.value),
                kero: parseFloat(this.dom.cutKeroInput.value),
                fo4: parseFloat(this.dom.cutFo4Input.value)
            },
            apiCrude: formData.api,
            sulfurCrude: formData.sulfur,
            viscosityCrude: formData.viscosity,
            includeKero: this.dom.toggleKero.checked
        };
        
        const data = await this._handleApiRequest(
            '{{ url_for("api_calcular_rendimiento") }}',
            { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) },
            this.dom.btnCalculate
        );
        
        if (data && data.success) {
            data.name = runName;
            this.state.comparisonResults.push(data);
            this.displayComparison();
        } else if (data) {
            alert('Error en el cálculo: ' + data.message);
        }
    },

    async handleLoadSavedCrudes() {
        const data = await this._handleApiRequest('{{ url_for("get_crudos_guardados") }}');
        if (data) {
            this.state.savedCrudesData = data;
            this.dom.savedCrudesSelect.innerHTML = '<option selected disabled>Selecciona un crudo...</option>';
            Object.keys(this.state.savedCrudesData).sort().forEach(name => {
                this.dom.savedCrudesSelect.add(new Option(name, name));
            });
        }
    },

    async handleSaveCrude() {
        const selectedCrudeName = this.dom.savedCrudesSelect.disabled ? "" : this.dom.savedCrudesSelect.value;
        const nombre = prompt("Introduce el nombre para guardar este crudo:", selectedCrudeName);
        if (!nombre) return;
        
        const formData = this._getFormData();
        const assayData = this._getAssayDataForSave();
        if (formData.curva.length < 1) {
            alert('No hay puntos en la curva para guardar.');
            return;
        }
        
        const payload = { nombre: nombre.toUpperCase(), ...formData, assay: assayData };
        const result = await this._handleApiRequest(
            '{{ url_for("save_crudo") }}',
            { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
        );

        if (result) {
            alert(result.message);
            if (result.success) this.handleLoadSavedCrudes();
        }
    },

    async handleDeleteCrude() {
        const crudeName = this.dom.savedCrudesSelect.value;
        if (!crudeName || crudeName.startsWith("Selecciona")) {
            alert("Selecciona un crudo para eliminar.");
            return;
        }
        if (confirm(`¿Seguro que quieres eliminar '${crudeName}'?`)) {
            const result = await this._handleApiRequest(
                `/api/crudos_guardados/${crudeName}`,
                { method: 'DELETE' }
            );

            if (result) {
                alert(result.message);
                if (result.success) {
                    this.dom.curveBody.innerHTML = '';
                    this.handleLoadSavedCrudes();
                }
            }
        }
    },

    async handleImportAssay() {
        try {
            await this._generateCurveFromAssay();
        } catch (error) {
            console.error('Error al importar ensayo:', error);
            alert('Error al generar la curva desde el ensayo: ' + error.message);
        }
    }
};

// Iniciar la aplicación cuando el DOM esté listo.
document.addEventListener('DOMContentLoaded', () => {
    CrudeSimulator.init();
});
</script>
{% endblock %}