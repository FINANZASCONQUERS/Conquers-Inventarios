{% extends 'base.html' %}

{% block title %}Reporte Gráfico de Despachos{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header mejorado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-900"><i class="fas fa-chart-pie me-2 text-primary"></i>Reporte Gráfico de Despachos</h1>
            <p class="text-gray-600 mb-0">Visualización analítica de los despachos realizados</p>
        </div>
        <div>
            <a href="{{ url_for('descargar_reporte_grafico_despachos_pdf', fecha_inicio=filtros.fecha_inicio, fecha_fin=filtros.fecha_fin) }}" 
               class="btn btn-danger btn-icon-split shadow-sm" target="_blank">
                <span class="icon text-white-50">
                    <i class="fas fa-file-pdf"></i>
                </span>
                <span class="text">Exportar PDF</span>
            </a>
        </div>
    </div>

    <!-- Tarjeta de filtros mejorada -->
    <div class="card shadow mb-4 border-left-primary">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white border-bottom-0">
            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-filter me-1"></i> Filtros de Búsqueda</h6>
            <div class="dropdown no-arrow">
                <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" 
                   data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow animated--fade-in" 
                    aria-labelledby="dropdownMenuLink">
                    <li><a class="dropdown-item" href="#" onclick="resetFilters()">
                        <i class="fas fa-undo fa-sm me-2"></i>Restablecer filtros
                    </a></li>
                </ul>
            </div>
        </div>
        <div class="card-body pt-0">
            <form method="GET" action="{{ url_for('reporte_grafico_despachos') }}" class="row g-3 mt-2">
                <div class="col-md-3">
                    <label for="fecha_inicio" class="form-label text-gray-700 small font-weight-bold">Fecha de Inicio</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="fas fa-calendar-alt text-primary"></i></span>
                        <input type="date" class="form-control form-control-sm" id="fecha_inicio" name="fecha_inicio" value="{{ filtros.fecha_inicio }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="fecha_fin" class="form-label text-gray-700 small font-weight-bold">Fecha de Fin</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="fas fa-calendar-alt text-primary"></i></span>
                        <input type="date" class="form-control form-control-sm" id="fecha_fin" name="fecha_fin" value="{{ filtros.fecha_fin }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="mes" class="form-label text-gray-700 small font-weight-bold">Mes</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light"><i class="fas fa-calendar text-primary"></i></span>
                        <input type="month" class="form-control form-control-sm" id="mes" name="mes" value="{{ filtros.mes }}">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="cliente" class="form-label text-gray-700 small font-weight-bold">Cliente</label>
                    <select class="form-select form-select-sm" id="cliente" name="cliente">
                        <option value="">Todos los clientes</option>
                        {% for cli in clientes %}
                        <option value="{{ cli }}" {% if filtros.cliente == cli %}selected{% endif %}>{{ cli }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="producto" class="form-label text-gray-700 small font-weight-bold">Producto</label>
                    <select class="form-select form-select-sm" id="producto" name="producto">
                        <option value="ambos" {% if filtros.producto=='ambos' %}selected{% endif %}>Ambos (FO4 + Diluyente)</option>
                        <option value="fo4" {% if filtros.producto=='fo4' %}selected{% endif %}>FO4</option>
                        <option value="diluyente" {% if filtros.producto=='diluyente' %}selected{% endif %}>Diluyente</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm btn-block w-100 shadow-sm"><i class="fas fa-search me-1"></i> Buscar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de resumen de productos (si aplica) -->
    {% if resumen_productos and filtros.cliente %}
    <div class="row mt-4">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-primary text-white py-2 border-0">
                    <h6 class="mb-0"><i class="fas fa-table me-1"></i> Cantidad Despachada por Producto para <b>{{ filtros.cliente }}</b></h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-striped mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th class="text-center ps-4">Producto</th>
                                    <th class="text-center pe-4">Barriles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto, total in resumen_productos %}
                                <tr>
                                    <td class="text-truncate ps-4" style="max-width: 150px;" title="{{ producto }}">{{ producto }}</td>
                                    <td class="text-end font-weight-bold pe-4">{{ "%.2f"|format(total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráfico o mensaje de no datos -->
    {% if grafico_base64 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow border-0">
                <div class="card-header py-3 d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between bg-white border-0">
                    <div class="d-flex flex-column">
                        <h5 class="m-0 font-weight-bold text-primary d-flex align-items-center gap-2">
                            <i class="fas fa-chart-bar"></i>
                            Distribución de Despachos por Cliente
                        </h5>
                        <small class="text-muted">Formato: {{ 'Barras Horizontales' if tipo!='pie' else 'Donut (Pie)' }} | Vista: {% if producto=='fo4' %}FO4{% elif producto=='diluyente' %}Diluyente{% else %}FO4 + Diluyente{% endif %}</small>
                    </div>
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Formato">
                            <a class="btn btn-outline-primary {% if tipo!='pie' %}active{% endif %}" href="{{ url_for('reporte_grafico_despachos', fecha_inicio=filtros.fecha_inicio, fecha_fin=filtros.fecha_fin, mes=filtros.mes, cliente=filtros.cliente, producto=filtros.producto, tipo='bar') }}">Barras</a>
                            <a class="btn btn-outline-primary {% if tipo=='pie' %}active{% endif %}" href="{{ url_for('reporte_grafico_despachos', fecha_inicio=filtros.fecha_inicio, fecha_fin=filtros.fecha_fin, mes=filtros.mes, cliente=filtros.cliente, producto=filtros.producto, tipo='pie') }}">Donut</a>
                        </div>
                        <div class="d-flex align-items-center gap-1 ms-1" id="zoomControls">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Zoom">
                                <button type="button" class="btn btn-outline-secondary" id="zoomOutBtn" title="Alejar">-</button>
                                <span class="btn btn-light disabled px-2" id="zoomPct" style="min-width:64px;">100%</span>
                                <button type="button" class="btn btn-outline-secondary" id="zoomInBtn" title="Acercar">+</button>
                                <button type="button" class="btn btn-outline-secondary" id="zoomResetBtn" title="Restablecer"><i class="fas fa-undo"></i></button>
                                <button type="button" class="btn btn-outline-secondary" id="zoomFsBtn" title="Pantalla completa"><i class="fas fa-expand"></i></button>
                            </div>
                            <input type="range" class="form-range ms-2" id="zoomRange" min="50" max="300" step="10" value="100" style="width:160px;" />
                        </div>
                        <button class="btn btn-success btn-sm" onclick="downloadChart()"><i class="fas fa-image me-1"></i>PNG</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-area mb-3 border rounded bg-light p-3 position-relative" id="chartArea" title="Usa Ctrl + rueda del mouse para hacer zoom">
                                {% set altura_bar = (datos_tabla|length * 55 + 240) if datos_tabla|length>8 else 820 %}
                                <img src="data:image/png;base64,{{ grafico_base64 }}" class="w-100 grafico-img {% if tipo=='pie' %}grafico-pie{% else %}grafico-bar{% endif %}" alt="Gráfico de Despachos" id="chartImage" data-altura-bar="{{ altura_bar }}" />
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-success text-start" style="white-space:normal; line-height:1.1; font-size:0.75rem;">
                                        {% if total_box_text %}{{ total_box_text|safe }}{% else %}TOTAL {{ '%.2f'|format(total_barriles) }} BBL{% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="small text-muted text-center mt-3">
                                <i class="fas fa-info-circle me-1"></i> Generado el {{ now.strftime('%d/%m/%Y %H:%M') }} — Puedes cambiar el formato arriba.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card shadow mb-4 border-0">
        <div class="card-header py-3 bg-white border-0">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-exclamation-triangle me-1"></i> Información no disponible
            </h6>
        </div>
        <div class="card-body text-center py-5">
            <i class="fas fa-chart-pie fa-4x mb-3 text-gray-300"></i>
            <h5 class="text-gray-800">No se encontraron datos de despachos</h5>
            <p class="text-gray-600 mb-0">Para el rango de fechas seleccionado no existen registros de despachos.</p>
            <p class="text-gray-600">Por favor, intente con otro período.</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
function downloadChart() {
    const link = document.createElement('a');
    link.download = 'grafico_despachos_{{ now.strftime("%Y%m%d_%H%M") }}.png';
    link.href = document.getElementById('chartImage').src;
    link.click();
}

function resetFilters() {
    document.getElementById('fecha_inicio').value = '';
    document.getElementById('fecha_fin').value = '';
    document.getElementById('mes').value = '';
    document.getElementById('cliente').selectedIndex = 0;
    document.getElementById('producto').selectedIndex = 0;
}

// Exclusividad: si se elige mes, limpiar fechas; si se ajusta una fecha, limpiar mes
document.addEventListener('DOMContentLoaded', () => {
    const mesInput = document.getElementById('mes');
    const fi = document.getElementById('fecha_inicio');
    const ff = document.getElementById('fecha_fin');
    const img = document.getElementById('chartImage');
    const chartArea = document.getElementById('chartArea');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomResetBtn = document.getElementById('zoomResetBtn');
    const zoomFsBtn = document.getElementById('zoomFsBtn');
    const zoomRange = document.getElementById('zoomRange');
    const zoomPct = document.getElementById('zoomPct');
    let scale = 1;
    let naturalWidth = null;
    function updateZoomUI(){
        zoomPct && (zoomPct.textContent = Math.round(scale*100) + '%');
        zoomRange && (zoomRange.value = Math.round(scale*100));
    }
    function applyScale(){
        if(!img) return;
        if(naturalWidth == null){ naturalWidth = img.naturalWidth || img.width; }
        if(scale === 1){
            img.classList.remove('zoom-mode');
            img.style.removeProperty('max-width');
            img.style.removeProperty('width');
            img.style.removeProperty('height');
        } else {
            img.classList.add('zoom-mode');
            img.style.maxWidth = 'none';
            img.style.width = (naturalWidth * scale) + 'px';
            img.style.height = 'auto';
        }
        updateZoomUI();
    }
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    if (chartArea) { chartArea.style.overflow = 'auto'; }
    if (img) {
        if (img.complete) { applyScale(); }
        else { img.addEventListener('load', applyScale); }
    }
    // Ctrl + rueda del mouse para zoom con enfoque bajo el cursor
    if (chartArea && img) {
        chartArea.addEventListener('wheel', (e) => {
            if (!(e.ctrlKey || e.metaKey)) return; // solo si mantiene Ctrl/Cmd
            e.preventDefault();
            const factor = e.deltaY < 0 ? 1.1 : 0.9;
            const areaRect = chartArea.getBoundingClientRect();
            const imgRect = img.getBoundingClientRect();
            const relX = (e.clientX - imgRect.left + chartArea.scrollLeft) / imgRect.width;
            const relY = (e.clientY - imgRect.top + chartArea.scrollTop) / imgRect.height;
            scale = clamp(scale * factor, 0.5, 3);
            applyScale();
            const newW = (img.naturalWidth || img.width) * scale;
            const newH = (img.naturalHeight || img.height) * scale;
            chartArea.scrollLeft = relX * newW - (e.clientX - areaRect.left);
            chartArea.scrollTop  = relY * newH - (e.clientY - areaRect.top);
        }, { passive: false });
    }
    if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => { scale = clamp(scale - 0.1, 0.5, 3); applyScale(); });
    if (zoomInBtn) zoomInBtn.addEventListener('click', () => { scale = clamp(scale + 0.1, 0.5, 3); applyScale(); });
    if (zoomResetBtn) zoomResetBtn.addEventListener('click', () => { scale = 1; applyScale(); });
    if (zoomRange) zoomRange.addEventListener('input', (e) => { scale = clamp(e.target.value/100, 0.5, 3); applyScale(); });
    if (zoomFsBtn && chartArea) {
        zoomFsBtn.addEventListener('click', async () => {
            try {
                if (!document.fullscreenElement) {
                    await chartArea.requestFullscreen();
                } else {
                    await document.exitFullscreen();
                }
            } catch(err) { /* noop */ }
        });
    }
    if(mesInput){
        mesInput.addEventListener('input', () => {
            if(mesInput.value){
                fi.value='';
                ff.value='';
            }
        });
    }
    [fi, ff].forEach(el => el && el.addEventListener('input', () => {
        if(fi.value || ff.value){
            document.getElementById('mes').value='';
        }
    }));
});
</script>

<style>
    .border-left-primary {
        border-left: 0.35rem solid #4e73df !important;
    }
    .card {
        border-radius: 0.5rem;
    }
    .card-header:first-child {
        border-radius: 0.5rem 0.5rem 0 0;
    }
    .btn {
        border-radius: 0.35rem;
    }
    .form-control, .form-select {
        border-radius: 0.35rem;
    }
    .table thead th {
        vertical-align: middle;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-top: 0;
    }
    .table tbody td {
        vertical-align: middle;
    }
    .bg-gradient-primary {
        background: linear-gradient(90deg, #4e73df 0%, #224abe 100%);
    }
    .shadow-sm {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    }
</style>
{% endblock %}

{% block extra_css %}
<style>
    img.grafico-img { object-fit: contain; width:100%; }
    /* Cuando se activa el zoom, permitimos que la imagen crezca y se desplace */
    img.grafico-img.zoom-mode { width:auto !important; max-width:none !important; }
    .chart-area { overflow:auto; }
    img.grafico-bar { max-height: 820px; }
    img.grafico-pie { max-height: 1100px; }
    @media (min-width:1400px){
        img.grafico-bar { max-height: 1000px; }
        img.grafico-pie { max-height: 1300px; }
    }
</style>
{% endblock %}