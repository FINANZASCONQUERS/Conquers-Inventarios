{% extends "base.html" %}

{% block title %}Planilla de Tránsito{% endblock %}
{% block navbar_brand_text %}Planilla Tránsito{% endblock %}

{% block main_style %}
    /* Fondo limpio y fuente profesional */
    background-color: #f4f7f9;
    font-family: 'Poppins', sans-serif;
{% endblock %}

{% block content %}
<div class="container-xl my-4">

    <div class="page-header-container d-flex justify-content-between align-items-center mb-4">
        <div class="page-title">
            <h1 class="page-title-text h2 mb-0">
                <i class="bi bi-truck-front-fill page-title-icon"></i>
                <span id="tipoTransitoVisual">
                    {{ transito_config.get(tipo_inicial if tipo_inicial == 'refineria' else 'EDSM', {}).get('nombre_display', 'Tránsito') }}
                </span>
            </h1>
        </div>
        <div class="action-buttons-bar">
            <div class="btn-group" role="group">
                <button id="btnGuardarTransito" onclick="guardarRegistro()" class="btn btn-success">
                    <i class="bi bi-save2-fill me-1"></i> Guardar
                </button>
                <a href="{{ url_for('reporte_transito') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-file-earmark-bar-graph-fill me-1"></i> Ver Reporte
                </a>
            </div>
            <div class="btn-group ms-2" role="group">
                 <button id="btnCambiarVistaTransito" onclick="cambiarVista()" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-repeat me-1"></i>
                    <span id="toggleNombreVista">
                        {% set otra_vista_key = 'REFINERIA' if tipo_inicial == 'general' else 'EDSM' %}
                        {{ transito_config.get(otra_vista_key, {}).get('nombre_display', 'Otra Vista') }}
                    </span>
                </button>
                <button id="btnAnadirFilaTransito" onclick="agregarFilaTransito()" class="btn btn-outline-secondary" title="Añadir Fila">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="alert-container" style="position: fixed; top: 80px; right: 20px; z-index: 1100;"></div>
    <div id="avisoHoraLimiteContainer" class="mb-3"></div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-header-custom">
                        <tr>
                            <th class="ps-3" style="min-width: 170px;">
                                FECHA CARGUE
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="0">
                            </th>
                            <th style="min-width: 220px;">
                                GUÍA
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="1">
                            </th>
                            <th style="min-width: 180px;">
                                ORIGEN
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="2">
                            </th>
                            <th style="min-width: 220px;">
                                PRODUCTO
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="3">
                            </th>
                            <th style="min-width: 130px;">
                                PLACA
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="4">
                            </th>
                            <th class="text-center" style="min-width: 120px;">
                                API @60°F
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="5">
                            </th>
                            <th class="text-center" style="min-width: 100px;">
                                %BSW
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="6">
                            </th>
                            <th class="text-center" style="min-width: 120px;">
                                NSV
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="7">
                            </th>
                            <th style="min-width: 300px;">
                                OBSERVACIONES
                                <input type="text" class="form-control form-control-sm mt-1 excel-filter" placeholder="Filtrar..." data-column-index="8">
                            </th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="tablaTransitoBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nuevo Origen -->
<div class="modal fade" id="modalNuevoOrigen" tabindex="-1" aria-labelledby="modalNuevoOrigenLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNuevoOrigenLabel">Añadir Nuevo Origen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formNuevoOrigen" onsubmit="event.preventDefault(); guardarNuevoOrigen();">
          <div class="mb-3">
            <label for="inputNuevoOrigen" class="form-label">Nombre del Nuevo Origen:</label>
            <input type="text" class="form-control" id="inputNuevoOrigen" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarNuevoOrigen" onclick="guardarNuevoOrigen()">Guardar Origen</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Nuevo Producto -->
<div class="modal fade" id="modalNuevoProducto" tabindex="-1" aria-labelledby="modalNuevoProductoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNuevoProductoLabel">Añadir Nuevo Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Añadir producto para el origen: <strong id="origenAsociadoTexto"></strong></p>
        <form id="formNuevoProducto" onsubmit="event.preventDefault(); guardarNuevoProducto();">
          <div class="mb-3">
            <label for="inputNuevoProducto" class="form-label">Nombre del Nuevo Producto:</label>
            <input type="text" class="form-control" id="inputNuevoProducto" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarNuevoProducto" onclick="guardarNuevoProducto()">Guardar Producto</button>
      </div>
    </div>
  </div>
</div>

<style>
    /* Estilo del título principal, como en la página de Planta */
    .page-title-text {
        color: #343a40;
        font-weight: 600;
    }
    .page-title-icon {
        color: #0b8552;
        font-size: 1.2em;
        margin-right: 0.75rem;
        vertical-align: text-bottom;
    }
    
    /* Estilo del encabezado de la tabla, como en Planta */
    .table-header-custom th {
        background-color: #0b8552 !important;
        color: white;
        text-transform: uppercase;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        padding: 0.9rem;
        vertical-align: middle;
    }
    
    .table tbody td {
        vertical-align: middle;
    }

    /* Estilos para los inputs y selects */
    .cell-input-wrapper {
        padding: 0.25rem 0.5rem !important;
    }

    .cell-input-wrapper .form-control,
    .cell-input-wrapper .form-select {
        font-size: 0.9rem;
        padding: 0.5rem;
        border-color: #e0e5ec;
        background-color: #fef9e7;
        transition: all 0.2s ease-in-out;
    }
    .cell-input-wrapper .form-control:focus,
    .cell-input-wrapper .form-select:focus {
        background-color: #fffde7;
        border-color: #0b8552;
        box-shadow: 0 0 0 0.2rem rgba(11, 133, 82, 0.15);
        outline: none;
    }
    .cell-input-wrapper .form-control:disabled,
    .cell-input-wrapper .form-select:disabled {
        background-color: #e9ecef !important;
        cursor: not-allowed;
    }
    
    /* Estilos para los botones de añadir */
    .btn-add-item {
        min-width: 30px;
        padding: 0.25rem;
    }
    
    /* Estilos para los contenedores flex de selects + botones */
    .select-with-btn-container {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .aviso-hora-limite {
        padding: 1rem;
        border-left: 4px solid #ffc107;
    }
</style>

<script>
    // --- Variables globales ---
    let datosGeneralInit = {{ datos_general | default([]) | tojson | safe }};
    let datosRefineriaInit = {{ datos_refineria | default([]) | tojson | safe }};
    const transitoConfig = {{ transito_config | default({}) | tojson | safe }};
    
    let vistaActual = '{{ tipo_inicial | default("general") }}';
    let currentData = []; 
    let edicionTransitoPermitida = true;
    const HORA_LIMITE_REGISTRO_TRANSITO = 10;
    let FilaActivaParaAnadirItem = null;
    let modalNuevoOrigen = null;
    let modalNuevoProducto = null;

    // Elementos del DOM
    const tipoTransitoVisualSpan = document.getElementById("tipoTransitoVisual");
    const toggleNombreVistaSpan = document.getElementById("toggleNombreVista");
    const tablaTransitoBody = document.getElementById("tablaTransitoBody");
    const btnGuardarTransito = document.getElementById('btnGuardarTransito');
    const btnAnadirFilaTransito = document.getElementById('btnAnadirFilaTransito');
    const avisoHoraLimiteContainer = document.getElementById('avisoHoraLimiteContainer');

    // --- Lógica para el filtro tipo Excel ---
    document.addEventListener('DOMContentLoaded', function() {
        const filterInputs = document.querySelectorAll('.excel-filter');
        const tableBody = document.getElementById('tablaTransitoBody');

        const applyFilters = () => {
            const rows = tableBody.querySelectorAll('tr');
            const activeFilters = Array.from(filterInputs).map(input => ({
                value: input.value.toUpperCase(),
                index: parseInt(input.getAttribute('data-column-index'), 10)
            })).filter(filter => filter.value !== '');

            rows.forEach(row => {
                let shouldShow = true;
                const cells = row.querySelectorAll('td');

                for (const filter of activeFilters) {
                    if (cells.length > filter.index) {
                        const cellElement = cells[filter.index].querySelector('input, select, textarea');
                        const cellContent = (cellElement ? cellElement.value : cells[filter.index].textContent).toUpperCase();
                        
                        if (!cellContent.includes(filter.value)) {
                            shouldShow = false;
                            break;
                        }
                    } else {
                        shouldShow = false;
                        break;
                    }
                }
                row.style.display = shouldShow ? '' : 'none';
            });
        };

        filterInputs.forEach(input => {
            input.addEventListener('keyup', applyFilters);
        });

        // Inicializar modales de Bootstrap
        modalNuevoOrigen = new bootstrap.Modal(document.getElementById('modalNuevoOrigen'));
        modalNuevoProducto = new bootstrap.Modal(document.getElementById('modalNuevoProducto'));
        
        const estadoRecuperado = cargarEstadoDesdeSesion();
        if (estadoRecuperado) {
            // Si hay datos en la memoria, los cargamos
            vistaActual = estadoRecuperado.vista;
            currentData = estadoRecuperado.datos;
            mostrarAlerta("Se recuperaron los cambios no guardados de tu sesión anterior.", "info");
            actualizarTextosDeVista();
            redibujarTabla();
        } else {
            // Si no hay nada, cargamos desde cero como antes
            vistaActual = '{{ tipo_inicial | default("general") }}';
            renderTabla();
        }
        
        // Esta función se ejecuta en ambos casos
        verificarEstadoEdicion();
    });

    // --- Funciones para añadir orígenes y productos ---
    function abrirModalNuevoOrigen(rowIndex) {
        if (!edicionTransitoPermitida) {
            mostrarAlerta("No se pueden añadir orígenes. Los registros están cerrados.", "warning");
            return;
        }
        FilaActivaParaAnadirItem = rowIndex;
        document.getElementById('inputNuevoOrigen').value = '';
        modalNuevoOrigen.show();
    }

    function abrirModalNuevoProducto(rowIndex) {
        if (!edicionTransitoPermitida) {
            mostrarAlerta("No se pueden añadir productos. Los registros están cerrados.", "warning");
            return;
        }
        
        const fila = currentData[rowIndex];
        if (!fila.ORIGEN) {
            mostrarAlerta("Por favor, seleccione un origen primero.", "warning");
            return;
        }
        
        FilaActivaParaAnadirItem = rowIndex;
        document.getElementById('inputNuevoProducto').value = '';
        document.getElementById('origenAsociadoTexto').textContent = fila.ORIGEN;
        modalNuevoProducto.show();
    }

    function guardarNuevoOrigen() {
        const input = document.getElementById('inputNuevoOrigen');
        const nuevoOrigenNombre = input.value.trim().toUpperCase();
        const tipoPlanilla = vistaActual === "general" ? "EDSM" : "REFINERIA";
        
        if (!nuevoOrigenNombre) {
            mostrarAlerta("El nombre del origen no puede estar vacío.", "warning");
            return;
        }
        
        const btn = document.getElementById('btnGuardarNuevoOrigen');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Guardando...`;

        fetch('/api/add-origen', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
            body: JSON.stringify({ origen_nombre: nuevoOrigenNombre, tipo_planilla: tipoPlanilla })
        })
        .then(res => res.json().then(data => ({ ok: res.ok, status: res.status, data })))
        .then(({ ok, status, data }) => {
            if (!ok) throw new Error(data.message || `Error del servidor (${status})`);
            
            // Éxito: Actualizar configuración local y redibujar
            transitoConfig[tipoPlanilla].campos[nuevoOrigenNombre] = { productos: [], auto_select_product: "" };
            mostrarAlerta("Origen guardado con éxito.", "success");
            modalNuevoOrigen.hide();
            
            if (FilaActivaParaAnadirItem !== null) {
                currentData[FilaActivaParaAnadirItem].ORIGEN = nuevoOrigenNombre;
                currentData[FilaActivaParaAnadirItem].PRODUCTO = ""; // Limpiar producto
            }
            redibujarTabla(); // Redibuja toda la tabla con la nueva opción
        })
        .catch(error => {
            if (error.message.includes("SESSION_EXPIRED")) {
                window.location.reload();
            } else {
                mostrarAlerta(`Error: ${error.message}`, "danger");
            }
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Guardar Origen';
        });
    }

    function guardarNuevoProducto() {
        const inputProducto = document.getElementById('inputNuevoProducto');
        const nuevoProductoNombre = inputProducto.value.trim();
        const origenAsociado = document.getElementById('origenAsociadoTexto').textContent;
        const tipoPlanilla = vistaActual === "general" ? "EDSM" : "REFINERIA";

        if (!nuevoProductoNombre) {
            mostrarAlerta("El nombre del producto no puede estar vacío.", "warning");
            return;
        }

        const btn = document.getElementById('btnGuardarNuevoProducto');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Guardando...`;

        fetch('/api/add-producto', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
            body: JSON.stringify({ 
                origen_nombre: origenAsociado, 
                producto_nombre: nuevoProductoNombre,
                tipo_planilla: tipoPlanilla 
            })
        })
        .then(res => res.json().then(data => ({ ok: res.ok, status: res.status, data })))
        .then(({ ok, status, data }) => {
            if (!ok) throw new Error(data.message || `Error del servidor (${status})`);
            
            // Actualizar configuración local
            if (!transitoConfig[tipoPlanilla].campos[origenAsociado]) {
                transitoConfig[tipoPlanilla].campos[origenAsociado] = {
                    productos: [],
                    auto_select_product: ""
                };
            }
            transitoConfig[tipoPlanilla].campos[origenAsociado].productos.push(nuevoProductoNombre);
            
            mostrarAlerta("Producto guardado con éxito.", "success");
            modalNuevoProducto.hide();

            if (FilaActivaParaAnadirItem !== null) {
                currentData[FilaActivaParaAnadirItem].PRODUCTO = nuevoProductoNombre;
            }
            redibujarTabla(); // Redibuja toda la tabla con la nueva opción
        })
        .catch(error => {
             if (error.message.includes("SESSION_EXPIRED")) {
                window.location.reload();
            } else {
                mostrarAlerta(`Error: ${error.message}`, "danger");
            }
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Guardar Producto';
        });
    }

    // --- Funciones principales ---

    function clonarDatosIniciales(datosOriginales) {
    const MIN_FILAS = 10;
    let datosValidos = Array.isArray(datosOriginales) ? datosOriginales : [];
    
    // Hacemos una copia profunda de los datos recibidos del servidor
    let datosClonados = JSON.parse(JSON.stringify(datosValidos));
    
    // Añade filas vacías solo si el historial actual es menor a 10
    while (datosClonados.length < MIN_FILAS) {
        datosClonados.push({
            id: null, // El id es null porque es una fila nueva, no guardada
            FECHA: "", GUIA: "", ORIGEN: "", PRODUCTO: "", 
            PLACA: "", API: "", BSW: "", NSV: "", OBSERVACIONES: ""
        });
    }
    
    return datosClonados;
}

    function redibujarTabla() {
        tablaTransitoBody.innerHTML = "";

        currentData.forEach((fila, index) => {
            const tr = document.createElement("tr");
            tr.dataset.index = index;
            
            crearTdFecha(tr, fila, "FECHA");
            crearTdInputAlfanumerico(tr, fila, "GUIA");
            crearTdOrigen(tr, fila, "ORIGEN"); 
            crearTdProducto(tr, fila, "PRODUCTO", fila["ORIGEN"]); 
            crearTdInputAlfanumerico(tr, fila, "PLACA");
            crearTdInputNumerico(tr, fila, 'API');
            crearTdInputNumerico(tr, fila, 'BSW');
            crearTdInputNumerico(tr, fila, 'NSV');
            crearTdTextArea(tr, fila, "OBSERVACIONES");
            crearTdBotonEliminar(tr, index);
            
            tablaTransitoBody.appendChild(tr);
        });
        
        verificarEstadoEdicion();
    }

    function renderTabla() {
        currentData = vistaActual === "general" 
            ? clonarDatosIniciales(datosGeneralInit) 
            : clonarDatosIniciales(datosRefineriaInit);
        redibujarTabla();
    }

    // --- Funciones auxiliares para crear celdas ---

    function crearTdGenerico(tr) {
        const td = document.createElement("td");
        td.classList.add("align-middle", "px-1");
        tr.appendChild(td);
        return td;
    }

    function crearTdTextArea(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const textarea = document.createElement("textarea");
        textarea.className = "form-control form-control-sm";
        textarea.rows = "1";
        textarea.value = fila[campoKey] || "";
        textarea.dataset.field = campoKey;
        textarea.disabled = !edicionTransitoPermitida;
        textarea.addEventListener("change", actualizarDatoFila);
        td.appendChild(textarea);
    }

    function crearTdFecha(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        td.classList.add("ps-3");
        const input = document.createElement("input");
        input.type = "date"; 
        input.className = "form-control form-control-sm";
        let fechaValor = fila[campoKey] || "";
        if (fechaValor && fechaValor.includes('/')) {
            const partes = fechaValor.split('/');
            if (partes.length === 3) {
                fechaValor = `${partes[2]}-${partes[1].padStart(2,'0')}-${partes[0].padStart(2,'0')}`;
            }
        }
        input.value = fechaValor;
        input.dataset.field = campoKey;
        input.disabled = !edicionTransitoPermitida;
        input.addEventListener("change", actualizarDatoFila);
        td.appendChild(input);
    }

    function crearTdInputAlfanumerico(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control form-control-sm";
        input.value = fila[campoKey] || "";
        input.dataset.field = campoKey;
        input.disabled = !edicionTransitoPermitida;
        input.addEventListener("change", actualizarDatoFila);
        td.appendChild(input);
    }

    function crearTdInputNumerico(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const input = document.createElement("input");
        input.type = "text"; 
        input.className = "form-control form-control-sm text-center";
        input.setAttribute('inputmode', 'decimal'); 
        input.value = String(fila[campoKey] || "").replace('.', ','); 
        input.dataset.field = campoKey;
        input.disabled = !edicionTransitoPermitida;
        input.addEventListener("change", actualizarDatoFila);
        input.addEventListener('keydown', function(event) {
            if (!edicionTransitoPermitida) { event.preventDefault(); return; }
            const allowedKeys = ["Backspace", "Delete", "Tab", "Escape", "Enter", "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Home", "End", ".", ","];
            if (allowedKeys.includes(event.key)) {
                if ((event.key === '.' || event.key === ',') && (input.value.includes(',') || input.value.includes('.'))) {
                    event.preventDefault();
                }
                return;
            }
            if ((event.ctrlKey || event.metaKey) && ['a', 'c', 'v', 'x', 'z'].includes(event.key.toLowerCase())) { return; }
            if (!(event.key >= '0' && event.key <= '9')) { event.preventDefault(); }
        });
        td.appendChild(input);
    }

    function crearTdOrigen(tr, fila, campoKey) {
        const td = crearTdGenerico(tr);
        const divContenedor = document.createElement("div");
        divContenedor.className = "select-with-btn-container";
        
        const select = document.createElement("select");
        select.className = "form-select form-select-sm";
        select.dataset.field = campoKey;
        select.disabled = !edicionTransitoPermitida;
        
        const tipoConfigKey = vistaActual === "general" ? "EDSM" : "REFINERIA";
        const configParaTipoActual = transitoConfig ? transitoConfig[tipoConfigKey] : null;
        const origenesDisponibles = configParaTipoActual?.campos ? Object.keys(configParaTipoActual.campos).sort() : [];
        
        select.innerHTML = '<option value="">Seleccione Origen...</option>';
        origenesDisponibles.forEach(nombreOrigen => {
            const option = document.createElement("option");
            option.value = nombreOrigen;
            option.textContent = nombreOrigen;
            select.appendChild(option);
        });
        select.value = fila[campoKey] || "";
        
        select.addEventListener("change", function(event) {
            const rowIndex = parseInt(event.target.closest("tr").dataset.index, 10);
            const nuevoOrigen = event.target.value;
            currentData[rowIndex][campoKey] = nuevoOrigen;
            
            const productoSelectElement = event.target.closest("tr").querySelector('select[data-field="PRODUCTO"]');
            if (productoSelectElement) {
                const origenConfig = configParaTipoActual?.campos?.[nuevoOrigen];
                const productos = origenConfig?.productos || [];
                const autoProducto = origenConfig?.auto_select_product || "";
                
                productoSelectElement.innerHTML = '<option value="">Seleccione Producto...</option>';
                productos.forEach(prod => {
                    const opt = document.createElement("option");
                    opt.value = prod;
                    opt.textContent = prod;
                    productoSelectElement.appendChild(opt);
                });
                productoSelectElement.value = autoProducto;
                currentData[rowIndex]["PRODUCTO"] = autoProducto;
            }
        });
        
        const btnAdd = document.createElement("button");
        btnAdd.className = "btn btn-sm btn-outline-secondary btn-add-item";
        btnAdd.innerHTML = '<i class="bi bi-plus-lg"></i>';
        btnAdd.title = "Añadir nuevo origen";
        btnAdd.disabled = !edicionTransitoPermitida;
        btnAdd.onclick = function() {
            abrirModalNuevoOrigen(parseInt(tr.dataset.index, 10));
        };
        
        divContenedor.appendChild(select);
        divContenedor.appendChild(btnAdd);
        td.appendChild(divContenedor);
    }
    
    function crearTdProducto(tr, fila, campoKey, origenSeleccionado) {
        const td = crearTdGenerico(tr);
        const divContenedor = document.createElement("div");
        divContenedor.className = "select-with-btn-container";
        
        const select = document.createElement("select");
        select.className = "form-select form-select-sm";
        select.dataset.field = campoKey;
        select.disabled = !edicionTransitoPermitida;
        
        select.innerHTML = '<option value="">Seleccione Producto...</option>';
        
        if (origenSeleccionado) {
            const tipoConfigKey = vistaActual === "general" ? "EDSM" : "REFINERIA";
            const configParaTipoActual = transitoConfig ? transitoConfig[tipoConfigKey] : null;
            const origenConfig = configParaTipoActual?.campos?.[origenSeleccionado];
            
            if (origenConfig && origenConfig.productos) {
                origenConfig.productos.forEach(prod => {
                    const option = document.createElement("option");
                    option.value = prod;
                    option.textContent = prod;
                    select.appendChild(option);
                });
                select.value = fila[campoKey] || origenConfig.auto_select_product || "";
            }
        }
        
        select.addEventListener("change", actualizarDatoFila);
        
        const btnAdd = document.createElement("button");
        btnAdd.className = "btn btn-sm btn-outline-secondary btn-add-item";
        btnAdd.innerHTML = '<i class="bi bi-plus-lg"></i>';
        btnAdd.title = "Añadir nuevo producto";
        btnAdd.disabled = !edicionTransitoPermitida;
        btnAdd.onclick = function() {
            abrirModalNuevoProducto(parseInt(tr.dataset.index, 10));
        };
        
        divContenedor.appendChild(select);
        divContenedor.appendChild(btnAdd);
        td.appendChild(divContenedor);
    }

    function crearTdBotonEliminar(tr, index) {
    const td = document.createElement("td");
    td.classList.add("text-center", "align-middle");
    const button = document.createElement("button");
    button.className = "btn btn-outline-danger btn-sm";
    button.innerHTML = '<i class="bi bi-trash"></i>';
    button.type = "button";
    button.disabled = !edicionTransitoPermitida;

    button.onclick = function() {
        if (!edicionTransitoPermitida) return;
        
        // Obtenemos el ID del registro de la base de datos.
        // Si no tiene ID (es una fila nueva sin guardar), simplemente la borra de la vista.
        const registroId = currentData[index].id;
        
        if (registroId) {
            // Si tiene ID, llama a la función para borrarla del servidor
            eliminarFilaEnServidor(registroId, index);
        } else {
            // Si no tiene ID, es una fila nueva, solo se borra de la vista
            if (currentData.length > 1) { 
                currentData.splice(index, 1);
                guardarEstadoEnSesion();
                redibujarTabla(); 
            } else {
                mostrarAlerta("Debe haber al menos una fila.", "warning");
            }
        }
    };
    td.appendChild(button);
    tr.appendChild(td);
}

    function actualizarDatoFila(event) {
        const element = event.target;
        const field = element.dataset.field;
        const index = parseInt(element.closest("tr").dataset.index, 10);
        let value = element.value; 
        if (element.type === "date") { /* No hacer trim a fechas */ } 
        else if (element.getAttribute('inputmode') === 'decimal') { value = value.replace(',', '.'); } 
        else { value = value.trim(); }
        if (currentData && currentData[index] !== undefined) {
            currentData[index][field] = value;
        }
        guardarEstadoEnSesion();
    }

    function agregarFilaTransito() {
        if (!edicionTransitoPermitida) {
            mostrarAlerta("No se pueden añadir filas. Los registros están cerrados.", "warning");
            return;
        }
        const nuevaFilaVacia = {
            FECHA: "", GUIA: "", ORIGEN: "", PRODUCTO: "", 
            PLACA: "", API: "", BSW: "", NSV: "", OBSERVACIONES: ""
        };
        currentData.push(nuevaFilaVacia);
        guardarEstadoEnSesion();
        redibujarTabla();
    }
    
    function guardarRegistro() {
    if (!edicionTransitoPermitida) {
        mostrarAlerta(`Los registros están cerrados.`, "warning");
        return;
    }
    const btn = document.getElementById('btnGuardarTransito');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Guardando...`;

    // Filtra para enviar solo las filas que el usuario ha llenado
    const datosAEnviar = currentData.filter(fila => fila.GUIA && fila.GUIA.trim() !== "");

    if (datosAEnviar.length === 0) {
        mostrarAlerta("No hay datos nuevos o modificados para guardar.", "warning");
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-save2-fill me-1"></i> Guardar`;
        return;
    }

    fetch(`/guardar-registro-transito-${vistaActual}`, { 
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
        body: JSON.stringify(datosAEnviar)
    })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
        if (!ok) throw new Error(data.message || "Error del servidor");

        mostrarAlerta(data.message, "success");
        limpiarEstadoDeSesion(); 
        
        // Actualiza los datos base con la respuesta COMPLETA del servidor
        const historialCompleto = data.datos;
        
        if (vistaActual === 'general') {
            datosGeneralInit = historialCompleto;
        } else {
            datosRefineriaInit = historialCompleto;
        }
        // Vuelve a renderizar la tabla con todo el historial fresco
        renderTabla(); 
    })
    .catch(error => {
        console.error("Error al guardar:", error);
        mostrarAlerta(`Error: ${error.message}`, "danger"); 
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-save2-fill me-1"></i> Guardar`;
    });
}

function eliminarFilaEnServidor(registroId, indexFila) {
    if (!confirm("¿Está seguro que desea eliminar este registro permanentemente?")) {
        return;
    }

    const btnEliminar = document.querySelector(`tr[data-index="${indexFila}"] .btn-outline-danger`);
    if (btnEliminar) {
        btnEliminar.disabled = true;
        btnEliminar.innerHTML = '<i class="bi bi-hourglass"></i>';
    }

    fetch(`/eliminar-registro-transito/${registroId}`, {
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Eliminar la fila del array currentData
            currentData.splice(indexFila, 1);
            
            // Si estamos viendo datos iniciales, actualizamos también el dataset correspondiente
            if (vistaActual === "general") {
                datosGeneralInit = datosGeneralInit.filter(item => item.id !== registroId);
            } else {
                datosRefineriaInit = datosRefineriaInit.filter(item => item.id !== registroId);
            }
            
            mostrarAlerta(data.message, "success");
            guardarEstadoEnSesion();
            redibujarTabla();
        } else {
            throw new Error(data.message || "Error al eliminar");
        }
    })
    .catch(error => {
        console.error("Error al eliminar:", error);
        mostrarAlerta(`Error al eliminar: ${error.message}`, "danger");
    })
    .finally(() => {
        if (btnEliminar) {
            btnEliminar.disabled = false;
            btnEliminar.innerHTML = '<i class="bi bi-trash"></i>';
        }
    });
}

    function guardarEstadoEnSesion() {
    // Guarda tanto la vista actual como los datos en un solo objeto
    const estado = {
        vista: vistaActual,
        datos: currentData
    };
    sessionStorage.setItem('estadoTransito', JSON.stringify(estado));
}

function cargarEstadoDesdeSesion() {
    const estadoGuardado = sessionStorage.getItem('estadoTransito');
    if (estadoGuardado) {
        // Si hay datos guardados, los devuelve
        return JSON.parse(estadoGuardado);
    }
    // Si no hay nada, devuelve null
    return null;
}

function limpiarEstadoDeSesion() {
    // Elimina la memoria temporal
    sessionStorage.removeItem('estadoTransito');
}

    // --- Funciones de vista y estado ---

    function actualizarTextosDeVista() {
        const tipoConfigActualKey = vistaActual === "general" ? "EDSM" : "REFINERIA";
        const tipoConfigOtraKey = vistaActual === "general" ? "REFINERIA" : "EDSM";
        const configActual = transitoConfig ? transitoConfig[tipoConfigActualKey] : null;
        const configOtra = transitoConfig ? transitoConfig[tipoConfigOtraKey] : null;
        if (tipoTransitoVisualSpan) {
            tipoTransitoVisualSpan.textContent = configActual?.nombre_display || (vistaActual === "general" ? "Tránsito Crudo EDSM" : "Tránsito Crudo Refinería");
        }
        if (toggleNombreVistaSpan) {
            toggleNombreVistaSpan.textContent = configOtra?.nombre_display || (vistaActual === "general" ? "Refinería" : "EDSM");
        }
    }

    function cambiarVista() {
        vistaActual = vistaActual === "general" ? "refineria" : "general";
        guardarEstadoEnSesion(); 
        actualizarTextosDeVista();
        renderTabla(); 
    }

    function mostrarAlerta(mensaje, tipo = 'info', duracion = 4000) {
        const alertContainer = document.getElementById('alert-container');
        if (!alertContainer) return;
        const wrapper = document.createElement('div');
        const iconClass = tipo === 'success' ? 'bi-check-circle-fill' : tipo === 'danger' ? 'bi-exclamation-triangle-fill' : tipo === 'warning' ? 'bi-exclamation-diamond-fill' : 'bi-info-circle-fill';
        wrapper.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center shadow" role="alert"><i class="bi ${iconClass} me-2"></i><div>${mensaje}</div><button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        alertContainer.appendChild(wrapper);
        const alertElement = wrapper.firstChild;
        if (alertElement) {
            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertElement);
                if (bsAlert) { bsAlert.close(); }
            }, duracion);
        }
    }

    function verificarEstadoEdicion() {
        // La lógica de restricción por hora sigue comentada como en tu ejemplo.
        // Si la descomentas, funcionará como antes.
    }

    

</script>
{% endblock %}