{% extends "base.html" %}

{% block title %}Dashboard | Sistema de Gestión{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=1.0" />
{% endblock %}

{% block page_header %}
<div class="page-header-pro mb-5 fade-in-up">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
            <ul class="breadcrumb-mini mb-2">
                <li>Inicio</li>
                <li>Panel</li>
                <li>Dashboard</li>
            </ul>
            <h1 class="mb-2"><i class="bi bi-speedometer2 me-2 text-primary"></i>Panel de Control</h1>
            <div class="page-header-meta">
                <span class="d-inline-flex align-items-center gap-2"><i class="bi bi-calendar-check"></i><span id="current-date">{{ current_date }}</span></span>
                <span class="vr"></span>
                <span class="d-inline-flex align-items-center gap-2"><i class="bi bi-activity"></i>Estado consolidado</span>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-soft-primary btn-icon" data-loading="false" id="refreshDashboard" data-bs-toggle="tooltip" data-bs-title="Actualizar datos">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <a href="{{ url_for('home') }}" class="btn btn-outline-primary d-flex align-items-center gap-2"><i class="bi bi-house"></i><span>Inicio</span></a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row access-grid">
    <div class="col-12 col-md-6 col-xl-3 fade-in-up delay-1">
        <div class="dash-card theme-planta h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="dash-icon"><i class="bi bi-buildings-fill"></i></div>
                <div class="text-end small text-muted fw-medium">
                    <div class="dash-updated"><i class="bi bi-clock-history text-planta"></i> {{ planta_summary.info_completa }}</div>
                </div>
            </div>
            <h3 class="dash-title text-planta">Reporte Planta</h3>
            <p class="mb-2 small text-muted flex-grow-1">Indicadores operativos y consolidado de entradas / salidas en planta.</p>
            <div class="dash-btn"><a class="btn btn-accent text-white" href="{{ url_for('reporte_planta') }}"><span>Acceder</span><i class="bi bi-arrow-right"></i></a></div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3 fade-in-up delay-2">
        <div class="dash-card theme-transito h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="dash-icon"><i class="bi bi-truck"></i></div>
                <div class="text-end small text-muted fw-medium">
                    <div class="dash-updated"><i class="bi bi-clock-history text-transito"></i> {{ transito_summary.info_completa }}</div>
                </div>
            </div>
            <h3 class="dash-title text-transito">Reporte Tránsito</h3>
            <p class="mb-2 small text-muted">Seguimiento de movimientos y tiempos logísticos en tránsito.</p>
            <div class="dash-btn"><a class="btn btn-accent text-white" href="{{ url_for('reporte_transito') }}"><span>Acceder</span><i class="bi bi-arrow-right"></i></a></div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3 fade-in-up delay-3">
        <div class="dash-card theme-orion h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="dash-icon"><i class="bi bi-water"></i></div>
                <div class="text-end small text-muted fw-medium">
                    <div class="dash-updated"><i class="bi bi-clock-history text-orion"></i> {{ orion_summary.info_completa }}</div>
                </div>
            </div>
            <h3 class="dash-title text-orion">Barcaza Orion</h3>
            <p class="mb-2 small text-muted">Resumen operativo y métricas clave de la barcaza Orion.</p>
            <div class="dash-btn"><a class="btn btn-accent text-white" href="{{ url_for('reporte_barcaza') }}"><span>Acceder</span><i class="bi bi-arrow-right"></i></a></div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3 fade-in-up delay-4">
        <div class="dash-card theme-bita h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="dash-icon"><i class="bi bi-tsunami"></i></div>
                <div class="text-end small text-muted fw-medium">
                    <div class="dash-updated"><i class="bi bi-clock-history text-bita"></i> {{ bita_summary.info_completa }}</div>
                </div>
            </div>
            <h3 class="dash-title text-bita">Barcaza BITA</h3>
            <p class="mb-2 small text-muted">Resumen operativo y métricas clave de la barcaza BITA.</p>
            <div class="dash-btn"><a class="btn btn-accent text-white" href="{{ url_for('reporte_barcaza_bita') }}"><span>Acceder</span><i class="bi bi-arrow-right"></i></a></div>
        </div>
    </div>
</div>

<div class="mt-5 fade-in-up delay-2">
    <div class="row g-4">
        <div class="col-12">
            <div class="dash-card h-100">
                <div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-2">
                    <h4 class="mb-0 d-flex align-items-center gap-2"><i class="bi bi-bell-fill text-info"></i><span>Alertas / Eventos</span></h4>
                    <div class="small text-muted">Actualizado al cargar la página</div>
                </div>
                {% if alerts and alerts|length > 0 %}
                <ul class="list-unstyled mb-0 small" id="alertList">
                    {% for a in alerts %}
                    <li class="py-2 d-flex flex-wrap align-items-start gap-2 border-bottom last-border-0">
                        <span class="badge rounded-pill bg-{{ 'danger' if a.severity=='danger' else 'warning' if a.severity=='warning' else 'info' if a.severity=='info' else 'success' }} text-dark-emphasis d-inline-flex align-items-center gap-1" style="font-weight:600;">
                            <i class="bi bi-{{ a.icon }}"></i>{{ a.category }}
                        </span>
                        <span class="flex-grow-1 lh-sm">{{ a.message }}</span>
                        {% if loop.first and a.severity in ['danger','warning'] %}
                            <span class="ms-auto text-muted small fst-italic">Prioridad alta</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <div class="small text-muted">Sin alertas generadas.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.textContent = new Date().toLocaleDateString('es-ES', options);
        }
        const refreshBtn = document.getElementById('refreshDashboard');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                refreshBtn.setAttribute('data-loading','true');
                try {
                    // Aquí podrías hacer un fetch a un endpoint para refrescar KPIs
                    await new Promise(r=>setTimeout(r,1200));
                } finally {
                    refreshBtn.setAttribute('data-loading','false');
                }
            });
        }
    });
</script>
{% endblock %}