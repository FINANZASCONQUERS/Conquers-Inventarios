<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>GUÍA TRANSPORTE MINMINAS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* Estilos Generales y de la Guía */
        @page { size: landscape; margin: 0; }
        html, body { 
            margin: 0; padding: 0;
            font: 12pt ARIAL, sans-serif;
            width: 100%; height: 100%;
            overflow: hidden;
            line-height: 1.2;
            position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url("{{ url_for('static', filename='Fondo.webp') }}") no-repeat center center;
            background-size: 1590px 900px;
            opacity: 0.50;
            z-index: -1;
        }
        /* Contenedor de acciones (id histórico) */
        #acciones { 
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        /* Contenedor de acciones que actualmente usa class="acciones" */
        .acciones {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        #acciones button {
            padding: 8px 15px;
            margin-right: 8px;
            background: #004080;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .acciones button { /* mismo estilo para la clase */
            padding: 8px 15px;
            margin-right: 8px;
            background: #004080;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        #acciones button:hover {
            background: #0066cc;
        }
        .acciones button:hover { background: #0066cc; }
        
        /* Estilo para el botón de Cerrar Sesión */
        #boton-logout {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            font-family: sans-serif;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #boton-logout:hover {
            background-color: #c82333;
        }
        
        #selloInput { -webkit-appearance: none; -moz-appearance: textfield; appearance: textfield; }
        #selloInput::-webkit-outer-spin-button, #selloInput::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; display: none; }
        .fila-acciones-agregar {
    display: flex;
    justify-content: center; /* Centra los botones horizontalmente */
    gap: 1rem; /* Espacio entre los botones */
    margin-top: 1cm; /* Espacio arriba, separándolo del formulario */
}

/* Estilo opcional para que los botones se vean un poco mejor */
.fila-acciones-agregar .btn {
    font-weight: 500;
}
        /* Estilos de Impresión */
        @media print {
           .no-print { 
        display: none !important; 
    }
    .btn-agregar-conductor-interno {
        display: none !important;
    }

            #acciones, #boton-logout { display: none !important; }
            body::before { display: none; }
            .campo, .hoja { border: none !important; }
            select { background: transparent !important; border: none !important; }
            body { transform: rotate(0deg) !important; }
            ::placeholder { color: transparent !important; }
            input[placeholder]:empty:before { content: none !important; }
            #selloInput::-webkit-outer-spin-button, #selloInput::-webkit-inner-spin-button { display: none !important; }
            @page { size: letter; margin: 0; }
             body { width: 29.7cm; height: 21cm; transform: rotate(0deg); } 
            #contenedor-guia { width: 25.7cm; height: 16.5cm; margin: 3.8cm auto; padding: 1.5cm 1cm 1cm 1cm; }

            /* Empresa transportadora: envolver texto largo en dos líneas dentro del mismo cuadro */
            .empresa-transportadora input { display: none !important; }
            .empresa-transportadora .empresa-transportadora-wrap {
                display: flex !important;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
                padding: 0 2px;
                text-align: center;
                white-space: normal;
                word-break: break-word;
                overflow-wrap: anywhere;
                text-transform: uppercase;
                font-weight: bold;
                /* Afinar para 2 renglones dentro de ~1cm */
                font-size: 12pt;
                line-height: 0.42cm;
            }

            /* Destino: envolver texto largo en dos líneas dentro del mismo cuadro */
            .lugar-destino input { display: none !important; }
            .lugar-destino .destino-wrap {
                display: flex !important;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
                padding: 0 2px;
                text-align: center;
                white-space: normal;
                word-break: break-word;
                overflow-wrap: anywhere;
                text-transform: uppercase;
                font-weight: bold;
                font-size: 12pt;
                line-height: 0.42cm;
            }
        }

        /* Solo pantalla: ordenar visualmente sin tocar la impresión */
        @media screen {
            /* Separación uniforme entre campos por fila */
            .fila { gap: 0.25cm; }
            /* Quitar desplazamientos negativos solo en pantalla */
            .lugar-fecha,
            .planta-productor,
            .factura-remision,
            .observaciones { left: 0 !important; }
            /* Evitar desbordes horizontales en pantalla */
            .observaciones { width: 100% !important; }
            /* El margen superior negativo de dirección hace saltos; anúlalo en pantalla */
            .direccion { margin-top: 0 !important; }
            /* Ajuste opcional para que acciones no tape el formulario en pantallas pequeñas */
            #contenedor-guia { margin-top: 3.0cm; }
            /* La caja de volumen no tenía ancho válido; define uno solo para pantalla */
            .volumen { width: 8.6cm; }
        }
        #contenedor-guia { width: 25.7cm; height: 16.5cm; margin: 2.2cm auto 1cm auto; padding: 1.5cm 1cm 1cm 1cm; }
        .hoja { width: 100%; height: 100%; display: flex; flex-direction: column; font-size: 10pt; }
        .fila { display: flex; margin-bottom: 0.4cm; }
        .fila.pequeno { margin-bottom: 0.3cm; }
        .fila.muy-pequeno { margin-bottom: 0.20cm; }
        .campo { flex: none; border: 1px solid #333; padding: 4px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; text-align: center; background: white; border-radius: 5px; }
        label { font-weight: bold; font-size: 9pt; margin-bottom: 2px; text-align: center; text-transform: uppercase; }
        .campo input::placeholder, .campo select::placeholder { color: transparent; }
        .campo input:focus::placeholder, .campo select:focus::placeholder { color: #999; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none; }
        select::-ms-expand { display: none; }
        .campo input, .campo select, .campo textarea { width: 100%; border: none; background: transparent; font: inherit; text-transform: uppercase; outline: none; resize: none; text-align: center; font-weight: bold; padding: 0; }
          #direccionCliente {
            line-height: 0.45cm; /* Establece la altura de cada renglón */
            overflow-y: hidden;  /* Oculta el scroll si el texto es muy largo */
        }
        .select-producto { font-size: 12pt; font-weight: bold; border: none; background: transparent; width: 100%; }
        .descripcion-producto, .volumen { font-weight: bold; }
        .grupo-producto .dato-producto span { font-weight: bold; font-size: 11pt; }
        .lugar-fecha {position: relative;left: -75px; width: 10.5cm; height: 1.1cm; font-size: 14pt }
        .planta-productor { position: relative;left: -83px; width: 8.8cm; height: 1cm;font-size: 14pt }
        .planta-productor input { text-align: left; padding-left: 0px; padding-right: 0px; }
        .factura-remision {position: relative;left: -40px; width: 3.5cm; height: 1cm;font-size: 16pt  }
        .despacho { width: 15cm; height: 1cm; font-size: 14pt }
        .codigo-sicom { width: 10cm; height: 1cm; font-size: 16pt }
        .direccion { margin-top: -0.3cm;width: 15cm; height: 1.2cm; font-size: 14pt }
        .ciudad { width: 11cm; height: 1cm; font-size: 12pt }
        .nombre-conductor { width: 16cm; height: 1cm; font-size: 14pt }
        .cedula { width: 9cm; height: 1cm; font-size: 18pt }
        .empresa-transportadora { width: 9cm; height: 1cm; font-size: 14pt }
    /* Capa de texto envuelto (solo visible en impresión) */
    .empresa-transportadora .empresa-transportadora-wrap { display: none; }
        /* Capa de texto envuelto para DESTINO (oculta en pantalla) */
        .lugar-destino .destino-wrap { display: none; }
        .placa-cabezote { width: 9.5cm; height: 1cm; font-size: 16pt }
        .placa-tanque { width: 7.5cm; height: 1cm; font-size: 16pt }
        /* Ajuste para bajar el texto dentro de los cuadros */
        .empresa-transportadora input,
        .placa-cabezote input,
        .placa-tanque input {
            margin-top: 10px;
        }
        .lugar-origen input,
        .fecha-hora-salida input,
        .hora input {
            margin-top: 10px;
        }
        .lugar-origen { width: 9cm; height: 1cm; font-size: 14pt }
        .fecha-hora-salida { width: 12cm; height: 1cm;font-size: 14pt  }
        .hora { width: 2.8cm; height: 1cm; font-size: 14pt }
        .lugar-destino { width: 10cm; height: 1cm; font-size: 14pt }
        .horas-vigencia { width: 11cm; height: 1cm; font-size: 14pt }
        .descripcion-producto { width: 17cm; height: 3.9cm; padding: 25px; font-size: 18pt; padding-bottom: 60px; padding-top: 60px; }
        .volumen { width: cm; height: 4.2cm; padding: 18px; font-size: 18pt; }
        .volumen div { margin-bottom: 25px; }
        .volumen div:last-child { margin-bottom: 0; }
        .observaciones { position: relative;left: -40px; width: 26cm; height: 1.6cm; font-size: 18pt; position: relative;  }
        .zona-frontera { width: 3.7cm; height: 1cm; }
        .grupo-producto { display: flex; flex-direction: column; width: 100%; height: 100%; }
        .datos-producto { display: flex; justify-content: space-between; margin-top: 0.2cm; }
        .dato-producto { display: flex; flex-direction: column; align-items: center; width: 2.2cm; }
        .dato-producto input { width: 100%; border: none; text-align: center; }
    </style>
</head>
<body>
  </div> <div class="fila-acciones-agregar no-print">
    <button type="button" id="btnAbrirModalCliente" class="btn btn-outline-success">
        <i class="bi bi-person-plus-fill me-1"></i> Agregar Cliente
    </button>
    <button type="button" id="btnEditarCliente" class="btn btn-outline-primary">
        <i class="bi bi-pencil-square me-1"></i> Editar Cliente
    </button>
    <button type="button" id="btnAbrirModalConductor" class="btn btn-outline-success">
        <i class="bi bi-person-plus-fill me-1"></i> Agregar Conductor
    </button>
    <button type="button" id="btnAbrirModalEmpresa" class="btn btn-outline-success">
        <i class="bi bi-building-add me-1"></i> Agregar Empresa
    </button>
</div>
</div>
<div class="acciones no-print">
    <button onclick="window.history.back()" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Regresar
    </button>
    <button onclick="window.print()" class="btn btn-primary">
        <i class="bi bi-printer"></i> Imprimir Guía
    </button>
    <a id="boton-logout" href="{{ url_for('logout') }}" class="btn btn-danger">
        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
    </a>
</div>
<div id="contenedor-guia">
  <div class="hoja">
    <div class="fila">
      <div class="campo lugar-fecha sin-borde"><input id="fechaExpEDICION" readonly></div>
      <div class="campo planta-productor sin-borde"><input value="SOCIEDAD PORTUARIA DEL DIQUE" readonly></div>
      <div class="campo factura-remision sin-borde"><input id="facturaRemision" placeholder="FACTURA O REMISIÓN N°" value="{{ datos_guia.factura_remision }}"></div>
    </div>
    <div class="fila">
      <div class="campo despacho sin-borde">
        <select id="clienteSelect" onchange="autocompletarCliente()" class="sin-borde">
          <option value="">SELECCIONE UN CLIENTE</option>
          </select>
      </div>
      <div class="campo codigo-sicom sin-borde"><input placeholder="CÓDIGO SICOM"></div>
    </div>
    <div class="fila">
      <div class="campo direccion sin-borde"><textarea id="direccionCliente" placeholder="DIRECCIÓN"></textarea></div>
      <div class="campo ciudad sin-borde"><input id="ciudadCliente" placeholder="CIUDAD"></div>
    </div>
    <div class="fila pequeno">
      <div class="campo nombre-conductor sin-borde">
        <input id="conductorSelect" list="listaConductores" placeholder="NOMBRE DEL CONDUCTOR">
        <datalist id="listaConductores"></datalist>
      </div>
      <div class="campo cedula sin-borde">
        <input id="cedulaConductor" list="listaCedulas" placeholder="CÉDULA DEL CONDUCTOR">
        <datalist id="listaCedulas"></datalist>
      </div>
    </div>
    <div class="fila">
      <div class="campo empresa-transportadora sin-borde">
    <input id="empresaTransportadoraInput" list="listaEmpresas" placeholder="EMPRESA TRANSPORTADORA">
    <div class="empresa-transportadora-wrap" aria-hidden="true"></div>
    <datalist id="listaEmpresas"></datalist>
</div>
      <div class="campo placa-cabezote sin-borde"><input id="placaCabezote" placeholder="PLACA DEL CABEZOTE"></div>
    <div class="campo placa-tanque sin-borde"><input id="placaTanque" placeholder="PLACA DEL TANQUE"></div>
    </div>
    <div class="fila">
      <div class="campo lugar-origen sin-borde"><input value="SOCIEDAD PORTUARIA DEL DIQUE" readonly></div>
      <div class="campo fecha-hora-salida sin-borde"><input id="fechaHoraSalida" readonly></div>
      <div class="campo hora sin-borde"><input id="horaSalida"></div>
    </div>
    <div class="fila">
            <div class="campo lugar-destino sin-borde">
                <input id="destinoDireccion" placeholder="DESTINO">
                <div class="destino-wrap" aria-hidden="true"></div>
            </div>
      <div class="campo horas-vigencia sin-borde"><input placeholder="HORAS DE VIGENCIA"></div>
    </div>
    <div class="fila muy-pequeno">
      <div class="campo descripcion-producto sin-borde">
        <div class="grupo-producto">
          <select id="productoSelect" class="select-producto" onchange="mostrarProducto()"></select>
          <div class="datos-producto">
            <div class="dato-producto"><span>TEMP F</span><input id="tempF" class="sin-borde"></div>
            <div class="dato-producto"><span>API OBS</span><input id="apiObs" class="sin-borde"></div>
            <div class="dato-producto"><span>API CORR</span><input id="apiCorr" class="sin-borde"></div>
            <div class="dato-producto"><span>UN</span><input id="unidadProducto" class="sin-borde"></div>
          </div>
        </div>
      </div>
      <div class="campo volumen sin-borde">
        <div><label for="barriles" style="display:inline; font-weight:bold; font-size:12pt;">BBL NSV:</label> <input id="barriles" readonly style="width:3cm; border:none; display:inline; text-align:left;"></div>
        <div><label for="galones" style="display:inline; font-weight:bold; font-size:12pt;">GAL NETOS:</label> <input id="galones" oninput="convertirABarriles()" style="width:3cm; border:none; display:inline; text-align:left;"></div>  
      </div>
    </div>
    <div class="fila" style="position: relative;">
      <div class="campo observaciones">
        <div style="display:flex; flex-direction:column; height:100%; justify-content:space-between;">
            <textarea class="sin-borde" style="height: 70%; padding-top: 18px;"></textarea>
            <div style="margin-top:12px; display:flex; align-items:center; width:100%;">
                <strong style="margin-right:8px;">SELLOS:</strong>
                <input id="selloInput" type="text" style="flex:1; min-width:0; border:none; background:white; font-weight:bold; font-size:1.1em; text-align:left; outline:none; box-shadow:none; overflow:hidden; resize:none; -webkit-appearance:none; -moz-appearance:textfield; appearance:textfield;">
            </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="modalAgregarCliente" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Agregar Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formAgregarCliente">
            <div class="mb-3">
                <label for="nombreNuevoCliente" class="form-label">Nombre del Cliente</label>
                <input type="text" class="form-control" id="nombreNuevoCliente" required>
            </div>
            <div class="mb-3">
                <label for="direccionNuevoCliente" class="form-label">Dirección</label>
                <input type="text" class="form-control" id="direccionNuevoCliente" required>
            </div>
            <div class="mb-3">
                <label for="ciudadNuevoCliente" class="form-label">Ciudad y Departamento</label>
                <input type="text" class="form-control" id="ciudadNuevoCliente" required>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarCliente">Guardar Cliente</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modalEditarCliente" tabindex="-1" aria-labelledby="modalLabelEditarCliente" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabelEditarCliente">Editar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarCliente">
                        <input type="hidden" id="originalNombreCliente">
                        <div class="mb-3">
                                <label for="editarNombreCliente" class="form-label">Nombre del Cliente</label>
                                <input type="text" class="form-control" id="editarNombreCliente" required>
                        </div>
                        <div class="mb-3">
                                <label for="editarDireccionCliente" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="editarDireccionCliente" required>
                        </div>
                        <div class="mb-3">
                                <label for="editarCiudadCliente" class="form-label">Ciudad y Departamento</label>
                                <input type="text" class="form-control" id="editarCiudadCliente" required>
                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnActualizarCliente">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalAgregarConductor" tabindex="-1" aria-labelledby="modalLabelConductor" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabelConductor">Agregar Nuevo Conductor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formAgregarConductor">
              <div class="mb-3">
                  <label for="nombreNuevoConductor" class="form-label">Nombre del Conductor</label>
                  <input type="text" class="form-control" id="nombreNuevoConductor" required>
              </div>
              <div class="mb-3">
                  <label for="cedulaNuevoConductor" class="form-label">Cédula</label>
                  <input type="text" class="form-control" id="cedulaNuevoConductor" required>
              </div>
              <div class="mb-3">
                  <label for="placaNuevoConductor" class="form-label">Placa del Cabezote</label>
                  <input type="text" class="form-control" id="placaNuevoConductor" required>
              </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnGuardarConductor">Guardar Conductor</button>
        </div>
      </div>
    </div>
</div>
<div class="modal fade" id="modalAgregarEmpresa" tabindex="-1" aria-labelledby="modalLabelEmpresa" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabelEmpresa">Agregar Nueva Empresa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarEmpresa">
                    <div class="mb-3">
                        <label for="nombreNuevaEmpresa" class="form-label">Nombre de la Empresa Transportadora</label>
                        <input type="text" class="form-control" id="nombreNuevaEmpresa" name="nombre" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarEmpresa">Guardar Empresa</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let conductores = [], clientes = [], productos = [], empresas = [];

    // --- FUNCIONES DE CARGA Y ACTUALIZACIÓN ---

    async function cargarDatos() {
        console.log("Iniciando carga de datos...");

        const cargarJson = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.warn(`Advertencia: No se pudo cargar ${url}. Se usará una lista vacía.`);
                    return [];
                }
                return await response.json();
            } catch (error) {
                console.error(`Fallo crítico al cargar ${url}:`, error);
                return [];
            }
        };

        [conductores, clientes, productos, empresas] = await Promise.all([
            cargarJson("{{ url_for('static', filename='Conductores.json') }}"),
            cargarJson("{{ url_for('static', filename='Clientes.json') }}"),
            cargarJson("{{ url_for('static', filename='Producto.json') }}"),
            cargarJson("{{ url_for('static', filename='EmpresasTransportadoras.json') }}")
        ]);

        console.log("Datos cargados:", { conductores, clientes, productos, empresas });

        // Llenamos todos los dropdowns y datalists
        actualizarDropdownEmpresas();
        actualizarDropdownClientes();
        actualizarDropdownConductores();

        const prodSel = document.getElementById('productoSelect');
        prodSel.innerHTML = '';
        productos.forEach(p => prodSel.insertAdjacentHTML('beforeend', `<option value="${p.PRODUCTO}">${p.PRODUCTO}</option>`));

        configurarEventosConductores();
    }

    function actualizarDropdownClientes() {
        const cliSel = document.getElementById('clienteSelect');
        cliSel.innerHTML = '<option value="">SELECCIONE UN CLIENTE</option>';
        clientes.forEach(c => cliSel.insertAdjacentHTML('beforeend', `<option value="${c.NOMBRE_CLIENTE}">${c.NOMBRE_CLIENTE}</option>`));
        cliSel.insertAdjacentHTML('beforeend', '<option value="AGREGAR_CLIENTE" style="font-weight:bold; color: #007bff;">+ AGREGAR NUEVO CLIENTE</option>');
    }

    function actualizarDropdownConductores() {
        const dl = document.getElementById('listaConductores');
        const dc = document.getElementById('listaCedulas');
        dl.innerHTML = '';
        dc.innerHTML = '';
        conductores.forEach(c => {
            dl.insertAdjacentHTML('beforeend', `<option value="${c.CONDUCTOR}" data-cedula="${c.CEDULA}" data-placa="${c.PLACA}"></option>`);
            dc.insertAdjacentHTML('beforeend', `<option value="${c.CEDULA}" data-nombre="${c.CONDUCTOR}" data-placa="${c.PLACA}"></option>`);
        });
    }

    // Asegúrate de tener la función para empresas también
    function actualizarDropdownEmpresas() {
        const datalist = document.getElementById('listaEmpresas');
        if (datalist) {
            datalist.innerHTML = '';
            empresas.forEach(e => {
                datalist.insertAdjacentHTML('beforeend', `<option value="${e.NOMBRE_EMPRESA}"></option>`);
            });
        }
    }
    
    // --- LÓGICA PRINCIPAL AL CARGAR LA PÁGINA ---

    window.addEventListener('DOMContentLoaded', async () => {
    // 1. Cargar todos los datos iniciales
    await cargarDatos();

    // ▼▼▼ AÑADIR ESTE BLOQUE DE CÓDIGO COMPLETO ▼▼▼

    // Pasa los datos de Flask a una variable de JavaScript de forma segura.
    const datosGuia = {{ (datos_guia | default({})) | tojson | safe }};

    // Sincroniza el texto envuelto para impresión con el valor del input de empresa transportadora
    function syncEmpresaTransportadoraWrap(){
        const inp = document.getElementById('empresaTransportadoraInput');
        const wrap = document.querySelector('.empresa-transportadora .empresa-transportadora-wrap');
        if (inp && wrap){
            const txt = (inp.value || 'EMPRESA TRANSPORTADORA').toString();
            wrap.textContent = txt.toUpperCase();
        }
    }

    // Sincroniza el texto envuelto del DESTINO para impresión con el valor del input
    function syncDestinoWrap(){
        const inp = document.getElementById('destinoDireccion');
        const wrap = document.querySelector('.lugar-destino .destino-wrap');
        if (inp && wrap){
            const txt = (inp.value || 'DESTINO').toString();
            wrap.textContent = txt.toUpperCase();
        }
    }

if (Object.keys(datosGuia).length > 1) { 
    console.log("Rellenando guía con datos recibidos:", datosGuia);

    // --- Rellenar campos de texto y selects ---
    document.getElementById('empresaTransportadoraInput').value = datosGuia.transportadora || '';
    syncEmpresaTransportadoraWrap();
    document.getElementById('placaCabezote').value = datosGuia.placa || '';
    // Mapear columna 'TANQUE' desde programación a 'PLACA DEL TANQUE' (acepta variantes de nombre)
    document.getElementById('placaTanque').value = (
        datosGuia.TANQUE || datosGuia.tanque || datosGuia.PLACA_TANQUE || datosGuia.placa_tanque || ''
    ).toString();
    document.getElementById('conductorSelect').value = datosGuia.conductor || '';
    document.getElementById('cedulaConductor').value = datosGuia.cedula || '';
    document.getElementById('destinoDireccion').value = datosGuia.destino || '';
    syncDestinoWrap();
    document.getElementById('galones').value = datosGuia.galones || '';
    document.getElementById('selloInput').value = datosGuia.precintos || '';
    // Factura/Remisión desde Programación de Cargue
    document.getElementById('facturaRemision').value = datosGuia.factura_remision || '';

    // --- Cliente y Dirección ---
    const clienteSelect = document.getElementById('clienteSelect');
    if (datosGuia.cliente) {
        clienteSelect.value = datosGuia.cliente;
        // Disparamos el evento 'change' para que se ejecute la función que autocompleta la dirección.
        clienteSelect.dispatchEvent(new Event('change')); 
    }

    // --- Producto, Temperatura y APIs ---
    const productoSelect = document.getElementById('productoSelect');
    if (datosGuia.producto) {
        productoSelect.value = datosGuia.producto;
        // Disparamos el evento para que cargue los datos por defecto del producto (Temp, API, etc.)
        productoSelect.dispatchEvent(new Event('change'));
    }

    // Ahora, sobrescribimos los datos por defecto con los valores REALES de la programación.
    document.getElementById('tempF').value = datosGuia.temperatura || document.getElementById('tempF').value;
    document.getElementById('apiObs').value = datosGuia.api_obs || document.getElementById('apiObs').value;
    document.getElementById('apiCorr').value = datosGuia.api_corregido || document.getElementById('apiCorr').value;
    
    // Si se rellenaron los galones, disparamos la conversión a barriles.
    if (document.getElementById('galones').value) {
         convertirABarriles();
    }
}

    // 2. Definir todas las variables de los modales en un solo lugar
    const modalElCliente = document.getElementById('modalAgregarCliente');
    const modalCliente = new bootstrap.Modal(modalElCliente);
    const modalElEditarCliente = document.getElementById('modalEditarCliente');
    const modalEditarCliente = modalElEditarCliente ? new bootstrap.Modal(modalElEditarCliente) : null;
    
    const modalElConductor = document.getElementById('modalAgregarConductor');
    const modalConductor = new bootstrap.Modal(modalElConductor);

    const modalElEmpresa = document.getElementById('modalAgregarEmpresa');
    const modalEmpresa = new bootstrap.Modal(modalElEmpresa);

    // 3. Configurar todos los eventos
    
    // Eventos para CLIENTE
    document.getElementById('btnAbrirModalCliente').addEventListener('click', () => {
        document.getElementById('formAgregarCliente').reset();
        modalCliente.show();
    });
    const btnEditarCliente = document.getElementById('btnEditarCliente');
    if (btnEditarCliente && modalEditarCliente) {
        btnEditarCliente.addEventListener('click', () => {
            const select = document.getElementById('clienteSelect');
            const seleccionado = (select.value || '').trim();
            if (!seleccionado || seleccionado === 'AGREGAR_CLIENTE') {
                Swal.fire({ icon: 'info', title: 'Selecciona un cliente', text: 'Elige un cliente de la lista para poder editarlo.' });
                return;
            }
            const clienteActual = clientes.find(c => (c.NOMBRE_CLIENTE || '').toUpperCase() === seleccionado.toUpperCase());
            if (!clienteActual) {
                Swal.fire({ icon: 'error', title: 'Cliente no encontrado', text: 'No pudimos cargar los datos de ese cliente. Actualiza la página e inténtalo de nuevo.' });
                return;
            }
            document.getElementById('originalNombreCliente').value = clienteActual.NOMBRE_CLIENTE || '';
            document.getElementById('editarNombreCliente').value = clienteActual.NOMBRE_CLIENTE || '';
            document.getElementById('editarDireccionCliente').value = clienteActual.DIRECCION || '';
            document.getElementById('editarCiudadCliente').value = clienteActual.CIUDAD_DEPARTAMENTO || '';
            modalEditarCliente.show();
        });
    }
    document.getElementById('clienteSelect').addEventListener('change', function() {
        if (this.value === 'AGREGAR_CLIENTE') {
            document.getElementById('formAgregarCliente').reset();
            modalCliente.show();
            this.value = "";
        }
    });
    document.getElementById('btnGuardarCliente').addEventListener('click', async () => {
        const nombre = document.getElementById('nombreNuevoCliente').value.trim();
        const direccion = document.getElementById('direccionNuevoCliente').value.trim();
        const ciudad = document.getElementById('ciudadNuevoCliente').value.trim();
        if (!nombre || !direccion || !ciudad) return Swal.fire({icon: 'warning', title: 'Campos Vacíos', text: 'Por favor, complete todos los campos.'});
        
        try {
            const response = await fetch("{{ url_for('agregar_cliente_ajax') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre, direccion, ciudad }) });
            const result = await response.json();
            if (response.ok) {
                clientes = await (await fetch("{{ url_for('static', filename='Clientes.json') }}?v=" + Date.now())).json();
                actualizarDropdownClientes();
                document.getElementById('clienteSelect').value = result.nuevo_cliente.NOMBRE_CLIENTE;
                document.getElementById('clienteSelect').dispatchEvent(new Event('change'));
                modalCliente.hide();
                Swal.fire({ icon: 'success', title: '¡Guardado!', text: `El cliente '${result.nuevo_cliente.NOMBRE_CLIENTE}' se agregó con éxito.`, timer: 2500, showConfirmButton: false });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.message });
            }
        } catch (error) { Swal.fire({ icon: 'error', title: 'Error de Conexión', text: 'No se pudo comunicar con el servidor.'}); }
    });
    const btnActualizarCliente = document.getElementById('btnActualizarCliente');
    if (btnActualizarCliente && modalEditarCliente) {
        btnActualizarCliente.addEventListener('click', async () => {
            const original = document.getElementById('originalNombreCliente').value.trim();
            const nombre = document.getElementById('editarNombreCliente').value.trim();
            const direccion = document.getElementById('editarDireccionCliente').value.trim();
            const ciudad = document.getElementById('editarCiudadCliente').value.trim();
            if (!original || !nombre || !direccion || !ciudad) {
                Swal.fire({ icon: 'warning', title: 'Campos Vacíos', text: 'Completa todos los campos antes de guardar.' });
                return;
            }
            try {
                const response = await fetch("{{ url_for('actualizar_cliente_ajax') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ original_nombre: original, nombre, direccion, ciudad })
                });
                const result = await response.json();
                if (response.ok) {
                    clientes = await (await fetch("{{ url_for('static', filename='Clientes.json') }}?v=" + Date.now())).json();
                    actualizarDropdownClientes();
                    const select = document.getElementById('clienteSelect');
                    select.value = result.cliente.NOMBRE_CLIENTE;
                    select.dispatchEvent(new Event('change'));
                    modalEditarCliente.hide();
                    Swal.fire({ icon: 'success', title: '¡Actualizado!', text: result.message, timer: 2500, showConfirmButton: false });
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: result.message || 'No se pudo actualizar el cliente.' });
                }
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'Error de Conexión', text: 'No se pudo comunicar con el servidor.' });
            }
        });
    }

    // Eventos para CONDUCTOR
    document.getElementById('btnAbrirModalConductor').addEventListener('click', () => {
        document.getElementById('formAgregarConductor').reset();
        modalConductor.show();
    });
    document.getElementById('btnGuardarConductor').addEventListener('click', async () => {
        const nombre = document.getElementById('nombreNuevoConductor').value.trim();
        const cedula = document.getElementById('cedulaNuevoConductor').value.trim();
        const placa = document.getElementById('placaNuevoConductor').value.trim();
        if (!nombre || !cedula || !placa) return Swal.fire({icon: 'warning', title: 'Campos Vacíos', text: 'Por favor, complete todos los campos.'});
        
        try {
            const response = await fetch("{{ url_for('agregar_conductor_ajax') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre, cedula, placa }) });
            const result = await response.json();
            if (response.ok) {
                conductores = await (await fetch("{{ url_for('static', filename='Conductores.json') }}?v=" + Date.now())).json();
                actualizarDropdownConductores();
                document.getElementById('conductorSelect').value = result.nuevo_conductor.CONDUCTOR;
                document.getElementById('conductorSelect').dispatchEvent(new Event('change'));
                modalConductor.hide();
                Swal.fire({ icon: 'success', title: '¡Guardado!', text: `El conductor '${result.nuevo_conductor.CONDUCTOR}' se agregó con éxito.`, timer: 2500, showConfirmButton: false });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.message });
            }
        } catch (error) { Swal.fire({ icon: 'error', title: 'Error de Conexión', text: 'No se pudo comunicar con el servidor.'}); }
    });

    // Eventos para EMPRESA
    document.getElementById('btnAbrirModalEmpresa').addEventListener('click', () => {
        document.getElementById('formAgregarEmpresa').reset();
        modalEmpresa.show();
    });
    document.getElementById('btnGuardarEmpresa').addEventListener('click', async () => {
        const nombre = document.getElementById('nombreNuevaEmpresa').value.trim();
        if (!nombre) return Swal.fire({icon: 'warning', title: 'Campo Vacío', text: 'Por favor, ingrese el nombre de la empresa.'});
        
        try {
            const response = await fetch("{{ url_for('agregar_empresa_ajax') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre }) });
            const result = await response.json();
            if (response.ok) {
                empresas = await (await fetch("{{ url_for('static', filename='EmpresasTransportadoras.json') }}?v=" + Date.now())).json();
                actualizarDropdownEmpresas();
                document.getElementById('empresaTransportadoraInput').value = result.nueva_empresa.NOMBRE_EMPRESA;
                syncEmpresaTransportadoraWrap();
                modalEmpresa.hide();
                Swal.fire({ icon: 'success', title: '¡Guardado!', text: `La empresa '${result.nueva_empresa.NOMBRE_EMPRESA}' se agregó con éxito.`, timer: 2500, showConfirmButton: false });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.message });
            }
        } catch (error) { Swal.fire({ icon: 'error', title: 'Error de Conexión', text: 'No se pudo comunicar con el servidor.'}); }
    });

    // Actualiza el wrap al editar manualmente el campo
    const empresaInput = document.getElementById('empresaTransportadoraInput');
    if (empresaInput){
        empresaInput.addEventListener('input', syncEmpresaTransportadoraWrap);
        empresaInput.addEventListener('change', syncEmpresaTransportadoraWrap);
    }

    // Asegurar sincronización antes de imprimir
    window.addEventListener('beforeprint', () => { syncEmpresaTransportadoraWrap(); syncDestinoWrap(); });

    // Actualiza el wrap de DESTINO al editar manualmente
    const destinoInput = document.getElementById('destinoDireccion');
    if (destinoInput){
        destinoInput.addEventListener('input', syncDestinoWrap);
        destinoInput.addEventListener('change', syncDestinoWrap);
    }

     const now = new Date();
    const dOpt = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        timeZone: 'America/Bogota'
    };
    const fechaActual = now.toLocaleDateString('es-CO', dOpt).toUpperCase();
    
    const fechaInput = document.getElementById('fechaExpEDICION');
    if (fechaInput) {
        fechaInput.value = `CARTAGENA, ${fechaActual}`;
    }

    // Lógica para actualizar la hora de salida automáticamente
    actualizarHoraAutomaticamente(); // Llama a la función una vez al inicio
    setInterval(actualizarHoraAutomaticamente, 60000); // Y la actualiza cada minuto

    // Configurar campo Sellos (formato y límite)
    configurarCampoSellos();

});
    function configurarEventosConductores() {
        const conductorInput = document.getElementById('conductorSelect');
        const cedulaInput = document.getElementById('cedulaConductor');
        const placaInput = document.getElementById('placaCabezote');
        conductorInput.addEventListener('change', function() {
            const selectedOption = document.querySelector(`#listaConductores option[value="${this.value}"]`);
            if (selectedOption) {
                cedulaInput.value = selectedOption.getAttribute('data-cedula') || '';
                placaInput.value = selectedOption.getAttribute('data-placa') || '';
            }
        });
        cedulaInput.addEventListener('change', function() {
            const selectedOption = document.querySelector(`#listaCedulas option[value="${this.value}"]`);
            if (selectedOption) {
                conductorInput.value = selectedOption.getAttribute('data-nombre') || '';
                placaInput.value = selectedOption.getAttribute('data-placa') || '';
            }
        });
    }

    function autocompletarCliente(){
        if(document.getElementById('clienteSelect').value === 'AGREGAR_CLIENTE') return;
        const nom = document.getElementById('clienteSelect').value;
        const cli = clientes.find(c=>c.NOMBRE_CLIENTE===nom);
        document.getElementById('direccionCliente').value = cli ? cli.DIRECCION : '';
        document.getElementById('ciudadCliente').value = cli ? cli.CIUDAD_DEPARTAMENTO : '';
        // Ahora el destino muestra la misma información que CIUDAD
        document.getElementById('destinoDireccion').value = cli ? cli.CIUDAD_DEPARTAMENTO : '';
        // Actualiza la capa impresa del DESTINO cuando proviene del autocompletado
        if (typeof syncDestinoWrap === 'function') {
            syncDestinoWrap();
        }
    }

    function mostrarProducto(){
        const nom=document.getElementById('productoSelect').value;
        const p=productos.find(x=>x.PRODUCTO===nom);
        if(p){
            document.getElementById('tempF').value=p.TempF;
            document.getElementById('apiObs').value=p.API_Obs;
            document.getElementById('apiCorr').value=p.API_Cor;
            document.getElementById('unidadProducto').value=p.UN;
        }
    }

    function convertirABarriles(){
        const gal=parseFloat(document.getElementById('galones').value.replace(/,/g, '.'));
        if(!isNaN(gal)){
            document.getElementById('barriles').value=(gal/42).toFixed(2).replace('.', ',');
        }
    }

    function descargarPDF(){
        const hoy=new Date().toISOString().slice(0,10);
        html2pdf().set({
            margin:[1.5,1,1,1],
            filename:`Guia-${hoy}.pdf`,
            html2canvas:{ scale:2, width:2570, height:1650, useCORS:true },
            jsPDF:{ unit:'mm', format:'a4', orientation:'landscape' }
        }).from(document.getElementById('contenedor-guia')).save();
    }

    function actualizarHoraAutomaticamente() {
        const ahora = new Date();
        const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Bogota' };
        const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'America/Bogota' };
        const fechaTexto = ahora.toLocaleDateString('es-CO', opcionesFecha).toUpperCase();
        const horaTexto = ahora.toLocaleTimeString('es-CO', opcionesHora).toUpperCase();
        document.getElementById('fechaHoraSalida').value = fechaTexto;
        document.getElementById('horaSalida').value = horaTexto;
    }

    // Configura el input de sellos: solo dígitos, máximo 100 y guiones cada 6 dígitos
    function configurarCampoSellos(){
        const selloInput = document.getElementById('selloInput');
        if (!selloInput) return;

        const formatear = (raw) => {
            // Solo dígitos y máximo 100
            let valor = (raw || '').replace(/[^\d]/g, '').substring(0, 100);
            // Guión cada 6 dígitos
            let out = '';
            for (let i = 0; i < valor.length; i++) {
                if (i > 0 && i % 6 === 0) out += '-';
                out += valor[i];
            }
            return out;
        };

        selloInput.addEventListener('input', function(){
            this.value = formatear(this.value);
        });
        selloInput.addEventListener('paste', function(e){
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, formatear(text));
        });
    }
</script>
</body>
</html>
