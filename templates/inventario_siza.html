{% extends "base.html" %}

{% block title %}Inventario SIZA{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Control de Inventario SIZA</h2>
        <div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalRegistrarEntrada">
                <i class="fas fa-plus-circle me-2"></i>Registrar Nueva Planilla (Entrada)
            </button>
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRegistrarConsumo">
                <i class="fas fa-minus-circle me-2"></i>Registrar Consumo (Salida)
            </button>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">Resumen de Inventario Actual</h4>
        </div>
        <div class="card-body">
            <table class="table table-sm table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Tanque (TK)</th>
                        <th>Producto</th>
                        <th>Total Disponible (BLS)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tk, data in inventario_totalizado.items() %}
                    <tr>
                        <td><strong>{{ tk }}</strong></td>
                        <td>{{ data.producto }}</td>
                        <td>{{ "%.2f"|format(data.total_bls) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center">No hay inventario registrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Inventario Desglosado por Planilla (Lote)</h4>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Fecha Recepción</th>
                        <th>Fuente / Planilla</th>
                        <th>Tanque (TK)</th>
                        <th>Producto</th>
                        <th>API</th>
                        <th>BSW</th>
                        <th>BLS Iniciales</th>
                        <th>BLS Actuales</th>
                        <th>% Restante</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lote in inventario_desglosado %}
                    <tr>
                        <td>{{ lote.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ lote.fuente_planilla }}</td>
                        <td>{{ lote.tk }}</td>
                        <td>{{ lote.producto }}</td>
                        <td>{{ lote.api | default('', true) }}</td>
                        <td>{{ lote.bsw | default('', true) }}</td>
                        <td><strong>{{ "%.2f"|format(lote.bls_iniciales) }}</strong></td>
                        <td class="table-success">{{ "%.2f"|format(lote.bls_actuales) }}</td>
                        <td>
                            {% if lote.bls_iniciales > 0 %}
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: {{ (lote.bls_actuales / lote.bls_iniciales) * 100 }}%;" aria-valuenow="{{ lote.bls_actuales }}" aria-valuemin="0" aria-valuemax="{{ lote.bls_iniciales }}">
                                    {{ "%.1f"|format((lote.bls_actuales / lote.bls_iniciales) * 100) }}%
                                </div>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center fst-italic">No hay lotes de inventario activos.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRegistrarEntrada" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Nueva Planilla (Entrada)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEntrada">
                    <div class="mb-3">
                        <label for="fuente_planilla" class="form-label">Nombre o ID de la Planilla</label>
                        <input type="text" class="form-control" id="fuente_planilla" placeholder="Ej: Planilla SIZA 2025-06-26" required>
                    </div>
                    <hr>
                    <h6>Detalles de los Tanques</h6>
                    <div id="entradas-container">
                        </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="agregarFilaEntrada()">+ Agregar Tanque</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarFormularioEntrada()">Guardar Entrada</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRegistrarConsumo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Consumo (Salida)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formConsumo">
                    <div class="mb-3">
                        <label for="consumo_tk" class="form-label">Consumir del Tanque:</label>
                        <select class="form-select" id="consumo_tk" required>
                            <option value="">Seleccione un tanque...</option>
                            {% for tk in inventario_totalizado.keys() %}
                            <option value="{{ tk }}">{{ tk }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="consumo_bls" class="form-label">Cantidad a Consumir (BLS)</label>
                        <input type="number" step="0.01" class="form-control" id="consumo_bls" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="enviarFormularioConsumo()">Confirmar Consumo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let filaIndex = 0;

    function agregarFilaEntrada() {
        filaIndex++;
        const container = document.getElementById('entradas-container');
        const newRow = document.createElement('div');
        newRow.className = 'row mb-2 align-items-center';
        newRow.id = `fila-entrada-${filaIndex}`;
        newRow.innerHTML = `
            <div class="col-md-2"><input type="text" class="form-control" name="tk" placeholder="TK-XXX" required></div>
            <div class="col-md-3"><input type="number" step="0.01" class="form-control" name="bls" placeholder="BLS" required></div>
            <div class="col-md-3"><input type="number" step="0.01" class="form-control" name="api" placeholder="API"></div>
            <div class="col-md-3"><input type="number" step="0.01" class="form-control" name="bsw" placeholder="BSW"></div>
            <div class="col-md-1"><button type="button" class="btn btn-sm btn-outline-danger" onclick="document.getElementById('fila-entrada-${filaIndex}').remove()">X</button></div>
        `;
        container.appendChild(newRow);
    }

    async function enviarFormularioEntrada() {
        const fuente = document.getElementById('fuente_planilla').value;
        if (!fuente) {
            alert('Por favor, ingrese el nombre de la planilla.');
            return;
        }

        const entradas = [];
        const rows = document.querySelectorAll('#entradas-container .row');
        rows.forEach(row => {
            const tk = row.querySelector('input[name="tk"]').value;
            const bls = row.querySelector('input[name="bls"]').value;
            if (tk && bls) {
                entradas.push({
                    tk: tk,
                    bls: bls,
                    api: row.querySelector('input[name="api"]').value,
                    bsw: row.querySelector('input[name="bsw"]').value
                });
            }
        });

        if (entradas.length === 0) {
            alert('Debe agregar al menos un tanque con volumen.');
            return;
        }

        try {
            const response = await fetch('/siza/registrar_entrada', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fuente_planilla: fuente, entradas: entradas })
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error de conexión con el servidor.');
        }
    }
    
    async function enviarFormularioConsumo() {
        const tk = document.getElementById('consumo_tk').value;
        const bls = document.getElementById('consumo_bls').value;

        if (!tk || !bls || parseFloat(bls) <= 0) {
            alert('Por favor, seleccione un tanque y una cantidad válida.');
            return;
        }

        if (!confirm(`¿Está seguro de que desea consumir ${bls} BLS del tanque ${tk}? Esta acción no se puede deshacer.`)) {
            return;
        }

        try {
            const response = await fetch('/siza/registrar_consumo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tk: tk, bls: bls })
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error de conexión con el servidor.');
        }
    }

    // Agregar una fila inicial al cargar el modal de entrada
    document.getElementById('modalRegistrarEntrada').addEventListener('shown.bs.modal', () => {
        if (document.getElementById('entradas-container').children.length === 0) {
            agregarFilaEntrada();
        }
    });

</script>
{% endblock %}