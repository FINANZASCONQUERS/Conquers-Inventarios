<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Reporte Comparativo KERO</title>
<style>
@page { size:A4 landscape; margin:14mm 14mm 16mm 14mm; }
body { font-family:'Segoe UI', Arial, sans-serif; font-size:12px; color:#25313e; background:#f5f7fa; }
body { color:#2d3436; }
h1 { font-size:20px; margin:0; color:#1b4f72; }
.header { text-align:center; margin-bottom:6px; }
.brand { display:flex; flex-direction:column; align-items:center; gap:4px; }
.brand img { height:60px; }
.badge-meta { background:#0b8552; color:#fff; padding:8px 14px; border-radius:8px; font-size:11px; font-weight:600; }
.layout { border:1px solid #e0e6ec; background:#fff; border-radius:10px; padding:14px 18px 10px; }
.section-title { font-size:15px; margin:14px 0 6px; color:#1b4f72; text-align:center; }
.table-wrapper table { width:100%; border-collapse:collapse; }
table { border-collapse:collapse; width:100%; }
th, td { padding:5px 6px; border-bottom:1px solid #ecf0f1; font-size:11px; }
th { background:#f4f7fb; color:#1b4f72; text-transform:uppercase; letter-spacing:.5px; }
td.num { text-align:right; font-variant-numeric:tabular-nums; }
.delta-pos { color:#0b8552; font-weight:600; }
.delta-neg { color:#c0392b; font-weight:600; }
.pair-card { background:#ffffff; border:1px solid #d2d9df; border-left:5px solid #1b4f72; border-radius:10px; padding:0 0 10px 0; margin-bottom:14px; box-shadow:0 1px 2px #00000008,0 3px 6px -3px #00000012; page-break-inside:avoid; }
.pair-head { background:linear-gradient(90deg,#f3f7fa,#ffffff); padding:10px 14px 6px; border-bottom:1px solid #e5ebef; display:flex; justify-content:space-between; align-items:flex-end; }
.pair-head h3 { margin:0; font-size:14px; letter-spacing:.5px; font-weight:600; color:#1b4f72; }
.meta { font-size:10px; color:#4d6575; }
.prod-table { width:100%; }
.prod-table th, .prod-table td { padding:4px 5px; font-size:10px; }
.tiny { font-size:9px; color:#6c7a89; }
.watermark { position:fixed; top:40%; left:18%; font-size:120px; color:#1b4f7215; transform:rotate(-25deg); }
.summary-grid { display:flex; flex-wrap:wrap; gap:10px; }
.metric-box { flex:1 1 180px; background:#ffffff; border:1px solid #e2e7ec; border-radius:8px; padding:8px 10px; }
.metric-box span { display:block; font-size:10px; color:#6c7a89; text-transform:uppercase; letter-spacing:.5px; }
.metric-box b { font-size:13px; color:#193b55; }
.footer { margin-top:8px; font-size:10px; color:#8d99a6; text-align:right; }
</style>
</head>
<body>
<div class="watermark">CONQUERS</div>
<div class="header">
  <div class="brand">
    {% if logo_base64 %}
      <img src="data:image/jpeg;base64,{{ logo_base64 }}" alt="Logo" />
    {% else %}
      <div style="font-size:22px;font-weight:700;color:#1b4f72;">LOGO</div>
    {% endif %}
    <h1>Comparativo KERO (Con vs Sin)</h1>
    <div class="meta">Generado: {{ fecha_generacion }}</div>
    <div class="tiny">Para cada crudo se muestran rendimientos y propiedades. Deltas = (Con - Sin).</div>
  </div>
</div>
<div class="layout">
  <h2 class="section-title" style="margin-top:0;">Resumen Global</h2>
  <div class="summary-grid">
    {% for s in resumen_global %}
    <div class="metric-box">
      <span>{{ s.nombre }}</span>
      <b>{{ s.valor }}</b>
      {% if s.nota %}<div class="tiny" style="margin-top:4px;">{{ s.nota }}</div>{% endif %}
    </div>
    {% endfor %}
  </div>
</div>
<div style="page-break-before:always;"></div>
<h2 class="section-title">Detalle por Crudo</h2>
{% for base_name, pair in comparativos.items() %}
<div class="pair-card">
  <div class="pair-head">
    <h3>{{ base_name }}</h3>
    <div class="meta">Productos: {{ pair.order|join(', ') }}</div>
  </div>
  <div style="padding:8px 14px 0;">
    <table class="prod-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>% Con</th>
          <th>% Sin</th>
          <th>Δ %</th>
          <th>API Con</th>
          <th>API Sin</th>
          <th>Δ API</th>
          <th>%S Con</th>
          <th>%S Sin</th>
          <th>Δ %S</th>
        </tr>
      </thead>
      <tbody>
      {% for prod in pair.order %}
        {% set con = pair.con.yields_pct.get(prod,0) if pair.con else 0 %}
        {% set sin = pair.sin.yields_pct.get(prod,0) if pair.sin else 0 %}
        {% set d_pct = con - sin %}
        {% set api_con = pair.con.api_by_product.get(prod,0) if pair.con else 0 %}
        {% set api_sin = pair.sin.api_by_product.get(prod,0) if pair.sin else 0 %}
        {% set d_api = api_con - api_sin %}
        {% set s_con = pair.con.sulfur_by_product.get(prod,0) if pair.con else 0 %}
        {% set s_sin = pair.sin.sulfur_by_product.get(prod,0) if pair.sin else 0 %}
        {% set d_s = s_con - s_sin %}
        <tr>
          <td>{{ prod }}</td>
          <td class="num">{{ '%.2f'|format(con) }}</td>
          <td class="num">{{ '%.2f'|format(sin) }}</td>
          <td class="num {% if d_pct>0 %}delta-pos{% elif d_pct<0 %}delta-neg{% endif %}">{{ '%.2f'|format(d_pct) }}</td>
          <td class="num">{{ '%.2f'|format(api_con) }}</td>
          <td class="num">{{ '%.2f'|format(api_sin) }}</td>
          <td class="num {% if d_api>0 %}delta-pos{% elif d_api<0 %}delta-neg{% endif %}">{{ '%.2f'|format(d_api) }}</td>
          <td class="num">{{ '%.4f'|format(s_con) }}</td>
          <td class="num">{{ '%.4f'|format(s_sin) }}</td>
          <td class="num {% if d_s>0 %}delta-pos{% elif d_s<0 %}delta-neg{% endif %}">{{ '%.4f'|format(d_s) }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div class="tiny" style="margin-top:6px;">Δ calculado como (Con - Sin). Valores faltantes se tratan como 0.</div>
  </div>
</div>
{% endfor %}
<div class="footer">Comparativo KERO - Generado {{ fecha_generacion }}</div>
</body>
</html>