{% extends "base.html" %}

{% block title %}Planilla de Planta{% endblock %}

{% block navbar_brand_text %}Planilla de Planta{% endblock %}

{% block main_style %}
    /* Estilo para el fondo del área principal (<main>) */
    background-color: #f4f7f9; /* Un fondo más limpio y profesional */
    font-family: 'Poppins', sans-serif; /* Aplicando una fuente moderna */
{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<div class="container-xl my-4">

    <div class="page-header-container mb-4">
        <div class="row g-3 align-items-center justify-content-between">
            <div class="col-12 col-lg-6 d-flex align-items-center gap-3 mb-2 mb-lg-0">
                <i class="bi bi-clipboard-data-fill page-title-icon"></i>
                <h1 class="page-title-text h3 mb-0">Planilla de Inventario de Planta</h1>
            </div>
            <div class="col-12 col-lg-6">
                <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                    <a href="{{ url_for('reporte_planta') }}" class="btn btn-outline-secondary d-flex align-items-center">
                        <i class="bi bi-file-earmark-bar-graph-fill me-1"></i> Ver Reporte
                    </a>
                    <a href="{{ url_for('reporte_variaciones_tanques') }}" class="btn btn-outline-primary d-flex align-items-center">
                        <i class="bi bi-graph-up-arrow me-1"></i> Variación por Tanque
                    </a>
                    <button id="btnGuardarRegistro" onclick="guardarRegistro()" class="btn btn-success d-flex align-items-center">
                        <i class="bi bi-save2-fill me-1"></i> Guardar Registro
                    </button>
                </div>
            </div>
            <div class="col-12">
                <div class="d-flex align-items-center gap-3 small text-muted mt-1">
                    <span class="legend-dot" style="--dot-color:#198754"></span> Días con registro
                    <span class="legend-dot" style="--dot-color:#adb5bd"></span> Días sin registro
                </div>
            </div>
        </div>
    </div>

    <form method="GET" action="{{ url_for('planta') }}" class="mb-4">
        <div class="row g-3 align-items-end bg-white border rounded-3 shadow-sm p-3 mx-0">
            <div class="col-12 col-md-5">
                <label for="fecha_filtro" class="form-label fw-bold text-muted">Ver inventario del día:</label>
                <input type="text" class="form-control" id="fecha_filtro" name="fecha" value="{{ fecha_seleccionada or '' }}" placeholder="YYYY-MM-DD" data-fechas='{{ (fechas_con_registro or [])|tojson|safe }}'>
            </div>
            <div class="col-12 col-md-auto d-flex gap-2">
                <button type="submit" class="btn btn-primary d-flex align-items-center">
                    <i class="bi bi-funnel-fill me-1"></i> Filtrar
                </button>
                <a href="{{ url_for('planta') }}" class="btn btn-outline-secondary d-flex align-items-center">
                    <i class="bi bi-arrow-clockwise me-1"></i> Ver Estado Actual
                </a>
            </div>
            {% if fecha_seleccionada and today_iso and fecha_seleccionada != today_iso %}
            <div class="col-12 col-md-auto ms-auto">
                <div class="badge bg-primary bg-opacity-10 text-primary p-2">
                    <i class="bi bi-calendar-check me-1"></i> Mostrando datos del: {{ fecha_seleccionada }}
                </div>
            </div>
            {% endif %}
        </div>
    </form>
                </div>
            </div>
        </div>
    </form>

    <div id="time-limit-alert-container" class="mb-3"></div>

    <div id="alert-container"></div>
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead class="sticky-top">
                        <tr>
                            <th style="min-width: 100px;">TK</th>
                            <th style="min-width: 150px;">PRODUCTO</th>
                            <th style="min-width: 120px;">MAX. CAP</th>
                            <th style="min-width: 120px;">BLS @60</th>
                            <th style="min-width: 110px;">TON</th>
                            <th style="min-width: 100px;">API</th>
                            <th style="min-width: 100px;">%BSW</th>
                            <th style="min-width: 100px;">%S</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in planilla %}
                        <tr data-tk="{{ fila.TK }}">
                            <td class="fw-bold">{{ fila.TK }}</td>
                            <td data-field="PRODUCTO">{{ fila.PRODUCTO }}</td>
                            <td data-field="MAX_CAP">{{ fila.MAX_CAP }}</td>
                            <td contenteditable="true" class="editable" data-field="BLS_60" inputmode="decimal" title="BLS @60; Las toneladas se calculan con API o factores de referencia.">{{ fila.BLS_60 }}</td>
                            <td class="ton-col text-muted" title="Ton calculadas automáticamente">—</td>
                            <td contenteditable="true" class="editable" data-field="API" inputmode="decimal">{{ fila.API }}</td>
                            <td contenteditable="true" class="editable" data-field="BSW" inputmode="decimal">{{ fila.BSW }}</td>
                            <td contenteditable="true" class="editable" data-field="S" inputmode="decimal">{{ fila.S }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    /* ----------------------------------------- */
    /* --- ESTILOS GENERALES Y DE LAYOUT --- */
    /* ----------------------------------------- */

    .page-title-icon {
        font-size: 1.75rem;
        color: #0b8552; /* Verde institucional */
        margin-right: 0.75rem;
    }

    .page-title-text {
        color: #343a40;
        font-weight: 600;
    }

    .action-buttons-bar .btn-lg {
        font-size: 0.95rem;
        padding: 0.6rem 1.25rem;
        font-weight: 500;
    }

    #alert-container {
        position: fixed;
        top: calc(4.5rem + 20px);
        right: 20px;
        z-index: 1055; /* Encima de otros elementos */
        width: auto;
        max-width: 400px;
    }
    

    /* ----------------------------------------- */
    /* --- ESTILOS DEL FILTRO MEJORADO --- */
    /* ----------------------------------------- */
    
    .card.filter-card {
        border-radius: 0.5rem;
        background-color: #f8fafc;
        border: 1px solid rgba(11, 133, 82, 0.1);
    }

    .form-floating .form-control {
        height: calc(3rem + 2px);
        min-height: auto;
        padding: 1rem 1.25rem;
        border-radius: 0.375rem;
        box-shadow: none;
        transition: all 0.2s ease;
    }

    .form-floating .form-control:focus {
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(11, 133, 82, 0.15);
        border-color: rgba(11, 133, 82, 0.4);
    }

    .form-floating label {
        font-size: 0.85rem;
        padding: 0.75rem 1.25rem;
        color: #6c757d;
    }

    .form-floating>.form-control:focus~label, 
    .form-floating>.form-control:not(:placeholder-shown)~label {
        transform: scale(0.85) translateY(-0.8rem) translateX(0.15rem);
        background-color: #f8fafc;
        padding: 0 0.5rem;
        color: #0b8552;
    }

    .badge.bg-primary-opacity {
        background-color: rgba(11, 133, 82, 0.1);
        color: #0b8552;
    }

    /* ----------------------------------------- */
    /* --- ESTILOS DE LA TABLA --- */
    /* ----------------------------------------- */

    .table-responsive thead.sticky-top th {
        position: sticky;
        top: 0;
        z-index: 2; /* Debe estar por encima del contenido de la tabla */
        background-color: #f8f9fa; /* Un fondo de cabecera más claro */
        color: #495057;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
    }

    .table th, .table td {
        padding: 0.75rem;
        vertical-align: middle;
    }
    
    .table tbody tr:last-child td {
        border-bottom: none; /* Quitar el borde de la última fila */
    }

    /* ----------------------------------------- */
    /* --- ESTILOS DE CELDAS EDITABLES --- */
    /* ----------------------------------------- */

    .editable {
        cursor: text;
        background-color: #fef9e7; /* Fondo amarillo suave inicial */
        border-left: 3px solid #f1c40f; /* Borde izquierdo para indicar "editable" */
        transition: background-color 0.2s ease-in-out;
    }

    .editable:hover {
        background-color: #fdecb3;
    }

    .editable:focus {
        background-color: #fff;
        outline: 2px solid #0b8552; /* Foco claro con el color principal */
        outline-offset: -2px;
        box-shadow: 0 0 8px rgba(11, 133, 82, 0.3);
    }

    /* Estilo para celda guardada exitosamente (usado por JS) */
    .cell-save-success {
        transition: background-color 0.3s ease;
        background-color: #d1e7dd !important; /* Verde de éxito de Bootstrap */
    }

    /* ----------------------------------------- */
    /* --- ESTILOS PARA ESTADO BLOQUEADO --- */
    /* ----------------------------------------- */
    
    /* Estilo para aviso de hora límite (inyectado por JS) */
    .aviso-hora-limite {
        font-size: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 0.375rem; /* Bootstrap .rounded-3 */
        font-weight: 500;
    }

    /* Estilo para celdas no editables después de la hora límite */
    .celda-no-editable {
        background-color: #e9ecef !important; /* Gris neutro */
        cursor: not-allowed !important;
        color: #6c757d;
        border-left: 3px solid #adb5bd; /* Borde gris para indicar "bloqueado" */
    }

    .celda-no-editable:hover,
    .celda-no-editable:focus {
        background-color: #e9ecef !important;
        outline: none !important;
        box-shadow: none !important;
    }
</style>

<script>
    // --- Inicialización del selector de fecha con colores por registro ---
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('fecha_filtro');
        const fechasConRegistro = input ? JSON.parse(input.getAttribute('data-fechas') || '[]') : [];
        const setFechas = new Set(fechasConRegistro);
        if (input) {
            // Cargar Flatpickr desde CDN (ligero y sin dependencias)
            const addCss = (href) => { const l = document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); };
            const addJs = (src, cb) => { const s = document.createElement('script'); s.src=src; s.onload=cb; document.body.appendChild(s); };
            addCss('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css');
            addCss('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/material_green.css');
            addJs('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', () => {
                flatpickr(input, {
                    dateFormat: 'Y-m-d',
                    defaultDate: input.value || '{{ today_iso }}',
                    allowInput: true,
                    onDayCreate: function(dObj, dStr, fp, dayElem) {
                        const dateStr = dayElem.dateObj.toISOString().slice(0,10);
                        dayElem.classList.add('fp-hint-day');
                        if (setFechas.has(dateStr)) {
                            dayElem.classList.add('fp-day-con-registro');
                            dayElem.setAttribute('title','Con registro');
                        } else {
                            dayElem.classList.add('fp-day-sin-registro');
                            dayElem.setAttribute('title','Sin registro');
                        }
                    }
                });
            });
        }
    });

    // --- FUNCIÓN DE ALERTA MEJORADA ---
    function mostrarAlerta(mensaje, tipo = 'info', duracion = 4000) {
        const alertContainer = document.getElementById('alert-container');
        if (!alertContainer) { console.error("Contenedor de alertas no encontrado."); return; }
        
        const wrapper = document.createElement('div');
        let iconClass = 'bi-info-circle-fill';
        if (tipo === 'success') iconClass = 'bi-check-circle-fill';
        if (tipo === 'danger') iconClass = 'bi-exclamation-triangle-fill';
        if (tipo === 'warning') iconClass = 'bi-exclamation-diamond-fill';
        
        wrapper.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show d-flex align-items-center shadow-lg border-0" role="alert">
                <i class="bi ${iconClass} me-2" style="font-size: 1.2em;"></i>
                <div>${mensaje}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        
        alertContainer.appendChild(wrapper);
        const alertElement = wrapper.firstChild;
        
        if (alertElement) {
            setTimeout(() => {
                const alertInstance = bootstrap.Alert.getOrCreateInstance(alertElement);
                if (alertInstance) { alertInstance.close(); }
                else if (wrapper.parentElement) { wrapper.remove(); }
            }, duracion);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const editableCells = document.querySelectorAll(".editable");
        let edicionPermitida = true;

        // --- LÓGICA PARA CELDAS EDITABLES ---
        editableCells.forEach(cell => {
            // Validación de entrada (sin cambios en la lógica)
            cell.addEventListener('keydown', function(event) {
                if (!cell.isContentEditable) { event.preventDefault(); return; }
                const allowedKeys = ["Backspace", "Delete", "Tab", "Escape", "Enter", "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Home", "End"];
                if (allowedKeys.includes(event.key)) { return; }
                if ((event.ctrlKey || event.metaKey) && ['a', 'c', 'v', 'x', 'z'].includes(event.key.toLowerCase())) { return; }
                if ((event.key >= '0' && event.key <= '9')) { return; }
                if (event.key === ',' || event.key === '.') {
                    if (cell.innerText.includes(',') || cell.innerText.includes('.')) { event.preventDefault(); }
                    return;
                }
                event.preventDefault();
            });

            cell.addEventListener('paste', function(event) {
                if (!cell.isContentEditable) { event.preventDefault(); return; }
                event.preventDefault();
                let paste = (event.clipboardData || window.clipboardData).getData('text');
                paste = paste.replace(/[^\d,.]/g, '').replace(/([,.])(?=.*[,.])/g, '');
                document.execCommand('insertText', false, paste);
            });

            // Guardado automático al perder el foco (on-blur)
            cell.addEventListener("blur", () => {
                // Solo guardar si la celda aún es editable
                if (cell.isContentEditable) {
                    const row = cell.closest("tr"); if (!row) return;
                    const tk = row.dataset.tk;
                    const field = cell.dataset.field;
                    let value = cell.innerText.trim().replace(',', '.');

                    // Recalcular TON en la fila cuando cambian BLS_60 o API
                    try { actualizarToneladasFila(row); } catch (e) {}

                    fetch("{{ url_for('guardar_datos_planta') }}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ tk, field, value: value })
                    })
                    .then(res => {
                        if (!res.ok) { return res.json().then(errData => { throw errData || new Error("Error HTTP: " + res.status); }); }
                        return res.json();
                    })
                    .then(data => {
                        if (data.success) {
                            cell.classList.add('cell-save-success');
                            setTimeout(() => { cell.classList.remove('cell-save-success'); }, 2000);
                        } else {
                            mostrarAlerta("Error al guardar celda: " + (data.message || "Error desconocido"), "danger");
                        }
                    })
                    .catch(err => {
                        console.error("Error fetch (guardar celda):", err);
                        mostrarAlerta("Error al guardar celda: " + (err.message || "Error de conexión."), "danger");
                    });
                }
            });
        });
    }); // Fin de DOMContentLoaded

    // --- FUNCIÓN PARA GUARDAR REGISTRO COMPLETO ---
    function guardarRegistro() {
        const datosAEnviar = [];
        document.querySelectorAll("tbody tr").forEach(row => {
            const tk = row.dataset.tk;
            if (!tk) return;
            const getVal = (name) => {
                const el = row.querySelector(`[data-field="${name}"]`);
                return el ? el.innerText.trim() : '';
            };
            datosAEnviar.push({
                "TK": tk,
                "PRODUCTO": getVal('PRODUCTO'),
                "MAX_CAP": getVal('MAX_CAP'),
                "BLS_60": getVal('BLS_60'),
                "API": getVal('API'),
                "BSW": getVal('BSW'),
                "S": getVal('S')
            });
        });
        
        // 2. Enviar los datos al backend con el formato correcto
        fetch("{{ url_for('guardar_registro_planta') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest"
            },
            // Asegurarse de que el cuerpo del mensaje es una cadena JSON
            body: JSON.stringify(datosAEnviar)
        })
        .then(res => {
            if (!res.ok) {
                // Si la respuesta no es OK, intenta leer el error como JSON
                return res.json().then(errData => {
                    throw new Error(errData.message || "Error del servidor");
                }).catch(() => {
                    // Si falla, es porque la respuesta es HTML (como una página de error)
                    throw new Error("Error inesperado del servidor. No se recibió una respuesta válida.");
                });
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                mostrarAlerta("¡Registro guardado exitosamente!", "success");
                // Redirigir al reporte después de guardar
                setTimeout(() => { window.location.href = "{{ url_for('reporte_planta') }}"; }, 1500);
            } else {
                throw new Error(data.message || "El servidor indicó un fallo.");
            }
        })
        .catch(err => {
            console.error("Error al guardar:", err);
            mostrarAlerta(`Error fatal: ${err.message}`, "danger");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = `<i class="bi bi-save2-fill me-2"></i>Guardar Registro`;
        });
    }

    // --- CÁLCULO DE TONELADAS EN TIEMPO REAL ---
    function calcularTons(bls60, api, tk, producto){
        const b = parseFloat((bls60||'').toString().replace(',','.')) || 0;
        const a = parseFloat((api||'').toString().replace(',','.'));
        if (b <= 0) return null;

        const tank = (tk||'').toUpperCase();
        const allowed = new Set(['TK-102','TK-110','TK-108']);
        if (!allowed.has(tank)) return null; // Solo mostrar TON para 102, 110 y 108

        if (!isNaN(a)) {
            // SG = 141.5/(API+131.5); Tons = BLS_60 * SG / 6.2898
            const sg = 141.5 / (a + 131.5);
            return b * (sg / 6.2898);
        }
        // Fallbacks específicos por tanque
        if (tank === 'TK-102') return b / 6.7;
        if (tank === 'TK-110') return b / 7.4;
        if (tank === 'TK-108') return b / 6.7; // VLSFO
        return null;
    }

    function actualizarToneladasFila(row){
        const tk = row.dataset.tk || '';
        const bls = row.querySelector('[data-field="BLS_60"]')?.innerText || '';
        const api = row.querySelector('[data-field="API"]')?.innerText || '';
        const prod = row.querySelector('[data-field="PRODUCTO"]')?.innerText || '';
        const tons = calcularTons(bls, api, tk, prod);
        const tonCell = row.querySelector('.ton-col');
        if (tonCell){ tonCell.textContent = (tons==null) ? '—' : tons.toFixed(2); }
    }

    document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('tbody tr').forEach(actualizarToneladasFila);
    });
</script>

<style>
/* Indicadores visuales en el calendario */
.flatpickr-calendar .flatpickr-day.fp-hint-day { position: relative; }
.flatpickr-calendar .flatpickr-day.fp-day-con-registro { background: rgba(25, 135, 84, 0.2); color: #198754; border-color: rgba(25,135,84,0.45); }
.flatpickr-calendar .flatpickr-day.fp-day-sin-registro { background: rgba(173,181,189,0.25); color: #6c757d; }
.flatpickr-calendar .flatpickr-day.selected { background: #0b8552; border-color: #0b8552; color: #fff; }
.flatpickr-calendar .flatpickr-day.today { border-color: #0b8552; }
.legend-dot { width:10px; height:10px; border-radius:50%; background: var(--dot-color); display:inline-block; }
</style>
{% endblock %}