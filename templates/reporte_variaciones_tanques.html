{% extends "base.html" %}
{% block title %}Variaciones por Tanque{% endblock %}

{% block content %}
<div class="container-xl my-4">
  <div class="d-flex flex-wrap align-items-center mb-3">
    <h2 class="h4 mb-2 mb-md-0"><i class="bi bi-graph-up-arrow me-2"></i>Variación diaria por tanque</h2>
    <div class="ms-auto d-flex flex-wrap gap-2 align-items-center justify-content-end text-end">
      <form id="filtroFechasForm" class="d-flex align-items-center me-2" onsubmit="return false;">
        <label class="me-2 text-muted small">Desde</label>
        <input type="text" id="inputDesde" class="form-control form-control-sm me-2" value="{{ desde or '' }}" placeholder="YYYY-MM-DD" data-fechas='{{ (fechas_con_registro or [])|tojson|safe }}'>
        <label class="me-2 text-muted small">Hasta</label>
        <input type="text" id="inputHasta" class="form-control form-control-sm me-2" value="{{ hasta or '' }}" placeholder="YYYY-MM-DD" data-fechas='{{ (fechas_con_registro or [])|tojson|safe }}'>
        <button type="button" id="btnAplicarFechas" class="btn btn-sm btn-outline-primary"><i class="bi bi-filter me-1"></i>Aplicar</button>
      </form>
      <a href="{{ url_for('reporte_planta') }}" class="btn btn-outline-secondary btn-sm d-flex align-items-center">
        <i class="bi bi-arrow-left-circle me-2"></i>Volver a Reporte Planta
      </a>
      <div class="btn-group">
        <button type="button" class="btn btn-primary btn-sm dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-download me-1"></i>Descargar Reporte
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" data-filtro="dia">Por Día</a></li>
          <li><a class="dropdown-item" href="#" data-filtro="mes">Por Mes</a></li>
          <li><a class="dropdown-item" href="#" data-filtro="trimestre">Por Trimestre</a></li>
          <li><a class="dropdown-item" href="#" data-filtro="anual">Todo el Año</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="modal fade" id="opcionesDescargaModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">Seleccione una Opción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="inputDia" class="mb-3" style="display: none;">
            <label for="fechaValor" class="form-label"><b>Día:</b></label>
            <input type="date" id="fechaValor" class="form-control">
          </div>
          <div id="inputMes" class="mb-3" style="display: none;">
            <label for="mesValor" class="form-label"><b>Mes:</b></label>
            <input type="month" id="mesValor" class="form-control">
          </div>
          <div id="inputTrimestre" class="mb-3" style="display: none;">
            <label for="trimestreValor" class="form-label"><b>Año y Trimestre:</b></label>
            <div class="d-flex">
              <input type="number" id="trimestreAno" class="form-control me-2" placeholder="Año" min="2020" max="2099">
              <select id="trimestreNum" class="form-select">
                <option value="1">Q1 (Ene-Mar)</option>
                <option value="2">Q2 (Abr-Jun)</option>
                <option value="3">Q3 (Jul-Sep)</option>
                <option value="4">Q4 (Oct-Dic)</option>
              </select>
            </div>
          </div>
          <div id="inputAnual" class="mb-3" style="display: none;">
            <label for="anualValor" class="form-label"><b>Año:</b></label>
            <input type="number" id="anualValor" class="form-control" placeholder="Año" min="2020" max="2099">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnGenerarPdf" class="btn btn-danger"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Generar PDF</button>
          <button type="button" id="btnGenerarExcel" class="btn btn-success"><i class="bi bi-file-earmark-excel-fill me-1"></i> Generar Excel</button>
        </div>
      </div>
    </div>
  </div>

  {% if series_por_tanque and series_por_tanque|length > 0 %}
    {# Layout fijo solicitado: 
       Fila 1: TK-109
       Fila 2: TK-110 | TK-102
       Fila 3: TK-01  | TK-02 #}

    {# Pre-capturamos info para cabeceras #}
    {% set _109 = series_por_tanque.get('TK-109') or series_por_tanque.get('Tk-109') or series_por_tanque.get('tk-109') %}
  {% set _110 = series_por_tanque.get('TK-110') or series_por_tanque.get('Tk-110') or series_por_tanque.get('tk-110') %}
  {% set _108 = series_por_tanque.get('TK-108') or series_por_tanque.get('Tk-108') or series_por_tanque.get('tk-108') %}
    {% set _102 = series_por_tanque.get('TK-102') or series_por_tanque.get('Tk-102') or series_por_tanque.get('tk-102') %}
    {% set _01  = series_por_tanque.get('TK-01')  or series_por_tanque.get('Tk-01')  or series_por_tanque.get('tk-01')  %}
    {% set _02  = series_por_tanque.get('TK-02')  or series_por_tanque.get('Tk-02')  or series_por_tanque.get('tk-02')  %}

    <!-- Fila 1: TK-109 -->
    <div class="row g-4 mb-2">
      <div class="col-12" id="col-TK-109">
        <div class="card shadow-sm card-pro">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">TK-109 <small class="text-muted ms-2">{{ _109.producto if _109 else '' }}</small></h5>
              {% if _109 and _109.max_cap and _109.max_cap > 0 %}
                <span class="badge bg-primary bg-opacity-10 text-primary">Capacidad: {{ _109.max_cap|round(0) }} bls</span>
              {% endif %}
            </div>
            <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
              <span>Serie de niveles (BLS @60)</span>
              <span class="mini-legend">
                <span class="dot dot-green"></span> Suma
                <span class="dot dot-red ms-2"></span> Descarga
                <span class="dot dot-gray ms-2"></span> Sin cambio
              </span>
            </div>
            <div class="chart-fixed"><canvas id="chart-var-1"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fila 2: TK-108 -->
    <div class="row g-4 mb-2">
      <div class="col-12" id="col-TK-108">
        <div class="card shadow-sm card-pro">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">TK-108 <small class="text-muted ms-2">{{ _108.producto if _108 else '' }}</small></h5>
              {% if _108 and _108.max_cap and _108.max_cap > 0 %}
                <span class="badge bg-primary bg-opacity-10 text-primary">Capacidad: {{ _108.max_cap|round(0) }} bls</span>
              {% endif %}
            </div>
            <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
              <span>Serie de niveles (BLS @60)</span>
              <span class="mini-legend">
                <span class="dot dot-green"></span> Suma
                <span class="dot dot-red ms-2"></span> Descarga
                <span class="dot dot-gray ms-2"></span> Sin cambio
              </span>
            </div>
            <div class="chart-fixed"><canvas id="chart-var-3"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fila 3: TK-110 | TK-102 -->
    <div class="row g-4 mb-2">
      <div class="col-12 col-xl-6" id="col-TK-110">
        <div class="card shadow-sm card-pro">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">TK-110 <small class="text-muted ms-2">{{ _110.producto if _110 else '' }}</small></h5>
              {% if _110 and _110.max_cap and _110.max_cap > 0 %}
                <span class="badge bg-primary bg-opacity-10 text-primary">Capacidad: {{ _110.max_cap|round(0) }} bls</span>
              {% endif %}
            </div>
            <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
              <span>Serie de niveles (BLS @60)</span>
              <span class="mini-legend">
                <span class="dot dot-green"></span> Suma
                <span class="dot dot-red ms-2"></span> Descarga
                <span class="dot dot-gray ms-2"></span> Sin cambio
              </span>
            </div>
            <div class="chart-fixed"><canvas id="chart-var-2"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6" id="col-TK-102">
        <div class="card shadow-sm card-pro">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">TK-102 <small class="text-muted ms-2">{{ _102.producto if _102 else '' }}</small></h5>
              {% if _102 and _102.max_cap and _102.max_cap > 0 %}
                <span class="badge bg-primary bg-opacity-10 text-primary">Capacidad: {{ _102.max_cap|round(0) }} bls</span>
              {% endif %}
            </div>
            <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
              <span>Serie de niveles (BLS @60)</span>
              <span class="mini-legend">
                <span class="dot dot-green"></span> Suma
                <span class="dot dot-red ms-2"></span> Descarga
                <span class="dot dot-gray ms-2"></span> Sin cambio
              </span>
            </div>
            <div class="chart-fixed"><canvas id="chart-var-4"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fila 4: TK-01 | TK-02 -->
    <div class="row g-4">
      <div class="col-12 col-xl-6" id="col-TK-01">
        <div class="card shadow-sm card-pro">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">TK-01 <small class="text-muted ms-2">{{ _01.producto if _01 else '' }}</small></h5>
              <span class="badge bg-primary bg-opacity-10 text-primary">Capacidad: 500.0 bls</span>
            </div>
            <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
              <span>Serie de niveles (BLS @60)</span>
              <span class="mini-legend">
                <span class="dot dot-green"></span> Suma
                <span class="dot dot-red ms-2"></span> Descarga
                <span class="dot dot-gray ms-2"></span> Sin cambio
              </span>
            </div>
            <div class="chart-fixed"><canvas id="chart-var-5"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6" id="col-TK-02">
        <div class="card shadow-sm card-pro">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">TK-02 <small class="text-muted ms-2">{{ _02.producto if _02 else '' }}</small></h5>
              <span class="badge bg-primary bg-opacity-10 text-primary">Capacidad: 500.0 bls</span>
            </div>
            <div class="mb-1 small text-muted d-flex align-items-center justify-content-between">
              <span>Serie de niveles (BLS @60)</span>
              <span class="mini-legend">
                <span class="dot dot-green"></span> Suma
                <span class="dot dot-red ms-2"></span> Descarga
                <span class="dot dot-gray ms-2"></span> Sin cambio
              </span>
            </div>
            <div class="chart-fixed"><canvas id="chart-var-6"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      No hay datos en el rango seleccionado.
    </div>
  {% endif %}
</div>

<script id="series-data" type="application/json">{{ series_por_tanque | tojson }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Flatpickr para los filtros de fecha con coloreado
  (function(){
    const addCss = (href) => { const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); };
    const addJs = (src, cb) => { const s=document.createElement('script'); s.src=src; s.onload=cb; document.body.appendChild(s); };
    addCss('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css');
    addCss('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/material_green.css');
    addJs('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', () => {
      const inputs = [document.getElementById('inputDesde'), document.getElementById('inputHasta')];
      inputs.forEach(inp => {
        if(!inp) return;
        const fechas = inp.getAttribute('data-fechas') ? JSON.parse(inp.getAttribute('data-fechas')) : [];
        const setFechas = new Set(fechas);
        flatpickr(inp, {
          dateFormat: 'Y-m-d',
          defaultDate: inp.value || '{{ today_iso }}',
          allowInput: true,
          onDayCreate: function(dObj, dStr, fp, dayElem) {
            const dateStr = dayElem.dateObj.toISOString().slice(0,10);
            dayElem.classList.add('fp-hint-day');
            if (setFechas.has(dateStr)) {
              dayElem.classList.add('fp-day-con-registro');
              dayElem.setAttribute('title','Con registro');
            } else {
              dayElem.classList.add('fp-day-sin-registro');
              dayElem.setAttribute('title','Sin registro');
            }
          }
        });
      });
    });
  })();
  // Estilos compactos específicos de este reporte
  const style = document.createElement('style');
  style.textContent = `
    .card-pro .card-body{ padding: 1rem 1.25rem; }
    .card-pro .card-title{ font-size: 1.05rem; letter-spacing: .2px; }
    .chart-fixed{ height: 300px; width: 100%; }
    .chart-fixed > canvas{ width: 100% !important; height: 100% !important; }
    .mini-legend{ font-size:.7rem; color: #6c757d; white-space: nowrap; }
    .dot{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; }
    .dot-green{ background:#198754; }
    .dot-red{ background:#dc3545; }
    .dot-gray{ background:#6c757d; }
    #filtroFechasForm .form-control{ min-width: 150px; }
    #filtroFechasForm label{ margin-bottom: 0; }
    @media (min-width: 1400px){
      .chart-fixed{ height: 340px; }
    }
  `;
  document.head.appendChild(style);

  const formatosFecha = labels => labels.map(d => {
    // d viene como 'YYYY-MM-DD'
    const [Y, M, D] = d.split('-');
    return `${D}/${M}`; // DD/MM compacto
  });
  const series = JSON.parse(document.getElementById('series-data').textContent || '{}');

  const orderedTanks = ['TK-109','TK-110','TK-108','TK-102','TK-01','TK-02'];

  // Overrides de capacidad por tanque para el eje Y y línea de capacidad
  const capacityOverrides = { 'TK-01': 500, 'TK-02': 500 };

  function getInfoForTank(tank){
    if(series[tank]) return series[tank];
    const k = Object.keys(series).find(key => (key||'').toUpperCase() === tank.toUpperCase());
    return k ? series[k] : null;
  }

  function hideCol(tank){
    const el = document.getElementById('col-' + tank);
    if(el){ el.style.display = 'none'; }
  }

  function buildCharts(){
    orderedTanks.forEach((tank, i) => {
      const info = getInfoForTank(tank);
      const canvasId = 'chart-var-' + (i+1);
      const ctx2 = document.getElementById(canvasId);
      if(!ctx2){ return; }
      if(!info || !info.labels || !info.bls_60){ hideCol(tank); return; }

      const labels = formatosFecha(info.labels);
      const levelData = (info.bls_60 || []).map(v => Number(v||0));
      const deltas = levelData.map((v,idx) => idx===0 ? null : (v - levelData[idx-1]));
      const ptColors = deltas.map((d,idx)=> {
        if(idx===0 || d===null) return '#6c757d';
        return d>0 ? '#198754' : (d<0 ? '#dc3545' : '#6c757d');
      });
  // Aplica override si existe, si no usa max_cap de datos
  let yMax = capacityOverrides[tank] || Number(info.max_cap || 0);
      if(!yMax || yMax <= 0){
        const maxVal = levelData.reduce((a,b)=> Math.max(a,b||0), 0);
        yMax = Math.ceil(maxVal * 1.1);
      }
      const capacityLine = Array(levelData.length).fill(yMax);

      const gctx = ctx2.getContext('2d');
      const h = ctx2.clientHeight || ctx2.height || 300;
      const gradient = gctx.createLinearGradient(0,0,0,h);
      gradient.addColorStop(0, 'rgba(11,133,82,0.18)');
      gradient.addColorStop(1, 'rgba(11,133,82,0.02)');

      new Chart(ctx2, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'BLS @60',
              data: levelData,
              borderColor: '#0b8552',
              backgroundColor: gradient,
              pointBackgroundColor: ptColors,
              pointBorderColor: ptColors,
              pointRadius: 2,
              pointHoverRadius: 4,
              pointHitRadius: 10,
              borderWidth: 2,
              fill: true,
              tension: 0.25,
              segment: {
                borderColor: ctx => {
                  const idx = ctx.p1DataIndex;
                  if(idx<=0) return '#0b8552';
                  const d = levelData[idx] - levelData[idx-1];
                  return d>0 ? '#198754' : (d<0 ? '#dc3545' : '#6c757d');
                }
              }
            },
            {
              label: 'Capacidad',
              data: capacityLine,
              borderColor: 'rgba(108,117,125,0.9)',
              borderDash: [6,4],
              pointRadius: 0,
              borderWidth: 1,
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 4, right: 8, bottom: 0, left: 0 } },
          scales: {
            x: { grid: { display: false }, ticks: { autoSkip: true, maxTicksLimit: 10, color: '#6c757d' } },
            y: {
              min: 0,
              max: yMax,
              grid: { color: 'rgba(0,0,0,0.06)' },
              ticks: { maxTicksLimit: 6, color: '#6c757d', callback: (val) => Number(val).toLocaleString('es-CO') }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  if(ctx.datasetIndex === 0){
                    const v = Number(ctx.parsed.y||0).toLocaleString('es-CO');
                    const d = deltas[ctx.dataIndex];
                    if(d===null || d===undefined){ return `BLS: ${v}`; }
                    const dNum = Number(d);
                    const suma = dNum>0 ? dNum : 0;
                    const descarga = dNum<0 ? Math.abs(dNum) : 0;
                    const sumaTxt = Number(suma).toLocaleString('es-CO');
                    const descTxt = Number(descarga).toLocaleString('es-CO');
                    return [ `BLS: ${v}`, `Suma: ${sumaTxt}`, `Descarga: ${descTxt}` ];
                  }
                  return undefined;
                }
              }
            }
          }
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', buildCharts);

  // Botones y modal (igual que reporte de planta)
  document.addEventListener('DOMContentLoaded', function() {
    // Filtro por fecha: recargar ruta con query params
    const btnAplicarFechas = document.getElementById('btnAplicarFechas');
    if (btnAplicarFechas){
      btnAplicarFechas.addEventListener('click', function(){
        const desde = document.getElementById('inputDesde').value;
        const hasta = document.getElementById('inputHasta').value;
        const params = new URLSearchParams();
        if(desde) params.append('desde', desde);
        if(hasta) params.append('hasta', hasta);
        const base = "{{ url_for('reporte_variaciones_tanques') }}";
        const url = params.toString() ? `${base}?${params.toString()}` : base;
        window.location.href = url;
      });
    }

    const modalElement = document.getElementById('opcionesDescargaModal');
    const descargaModal = new bootstrap.Modal(modalElement);
    let filtroSeleccionado = '';

    function prepararModal(filtro){
      filtroSeleccionado = filtro;
      const hoy = new Date().toISOString();
      const anoActual = new Date().getFullYear();
      document.getElementById('inputDia').style.display = 'none';
      document.getElementById('inputMes').style.display = 'none';
      document.getElementById('inputTrimestre').style.display = 'none';
      document.getElementById('inputAnual').style.display = 'none';
      if (filtro === 'dia'){
        document.getElementById('modalLabel').innerText = 'Descargar Reporte por Día';
        document.getElementById('inputDia').style.display = 'block';
        document.getElementById('fechaValor').value = hoy.slice(0,10);
      } else if (filtro === 'mes'){
        document.getElementById('modalLabel').innerText = 'Descargar Reporte por Mes';
        document.getElementById('inputMes').style.display = 'block';
        document.getElementById('mesValor').value = hoy.slice(0,7);
      } else if (filtro === 'trimestre'){
        document.getElementById('modalLabel').innerText = 'Descargar Reporte por Trimestre';
        document.getElementById('inputTrimestre').style.display = 'block';
        document.getElementById('trimestreAno').value = anoActual;
      } else if (filtro === 'anual'){
        document.getElementById('modalLabel').innerText = 'Descargar Reporte Anual';
        document.getElementById('inputAnual').style.display = 'block';
        document.getElementById('anualValor').value = anoActual;
      }
    }

    document.querySelectorAll('.dropdown-item[data-filtro]').forEach(item => {
      item.addEventListener('click', function(e){
        e.preventDefault();
        prepararModal(this.getAttribute('data-filtro'));
        descargaModal.show();
      });
    });

    function descargar(formato){
      let urlBase = '';
      if (formato === 'pdf'){
        urlBase = "{{ url_for('descargar_reporte_variaciones_pdf') }}";
      } else {
        urlBase = "{{ url_for('exportar_excel', nombre_reporte='variaciones') }}";
      }
      const params = new URLSearchParams();
      params.append('filtro_tipo', filtroSeleccionado);
      if (filtroSeleccionado === 'dia'){
        params.append('valor', document.getElementById('fechaValor').value);
      } else if (filtroSeleccionado === 'mes'){
        params.append('valor', document.getElementById('mesValor').value);
      } else if (filtroSeleccionado === 'trimestre'){
        const ano = document.getElementById('trimestreAno').value;
        const num = document.getElementById('trimestreNum').value;
        params.append('valor', `${ano}-Q${num}`);
      } else if (filtroSeleccionado === 'anual'){
        params.append('valor', document.getElementById('anualValor').value);
      }
      window.location.href = `${urlBase}?${params.toString()}`;
      descargaModal.hide();
    }

    document.getElementById('btnGenerarPdf').addEventListener('click', ()=>descargar('pdf'));
    document.getElementById('btnGenerarExcel').addEventListener('click', ()=>descargar('excel'));
  });
</script>
<style>
.flatpickr-calendar .flatpickr-day.fp-hint-day { position: relative; }
.flatpickr-calendar .flatpickr-day.fp-day-con-registro { background: rgba(25, 135, 84, 0.2); color: #198754; border-color: rgba(25,135,84,0.45); }
.flatpickr-calendar .flatpickr-day.fp-day-sin-registro { background: rgba(173,181,189,0.25); color: #6c757d; }
.flatpickr-calendar .flatpickr-day.selected { background: #0b8552; border-color: #0b8552; color: #fff; }
.flatpickr-calendar .flatpickr-day.today { border-color: #0b8552; }
</style>
{% endblock %}
