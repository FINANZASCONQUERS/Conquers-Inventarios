{% extends 'base.html' %}git addgit add
{% block head %}
    <title>Reporte de Flujo de Efectivo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/professional-theme.css" rel="stylesheet">
    <style>
        :root { --brand-primary:#0d6efd; --brand-primary-rgb:13,110,253; --brand-bg:linear-gradient(135deg,#f4f7f9 0%,#e3eafc 100%); --card-radius:18px; --transition:.25s cubic-bezier(.4,0,.2,1); }
        body { background: var(--brand-bg); font-size:.92rem; }
        .dashboard-wrapper { max-width:1700px; }
        .main-card { border-radius: var(--card-radius); box-shadow:0 6px 24px rgba(0,0,0,.06); border:1px solid #e2e8f0; background:#fff; }
        .uploader { border:2px dashed rgba(var(--brand-primary-rgb),.5); background:#f8fafd; border-radius:14px; transition:var(--transition); }
        .uploader:hover { border-color:var(--brand-primary); background:#f0f6ff; }
        .table-responsive { max-height: 600px; }
        .spinner-border { width:3rem; height:3rem; }
        .diff-pos { color:#198754 !important; }
        .diff-neg { color:#dc3545 !important; }
        .filter-label { color:var(--brand-primary); font-weight:600; font-size:.7rem; letter-spacing:.5px; text-transform:uppercase; }
        .filter-select { border-radius:10px; border:1px solid #cfd9e6; font-size:.8rem; }
        .filter-select:focus { border-color:var(--brand-primary); box-shadow:0 0 0 3px rgba(var(--brand-primary-rgb),.15); }
        .card { border:1px solid #e2e8f0; border-radius:16px; }
        .card-header { background:#f8fafc; border-bottom:1px solid #e2e8f0; border-radius:16px 16px 0 0; }
        .card-header h5,.card-header h6 { font-weight:600; }
        .card:hover { box-shadow:0 6px 20px -4px rgba(0,0,0,.08); transition:box-shadow var(--transition); }
        .table thead th { background:#eef3fb; color:#0d47a1; font-weight:600; font-size:.65rem; letter-spacing:.5px; text-transform:uppercase; }
        .table tfoot td { background:#f4f7f9; font-weight:600; }
        .section-title { color:#0d47a1; font-weight:700; letter-spacing:1px; display:flex; align-items:center; gap:.5rem; }
        .section-title:before { content:""; width:6px; height:24px; background:linear-gradient(180deg,var(--brand-primary),#4dabf7); border-radius:4px; }
        .dashboard-toolbar { background:rgba(255,255,255,.85); backdrop-filter:blur(6px); border:1px solid #e2e8f0; border-radius:18px; padding:1rem 1.25rem; margin-bottom:1.25rem; box-shadow:0 4px 16px -4px rgba(0,0,0,.06); }
        .dashboard-toolbar .toolbar-actions { gap:.75rem; }
        #toggle-view-btn { font-weight:600; display:inline-flex; align-items:center; gap:.35rem; }
        #resumen-directo .card { position:relative; overflow:hidden; }
        #resumen-directo .card:after { content:""; position:absolute; width:120px; height:120px; top:-40px; right:-40px; background:radial-gradient(circle at center, rgba(255,255,255,.4), transparent 70%); }
        #resumen-directo .card .small { font-size:.6rem; letter-spacing:.5px; }
        .badge-soft { background:rgba(var(--brand-primary-rgb),.15); color:var(--brand-primary); font-weight:500; font-size:.6rem; }
        @media (max-width:992px){ .dashboard-toolbar{padding:.85rem .9rem;} }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-wrapper py-4">
    <div class="dashboard-toolbar d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
        <div class="mb-3 mb-lg-0">
            <h1 class="h3 section-title mb-1">Reporte de Flujo de Efectivo</h1>
            <div class="text-muted small d-flex align-items-center gap-2">
                <i class="bi bi-person-circle text-primary"></i>
                <span>Hola, {{ nombre }}</span>
                <span class="badge badge-soft">DASHBOARD</span>
            </div>
        </div>
        <div class="toolbar-actions d-flex flex-wrap align-items-end">
            <div class="d-flex flex-column">
                <label for="file-upload" class="filter-label mb-1">Excel Bancos</label>
                <input type="file" id="file-upload" class="form-control form-control-sm filter-select" accept=".xlsx, .xls" style="min-width:180px;">
            </div>
            <div class="d-flex flex-column">
                <label for="file-facturacion" class="filter-label mb-1">Facturación</label>
                <input type="file" id="file-facturacion" class="form-control form-control-sm filter-select" accept=".xlsx, .xls" style="min-width:180px;">
            </div>
            <div class="d-flex flex-column">
                <label class="filter-label mb-1">Vista</label>
                <button id="toggle-view-btn" class="btn btn-outline-primary btn-sm"><i class="bi bi-graph-up"></i><span>Ver Gráficos</span></button>
            </div>
            <div class="d-flex flex-column">
                <label class="filter-label mb-1">Filtros</label>
                <button id="btn-toggle-filtros" class="btn btn-light btn-sm border"><i class="bi bi-funnel"></i></button>
            </div>
        <div class="d-flex flex-column">
                <label class="filter-label mb-1">Datos</label>
                <div class="btn-group">
                    <button id="btn-cargar-guardado" class="btn btn-outline-success btn-sm" title="Cargar último guardado"><i class="bi bi-cloud-download"></i></button>
                    <button id="btn-guardar-dataset" class="btn btn-success btn-sm" title="Guardar (persistir)" disabled><i class="bi bi-save"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div id="alert-zone" class="position-fixed" style="top:70px; right:20px; z-index:1080; max-width:320px;"></div>
    <div id="panel-filtros-avanzados" class="main-card p-3 mb-4" style="display:none;">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-3" id="empresa-filter-container" style="display:none;">
                <label for="empresa-filter" class="form-label filter-label">Empresa</label>
                <select id="empresa-filter" class="form-select filter-select"></select>
            </div>
            <div class="col-12 col-md-3" id="banco-filter-container" style="display:none;">
                <label for="banco-filter" class="form-label filter-label">Tipo Banco</label>
                <select id="banco-filter" class="form-select filter-select"></select>
            </div>
            <div class="col-6 col-md-2" id="fecha-inicio-wrapper" style="display:none;">
                <label for="fecha-inicio" class="form-label filter-label">Fecha Inicio</label>
                <input type="date" id="fecha-inicio" class="form-control form-control-sm filter-select" />
            </div>
            <div class="col-6 col-md-2" id="fecha-fin-wrapper" style="display:none;">
                <label for="fecha-fin" class="form-label filter-label">Fecha Fin</label>
                <input type="date" id="fecha-fin" class="form-control form-control-sm filter-select" />
            </div>
            <div class="col-12 col-md-2" id="mes-completo-wrapper" style="display:none;">
                <label for="mes-completo" class="form-label filter-label">Mes Completo</label>
                <input type="month" id="mes-completo" class="form-control form-control-sm filter-select" />
            </div>
            <div class="col-12 col-md-3 d-flex gap-2 justify-content-md-end">
                <button id="btn-reset-filtros" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                <button id="btn-hide-filtros" class="btn btn-primary btn-sm"><i class="bi bi-check2-circle"></i> Aplicar</button>
            </div>
        </div>
    </div>
    <!-- Tarjetas Resumen Método Directo -->
    <div id="resumen-directo" class="row g-3 mb-4 d-none"></div>
    <!-- Breakdowns -->
    <div id="breakdown-ingresos" class="row mb-3 d-none">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Detalle Ingresos por Tipo de Flujo (Odoo)</strong>
                    <button class="btn btn-sm btn-outline-secondary" data-close-breakdown="ingresos">Cerrar</button>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2 mb-2 align-items-end">
                        <div class="col-6 col-md-3">
                            <label class="form-label small mb-0 text-primary">Clase</label>
                            <select id="filtro-clase-ingresos" class="form-select form-select-sm">
                                <option value="">(Todas)</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label small mb-0 text-primary">Sub Clase</label>
                            <select id="filtro-subclase-ingresos" class="form-select form-select-sm">
                                <option value="">(Todas)</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light"><tr><th>Tipo Flujo</th><th class="text-end">Total Débito</th></tr></thead>
                            <tbody id="tbody-breakdown-ingresos"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="breakdown-egresos" class="row mb-3 d-none">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Detalle Egresos por Tipo de Flujo (Odoo)</strong>
                    <button class="btn btn-sm btn-outline-secondary" data-close-breakdown="egresos">Cerrar</button>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2 mb-2 align-items-end">
                        <div class="col-6 col-md-3">
                            <label class="form-label small mb-0 text-primary">Clase</label>
                            <select id="filtro-clase-egresos" class="form-select form-select-sm">
                                <option value="">(Todas)</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label small mb-0 text-primary">Sub Clase</label>
                            <select id="filtro-subclase-egresos" class="form-select form-select-sm">
                                <option value="">(Todas)</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light"><tr><th>Tipo Flujo</th><th class="text-end">Total Crédito</th></tr></thead>
                            <tbody id="tbody-breakdown-egresos"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- (Bloque original de filtros eliminado para evitar duplicación de IDs) -->

    <div id="loading-spinner" class="text-center my-5 d-none">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 text-primary fw-bold">Procesando archivo, por favor espera...</div>
    </div>

    <div id="report-output" class="d-none"></div>
    <div id="charts-view" class="d-none">
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Top Clientes Ventas EXW CTG (Ingresos)</h5>
                <small class="text-muted" id="total-exw-general"></small>
            </div>
            <div class="card-body">
                <!-- Filtros internos de la gráfica -->
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-12 col-md-4">
                        <label class="form-label small text-primary mb-1" for="chart-clase-filter">Clase:</label>
                        <select id="chart-clase-filter" class="form-select form-select-sm">
                            <option value="">(Auto)</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label small text-primary mb-1" for="chart-subclase-filter">Sub Clase:</label>
                        <select id="chart-subclase-filter" class="form-select form-select-sm">
                            <option value="">(Todas)</option>
                        </select>
                    </div>
                </div>
                <canvas id="chartTopClientesEXW" height="140"></canvas>
                <div id="facturas-cliente-panel" class="mt-3 d-none">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 text-primary" id="facturas-cliente-titulo">Facturas</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('facturas-cliente-panel').classList.add('d-none');">Cerrar</button>
                    </div>
                    <div class="table-responsive" style="max-height:260px;">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr><th>Número</th><th>Fecha</th><th class="text-end">COP$</th><th class="text-end">Gln</th><th class="text-end">Bbl</th><th class="text-end">Ton</th></tr>
                            </thead>
                            <tbody id="facturas-cliente-tbody"></tbody>
                            <tfoot class="table-secondary">
                                <tr><th>Total</th><th></th><th class="text-end" id="facturas-cliente-total-cop"></th><th class="text-end" id="facturas-cliente-total-gln"></th><th class="text-end" id="facturas-cliente-total-bbl"></th><th class="text-end" id="facturas-cliente-total-ton"></th></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="text-end mt-2"><small class="text-muted">Aplica mismos filtros de Empresa y Tiempo + filtros internos de Clase/Sub Clase.</small></div>
            </div>
        </div>
        <!-- Resumen global de facturación -->
        <div class="card shadow-sm mb-4" id="facturacion-global-card" style="display:none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Total Facturación Cargada</h6>
                <small class="text-muted" id="facturacion-global-total"></small>
            </div>
            <div class="card-body p-2">
                <div class="table-responsive" style="max-height:260px;">
                    <table class="table table-sm table-striped mb-0" id="facturacion-global-table">
                        <thead class="table-light" id="facturacion-global-thead">
                            <tr id="facturacion-global-head-row"><th>Cliente</th><th class="text-end">Facturas</th><th class="text-end">Total COP$</th><th class="text-end">Total Gln</th><th class="text-end">Total Bbl</th><th class="text-end">Total Ton</th></tr>
                        </thead>
                        <tbody id="facturacion-global-tbody"></tbody>
                        <tfoot class="table-secondary" id="facturacion-global-tfoot">
                            <tr id="facturacion-global-foot-row"><th colspan="2" class="text-end">Gran Total:</th><th class="text-end" id="facturacion-global-total-cop"></th><th class="text-end" id="facturacion-global-total-gln"></th><th class="text-end" id="facturacion-global-total-bbl"></th><th class="text-end" id="facturacion-global-total-ton"></th></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        <!-- NUEVA GRAFICA: EGRESOS PROVEEDORES -->
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Top Proveedores (Egresos)</h5>
                <small class="text-muted" id="total-proveedores-egresos"></small>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-12 col-md-3">
                        <label class="form-label small text-primary mb-1" for="prov-tf-filter">Tipo Flujo Efectivo:</label>
                        <select id="prov-tf-filter" class="form-select form-select-sm">
                            <option value="">(Operación + Inversión)</option>
                            <option value="OPERACION">Operación</option>
                            <option value="INVERSION">Inversión</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label small text-primary mb-1" for="prov-clase-filter">Clase:</label>
                        <select id="prov-clase-filter" class="form-select form-select-sm">
                            <option value="">(Auto)</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label small text-primary mb-1" for="prov-subclase-filter">Sub Clase:</label>
                        <select id="prov-subclase-filter" class="form-select form-select-sm">
                            <option value="">(Todas)</option>
                        </select>
                    </div>
                </div>
                <canvas id="chartTopProveedoresEgresos" height="140"></canvas>
                <div class="text-end mt-2"><small class="text-muted">Filtrado por Empresa / Tiempo + Tipo Flujo (Operación/Inversión) + Clase/Sub Clase.</small></div>
            </div>
        </div>
        <!-- NUEVAS GRAFICAS: TOP TERCEROS INGRESOS / EGRESOS CON FILTRO DE TIPO DE FLUJO -->
        <div class="card shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                        <label class="form-label small text-primary mb-1" for="tf-tercero-filter">Tipo de Flujo:</label>
                        <select id="tf-tercero-filter" class="form-select form-select-sm">
                            <option value="">(Todos)</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label small text-primary mb-1" for="tf-tercero-clase-filter">Clase:</label>
                        <select id="tf-tercero-clase-filter" class="form-select form-select-sm">
                            <option value="">(Todas)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Top Terceros (Ingresos)</h6>
                        <small class="text-muted" id="ingresos-flujo-total"></small>
                    </div>
                    <div class="card-body">
                        <canvas id="chartIngresosFlujo" height="160"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Top Terceros (Egresos)</h6>
                        <small class="text-muted" id="egresos-flujo-total"></small>
                    </div>
                    <div class="card-body">
                        <canvas id="chartEgresosFlujo" height="160"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('file-upload').addEventListener('change', handleFile, false);
    document.getElementById('file-facturacion').addEventListener('change', handleFacturacion, false);
        const btnGuardar = document.getElementById('btn-guardar-dataset');
    const btnCargarGuardado = document.getElementById('btn-cargar-guardado');

    // Mostrar alertas flotantes
    function pushAlert(tipo, mensaje, timeout=4000){
        const zone = document.getElementById('alert-zone');
        const id = 'al_'+Date.now()+Math.random().toString(16).slice(2);
        const div = document.createElement('div');
        div.id = id;
        div.className = `alert alert-${tipo} shadow-sm border mb-2 py-2 px-3 fade show`;
        div.innerHTML = `<div class='d-flex justify-content-between align-items-start'><span class='small'>${mensaje}</span><button type='button' class='btn-close btn-close-white ms-2' data-bs-dismiss='alert'></button></div>`;
        zone.appendChild(div);
        if(timeout){ setTimeout(()=>{ div.classList.remove('show'); setTimeout(()=> div.remove(), 400); }, timeout); }
    }

    async function cargarGuardado(auto=false){
        try{
            const resp = await fetch('/api/flujo_efectivo_cached');
            const data = await resp.json();
            if(!data.success){ if(!auto) pushAlert('warning', data.message||'No hay datos guardados'); return; }
            displayReport(data);
            pushAlert('success', 'Datos cargados desde base de datos');
            // Ya están guardados; desactivar botón guardar hasta nueva carga de archivo
            if(btnGuardar) btnGuardar.disabled = true;
        }catch(e){ if(!auto) pushAlert('danger','Error cargando guardado: '+e.message); }
    }
    if(btnCargarGuardado){ btnCargarGuardado.addEventListener('click', ()=> cargarGuardado(false)); }
    // Auto al cargar página
    document.addEventListener('DOMContentLoaded', ()=> cargarGuardado(true));

    // Guardar: en este flujo ya se guarda automáticamente al subir, así que solo feedback
    if(btnGuardar){
        btnGuardar.addEventListener('click', ()=>{
            pushAlert('info','El archivo ya se guarda automáticamente al subir. Vuelve a subir un archivo actualizado para persistir nuevos datos.');
        });
    }
    (function(){
        const panel = document.getElementById('panel-filtros-avanzados');
        const btnToggle = document.getElementById('btn-toggle-filtros');
        const btnHide = document.getElementById('btn-hide-filtros');
        const btnReset = document.getElementById('btn-reset-filtros');
        if(btnToggle){ btnToggle.addEventListener('click', ()=>{ panel.style.display = (panel.style.display==='none'||panel.style.display==='')?'block':'none'; }); }
        if(btnHide){ btnHide.addEventListener('click', ()=> panel.style.display='none'); }
        if(btnReset){ btnReset.addEventListener('click', ()=>{
            globalEmpresaSeleccionada=''; globalTipoBancoSeleccionado=''; globalFechaInicio=''; globalFechaFin='';
            ['empresa-filter','banco-filter','fecha-inicio','fecha-fin'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
            renderReport(globalReportData);
            updateBancoFilter(globalReportData);
        }); }
    })();

    const currencyFormatter = new Intl.NumberFormat('es-CO', {
        style: 'currency', currency: 'COP', minimumFractionDigits: 2
    });

    async function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const loadingSpinner = document.getElementById('loading-spinner');
        const reportOutput = document.getElementById('report-output');
        loadingSpinner.classList.remove('d-none');
        reportOutput.classList.add('d-none');
        reportOutput.innerHTML = '';

        const formData = new FormData();
        formData.append('archivo_excel', file);

        try {
            const response = await fetch('/api/procesar_flujo_efectivo', { method: 'POST', body: formData });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);

            displayReport(result);
            reportOutput.classList.remove('d-none');
        } catch (error) {
            reportOutput.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            reportOutput.classList.remove('d-none');
        } finally {
            loadingSpinner.classList.add('d-none');
        }
    }
    
    function createComparisonTable(data) {
        if (!data || data.length === 0) return '';
        
        // Totales acumulados
        let totalIngresosBancos = 0;
        let totalIngresosOdoo = 0;
        let totalEgresosBancos = 0;
        let totalEgresosOdoo = 0;
        let totalDiffIngresos = 0;
        let totalDiffEgresos = 0;

        const tableRows = data.map(row => {
            // Compatibilidad: permitir backend con 'Empresa'
            const empresa = row.empresa || row.Empresa || '';
            // Acumular totales
            totalIngresosBancos += row.ingresos_bancos;
            totalIngresosOdoo += row.ingresos_odoo;
            totalEgresosBancos += row.egresos_bancos;
            totalEgresosOdoo += row.egresos_odoo;
            totalDiffIngresos += row.diferencia_ingresos;
            totalDiffEgresos += row.diferencia_egresos;

            let diffIngresosClass = '';
            let diffEgresosClass = '';
            if (row.diferencia_ingresos !== 0) {
                diffIngresosClass = row.diferencia_ingresos > 0 ? 'diff-pos text-success fw-bold' : 'diff-neg text-danger fw-bold';
            }
            if (row.diferencia_egresos !== 0) {
                diffEgresosClass = row.diferencia_egresos > 0 ? 'diff-pos text-success fw-bold' : 'diff-neg text-danger fw-bold';
            }

            return `
                <tr>
                    <td>${row.fecha}</td>
                    <td>${empresa}</td>
                    <td>${row.tipo_banco || ''}</td>
                    <td class="text-end">${currencyFormatter.format(row.ingresos_bancos)}</td>
                    <td class="text-end">${currencyFormatter.format(row.ingresos_odoo)}</td>
                    <td class="text-end ${diffIngresosClass}">${currencyFormatter.format(row.diferencia_ingresos)}</td>
                    <td class="text-end">${currencyFormatter.format(row.egresos_bancos)}</td>
                    <td class="text-end">${currencyFormatter.format(row.egresos_odoo)}</td>
                    <td class="text-end ${diffEgresosClass}">${currencyFormatter.format(row.diferencia_egresos)}</td>
                </tr>
            `;
        }).join('');

        let totalDiffIngresosClass = '';
        let totalDiffEgresosClass = '';
        if (totalDiffIngresos !== 0) {
            totalDiffIngresosClass = totalDiffIngresos > 0 ? 'diff-pos text-success fw-bold' : 'diff-neg text-danger fw-bold';
        }
        if (totalDiffEgresos !== 0) {
            totalDiffEgresosClass = totalDiffEgresos > 0 ? 'diff-pos text-success fw-bold' : 'diff-neg text-danger fw-bold';
        }

        return `
            <div class="card mt-4">
                <div class="card-header"><h5 class="mb-0">Conciliación Diaria (Bancos vs. Odoo)</h5></div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered mb-0">
                        <thead class="table-light text-center" style="position: sticky; top: 0;">
                            <tr>
                                <th rowspan="2" class="align-middle">Fecha</th>
                                <th rowspan="2" class="align-middle">Empresa</th>
                                <th rowspan="2" class="align-middle">Tipo Banco</th>
                                <th colspan="3">Ingresos</th>
                                <th colspan="3">Egresos</th>
                            </tr>
                            <tr>
                                <th>Bancos</th><th>Odoo</th><th>Diferencia</th>
                                <th>Bancos</th><th>Odoo</th><th>Diferencia</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                        <tfoot class="table-group-divider">
                            <tr class="fw-bold">
                                <td>TOTALES</td>
                                <td></td>
                                <td></td>
                                <td class="text-end">${currencyFormatter.format(totalIngresosBancos)}</td>
                                <td class="text-end">${currencyFormatter.format(totalIngresosOdoo)}</td>
                                <td class="text-end ${totalDiffIngresosClass}">${currencyFormatter.format(totalDiffIngresos)}</td>
                                <td class="text-end">${currencyFormatter.format(totalEgresosBancos)}</td>
                                <td class="text-end">${currencyFormatter.format(totalEgresosOdoo)}</td>
                                <td class="text-end ${totalDiffEgresosClass}">${currencyFormatter.format(totalDiffEgresos)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>`;
    }

    // --- Filtro de Empresa ---

    let globalReportData = null;
    let globalEmpresaSeleccionada = '';
    let globalTipoBancoSeleccionado = '';
    let globalYear = '';
    let globalQuarter = '';
    let globalMonth = '';
    let globalDay = '';
    let currentView = 'report'; // 'report' | 'charts'
    let globalFechaInicio = '';
    let globalFechaFin = '';
    // Nuevos contenedores para guardar los resúmenes filtrados de ingresos/egresos (por tipo de flujo)
    let globalFilteredInflowsByType = null;
    let globalFilteredOutflowsByType = null;


    function updateEmpresaFilter(empresas) {
        const container = document.getElementById('empresa-filter-container');
        const select = document.getElementById('empresa-filter');
        if (!empresas || empresas.length === 0) {
            container.style.display = 'none';
            return;
        }
        select.innerHTML = '<option value="">(Todas las empresas)</option>' + empresas.map(e => `<option value="${e}">${e}</option>`).join('');
        container.style.display = '';
        if (globalEmpresaSeleccionada) {
            select.value = globalEmpresaSeleccionada;
        }
        select.onchange = function() {
            globalEmpresaSeleccionada = select.value;
            renderReport(globalReportData);
            updateBancoFilter(globalReportData); // refrescar lista de bancos dependiente de empresa
        };
    }

    function updateBancoFilter(data){
        const container = document.getElementById('banco-filter-container');
        const select = document.getElementById('banco-filter');
        if(!data || !Array.isArray(data.daily_comparison) || data.daily_comparison.length===0){
            container.style.display='none';
            return;
        }
        // Filtrar set de bancos según empresa seleccionada (para relevancia)
        let rows = data.daily_comparison;
        if (globalEmpresaSeleccionada){
            rows = rows.filter(r => (r.empresa || r.Empresa) === globalEmpresaSeleccionada);
        }
        const bancos = [...new Set(rows.map(r => (r.tipo_banco||'').trim()).filter(x=>x))].sort();
        select.innerHTML = '<option value="">(Todos)</option>' + bancos.map(b=>`<option value="${b}">${b}</option>`).join('');
        container.style.display='';
        if(globalTipoBancoSeleccionado){
            // Si la selección ya no existe (cambio de empresa) limpiar
            if(!bancos.includes(globalTipoBancoSeleccionado)) globalTipoBancoSeleccionado='';
            select.value = globalTipoBancoSeleccionado;
        }
        select.onchange = function(){
            globalTipoBancoSeleccionado = select.value;
            renderReport(globalReportData);
        };
    }

    // --- Filtros de Tiempo ---
    function updateTimeFilters(data) {
        const fechaInicioInput = document.getElementById('fecha-inicio');
        const fechaFinInput = document.getElementById('fecha-fin');
        const mesCompletoInput = document.getElementById('mes-completo');
        if (!data || !data.daily_comparison || data.daily_comparison.length === 0) return;
        document.getElementById('fecha-inicio-wrapper').style.display='block';
        document.getElementById('fecha-fin-wrapper').style.display='block';
        document.getElementById('mes-completo-wrapper').style.display='block';
        function syncDateRange(){
            globalFechaInicio = fechaInicioInput.value;
            globalFechaFin = fechaFinInput.value;
            if(mesCompletoInput && (fechaInicioInput.value==='' && fechaFinInput.value==='')){
                mesCompletoInput.value=''; // limpiar mes si el usuario borra manualmente las fechas
            }
            renderReport(globalReportData);
        }
        if(fechaInicioInput) fechaInicioInput.onchange = syncDateRange;
        if(fechaFinInput) fechaFinInput.onchange = syncDateRange;
        if(mesCompletoInput) mesCompletoInput.onchange = function(){
            const val = mesCompletoInput.value; // formato YYYY-MM
            if(!val){
                globalFechaInicio='';
                globalFechaFin='';
                if(fechaInicioInput) fechaInicioInput.value='';
                if(fechaFinInput) fechaFinInput.value='';
                renderReport(globalReportData);
                return;
            }
            const [yy, mm] = val.split('-');
            const first = yy+'-'+mm+'-01';
            const lastDay = new Date(Number(yy), Number(mm), 0).getDate(); // mes siguiente día 0
            const last = yy+'-'+mm+'-'+String(lastDay).padStart(2,'0');
            globalFechaInicio = first;
            globalFechaFin = last;
            if(fechaInicioInput) fechaInicioInput.value = first;
            if(fechaFinInput) fechaFinInput.value = last;
            renderReport(globalReportData);
        };
    }


    function filterDataByEmpresaYTiempo(data, empresa, year, month, day) {
        // Filtrar daily_comparison
    let filteredDaily = data.daily_comparison || [];
    if (empresa) filteredDaily = filteredDaily.filter(row => (row.empresa || row.Empresa) === empresa);
        if (globalTipoBancoSeleccionado) filteredDaily = filteredDaily.filter(row => (row.tipo_banco||'').trim() === globalTipoBancoSeleccionado);
        // Prioridad: rango de fechas si está definido
        if(globalFechaInicio){ filteredDaily = filteredDaily.filter(r => r.fecha >= globalFechaInicio); }
        if(globalFechaFin){ filteredDaily = filteredDaily.filter(r => r.fecha <= globalFechaFin); }
    // si no hay rango, no se aplica filtro adicional (filtros antiguos eliminados)

        // Nuevo filtrado para detalle completo
        function filterDetalle(det) {
            if (!Array.isArray(det)) return [];
            return det.filter(r => {
                if (empresa && r.empresa !== empresa) return false;
                if (globalTipoBancoSeleccionado && (r.banco||'').trim() !== globalTipoBancoSeleccionado) return false;
                if(globalFechaInicio && r.fecha < globalFechaInicio) return false;
                if(globalFechaFin && r.fecha > globalFechaFin) return false;
                // (filtros año/mes/día eliminados)
                return true;
            });
        }
        const detalleFiltrado = filterDetalle(data.odoo_detalle || []);
        function buildResumenFiltrado(resumen) {
            if (!resumen) return {};
            const validKeys = new Set(detalleFiltrado.map(r => (r.tipo_flujo||'SIN TIPO')+'||'+(r.tercero||'SIN TERCERO')));
            const res = {};
            for (const tf in resumen) {
                for (const ter in resumen[tf]) {
                    const key = (tf||'SIN TIPO')+'||'+(ter||'SIN TERCERO');
                    if (validKeys.has(key)) {
                        (res[tf] ||= {})[ter] = resumen[tf][ter];
                    }
                }
            }
            return res;
        }
        return { 
            daily_comparison: filteredDaily,
            inflows_by_type: buildResumenFiltrado(data.inflows_by_type),
            outflows_by_type: buildResumenFiltrado(data.outflows_by_type),
            detalle_filtrado: detalleFiltrado
        };
    }

    function recomputeResumenFiltered(filteredDaily, bancosMovs, inflowsResumen, outflowsResumen) {
        // Saldo inicial = suma de todos los bancos del PRIMER DIA de CADA MES visible (o primer día disponible si falta el 01)
        // Respeta filtro de empresa; ignora filtro de tipo banco.
        // Si hay rango de fechas, solo meses dentro del rango.
        const empresasSet = new Set(filteredDaily.map(r=> r.empresa || r.Empresa));
        const movimientos = bancosMovs || [];
        // Construir set de meses visibles a partir de daily (si hay) o de movimientos de saldo inicial.
        let mesesVisibles = new Set();
        if(filteredDaily.length){
            filteredDaily.forEach(r=> mesesVisibles.add(r.fecha.slice(0,7)));
        } else {
            movimientos.filter(m=>m.clasificacion==='saldo_inicial').forEach(m=> mesesVisibles.add(m.fecha.slice(0,7)));
        }
        // Aplicar rango de fechas (si existe) sobre meses visibles
        if(globalFechaInicio){
            const mesInicio = globalFechaInicio.slice(0,7);
            mesesVisibles = new Set([...mesesVisibles].filter(m=> m >= mesInicio));
        }
        if(globalFechaFin){
            const mesFin = globalFechaFin.slice(0,7);
            mesesVisibles = new Set([...mesesVisibles].filter(m=> m <= mesFin));
        }
        let saldoInicial = 0;
        // Por cada mes visible: sumar saldo_inicial del día 01; si no existe, usar primer día disponible de ese mes.
        [...mesesVisibles].sort().forEach(mes => {
            const primerDia = mes+'-01';
            // Filtrar movimientos de ese mes
            const movMes = movimientos.filter(m=> m.fecha.startsWith(mes) && m.clasificacion==='saldo_inicial' && (!empresasSet.size || empresasSet.has(m.empresa)));
            if(!movMes.length) return; // nada para ese mes
            const exactos = movMes.filter(m=> m.fecha===primerDia);
            const candidatos = exactos.length ? exactos : movMes.sort((a,b)=> a.fecha.localeCompare(b.fecha)).slice(0, movMes.length); // si no hay 01, usar todos (luego filtramos primer día disponible)
            let fechaBase = primerDia;
            if(!exactos.length){
                // obtener menor fecha del mes
                fechaBase = movMes.map(m=>m.fecha).sort()[0];
            }
            // Sumar todos los registros de saldo_inicial de esa fecha base
            candidatos.forEach(m=>{
                if(m.fecha===fechaBase){ saldoInicial += m.monto; }
            });
        });
        // Ingresos / Egresos dentro del rango de fechas seleccionado (si hay)
        const movsOperativos = movimientos.filter(m=>{
            if(empresasSet.size>0 && !empresasSet.has(m.empresa)) return false;
            if(globalFechaInicio && m.fecha < globalFechaInicio) return false;
            if(globalFechaFin && m.fecha > globalFechaFin) return false;
            return true;
        });
        let ingresos=0, egresos=0;
        movsOperativos.forEach(m=>{
            if(m.clasificacion==='ingreso') ingresos += m.monto;
            else if(m.clasificacion==='egreso') egresos += Math.abs(m.monto);
        });
        // Sumar GMF: intentar primero desde outflowsResumen (claves que contengan GMF),
        // si no hay, derivar desde detalle_filtrado (créditos cuyo movimiento contenga GMF)
        let egresosGMF = 0;
        let foundFromResumen = false;
        if(outflowsResumen){
            Object.keys(outflowsResumen).forEach(tf=>{
                if(/gmf/i.test(tf)){
                    Object.values(outflowsResumen[tf]).forEach(v=> egresosGMF += v);
                    foundFromResumen = true;
                }
            });
        }
        if(!foundFromResumen){
            // Intentar sumar desde movimientos bancos clasificados como egreso_gmf
            movsOperativos.forEach(m=>{
                if(m.clasificacion==='egreso_gmf') egresosGMF += Math.abs(m.monto);
            });
            if(egresosGMF===0){
                // Buscar en detalle filtrado globalReportData.odoo_detalle como fallback
                const det = (globalReportData && Array.isArray(globalReportData.odoo_detalle)) ? globalReportData.odoo_detalle : [];
                det.forEach(r=>{
                    if(r && typeof r.movimiento === 'string' && /gmf/i.test(r.movimiento)){
                        const val = (typeof r.credito === 'number') ? r.credito : 0;
                        egresosGMF += val;
                    }
                });
            }
        }
        return {
            saldo_inicial: saldoInicial,
            ingresos: ingresos,
            saldo_antes_egresos: saldoInicial + ingresos,
            egresos: egresos,
            egresos_gmf: egresosGMF,
            egresos_total: egresos + egresosGMF,
            saldo_final: saldoInicial + ingresos - (egresos + egresosGMF),
            inflows_by_type: inflowsResumen,
            outflows_by_type: outflowsResumen
        };
    }

    function renderReport(data) {
        const outputDiv = document.getElementById('report-output');
        if (!data) return;
        let filtered = filterDataByEmpresaYTiempo(data, globalEmpresaSeleccionada, globalYear, globalMonth, globalDay);
            outputDiv.innerHTML = `
                ${createComparisonTable(filtered.daily_comparison)}`;
        // Activar toggles
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-target');
                const row = document.getElementById(targetId);
                if (row) {
                    const hidden = row.classList.contains('d-none');
                    row.classList.toggle('d-none');
                    btn.textContent = hidden ? '-' : '+';
                }
            });
        });
        // Recalcular resumen con filtros
        const resumenFiltered = recomputeResumenFiltered(
            filtered.daily_comparison,
            globalReportData.bancos_movimientos,
            filtered.inflows_by_type,
            filtered.outflows_by_type
        );
    // Guardar breakdowns filtrados para usarlos en el modal/tabla de detalle
    globalFilteredInflowsByType = filtered.inflows_by_type;
    globalFilteredOutflowsByType = filtered.outflows_by_type;
    // Guardar detalle filtrado para drill-down
    window.globalFilteredDetalleFlujo = filtered.detalle_filtrado || [];
        renderResumenDirecto(resumenFiltered, true);
        // Si los breakdowns están visibles, refrescarlos en caliente
        const ingresosRow = document.getElementById('breakdown-ingresos');
        if(ingresosRow && !ingresosRow.classList.contains('d-none')){
            showBreakdown('ingresos', globalFilteredInflowsByType || globalReportData.inflows_by_type, true);
        }
        const egresosRow = document.getElementById('breakdown-egresos');
        if(egresosRow && !egresosRow.classList.contains('d-none')){
            showBreakdown('egresos', globalFilteredOutflowsByType || globalReportData.outflows_by_type, true);
        }
        if(currentView==='charts'){
            recomputeTopClientesEXWFiltered();
            recomputeTopProveedoresEgresosFiltered();
            recomputeIngresoEgresoFlujoCharts();
        }
    }

    function displayReport(data) {
        // Normalizar daily_comparison para asegurar 'empresa'
        if (Array.isArray(data.daily_comparison)) {
            data.daily_comparison = data.daily_comparison.map(r => ({...r, empresa: r.empresa || r.Empresa || ''}));
        }
        globalReportData = data;
    updateEmpresaFilter(data.todas_las_empresas);
    updateBancoFilter(data);
        updateTimeFilters(data);
        renderReport(data);
        document.getElementById('report-output').classList.remove('d-none');
        // Primera render sin filtros usa resumen_directo original
        renderResumenDirecto(data.resumen_directo, false);
    // Preparar gráfico inicial (oculto hasta que se cambie vista)
    precomputeBaseEXW();
    }
    function renderResumenDirecto(resumen, filtered) {
        const cont = document.getElementById('resumen-directo');
        if (!resumen) { cont.classList.add('d-none'); return; }
        cont.innerHTML = `
            <div class="col-12 col-sm-6 col-xl-2">
                <div class="card text-white bg-primary h-100 shadow-sm">
                    <div class="card-body p-3">
                        <div class="small fw-semibold">Saldo Inicial${filtered?' (F)':''}</div>
                        <div class="fs-6 fw-bold">${currencyFormatter.format(resumen.saldo_inicial||0)}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-2">
                <div class="card text-white bg-success h-100 shadow-sm position-relative">
                    <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-1" data-breakdown="ingresos" title="Ver detalle">+</button>
                    <div class="card-body p-3">
                        <div class="small fw-semibold">Ingresos${filtered?' (F)':''}</div>
                        <div class="fs-6 fw-bold">${currencyFormatter.format(resumen.ingresos||0)}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card text-white bg-info h-100 shadow-sm">
                    <div class="card-body p-3">
                        <div class="small fw-semibold">Saldo Antes de Egresos${filtered?' (F)':''}</div>
                        <div class="fs-6 fw-bold">${currencyFormatter.format(resumen.saldo_antes_egresos||0)}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-2">
                <div class="card text-white bg-danger h-100 shadow-sm position-relative">
                    <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-1" data-breakdown="egresos" title="Ver detalle">+</button>
                    <div class="card-body p-3">
                        <div class="small fw-semibold">Egresos (+GMF)${filtered?' (F)':''}</div>
                        <div class="fs-6 fw-bold">${currencyFormatter.format((resumen.egresos_total!=null)?resumen.egresos_total: (resumen.egresos||0)+(resumen.egresos_gmf||0))}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card text-white bg-dark h-100 shadow-sm">
                    <div class="card-body p-3">
                        <div class="small fw-semibold">Saldo Final${filtered?' (F)':''}</div>
                        <div class="fs-6 fw-bold">${currencyFormatter.format(resumen.saldo_final||0)}</div>
                    </div>
                </div>
            </div>`;
        cont.classList.remove('d-none');
        attachBreakdownHandlers();
        cont.classList.remove('d-none');
        attachBreakdownHandlers();
    }

    function attachBreakdownHandlers() {
        document.querySelectorAll('[data-breakdown]')
            .forEach(btn => btn.addEventListener('click', () => {
                const tipo = btn.getAttribute('data-breakdown');
                // Usar siempre las estructuras filtradas si existen
                if (tipo === 'ingresos') {
                    showBreakdown('ingresos', globalFilteredInflowsByType || globalReportData.inflows_by_type, 'Débito');
                } else if (tipo === 'egresos') {
                    showBreakdown('egresos', globalFilteredOutflowsByType || globalReportData.outflows_by_type, 'Crédito');
                }
            }));
        document.querySelectorAll('[data-close-breakdown]')
            .forEach(btn => btn.addEventListener('click', () => {
                const tipo = btn.getAttribute('data-close-breakdown');
                const row = document.getElementById(`breakdown-${tipo}`);
                if (row) row.classList.add('d-none');
            }));
    }

    function showBreakdown(tipo, nested, skipScroll) {
        const row = document.getElementById(`breakdown-${tipo}`);
        const tbody = document.getElementById(`tbody-breakdown-${tipo}`);
        if (!nested || !tbody) return;
        const detalle = window.globalFilteredDetalleFlujo || [];
        const isIngresos = (tipo==='ingresos');
        const valorKey = isIngresos ? 'debito' : 'credito';
        // Filtros internos
        const claseSelect = document.getElementById(`filtro-clase-${tipo}`);
        const subclaseSelect = document.getElementById(`filtro-subclase-${tipo}`);
        // Construir universo para opciones (solo registros con valor >0 segun tipo)
        const universo = detalle.filter(r => Number(r[valorKey])>0);
        const setClases = new Set();
        universo.forEach(r=>{ if(r.clase) setClases.add(r.clase.toUpperCase()); });
        // Mantener selección previa
        const prevClase = claseSelect ? claseSelect.value.toUpperCase() : '';
        if(claseSelect){
            claseSelect.innerHTML = '<option value="">(Todas)</option>' + Array.from(setClases).sort().map(c=>`<option value="${c}">${c}</option>`).join('');
            if(prevClase && setClases.has(prevClase)) claseSelect.value = prevClase; else claseSelect.value='';
        }
        // Subclases según clase seleccionada (si hay)
        let setSub = new Set();
        const claseFiltro = claseSelect ? (claseSelect.value||'').toUpperCase() : '';
        universo.forEach(r=>{
            if(!claseFiltro || (r.clase||'').toUpperCase()===claseFiltro){ if(r.subclase) setSub.add(r.subclase.toUpperCase()); }
        });
        const prevSub = subclaseSelect ? subclaseSelect.value.toUpperCase() : '';
        if(subclaseSelect){
            subclaseSelect.innerHTML = '<option value="">(Todas)</option>' + Array.from(setSub).sort().map(s=>`<option value="${s}">${s}</option>`).join('');
            if(prevSub && setSub.has(prevSub)) subclaseSelect.value = prevSub; else subclaseSelect.value='';
        }
        const subFiltro = subclaseSelect ? (subclaseSelect.value||'').toUpperCase() : '';
        // Reattach change events (idempotente)
        if(claseSelect && !claseSelect.dataset.bound){
            claseSelect.addEventListener('change', ()=> showBreakdown(tipo, nested, true));
            claseSelect.dataset.bound='1';
        }
        if(subclaseSelect && !subclaseSelect.dataset.bound){
            subclaseSelect.addEventListener('change', ()=> showBreakdown(tipo, nested, true));
            subclaseSelect.dataset.bound='1';
        }
        const rows = Object.keys(nested)
            .filter(flow => !/gmf/i.test(flow))
            .sort()
            .map(flow => {
                const total = Object.values(nested[flow]).reduce((a,b)=>a+b,0);
                // Detalle filtrado para este flow
                const detalleFlow = detalle.filter(r => (r.tipo_flujo||'').toUpperCase() === flow.toUpperCase())
                    .filter(r => Number(r[valorKey])>0)
                    .filter(r => !claseFiltro || (r.clase||'').toUpperCase()===claseFiltro)
                    .filter(r => !subFiltro || (r.subclase||'').toUpperCase()===subFiltro)
                    .sort((a,b)=> (a.clase||'').localeCompare(b.clase||'') || (a.subclase||'').localeCompare(b.subclase||'') || a.fecha.localeCompare(b.fecha));
                const detalleHTML = detalleFlow.length ? `
                    <div class='table-responsive mt-2'>
                        <table class='table table-sm table-bordered mb-0'>
                            <thead class='table-light'>
                                <tr><th style=\"width:90px;\">Fecha</th><th>Clase</th><th>Sub Clase</th><th>Tercero</th><th class='text-end'>${isIngresos?'Débito':'Crédito'}</th></tr>
                            </thead>
                            <tbody>
                                ${detalleFlow.map(d=>`<tr><td>${d.fecha||''}</td><td>${(d.clase||'').toUpperCase()}</td><td>${(d.subclase||'').toUpperCase()}</td><td>${(d.tercero||'').toUpperCase()}</td><td class='text-end'>${currencyFormatter.format(Number(d[valorKey])||0)}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>` : `<div class='text-muted small mt-2'>Sin movimientos</div>`;
                const id = 'flow_det_'+tipo+'_'+btoa(encodeURIComponent(flow)).replace(/=/g,'');
                return `
                <tr class='align-middle'>
                    <td>
                        <button class='btn btn-xs btn-outline-primary me-1 flow-expand-btn' data-target='${id}' style='--bs-btn-padding-y:.15rem; --bs-btn-padding-x:.35rem; font-size:.65rem;'>+</button>
                        ${flow}
                    </td>
                    <td class=\"text-end\">${currencyFormatter.format(total)}</td>
                </tr>
                <tr id='${id}' class='d-none'><td colspan='2'>${detalleHTML}</td></tr>`;
            }).join('');
        tbody.innerHTML = rows || '<tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>';
        // Eventos expandir/colapsar
        tbody.querySelectorAll('.flow-expand-btn').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const targetId = btn.getAttribute('data-target');
                const detailRow = document.getElementById(targetId);
                if(!detailRow) return;
                const hidden = detailRow.classList.contains('d-none');
                detailRow.classList.toggle('d-none');
                btn.textContent = hidden ? '-' : '+';
            });
        });
        row.classList.remove('d-none');
        if(!skipScroll){
            row.scrollIntoView({behavior:'smooth', block:'center'});
        }
    }

    // ------ GRAFICA TOP CLIENTES VENTAS EXW CTG ------
    let topClientesChart = null;
    let baseEXW = null; // datos base sin filtros (estructura clientes/subclases)
    let chartClaseSelect = null;
    let chartSubclaseSelect = null;
    const ALLOWED_CLASSES = ['ANTICIPO VENTAS FOB CTG','VENTAS EXW CTG'];
    // Configuración para proveedores (egresos)
    // Para proveedores (egresos) detectaremos dinámicamente las clases presentes (excluyendo clases de ventas)
    const SALES_CLASSES = ['VENTAS EXW CTG','ANTICIPO VENTAS FOB CTG'];
    let proveedoresChart = null;
    let ingresosFlujoChart = null;
    let egresosFlujoChart = null;
    let provTfSelect = null, provClaseSelect = null, provSubclaseSelect = null;
    const EXCLUDE_KEYWORDS = ['RENTA','UVA','MGO'];
    let facturasData = [];
    let facturasPorClienteBase = new Map(); // sin filtros de tiempo
    let facturasPorCliente = new Map(); // filtrado actual
    function aplicarFiltrosFacturas(){
        facturasPorCliente = new Map();
        facturasPorClienteBase.forEach((lista, cli)=>{
            const filtradas = lista.filter(f=>{
                if(globalYear && !(f.fecha||'').startsWith(globalYear)) return false;
                if(globalMonth && (f.fecha||'').slice(5,7)!==globalMonth) return false;
                if(globalDay && (f.fecha||'').slice(8,10)!==globalDay) return false;
                return true;
            });
            if(filtradas.length){
                filtradas.sort((a,b)=> (b.valor||0)-(a.valor||0));
                facturasPorCliente.set(cli, filtradas);
            }
        });
    }

    function updateProvClaseSubOptions(detalleElegible){
        if(!provClaseSelect) provClaseSelect = document.getElementById('prov-clase-filter');
        if(!provSubclaseSelect) provSubclaseSelect = document.getElementById('prov-subclase-filter');
        if(!provClaseSelect || !provSubclaseSelect) return;
        if(!detalleElegible || detalleElegible.length===0){
            provClaseSelect.innerHTML = '<option value="">(Sin datos)</option>';
            provSubclaseSelect.innerHTML = '<option value="">(Sin datos)</option>';
            return;
        }
        // Detectar clases distintas de ventas (para egresos) presentes realmente
        const clasesDisp = Array.from(new Set(detalleElegible.map(r=> (r.clase||'').toUpperCase()).filter(c=> c && !SALES_CLASSES.includes(c))));
        const clasesFiltradas = clasesDisp.sort();
        const prev = (provClaseSelect.value||'').toUpperCase();
        provClaseSelect.innerHTML = '<option value="">(Auto)</option>' + clasesFiltradas.map(c=>`<option value="${c}">${c}</option>`).join('');
        let selected = prev && clasesFiltradas.includes(prev) ? prev : '';
        provClaseSelect.value = selected;
        let subclases = [];
        if(selected){
            subclases = Array.from(new Set(detalleElegible.filter(r=> (r.clase||'').toUpperCase()===selected).map(r=> (r.subclase||'SIN SUBCLASE')))).sort();
        } else {
            subclases = Array.from(new Set(detalleElegible.filter(r=> clasesFiltradas.includes((r.clase||'').toUpperCase())).map(r=> (r.subclase||'SIN SUBCLASE')))).sort();
        }
        const prevSub = provSubclaseSelect.value;
        provSubclaseSelect.innerHTML = '<option value="">(Todas)</option>' + subclases.map(s=>`<option value="${s}">${s}</option>`).join('');
        if(prevSub && subclases.includes(prevSub)) provSubclaseSelect.value = prevSub; else provSubclaseSelect.value='';
    }

    function attachProveedorFilters(){
        if(!provTfSelect) provTfSelect = document.getElementById('prov-tf-filter');
        if(!provClaseSelect) provClaseSelect = document.getElementById('prov-clase-filter');
        if(!provSubclaseSelect) provSubclaseSelect = document.getElementById('prov-subclase-filter');
        if(!provTfSelect || provTfSelect.dataset.eventsBound) return;
        provTfSelect.addEventListener('change', recomputeTopProveedoresEgresosFiltered);
        provClaseSelect.addEventListener('change', ()=>{ recomputeTopProveedoresEgresosFiltered(); });
        provSubclaseSelect.addEventListener('change', recomputeTopProveedoresEgresosFiltered);
        provTfSelect.dataset.eventsBound='1';
    }

    function recomputeTopProveedoresEgresosFiltered(){
        if(!globalReportData || !globalReportData.odoo_detalle){ renderTopProveedoresEgresos(null); return; }
        const detalle = globalReportData.odoo_detalle.filter(r=>{
            if(globalEmpresaSeleccionada && r.empresa !== globalEmpresaSeleccionada) return false;
            if(globalYear && !r.fecha.startsWith(globalYear)) return false;
            if(globalQuarter){ const qm = quarterMonths(globalQuarter); if(!qm.includes(r.fecha.slice(5,7))) return false; }
            else if(globalMonth && r.fecha.slice(5,7)!==globalMonth) return false;
            if(globalDay && r.fecha.slice(8,10)!==globalDay) return false;
            return true;
        });
        // Primero filtrar sólo registros de egresos verdaderos (egresos en Odoo suelen ser crédito > 0)
        const potencialesEgresos = detalle.filter(r=> (Number(r.credito)||0) > 0 || (Number(r.debito)||0) < 0);
        const tfSel = (provTfSelect && provTfSelect.value) ? provTfSelect.value.toUpperCase() : '';
        // Filtrar por tipo flujo (operación / inversión) si aplica
        const egresosTipo = potencialesEgresos.filter(r=>{
            const tipoFlujo = (r.tipo_flujo||'').toUpperCase();
            const esOper = /OPERACION|OPERACIÓN/.test(tipoFlujo);
            const esInv = /INVERSION|INVERSI[ÓO]N/.test(tipoFlujo);
            if(tfSel==='OPERACION') return esOper;
            if(tfSel==='INVERSION') return esInv;
            // Auto: incluir solo operación o inversión
            return esOper || esInv;
        });
        // Actualizar selects con registros elegibles
        updateProvClaseSubOptions(egresosTipo);
        attachProveedorFilters();
        const claseSel = (provClaseSelect && provClaseSelect.value) ? provClaseSelect.value.toUpperCase() : '';
        const subSel = (provSubclaseSelect && provSubclaseSelect.value) ? provSubclaseSelect.value.toUpperCase() : '';
        const filtrado = egresosTipo.filter(r=>{
            const claseDato = (r.clase||'').toUpperCase();
            const subDato = (r.subclase||'SIN SUBCLASE').toUpperCase();
            if(claseSel && claseDato!==claseSel) return false;
            if(subSel && subDato!==subSel) return false;
            // Excluir keywords
            if(EXCLUDE_KEYWORDS.some(k=> claseDato.includes(k) || subDato.includes(k))) return false;
            return true;
        });
        if(filtrado.length===0){ renderTopProveedoresEgresos({proveedores:[], total_general:0}); return; }
        const mapProv = new Map(); // proveedor -> total credito
        filtrado.forEach(r=>{
            const prov = (r.tercero || 'SIN PROVEEDOR') || 'SIN PROVEEDOR';
            const val = Number(r.credito||0) > 0 ? Number(r.credito||0) : ( (Number(r.debito)||0) < 0 ? Math.abs(Number(r.debito)||0) : 0 );
            mapProv.set(prov, (mapProv.get(prov)||0)+val);
        });
        let arrProv = Array.from(mapProv.entries()).map(([proveedor,total])=>({proveedor,total}));
        arrProv.sort((a,b)=>b.total-a.total);
        arrProv = arrProv.slice(0,10);
        renderTopProveedoresEgresos({proveedores:arrProv, total_general: arrProv.reduce((a,c)=>a+c.total,0)});
    }

    function renderTopProveedoresEgresos(payload){
        const canvas = document.getElementById('chartTopProveedoresEgresos');
        if(!canvas) return;
        const containerInfo = document.getElementById('total-proveedores-egresos');
    if(!payload || !payload.proveedores || payload.proveedores.length===0){
            containerInfo.textContent = 'Sin datos';
            if(proveedoresChart){ proveedoresChart.destroy(); proveedoresChart=null; }
            return;
        }
    containerInfo.textContent = 'Total filtrado: '+currencyFormatter.format(payload.total_general||0);
    const labels = payload.proveedores.map(p=>p.proveedor);
    const dataVals = payload.proveedores.map(p=>p.total);
        const colors = labels.map((_,i)=> ['#dc3545','#fd7e14','#ffc107','#198754','#0dcaf0','#6c757d','#343a40','#0d6efd','#6610f2','#6f42c1'][i%10]);
        const ctx = canvas.getContext('2d');
        if(proveedoresChart) proveedoresChart.destroy();
        proveedoresChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Crédito', data: dataVals, backgroundColor: colors }] },
            options: {
                plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: c=> 'Crédito: '+currencyFormatter.format(c.parsed.y||0) } } },
                scales:{
                    x:{
                        ticks:{
                            autoSkip:false,
                            maxRotation:0,
                            minRotation:0,
                            callback:function(val){
                                const label = this.getLabelForValue ? this.getLabelForValue(val) : '';
                                const maxChars=14; const words=label.split(' ');
                                const lines=[]; let line='';
                                words.forEach(w=>{
                                    if((line+w).length>maxChars){ if(line) lines.push(line.trim()); line=w+' '; } else { line+=w+' '; }
                                });
                                if(line) lines.push(line.trim());
                                return lines.length>3 ? lines.slice(0,2).concat('…') : lines;
                            }
                        }
                    },
                    y:{ ticks:{ callback:v=>currencyFormatter.format(v) } }
                },
                responsive:true,
                interaction:{ mode:'index', intersect:false }
            }
        });
    }

    function updateChartClaseSubclaseOptions(detalle){
        if(!chartClaseSelect) chartClaseSelect = document.getElementById('chart-clase-filter');
        if(!chartSubclaseSelect) chartSubclaseSelect = document.getElementById('chart-subclase-filter');
        if(!chartClaseSelect || !chartSubclaseSelect) return;
        if(!detalle || detalle.length===0){
            chartClaseSelect.innerHTML = '<option value="">(Sin datos)</option>';
            chartSubclaseSelect.innerHTML = '<option value="">(Sin datos)</option>';
            return;
        }
    const clasesDisponiblesSet = new Set(detalle.map(r=> (r.clase||'').toUpperCase()));
    const clasesFiltradas = ALLOWED_CLASSES.filter(c=> clasesDisponiblesSet.has(c));
        const prevClase = (chartClaseSelect.value||'').toUpperCase();
        // Construir opciones mostrando solo las permitidas presentes
        chartClaseSelect.innerHTML = '<option value="">(Auto)</option>' + clasesFiltradas.map(c=>`<option value="${c}">${c}</option>`).join('');
        let selectedClase = prevClase && clasesFiltradas.includes(prevClase) ? prevClase : '';
        if(!selectedClase){
            if(clasesFiltradas.includes('VENTAS EXW CTG')) selectedClase = 'VENTAS EXW CTG';
            else if(clasesFiltradas.includes('ANTICIPO VENTAS FOB CTG')) selectedClase = 'ANTICIPO VENTAS FOB CTG';
        }
        chartClaseSelect.value = selectedClase;
        // Subclases derivadas
        let subclases = [];
        if(selectedClase){
            subclases = Array.from(new Set(detalle.filter(r=> (r.clase||'').toUpperCase()===selectedClase).map(r=> (r.subclase||'SIN SUBCLASE')))).sort();
        } else {
            // Auto: subclases de cualquier clase permitida (solo las permitidas)
            subclases = Array.from(new Set(detalle.filter(r=> ALLOWED_CLASSES.includes((r.clase||'').toUpperCase())).map(r=> (r.subclase||'SIN SUBCLASE')))).sort();
        }
        const prevSub = chartSubclaseSelect.value;
        chartSubclaseSelect.innerHTML = '<option value="">(Todas)</option>' + subclases.map(s=>`<option value="${s}">${s}</option>`).join('');
        if(prevSub && subclases.includes(prevSub)) chartSubclaseSelect.value = prevSub; else chartSubclaseSelect.value='';
    }

    function attachChartInternalFilters(){
        if(!chartClaseSelect) chartClaseSelect = document.getElementById('chart-clase-filter');
        if(!chartSubclaseSelect) chartSubclaseSelect = document.getElementById('chart-subclase-filter');
        if(!chartClaseSelect || !chartSubclaseSelect) return;
        if(chartClaseSelect.dataset.eventsBound) return;
        chartClaseSelect.addEventListener('change', ()=>{
            if(globalReportData && globalReportData.odoo_detalle){
                const detalleFiltrado = globalReportData.odoo_detalle.filter(r=>{
                    if(globalEmpresaSeleccionada && r.empresa !== globalEmpresaSeleccionada) return false;
                    if(globalYear && !r.fecha.startsWith(globalYear)) return false;
                    if(globalMonth && r.fecha.slice(5,7)!==globalMonth) return false;
                    if(globalDay && r.fecha.slice(8,10)!==globalDay) return false;
                    return true;
                });
                updateChartClaseSubclaseOptions(detalleFiltrado);
            }
            recomputeTopClientesEXWFiltered();
            renderFacturacionGlobal();
        });
        chartSubclaseSelect.addEventListener('change', ()=> recomputeTopClientesEXWFiltered());
        chartClaseSelect.dataset.eventsBound='1';
    }
    function renderTopClientesEXW(payload){
        const chartsView = document.getElementById('charts-view');
        if(currentView!=='charts') return; // sólo dibujar si vista activa
        if(!payload || !payload.clientes || payload.clientes.length===0){
            chartsView.classList.remove('d-none');
            document.getElementById('chartTopClientesEXW').replaceWith(document.getElementById('chartTopClientesEXW').cloneNode(true));
            return;
        }
        chartsView.classList.remove('d-none');
        document.getElementById('total-exw-general').textContent = 'Total filtrado: ' + currencyFormatter.format(payload.total_general||0);
        const labels = payload.clientes.map(c=>c.cliente);
        // Obtener todas las subclases únicas
        const subSet = new Set();
        payload.clientes.forEach(c=> (c.subclases||[]).forEach(s=> subSet.add(s.subclase)) );
        const subclases = Array.from(subSet).sort();
        // Construir datasets apilados
        const colors = [
            '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107',
            '#198754','#20c997','#0dcaf0','#6c757d','#343a40'
        ];
        const datasets = subclases.map((sub,idx)=>{
            return {
                label: sub,
                data: labels.map(cli=> {
                    const clienteObj = payload.clientes.find(c=>c.cliente===cli);
                    const subObj = (clienteObj.subclases||[]).find(s=>s.subclase===sub);
                    return subObj ? subObj.total : 0;
                }),
                backgroundColor: colors[idx % colors.length],
                stack: 'stack1'
            };
        });
        const ctx = document.getElementById('chartTopClientesEXW').getContext('2d');
        if(topClientesChart){ topClientesChart.destroy(); }
    const claseActual = chartClaseSelect ? (chartClaseSelect.value||'').toUpperCase() : '';
    // Mostrar facturas para EXW y FOB
    const facturasHabilitadas = ['VENTAS EXW CTG','ANTICIPO VENTAS FOB CTG'].includes(claseActual);
        topClientesChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context){
                                const val = context.parsed.y||0;
                                if(!val) return null; // omitir líneas con 0
                                return context.dataset.label+': '+currencyFormatter.format(val);
                            },
                            afterBody: function(items){
                                if(!facturasHabilitadas) return;
                                if(!items || !items.length) return;
                                const cli = items[0].label;
                                const arr = facturasPorCliente.get(cli.toUpperCase());
                                if(!arr || !arr.length) return;
                                const totalCop = arr.reduce((a,f)=> a + (f.valor||0), 0);
                                const totalBbl = arr.reduce((a,f)=> a + (f.bbl||0), 0);
                                const totalGln = arr.reduce((a,f)=> a + (f.gln||0), 0);
                                const totalTon = arr.reduce((a,f)=> a + (f.ton||0), 0);
                                const result = [`Total COP$: ${currencyFormatter.format(totalCop)}`];
                                if(totalBbl) result.push(`Total Bbl: ${totalBbl.toLocaleString('es-CO')}`);
                                if(totalGln) result.push(`Total Gln: ${totalGln.toLocaleString('es-CO')}`);
                                if(totalTon) result.push(`Total Ton: ${totalTon.toLocaleString('es-CO')}`);
                                return result;
                            }
                        }
                    },
                    legend: { position: 'bottom' }
                },
                onClick: (evt, elements)=>{
                    if(!facturasHabilitadas) return; // solo mostrar panel cuando clase permitida
                    if(!elements || !elements.length) return;
                    const idx = elements[0].index;
                    const cli = topClientesChart.data.labels[idx];
                    const arr = facturasPorCliente.get(cli.toUpperCase())||[];
                    const panel = document.getElementById('facturas-cliente-panel');
                    const tbody = document.getElementById('facturas-cliente-tbody');
                    const tit = document.getElementById('facturas-cliente-titulo');
                    // Ajustar encabezado de la tabla según clase (EXW sin Etiqueta, FOB con Etiqueta)
                    const panelTable = panel.querySelector('table');
                    const thead = panelTable.querySelector('thead');
                    const tfoot = panelTable.querySelector('tfoot');
                    if(claseActual==='ANTICIPO VENTAS FOB CTG'){
                        thead.innerHTML = `<tr><th>Número</th><th>Etiqueta</th><th>Fecha</th><th class='text-end'>COP$</th><th class='text-end'>Bbl</th><th class='text-end'>Gln</th><th class='text-end'>Ton</th></tr>`;
                        tfoot.innerHTML = `<tr><th colspan='3'>Total</th><th class='text-end' id='facturas-cliente-total-cop'></th><th class='text-end' id='facturas-cliente-total-bbl'></th><th class='text-end' id='facturas-cliente-total-gln'></th><th class='text-end' id='facturas-cliente-total-ton'></th></tr>`;
                    } else {
                        thead.innerHTML = `<tr><th>Número</th><th>Fecha</th><th class='text-end'>COP$</th><th class='text-end'>Bbl</th><th class='text-end'>Gln</th><th class='text-end'>Ton</th></tr>`;
                        tfoot.innerHTML = `<tr><th colspan='2'>Total</th><th class='text-end' id='facturas-cliente-total-cop'></th><th class='text-end' id='facturas-cliente-total-bbl'></th><th class='text-end' id='facturas-cliente-total-gln'></th><th class='text-end' id='facturas-cliente-total-ton'></th></tr>`;
                    }
                    if(!panel) return;
                    tit.textContent = 'Facturas de '+cli;
                    if(!arr.length){
                        const colSpan = (claseActual==='ANTICIPO VENTAS FOB CTG')?7:6;
                        tbody.innerHTML = `<tr><td colspan='${colSpan}' class='text-muted text-center'>Sin facturas cargadas</td></tr>`;
                        document.getElementById('facturas-cliente-total-cop').textContent='';
                        document.getElementById('facturas-cliente-total-bbl').textContent='';
                        document.getElementById('facturas-cliente-total-gln').textContent='';
                        document.getElementById('facturas-cliente-total-ton').textContent='';
                    } else {
                        let totalCop=0, totalBbl=0, totalGln=0, totalTon=0, hasBbl=false, hasGln=false, hasTon=false;
                        tbody.innerHTML = arr.map(f=>{
                            totalCop += f.valor||0; 
                            totalBbl += f.bbl||0; if(f.bbl) hasBbl=true;
                            totalGln += f.gln||0; if(f.gln) hasGln=true;
                            totalTon += f.ton||0; if(f.ton) hasTon=true;
                            
                            if(claseActual==='ANTICIPO VENTAS FOB CTG'){
                                return `<tr>
                                    <td>${f.factura}</td>
                                    <td>${f.etiqueta||''}</td>
                                    <td>${f.fecha||''}</td>
                                    <td class='text-end'>${currencyFormatter.format(f.valor||0)}</td>
                                    <td class='text-end'>${f.bbl? f.bbl.toLocaleString('es-CO') : ''}</td>
                                    <td class='text-end'>${f.gln? f.gln.toLocaleString('es-CO') : ''}</td>
                                    <td class='text-end'>${f.ton? f.ton.toLocaleString('es-CO') : ''}</td>
                                </tr>`;
                            }
                            return `<tr>
                                <td>${f.factura}</td>
                                <td>${f.fecha||''}</td>
                                <td class='text-end'>${currencyFormatter.format(f.valor||0)}</td>
                                <td class='text-end'>${f.bbl? f.bbl.toLocaleString('es-CO') : ''}</td>
                                <td class='text-end'>${f.gln? f.gln.toLocaleString('es-CO') : ''}</td>
                                <td class='text-end'>${f.ton? f.ton.toLocaleString('es-CO') : ''}</td>
                            </tr>`;
                        }).join('');
                        
                        document.getElementById('facturas-cliente-total-cop').textContent = currencyFormatter.format(totalCop);
                        document.getElementById('facturas-cliente-total-bbl').textContent = hasBbl ? totalBbl.toLocaleString('es-CO') : '';
                        document.getElementById('facturas-cliente-total-gln').textContent = hasGln ? totalGln.toLocaleString('es-CO') : '';
                        document.getElementById('facturas-cliente-total-ton').textContent = hasTon ? totalTon.toLocaleString('es-CO') : '';
                    }
                    panel.classList.remove('d-none');
                    panel.scrollIntoView({behavior:'smooth', block:'nearest'});
                },
                scales: {
                    x: { 
                        stacked: true,
                        ticks: {
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0,
                            callback: function(val, idx){
                                // Obtener etiqueta original
                                const label = this.getLabelForValue ? this.getLabelForValue(val) : (Array.isArray(val)? val.join(' '): val);
                                if(!label) return '';
                                const maxChars = 14; // caracteres por línea
                                const words = label.split(' ');
                                const lines = [];
                                let line = '';
                                words.forEach(w=>{
                                    if((line + w).length > maxChars){
                                        if(line) lines.push(line.trim());
                                        line = w + ' ';
                                    } else {
                                        line += w + ' ';
                                    }
                                });
                                if(line) lines.push(line.trim());
                                // Limitar a 3 líneas y truncar con elipsis si excede
                                if(lines.length > 3){
                                    return lines.slice(0,2).concat('…');
                                }
                                return lines;
                            }
                        }
                    },
                    y: { stacked: true, ticks:{ callback: value=> currencyFormatter.format(value) } }
                },
                layout: { padding: { bottom: 10 } }
            }
        });
    }

    async function handleFacturacion(e){
        const file = e.target.files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append('archivo_excel', file);
        try{
            const resp = await fetch('/api/procesar_facturacion', {method:'POST', body: formData});
            const data = await resp.json();
            if(!data.success) throw new Error(data.message||'Error procesando facturación');
            
            // Debug: Mostrar estructura de datos
            console.log('Datos de facturación recibidos:', data);
            if(data.facturas && data.facturas.length > 0) {
                console.log('Primera factura:', data.facturas[0]);
                console.log('Columnas disponibles en primera factura:', Object.keys(data.facturas[0]));
            }
            
            facturasData = data.facturas||[];
            facturasPorClienteBase = new Map();
            facturasData.forEach(f=>{
                const cli = (f.tercero||'SIN TERCERO').toUpperCase();
                if(!facturasPorClienteBase.has(cli)) facturasPorClienteBase.set(cli, []);
                facturasPorClienteBase.get(cli).push(f);
            });
            aplicarFiltrosFacturas();
            if(currentView==='charts') recomputeTopClientesEXWFiltered();
            renderFacturacionGlobal();
        }catch(err){
            alert('Error: '+err.message);
        }
    }
    function precomputeBaseEXW(){
        baseEXW = globalReportData && globalReportData.top_clientes_ventas_exw ? globalReportData.top_clientes_ventas_exw : null;
    }
    function recomputeTopClientesEXWFiltered(){
        if(!globalReportData || !globalReportData.odoo_detalle){
            renderTopClientesEXW(null); return;
        }
    // Reaplicar filtros de facturas por tiempo
    aplicarFiltrosFacturas();
    // Filtrar detalle por vista seleccionada
        const detalle = globalReportData.odoo_detalle.filter(r=>{
            if(globalEmpresaSeleccionada && r.empresa !== globalEmpresaSeleccionada) return false;
            if(globalYear && !r.fecha.startsWith(globalYear)) return false;
            if(globalQuarter){ const qm = quarterMonths(globalQuarter); if(!qm.includes(r.fecha.slice(5,7))) return false; }
            else if(globalMonth && r.fecha.slice(5,7)!==globalMonth) return false;
            if(globalDay && r.fecha.slice(8,10)!==globalDay) return false;
            return true;
        });
        updateChartClaseSubclaseOptions(detalle);
        attachChartInternalFilters();
        const selectedClaseRaw = chartClaseSelect ? chartClaseSelect.value : '';
        const selectedClase = selectedClaseRaw.toUpperCase();
        const selectedSubRaw = chartSubclaseSelect ? chartSubclaseSelect.value : '';
        const selectedSub = selectedSubRaw.toUpperCase();
        const incluirAmbas = !selectedClase; // modo Auto: combinar ambas permitidas
        const exw = detalle.filter(r=> {
            const claseDato = (r.clase||'').toUpperCase();
            if(incluirAmbas){
                if(!ALLOWED_CLASSES.includes(claseDato)) return false;
            } else {
                if(claseDato !== selectedClase) return false;
            }
            if(selectedSub && ( (r.subclase||'SIN SUBCLASE').toUpperCase() !== selectedSub)) return false;
            return true;
        });
        if(exw.length===0){ renderTopClientesEXW({clientes:[], total_general:0}); return; }
        const map = new Map();
        exw.forEach(r=>{
            const cli = r.tercero || 'SIN TERCERO';
            const sub = r.subclase || 'SIN SUBCLASE';
            const val = Number(r.debito||0);
            if(!map.has(cli)) map.set(cli, new Map());
            const inner = map.get(cli);
            inner.set(sub, (inner.get(sub)||0)+val);
        });
        let arr = Array.from(map.entries()).map(([cli, inner])=>({
            cliente: cli,
            total: Array.from(inner.values()).reduce((a,b)=>a+b,0),
            subclases: Array.from(inner.entries()).map(([sub,total])=>({subclase:sub,total}))
        }));
        arr.sort((a,b)=>b.total-a.total);
        arr = arr.slice(0,10);
    renderTopClientesEXW({clientes:arr,total_general:arr.reduce((a,c)=>a+c.total,0)});
    renderFacturacionGlobal();
    }

    // ---- Graficas Ingresos / Egresos por Tipo de Flujo ----
    function recomputeIngresoEgresoFlujoCharts(){
        if(!globalReportData || !globalReportData.odoo_detalle) return;
        const tfSelect = document.getElementById('tf-tercero-filter');
        const claseSelect = document.getElementById('tf-tercero-clase-filter');
        const tfFiltro = tfSelect ? (tfSelect.value||'').toUpperCase() : '';
        const claseFiltro = claseSelect ? (claseSelect.value||'').toUpperCase() : '';
        // Base filtrada por empresa/tiempo
        const base = globalReportData.odoo_detalle.filter(r=>{
            if(globalEmpresaSeleccionada && r.empresa !== globalEmpresaSeleccionada) return false;
            // Rango de fechas (prioritario)
            if(globalFechaInicio && r.fecha < globalFechaInicio) return false;
            if(globalFechaFin && r.fecha > globalFechaFin) return false;
            // (Compatibilidad con antiguos filtros año/mes si en algún lugar se reactivan)
            if(!globalFechaInicio && !globalFechaFin){
                if(globalYear && !r.fecha.startsWith(globalYear)) return false;
                if(globalQuarter){ const qm = quarterMonths(globalQuarter); if(!qm.includes(r.fecha.slice(5,7))) return false; }
                else if(globalMonth && r.fecha.slice(5,7)!==globalMonth) return false;
                if(globalDay && r.fecha.slice(8,10)!==globalDay) return false;
            }
            // Filtro de tipo banco (coincide con daily_comparison en campo tipo_banco -> aquí 'banco')
            if(globalTipoBancoSeleccionado && (r.banco||'').trim() !== globalTipoBancoSeleccionado) return false;
            return true;
        });
        // Poblar tipos de flujo (siempre actualizar para reflejar filtros globales)
        if(tfSelect){
            const prev = tfSelect.value.toUpperCase();
            const tipos = Array.from(new Set(base.map(r=> (r.tipo_flujo||'SIN TIPO').toUpperCase()))).sort();
            tfSelect.innerHTML = '<option value="">(Todos)</option>'+tipos.map(t=>`<option value="${t}">${t}</option>`).join('');
            if(prev && tipos.includes(prev)) tfSelect.value = prev; else tfSelect.value='';
            if(!tfSelect.dataset.eventsBound){
                tfSelect.addEventListener('change', ()=>{ recomputeIngresoEgresoFlujoCharts(); });
                tfSelect.dataset.eventsBound='1';
            }
        }
        // Aplicar filtro de tipo flujo
        const trasTipo = base.filter(r=> !tfFiltro || (r.tipo_flujo||'SIN TIPO').toUpperCase()===tfFiltro);
        // Poblar clases a partir del subconjunto filtrado por tipo
        if(claseSelect){
            const prevClase = claseSelect.value.toUpperCase();
            const clases = Array.from(new Set(trasTipo.map(r=> (r.clase||'SIN CLASE').toUpperCase()))).sort();
            claseSelect.innerHTML = '<option value="">(Todas)</option>'+clases.map(c=>`<option value="${c}">${c}</option>`).join('');
            if(prevClase && clases.includes(prevClase)) claseSelect.value = prevClase; else claseSelect.value='';
            if(!claseSelect.dataset.eventsBound){
                claseSelect.addEventListener('change', ()=>{ recomputeIngresoEgresoFlujoCharts(); });
                claseSelect.dataset.eventsBound='1';
            }
        }
        const detFiltrado = trasTipo.filter(r=> !claseFiltro || (r.clase||'SIN CLASE').toUpperCase()===claseFiltro);
        // Agrupar por tercero
        const ingresosMap = new Map();
        const egresosMap = new Map();
        detFiltrado.forEach(r=>{
            const tercero = (r.tercero||'SIN TERCERO').toUpperCase();
            const deb = Number(r.debito)||0;
            const cred = Number(r.credito)||0;
            if(deb>0) ingresosMap.set(tercero,(ingresosMap.get(tercero)||0)+deb);
            if(cred>0) egresosMap.set(tercero,(egresosMap.get(tercero)||0)+cred);
        });
        let ingresosArr = Array.from(ingresosMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
        let egresosArr = Array.from(egresosMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
        renderTercerosChart('chartIngresosFlujo', ingresosArr, 'Débito', 'ingresos-flujo-total', ingresosArr.reduce((a,c)=>a+c[1],0));
        renderTercerosChart('chartEgresosFlujo', egresosArr, 'Crédito', 'egresos-flujo-total', egresosArr.reduce((a,c)=>a+c[1],0));
    }

    function renderTercerosChart(canvasId, dataPairs, serieLabel, totalSpanId, total){
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const span = document.getElementById(totalSpanId);
        if(!dataPairs.length){
            span.textContent = 'Sin datos';
            if(canvas._chartInstance){ canvas._chartInstance.destroy(); canvas._chartInstance=null; }
            return;
        }
        span.textContent = 'Total: '+currencyFormatter.format(total);
        const labels = dataPairs.map(p=>p[0]);
        const values = dataPairs.map(p=>p[1]);
        const palette = ['#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997','#0dcaf0','#6c757d','#343a40'];
        if(canvas._chartInstance) canvas._chartInstance.destroy();
        const ctx = canvas.getContext('2d');
        canvas._chartInstance = new Chart(ctx, {
            type:'bar',
            data:{ labels, datasets:[{ label: serieLabel, data: values, backgroundColor: labels.map((_,i)=>palette[i%palette.length]) }] },
            options:{
                responsive:true,
                plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: c=> serieLabel+': '+currencyFormatter.format(c.parsed.y||0) } } },
                scales:{
                    x:{
                        ticks:{ display:false }, // ocultar etiquetas eje X para ganar espacio
                        grid:{ display:false }
                    },
                    y:{ ticks:{ callback:v=>currencyFormatter.format(v) } }
                },
                layout:{ padding:{ bottom:0 } }
            }
        });
    }

    function renderFacturacionGlobal(){
        const card = document.getElementById('facturacion-global-card');
        if(!card) return;
        const claseActual = chartClaseSelect ? (chartClaseSelect.value||'').toUpperCase() : '';
    if(!['VENTAS EXW CTG','ANTICIPO VENTAS FOB CTG'].includes(claseActual)){
            card.style.display='none';
            return;
        }
        if(!facturasPorCliente || facturasPorCliente.size===0){
            card.style.display='none';
            return;
        }
        const thead = document.getElementById('facturacion-global-thead');
        const tfoot = document.getElementById('facturacion-global-tfoot');
        const tbody = document.getElementById('facturacion-global-tbody');
        const spanTotal = document.getElementById('facturacion-global-total');
        const totalCopCell = document.getElementById('facturacion-global-total-cop');
        const totalBblCell = document.getElementById('facturacion-global-total-bbl');
        const totalGlnCell = document.getElementById('facturacion-global-total-gln');
        const totalTonCell = document.getElementById('facturacion-global-total-ton');

        let granTotalCop=0, granTotalBbl=0, granTotalGln=0, granTotalTon=0, anyBbl=false, anyGln=false, anyTon=false;
        let filas = [];

    if(claseActual === 'ANTICIPO VENTAS FOB CTG'){
            // Agrupar por Cliente + Etiqueta
            const mapa = new Map(); // key: cliente|| etiqueta
            facturasPorCliente.forEach((lista, clienteUpper)=>{
                lista.forEach(f=>{
                    const etiqueta = (f.etiqueta||'').toString().trim() || 'SIN ETIQUETA';
                    const key = clienteUpper+'||'+etiqueta;
                    let obj = mapa.get(key);
                    if(!obj){
                        obj = {cliente:clienteUpper, etiqueta:etiqueta, cantidad:0, cop:0, bbl:0, gln:0, ton:0};
                        mapa.set(key,obj);
                    }
                    obj.cantidad += 1;
                    obj.cop += (f.valor||0);
                    obj.bbl += (f.bbl||0);
                    obj.gln += (f.gln||0);
                    obj.ton += (f.ton||0);
                });
            });
            filas = Array.from(mapa.values());
            filas.forEach(r=>{
                granTotalCop+=r.cop; 
                granTotalBbl+=r.bbl; if(r.bbl>0) anyBbl=true;
                granTotalGln+=r.gln; if(r.gln>0) anyGln=true;
                granTotalTon+=r.ton; if(r.ton>0) anyTon=true;
            });
            filas.sort((a,b)=>b.cop-a.cop);
            // Construir encabezado FOB con Etiqueta
            thead.innerHTML = `<tr><th>Cliente</th><th>Etiqueta</th><th class='text-end'>Facturas</th><th class='text-end'>Total COP$</th><th class='text-end'>Total Bbl</th><th class='text-end'>Total Gln</th><th class='text-end'>Total Ton</th></tr>`;
            tfoot.innerHTML = `<tr><th colspan='3' class='text-end'>Gran Total:</th><th class='text-end' id='facturacion-global-total-cop'></th><th class='text-end' id='facturacion-global-total-bbl'></th><th class='text-end' id='facturacion-global-total-gln'></th><th class='text-end' id='facturacion-global-total-ton'></th></tr>`;
            tbody.innerHTML = filas.map(f=>`<tr><td>${f.cliente}</td><td>${f.etiqueta}</td><td class='text-end'>${f.cantidad}</td><td class='text-end'>${currencyFormatter.format(f.cop)}</td><td class='text-end'>${f.bbl? f.bbl.toLocaleString('es-CO'):''}</td><td class='text-end'>${f.gln? f.gln.toLocaleString('es-CO'):''}</td><td class='text-end'>${f.ton? f.ton.toLocaleString('es-CO'):''}</td></tr>`).join('');
        } else { // VENTAS EXW CTG
            facturasPorCliente.forEach((lista, clienteUpper)=>{
                if(!lista.length) return;
                const sumCop = lista.reduce((a,f)=>a+(f.valor||0),0);
                const sumBbl = lista.reduce((a,f)=>a+(f.bbl||0),0);
                const sumGln = lista.reduce((a,f)=>a+(f.gln||0),0);
                const sumTon = lista.reduce((a,f)=>a+(f.ton||0),0);
                granTotalCop += sumCop; 
                granTotalBbl += sumBbl; if(sumBbl>0) anyBbl=true;
                granTotalGln += sumGln; if(sumGln>0) anyGln=true;
                granTotalTon += sumTon; if(sumTon>0) anyTon=true;
                filas.push({cliente:clienteUpper, cantidad:lista.length, cop:sumCop, bbl:sumBbl, gln:sumGln, ton:sumTon});
            });
            filas.sort((a,b)=>b.cop-a.cop);
            // Restaurar encabezado original EXW
            thead.innerHTML = `<tr><th>Cliente</th><th class='text-end'>Facturas</th><th class='text-end'>Total COP$</th><th class='text-end'>Total Bbl</th><th class='text-end'>Total Gln</th><th class='text-end'>Total Ton</th></tr>`;
            tfoot.innerHTML = `<tr><th colspan='2' class='text-end'>Gran Total:</th><th class='text-end' id='facturacion-global-total-cop'></th><th class='text-end' id='facturacion-global-total-bbl'></th><th class='text-end' id='facturacion-global-total-gln'></th><th class='text-end' id='facturacion-global-total-ton'></th></tr>`;
            tbody.innerHTML = filas.map(f=>`<tr><td>${f.cliente}</td><td class='text-end'>${f.cantidad}</td><td class='text-end'>${currencyFormatter.format(f.cop)}</td><td class='text-end'>${f.bbl? f.bbl.toLocaleString('es-CO'):''}</td><td class='text-end'>${f.gln? f.gln.toLocaleString('es-CO'):''}</td><td class='text-end'>${f.ton? f.ton.toLocaleString('es-CO'):''}</td></tr>`).join('');
        }

        // Re-obtener referencias (tfoot replaced)
        const newTotalCopCell = document.getElementById('facturacion-global-total-cop');
        const newTotalBblCell = document.getElementById('facturacion-global-total-bbl');
        const newTotalGlnCell = document.getElementById('facturacion-global-total-gln');
        const newTotalTonCell = document.getElementById('facturacion-global-total-ton');

    spanTotal.textContent = (claseActual==='ANTICIPO VENTAS FOB CTG'? 'Cliente / Etiqueta: ':'Clientes: ')+filas.length;
        newTotalCopCell.textContent = currencyFormatter.format(granTotalCop);
        newTotalBblCell.textContent = anyBbl? granTotalBbl.toLocaleString('es-CO'):'';
        newTotalGlnCell.textContent = anyGln? granTotalGln.toLocaleString('es-CO'):'';
        newTotalTonCell.textContent = anyTon? granTotalTon.toLocaleString('es-CO'):'';
        card.style.display='block';
    }

    // Botón de alternar vistas
    document.getElementById('toggle-view-btn').addEventListener('click', ()=>{
        if(!globalReportData){return;}
        if(currentView==='report'){
            currentView='charts';
            document.getElementById('report-output').classList.add('d-none');
            document.getElementById('charts-view').classList.remove('d-none');
            document.getElementById('toggle-view-btn').innerHTML='<i class="bi bi-table"></i><span>Ver Reporte</span>';
            recomputeTopClientesEXWFiltered();
            recomputeTopProveedoresEgresosFiltered();
            recomputeIngresoEgresoFlujoCharts();
        } else {
            currentView='report';
            document.getElementById('charts-view').classList.add('d-none');
            document.getElementById('report-output').classList.remove('d-none');
            document.getElementById('toggle-view-btn').innerHTML='<i class="bi bi-graph-up"></i><span>Ver Gráficos</span>';
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
 
{% endblock %}