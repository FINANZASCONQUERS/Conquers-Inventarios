{% extends "base.html" %}

{% block title %}Control de Tiempos de Remolcadores{% endblock %}

{% block head %}
{{ super() }}
<style>
    .maniobra-group { border: 1px solid #dee2e6; border-radius: .375rem; margin-bottom: 1.5rem; }
    .maniobra-header { background-color: #f8f9fa; padding: 0.75rem 1rem; border-bottom: 1px solid #dee2e6; }
    [contenteditable="true"], .form-select:not([disabled]), .form-control:not([readonly]) { 
        background-color: #e9f7ef;
        outline: 1px dashed #ced4da; 
    }
    .table th { font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .total-horas { font-weight: bold; color: #0d6efd; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 text-primary"><i class="fas fa-ship me-2"></i>Control de Tiempos de Remolcadores</h2>
        {% if session.email in ['ops@conquerstrading.com', 'finance@conquerstrading.com'] %}
            <div class="d-flex gap-2">
                <a href="{{ url_for('reporte_analisis_remolcadores') }}" class="btn btn-warning"><i class="fas fa-chart-line me-2"></i>Ver Reporte</a>
            </div>
        {% endif %}
    </div>

    <div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
    <div class="col-md-4">
        <label for="fecha_inicio" class="form-label fw-semibold">Fecha de Inicio:</label>
        <input type="date" class="form-control form-control-sm" id="fecha_inicio">
    </div>
    <div class="col-md-4">
        <label for="fecha_fin" class="form-label fw-semibold">Fecha de Fin:</label>
        <input type="date" class="form-control form-control-sm" id="fecha_fin">
    </div>
    <div class="col-md-4 d-flex gap-2">
        <button id="btn-filtrar" class="btn btn-primary btn-sm w-100">
            <i class="fas fa-filter me-2"></i>Filtrar
        </button>
        <button id="btn-limpiar-filtro" class="btn btn-outline-secondary btn-sm w-100">
            <i class="fas fa-times me-2"></i>Limpiar
        </button>
    </div>
    </div>
        </div>
    </div>
</div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-primary" id="btn-iniciar-maniobra"><i class="fas fa-plus me-2"></i>Iniciar Maniobra</button>
                <button type="button" class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#uploadExcelModal"><i class="fas fa-file-excel me-2"></i>Cargar Excel</button>
                <a id="btn-descargar-excel" href="{{ url_for('download_remolcadores_excel') }}" class="btn btn-success">
        <i class="fas fa-file-download me-2"></i>Descargar Excel
    </a>
</div>
            </div>
            <div id="contenedor-maniobras">
                <p class="text-center text-muted py-5">Cargando registros...</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadExcelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Cargar Datos desde Excel</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p class="small text-muted">Asegúrese que el archivo .xlsx tenga las columnas: Id, Barcaza, Mt Entregadas, Evento Anterior, Hora Inicio, Evento Actual, Hora Fin, Carga.</p>
                <form id="upload-excel-form">
                    <input class="form-control" type="file" id="excel_file" name="excel_file" accept=".xlsx" required>
                    <button type="submit" class="btn btn-primary mt-3">Subir Archivo</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadPdfModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Cargar Datos desde PDF</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p class="small text-muted">Sube el archivo <strong>.json</strong> generado a partir del análisis del PDF.</p>
                <form id="upload-pdf-form">
                    <input class="form-control" type="file" id="pdf_file" name="pdf_file" accept=".json" required>
                    <button type="submit" class="btn btn-danger mt-3">Subir y Procesar Archivo</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- SETUP DE PERMISOS Y VARIABLES ---
    const userEmail = "{{ session.email }}";
      const eventoAnteriorOptions = [
        "AUTORIZADO", "CAMBIO DE RR", "CANCELACION", "ESPERAR AUTORIZACION",
        "INICIO BASE OPS","INICIO BITA", "INICIO CONTECAR", "INICIO FONDEO", "INICIO SPRC", "INICIO PUERTO BAHIA",
        "LLEGADA BASE OPS","LLEGADA BITA", "LLEGADA CONTECAR", "LLEGADA FONDEO", "LLEGADA SPD",
        "LLEGADA PUERTO BAHIA","LLEGADA SPRC", "REPOSICIONAMIENTO BARCAZAS"
    ];
    const eventoActualOptions = [
    "ACODERADO", "AUTORIZADO", "CAMBIO DE RR", "CANCELACION",
    "ESPERAR AUTORIZACION", "INICIO BASE OPS", "INICIO BITA", "INICIO CONTECAR",
    "INICIO FONDEO", "INICIO PUERTO BAHIA", "INICIO SPRC", "LLEGADA BASE OPS", "LLEGADA BITA",
    "LLEGADA CONTECAR", "LLEGADA FONDEO", "LLEGADA SPD", "LLEGADA PUERTO BAHIA", "LLEGADA SPRC",
    "REUBICACION BARCAZAS", "TANQUEO",
    ];
    const esAdminOJuliana = "{{ session.rol }}" === 'admin' || userEmail === 'ops@conquerstrading.com';
    const esOperadorOpensean = userEmail === 'opensean@conquerstrading.com';
    
    const contenedor = document.getElementById('contenedor-maniobras');
    const btnLimpiarFiltro = document.getElementById('btn-limpiar-filtro');
    const fechaInicioInput = document.getElementById('fecha_inicio');
    const fechaFinInput = document.getElementById('fecha_fin');
    const btnIniciarManiobra = document.getElementById('btn-iniciar-maniobra');
    const btnFiltrar = document.getElementById('btn-filtrar');
    btnLimpiarFiltro.addEventListener('click', function() {
        // 1. Limpia los campos de fecha
        fechaInicioInput.value = '';
        fechaFinInput.value = '';
        
        // 2. Vuelve a cargar todos los datos sin filtros
        fetchAndRenderRemolcadores();
    });

    const barcazas = ["MANZANILLO", "CR", "MARGOTH", "ODISEA", "MARINSE", "OIL TECH"];
    const estadosCarga = ["LLENO", "VACIO", "N/A"];
    const camposEditablesOperador = ['evento_anterior', 'hora_inicio', 'evento_actual', 'hora_fin', 'barcaza', 'carga_estado'];
    
    // --- FUNCIONES DE RENDERIZADO (VISTA) ---

    function fetchAndRenderRemolcadores() {
        const fechaInicio = fechaInicioInput.value;
        const fechaFin = fechaFinInput.value;

        const params = new URLSearchParams();
        if (fechaInicio) params.append('fecha_inicio', fechaInicio);
        if (fechaFin) params.append('fecha_fin', fechaFin);
        
        const apiUrl = `/api/registros_remolcadores?${params.toString()}`;
        
        contenedor.innerHTML = '<p class="text-center text-muted py-5">Cargando registros...</p>';

        fetch(apiUrl)
            .then(response => response.ok ? response.json() : Promise.reject('Error de red'))
            .then(data => {
                renderizarGrupos(data); // Llama a la función que dibuja las maniobras
            })
            .catch(error => {
                console.error('Error al cargar los datos:', error);
                contenedor.innerHTML = '<p class="text-center text-danger py-5">Error al cargar la información.</p>';
            });
    }
    
    function renderizarFila(r, esUltimoEvento = false) {
    const esEditable = (campo) => esAdminOJuliana || (esOperadorOpensean && camposEditablesOperador.includes(campo));
    
    const selectAnteriorHTML = eventoAnteriorOptions.map(opt => `<option value="${opt}" ${r.evento_anterior === opt ? 'selected' : ''}>${opt}</option>`).join('');
    const eventoAnteriorDropdown = `<td>
        <select class="form-select form-select-sm" data-field="evento_anterior" ${!esEditable('evento_anterior') ? 'disabled' : ''}>
            <option value="">--</option>
            ${selectAnteriorHTML}
        </select>
    </td>`;

    const selectActualHTML = eventoActualOptions.map(opt => `<option value="${opt}" ${r.evento_actual === opt ? 'selected' : ''}>${opt}</option>`).join('');
    const eventoActualDropdown = `<td>
        <select class="form-select form-select-sm" data-field="evento_actual" ${!esEditable('evento_actual') ? 'disabled' : ''}>
            <option value="">--</option>
            ${selectActualHTML}
        </select>
    </td>`;

    const cargaSeleccionada = r.carga_estado || 'N/A';
    const selectCargaHTML = estadosCarga.map(opt => `<option value="${opt}" ${cargaSeleccionada === opt ? 'selected' : ''}>${opt}</option>`).join('');
    const cargaHtml = `<td>
        <select class="form-select form-select-sm" data-field="carga_estado" ${!esEditable('carga_estado') ? 'disabled' : ''}>
            ${selectCargaHTML}
        </select>
    </td>`;

    const totalHorasHtml = esUltimoEvento ? `<td class="total-horas">${r.total_horas || ''}</td>` : '<td></td>';

    let filaHtml = `<tr data-id="${r.id || 'new'}" data-maniobra-id="${r.maniobra_id}" ${esUltimoEvento ? 'class="evento-actual"' : ''}>
        ${eventoAnteriorDropdown}
        <td><input type="datetime-local" data-field="hora_inicio" class="form-control form-control-sm" value="${r.hora_inicio || ''}" ${!esEditable('hora_inicio') ? 'readonly' : ''}></td>
        ${eventoActualDropdown}
        <td><input type="datetime-local" data-field="hora_fin" class="form-control form-control-sm" value="${r.hora_fin || ''}" ${!esEditable('hora_fin') ? 'readonly' : ''}></td>
        <td class="text-muted">${r.duracion || ''}</td>
        ${totalHorasHtml}
        ${cargaHtml}
        <td>
            <button class="btn btn-sm btn-primary btn-save-evento" ${!esEditable('evento_anterior') ? 'disabled' : ''}>Guardar</button>
            <button class="btn btn-sm btn-outline-danger btn-remove-evento" ${!esEditable('evento_anterior') ? 'disabled' : ''}><i class="fas fa-times"></i></button>
        </td>
    </tr>`;
    
    return filaHtml;
}

    function renderizarGrupos(data) {
        contenedor.innerHTML = '';
        const grupos = data.reduce((acc, r) => { (acc[r.maniobra_id] = acc[r.maniobra_id] || []).push(r); return acc; }, {});

        if (Object.keys(grupos).length === 0) {
            contenedor.innerHTML = '<p class="text-center text-muted py-4">No hay maniobras registradas.</p>';
        }

        Object.keys(grupos).sort((a, b) => Number(b) - Number(a)).forEach(maniobra_id => {
            const eventos = grupos[maniobra_id];
            const grupoDiv = document.createElement('div');
            grupoDiv.className = 'maniobra-group';
            grupoDiv.dataset.maniobraId = maniobra_id;
            
            const barcazaOptions = barcazas.map(b => `<option value="${b}" ${b === eventos[0].barcaza ? 'selected' : ''}>${b}</option>`).join('');
            const puedeEditarHeader = esAdminOJuliana || esOperadorOpensean;
            
            let cabeceraHtml = `<div class="maniobra-header"><div class="row align-items-center g-3">
                <div class="col-md-auto"><h5>Maniobra #${maniobra_id}</h5></div>
                <div class="col-md-2"><label class="form-label-sm">Barcaza</label>
                    <select class="form-select form-select-sm barcaza-maniobra-input" ${!puedeEditarHeader ? 'disabled' : ''}>
                        <option value="">--</option>${barcazaOptions}
                    </select>
                </div>
                <div class="col-md-3"><label class="form-label-sm">Nombre Del Barco</label>
                    <input type="text" class="form-control form-control-sm nombre-barco-maniobra-input" value="${eventos[0].nombre_barco || ''}" ${!puedeEditarHeader ? 'disabled' : ''}>
                </div>`;
                
            if (esAdminOJuliana) {
                cabeceraHtml += `<div class="col-md-2"><label class="form-label-sm">MT Entregadas</label>
                    <input type="number" step="0.01" class="form-control form-control-sm mt-maniobra-input" value="${eventos[0].mt_entregadas || ''}">
                </div>`;
            }
            
            cabeceraHtml += `<div class="col-md-auto ms-auto text-end">
                <button class="btn btn-sm btn-outline-primary btn-agregar-evento-grupo"><i class="fas fa-plus"></i> Evento</button>
                ${puedeEditarHeader ? 
                  `<button class="btn btn-sm btn-secondary btn-guardar-maniobra">Guardar Maniobra</button>
                   <button class="btn btn-sm btn-outline-danger btn-eliminar-maniobra"><i class="fas fa-trash"></i></button>` : ''}
            </div></div></div>`;
            
            let tablaHtml = `<div class="maniobra-body"><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr>
                <th>Evento Anterior</th><th>Hora Inicio</th><th>Evento Actual</th><th>Hora Fin</th>
                <th>Duración</th><th>Total Horas</th><th>Carga</th><th>Acciones</th></tr></thead><tbody>`;

            eventos.forEach((r, index) => { 
                tablaHtml += renderizarFila(r, index === eventos.length - 1); 
            });
            tablaHtml += `</tbody></table></div></div>`;
            
            grupoDiv.innerHTML = cabeceraHtml + tablaHtml;
            contenedor.appendChild(grupoDiv);
        });
    }

    // --- EVENTOS DE CLICK ---
    btnFiltrar.addEventListener('click', fetchAndRenderRemolcadores);
    btnLimpiarFiltro.addEventListener('click', () => {
        fechaInicioInput.value = '';
        fechaFinInput.value = '';
        fetchAndRenderRemolcadores();
    });
    // --- LÓGICA DE EVENTOS ---
    async function apiRequest(url, options) {
        try {
            const response = await fetch(url, options);
            const result = await response.json();
            alert(result.message);
            if (result.success) cargarRegistros();
        } catch (error) { alert('Error de conexión.'); }
    }

    contenedor.addEventListener('click', function(e) {
        const target = e.target.closest('button');
        if (!target) return;
        
        const grupoDiv = target.closest('.maniobra-group');
        const maniobra_id = grupoDiv.dataset.maniobraId;

        if (target.classList.contains('btn-agregar-evento-grupo')) {
            const tbody = grupoDiv.querySelector('tbody');
            const ultimaFila = tbody.querySelector('tr:last-child');
            let eventoAnteriorNuevo = '';
            let horaInicioNueva = '';

            if (ultimaFila) {
                const eventoActualPrevio = ultimaFila.querySelector('[data-field="evento_actual"]').value;
                const horaFinPrevia = ultimaFila.querySelector('[data-field="hora_fin"]').value;
                eventoAnteriorNuevo = eventoActualPrevio;
                horaInicioNueva = horaFinPrevia;
            }

            const datosNuevaFila = {
                id: 'new', maniobra_id: maniobra_id,
                evento_anterior: eventoAnteriorNuevo, hora_inicio: horaInicioNueva
            };

            tbody.insertAdjacentHTML('beforeend', renderizarFila(datosNuevaFila));
        } else if (target.classList.contains('btn-remove-evento')) {
            const tr = target.closest('tr');
            if (tr.dataset.id === 'new') {
                tr.remove();
            } else if (confirm('¿Eliminar este evento?')) {
                apiRequest(`/api/registros_remolcadores/${tr.dataset.id}`, { method: 'DELETE' });
            }
        } else if (target.classList.contains('btn-save-evento')) {
            const tr = target.closest('tr');
            const datosFila = {};
            tr.querySelectorAll('[data-field]').forEach(el => datosFila[el.dataset.field] = el.value);
            
            const barcazaInput = grupoDiv.querySelector('.barcaza-maniobra-input');
            if (barcazaInput) datosFila.barcaza = barcazaInput.value;

            const nombreBarcoInput = grupoDiv.querySelector('.nombre-barco-maniobra-input');
            if (nombreBarcoInput) datosFila.nombre_barco = nombreBarcoInput.value;
            
            const mtEntregadasInput = grupoDiv.querySelector('.mt-maniobra-input');
            if (mtEntregadasInput && esAdminOJuliana) datosFila.mt_entregadas = mtEntregadasInput.value;

            datosFila.maniobra_id = maniobra_id === 'NUEVA' ? null : maniobra_id;
            const id = tr.dataset.id;
            const url = id !== 'new' ? `/api/registros_remolcadores/${id}` : '/api/registros_remolcadores';
            const method = id !== 'new' ? 'PUT' : 'POST';
            apiRequest(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(datosFila) });
        } else if (target.classList.contains('btn-eliminar-maniobra')) {
            if (confirm(`¿Seguro que quieres eliminar la Maniobra #${maniobra_id}?`)) {
                apiRequest(`/api/maniobra/${maniobra_id}`, { method: 'DELETE' });
            }
        } else if (target.classList.contains('btn-guardar-maniobra')) {
            const barcaza = grupoDiv.querySelector('.barcaza-maniobra-input').value;
            const nombreBarco = grupoDiv.querySelector('.nombre-barco-maniobra-input').value;
            
            const datos = { barcaza: barcaza, nombre_barco: nombreBarco };
            
            if (esAdminOJuliana) {
                const mtEntregadas = grupoDiv.querySelector('.mt-maniobra-input').value;
                datos.mt_entregadas = mtEntregadas;
            }
            
            apiRequest(`/api/maniobra/${maniobra_id}`, { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(datos) 
            });
        }
    });

    // Manejar el envío del formulario de Excel
    document.getElementById('upload-excel-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('excel_file');
        const file = fileInput.files[0];
        if (!file) { alert('Por favor seleccione un archivo Excel'); return; }
        
        const formData = new FormData();
        formData.append('excel_file', file);
        
        fetch('/api/remolcadores/upload_excel', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                cargarRegistros();
                bootstrap.Modal.getInstance(document.getElementById('uploadExcelModal')).hide();
            }
        })
        .catch(error => alert('Error al cargar el archivo Excel'));
    });

    // --- NUEVO MANEJADOR PARA EL FORMULARIO DE PDF ---
    document.getElementById('upload-pdf-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('pdf_file');
        const file = fileInput.files[0];
        if (!file) { alert('Por favor seleccione un archivo JSON'); return; }

        const formData = new FormData();
        formData.append('pdf_file', file);

        fetch('/api/remolcadores/upload_pdf', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                cargarRegistros();
                bootstrap.Modal.getInstance(document.getElementById('uploadPdfModal')).hide();
            }
        })
        .catch(error => alert('Error al cargar el archivo.'));
    });

    document.getElementById('btn-iniciar-maniobra').addEventListener('click', function() {
        if (document.querySelector(`[data-maniobra-id="NUEVA"]`)) {
            alert("Ya hay una nueva maniobra sin guardar."); return;
        }
        const grupoDiv = document.createElement('div');
        grupoDiv.className = 'maniobra-group';
        grupoDiv.dataset.maniobraId = 'NUEVA';
        
        // Se construye la cabecera
        let cabeceraHtml = `<div class="maniobra-header"><div class="row align-items-center g-3">
            <div class="col-md-auto"><h5>Nueva Maniobra</h5></div>
            <div class="col-md-3"><label class="form-label-sm">Barcaza</label>
                <select class="form-select form-select-sm barcaza-maniobra-input">
                    <option value="">--</option>${barcazas.map(b => `<option value="${b}">${b}</option>`).join('')}
                </select>
            </div>
             <div class="col-md-3"><label class="form-label-sm">Nombre Del Barco</label>
                <input type="text" class="form-control form-control-sm nombre-barco-maniobra-input">
            </div>`;

        // ✅ Se añade el campo MT Entregadas SOLO si el usuario tiene permiso
        if (esAdminOJuliana) {
            cabeceraHtml += `<div class="col-md-2"><label class="form-label-sm">MT Entregadas</label>
                <input type="number" step="0.01" class="form-control form-control-sm mt-maniobra-input">
            </div>`;
        }
            
        cabeceraHtml += `<div class="col-md-auto ms-auto text-end">
                <button class="btn btn-sm btn-outline-primary btn-agregar-evento-grupo"><i class="fas fa-plus"></i> Evento</button>
                <button class="btn btn-sm btn-secondary btn-guardar-maniobra">Guardar Maniobra</button>
            </div>
        </div></div>`;
        
        let tablaHtml = `<div class="maniobra-body"><table class="table table-sm mb-0"><thead><tr>
            <th>Evento Anterior</th><th>Hora Inicio</th><th>Evento Actual</th><th>Hora Fin</th>
            <th>Duración</th><th>Total Horas</th><th>Carga</th><th>Acciones</th>
        </tr></thead><tbody>${renderizarFila({ id: 'new', maniobra_id: 'NUEVA' })}</tbody></table></div>`;

        grupoDiv.innerHTML = cabeceraHtml + tablaHtml;
        contenedor.insertAdjacentElement('afterbegin', grupoDiv);
    });

    document.getElementById('btn-filtrar').addEventListener('click', function() {
    const fechaInicio = fechaInicioInput.value;
    const fechaFin = fechaFinInput.value;
    const btnDescargar = document.getElementById('btn-descargar-excel');
    
    const baseUrl = "{{ url_for('download_remolcadores_excel') }}";
    const params = new URLSearchParams();
    if (fechaInicio) params.append('fecha_inicio', fechaInicio);
    if (fechaFin) params.append('fecha_fin', fechaFin);
    
    btnDescargar.href = `${baseUrl}?${params.toString()}`;
});

    function cargarRegistros() {
        fetch('/api/registros_remolcadores').then(res => res.json()).then(renderizarGrupos);
    }
    cargarRegistros();
});
</script>
{% endblock %}