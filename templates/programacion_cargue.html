{% extends "base.html" %}
{% block title %}Programación de Cargue{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 fw-semibold text-gray-800 mb-0">
            <i class="fas fa-truck-loading me-2 text-primary"></i>Programación de Vehículos para Cargue
        </h2>    
        <div class="d-flex align-items-center">
            <div class="btn-group me-3" role="group">
                <button type="button" class="btn btn-outline-success btn-sm rounded-3 export-btn" 
                        data-bs-toggle="modal" data-bs-target="#reportModal" data-format="excel">
                    <i class="fas fa-file-excel me-1"></i> Excel
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm rounded-3 export-btn" 
                        data-bs-toggle="modal" data-bs-target="#reportModal" data-format="pdf">
                    <i class="fas fa-file-pdf me-1"></i> PDF
                </button>
            </div>
            <button id="btn-add-row" class="btn btn-primary btn-sm rounded-3 shadow-sm">
                <i class="fas fa-plus-circle me-1"></i> Nueva Programación
            </button>
        </div>
    </div>
    
    <div class="card border-0 shadow-lg rounded-lg overflow-hidden">
        <div class="card-header bg-white py-3 border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0 text-gray-800">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>Registros de Programación
                    </h5>
                </div>
                <div class="col-md-6 text-end">
                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                        <i class="fas fa-user-shield me-1"></i>{{ rol_usuario }}
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive-lg">
                <table class="table align-middle mb-0">
                    <thead class="bg-primary text-white">
                        </thead>
                    <tbody id="schedule-table-body" class="font-sm">
                        </tbody>
                </table>
                <datalist id="productos-lista">
                    </datalist>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-file-export me-2"></i>Opciones del Reporte
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    Selecciona un rango de fechas para generar tu reporte. Si dejas los campos vacíos, se exportarán todos los registros.
                </p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="fecha_inicio" class="form-label fw-semibold">Fecha de Inicio:</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="far fa-calendar-alt text-primary"></i></span>
                            <input type="date" class="form-control" id="fecha_inicio">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="fecha_fin" class="form-label fw-semibold">Fecha de Fin:</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="far fa-calendar-alt text-primary"></i></span>
                            <input type="date" class="form-control" id="fecha_fin">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-2 px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary rounded-2 px-4" id="btn-generate-report">
                    <i class="fas fa-file-export me-1"></i> Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- VARIABLES Y CONFIGURACIÓN ---
    const userEmail = "{{ email_usuario }}";
    const userRol = "{{ rol_usuario }}";
    const tbody = document.getElementById('schedule-table-body');
    const thead = document.querySelector('table thead');
    const btnAddRow = document.getElementById('btn-add-row');

    const permissions = {
        'ops@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'destino', 'cliente', 'fecha_despacho'],
        'logistic@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'numero_guia', 'destino', 'cliente', 'fecha_despacho'],
        'oci@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'numero_guia', 'destino', 'cliente', 'fecha_despacho'],
        'amariagallo@conquerstrading.com': ['destino', 'cliente'],
        'refinery.control@conquerstrading.com': ['estado', 'galones', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'],
        'production@conquerstrading.com': ['estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'destino', 'cliente', 'fecha_despacho'],
        'qualitycontrol@conquerstrading.com': ['estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos']
    };

    const columnsConfig = {
        'fecha_programacion': { width: '120px', type: 'date' },
        'empresa_transportadora': { width: '180px' },
        'placa': { width: '100px' },
        'tanque': { width: '80px' },
        'nombre_conductor': { width: '180px' },
        'cedula_conductor': { width: '120px' },
        'celular_conductor': { width: '120px' },
        'hora_llegada_estimada': { width: '120px', type: 'time' },
        // --- CONFIGURACIÓN DE COLUMNA MODIFICADA ---
        'producto_a_cargar': { 
            width: '150px', 
            type: 'datalist',
            options: ['FUEL OIL 4','FUEL OIL 6', 'DILUYENTE', 'MGO', 'DIESEL MARINO', 'VLSFO', 'CRUDO']
        },
        'destino': { width: '150px' },
        'cliente': { width: '180px' },
        'estado': { width: '130px', type: 'select', options: ['PROGRAMADO', 'CARGANDO', 'DESPACHADO'] },
        'galones': { width: '100px', type: 'number' },
        'barriles': { width: '100px', type: 'number', readonly: true },
        'temperatura': { width: '100px', type: 'number' },
        'api_obs': { width: '100px', type: 'number' },
        'api_corregido': { width: '120px', type: 'number' },
        'precintos': { width: '250px', type: 'text'},
        'fecha_despacho': { width: '120px', type: 'date' }, 
        'numero_guia': { width: '150px' }
    };
    const reportModal = document.getElementById('reportModal');
let exportFormat = ''; // Variable para guardar si es 'excel' o 'pdf'

// Cuando el modal se está por abrir, guardamos el formato del botón que se presionó.
reportModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    exportFormat = button.getAttribute('data-format');
});

// Cuando se hace clic en "Generar Reporte" dentro del modal.
document.getElementById('btn-generate-report').addEventListener('click', function() {
    const fechaInicio = document.getElementById('fecha_inicio').value;
    const fechaFin = document.getElementById('fecha_fin').value;

    // Construimos la URL base para la exportación.
    let url = `/exportar_programacion_cargue/${exportFormat}`;
    
    // Añadimos las fechas como parámetros a la URL.
    const params = new URLSearchParams();
    if (fechaInicio) {
        params.append('fecha_inicio', fechaInicio);
    }
    if (fechaFin) {
        params.append('fecha_fin', fechaFin);
    }

    // Si hay parámetros, los añadimos a la URL.
    if (params.toString()) {
        url += `?${params.toString()}`;
    }

    // Cerramos el modal y abrimos la URL para descargar el archivo.
    const modalInstance = bootstrap.Modal.getInstance(reportModal);
    modalInstance.hide();
    window.location.href = url;
});

    const allColumns = Object.keys(columnsConfig);
    const userPermissions = permissions[userEmail] || [];
    const isAdmin = userRol === 'admin';
    let originalData = [];

    // --- FUNCIONES DE RENDERIZADO Y FILTRADO ---
    function fetchAndRender() {
        fetch("{{ url_for('handle_programacion') }}")
            .then(res => res.ok ? res.json() : Promise.reject('Error de red'))
            .then(data => {
                originalData = data;
                renderTable(data);
            })
            .catch(error => {
                console.error('Error en fetchAndRender:', error);
                thead.innerHTML = '';
                tbody.innerHTML = `<tr><td colspan="100%" class="text-center text-danger py-3">Error al cargar la información.</td></tr>`;
            });
    }

    function renderTable(data) {
        renderHeader();
        renderBody(data);
    }
    
    function renderHeader() {
        let headerHtml = '<tr class="align-middle">';
        let filterHtml = '<tr id="filter-row" class="align-middle">';
        allColumns.forEach(col => {
            const config = columnsConfig[col];
            headerHtml += `<th style="width: ${config.width}; min-width: ${config.width}" class="text-nowrap">${formatColumnName(col)}</th>`;
            filterHtml += `<th><input type="text" class="form-control form-control-sm filter-input" data-filter-col="${col}" placeholder="Buscar..."></th>`;
        });
        headerHtml += '<th style="width: 80px" class="text-center sticky-col">Acciones</th></tr>'; // Modificado
        filterHtml += '<th></th>';
        thead.innerHTML = headerHtml + filterHtml;
        thead.querySelector('#filter-row').addEventListener('input', applyFilters);
    }

    // --- FUNCIÓN MODIFICADA PARA RENDERIZAR EL INPUT ---
    function renderBody(data) {
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${allColumns.length + 1}" class="text-center py-4 text-muted">No hay programaciones que coincidan con los filtros.</td></tr>`;
            return;
        }

        data.forEach(row => {
            let rowHtml = `<tr data-id="${row.id}" data-estado="${row.estado || 'PROGRAMADO'}" class="align-middle">`;
            allColumns.forEach(col => {
                const config = columnsConfig[col];
                const isEditable = !config.readonly && (isAdmin || userPermissions.includes(col));
                const value = row[col] || '';

                if (config.type === 'datalist' && isEditable) {
                    rowHtml += `<td data-field="${col}" data-type="datalist">
                                    <input list="productos-lista" class="form-control form-control-sm border-0 bg-transparent editable-input" 
                                           value="${value}">
                                </td>`;
                } else {
                    rowHtml += `<td data-field="${col}" data-type="${config.type || 'text'}" 
                                    contenteditable="${isEditable}"
                                    class="${isEditable ? 'editable-cell' : ''} ${config.type === 'number' ? 'text-end' : ''}"
                                    style="min-width: ${config.width}">${formatCellValue(value, config)}</td>`;
                }
            });
            
            rowHtml += `<td class="text-center save-status-cell sticky-col" data-id="${row.id}">
                            <div class="d-flex justify-content-center align-items-center">
                                <span class="save-indicator me-2" style="width: 16px;"></span>
                                <button class="btn btn-info btn-xs btn-print-guide" title="Imprimir Guía de Transporte">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td></tr>`;
            tbody.innerHTML += rowHtml;
        });
    }
    
    function applyFilters() {
        const filters = Array.from(thead.querySelectorAll('.filter-input')).reduce((acc, input) => {
            if (input.value) { acc[input.dataset.filterCol] = input.value.toLowerCase(); }
            return acc;
        }, {});
        const filteredData = originalData.filter(row => {
            return Object.keys(filters).every(col => {
                return String(row[col] || '').toLowerCase().includes(filters[col]);
            });
        });
        renderBody(filteredData);
    }

    function formatColumnName(colName) {
        return colName.replace(/_/g, ' ').toUpperCase();
    }

    function formatCellValue(value, config) {
        if (value === null || value === undefined || value === '') return '';
        switch (config.type) {
            case 'date':
                return new Date(value + 'T00:00:00').toLocaleDateString('es-CO', { timeZone: 'UTC' });
            case 'time':
                return value.slice(0, 5);
            case 'number':
                return Number(value).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            default:
                return value;
        }
    }

    // --- MANEJADORES DE EVENTOS ---
    btnAddRow.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Procesando...';
        fetch("{{ url_for('handle_programacion') }}", { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showToast('success', 'Nueva programación creada');
                fetchAndRender();
            } else {
                showToast('danger', 'Error: ' + data.message);
            }
        })
        .catch(error => showToast('danger', 'Error de conexión'))
        .finally(() => {
            this.disabled = false;
            this.innerHTML = `<i class="fas fa-plus me-2"></i>Nueva Programación`;
        });
    });

    tbody.addEventListener('input', function(e) {
        const cell = e.target.closest('td');
        if (!cell) return;

        if (cell.dataset.field === 'galones' && cell.isContentEditable) {
            const row = cell.closest('tr');
            const barrilesCell = row.querySelector('[data-field="barriles"]');
            const galonesValue = parseFloat(cell.textContent.replace(/\./g, '').replace(',', '.')) || 0;
            const barrilesValue = galonesValue / 42;
            barrilesCell.textContent = barrilesValue.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    });
    
    tbody.addEventListener('blur', function(e) {
        if (e.target.classList.contains('editable-cell') || e.target.classList.contains('editable-input')) {
            autosaveCell(e.target.closest('td'));
        }
    }, true);

    tbody.addEventListener('click', function(e) {
        const printButton = e.target.closest('.btn-print-guide');
        if (printButton) {
            const row = printButton.closest('tr');
            const url = new URL("{{ url_for('guia_transporte') }}", window.location.origin);
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.dataset.field;
                let value;
                const input = cell.querySelector('input.editable-input');
                if (input) {
                    value = input.value.trim();
                } else {
                    value = cell.textContent.trim();
                }
                
                if (cell.dataset.type === 'number' && value) {
                    value = value.replace(/\./g, '').replace(',', '.');
                }
                if (value && value !== '-') {
                     url.searchParams.append(field, value);
                }
            });
            window.location.href = url.href;
        }

        const estadoCell = e.target.closest('td[data-field="estado"].editable-cell');
        if (estadoCell && !estadoCell.querySelector('select')) {
            const originalValue = estadoCell.textContent.trim();
            const config = columnsConfig['estado'];
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm shadow-sm';
            config.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (opt === originalValue) option.selected = true;
                select.appendChild(option);
            });
            estadoCell.innerHTML = '';
            estadoCell.appendChild(select);
            select.focus();
            const handleSelectChange = () => {
                estadoCell.textContent = select.value;
                autosaveCell(estadoCell);
                select.removeEventListener('blur', handleSelectChange);
                select.removeEventListener('change', handleSelectChange);
            };
            select.addEventListener('blur', handleSelectChange);
            select.addEventListener('change', handleSelectChange);
        }
    });

    // --- FUNCIÓN MODIFICADA PARA GUARDAR DESDE EL INPUT ---
    function autosaveCell(cell) {
        const row = cell.closest('tr');
        const id = row.dataset.id;
        const field = cell.dataset.field;
        const config = columnsConfig[field];
        let value;

        const input = cell.querySelector('input.editable-input');
        if (input) {
            value = input.value.trim();
        } else {
            value = cell.textContent.trim();
        }

        if (value === '' || value === '-') {
            value = null;
        } else if (config.type === 'date' && value) {
            const parts = value.split('/');
            if (parts.length === 3) value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        } else if (config.type === 'number' && value) {
            value = parseFloat(value.replace(/\./g, '').replace(',', '.')) || null;
        }

        const updatedData = { [field]: value };
        
        if (field === 'galones') {
            updatedData.barriles = (value || 0) / 42;
        }

        const statusIndicator = row.querySelector('.save-indicator');
        statusIndicator.innerHTML = '<span class="spinner-border spinner-border-sm text-primary" role="status"></span>';

        fetch(`/api/programacion/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        })
        .then(res => res.json().then(data => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
            if (ok) {
                statusIndicator.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
            } else {
                statusIndicator.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
                showToast('danger', `Error en ${field}: ` + (data.message || 'Error'));
            }
        })
        .catch(error => {
            statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
            showToast('danger', 'Error de conexión');
        })
        .finally(() => {
            setTimeout(() => { statusIndicator.innerHTML = ''; }, 3000);
        });
    }

    function showToast(type, message) {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type} border-0`;
        toast.innerHTML = `<div class="d-flex"><div class="toast-body"><i class="${type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'} me-2"></i>${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1100';
        document.body.appendChild(container);
        return container;
    }

    // --- CÓDIGO AÑADIDO PARA POBLAR LA LISTA DE PRODUCTOS ---
    const datalist = document.getElementById('productos-lista');
    if (datalist && columnsConfig.producto_a_cargar.options) {
        columnsConfig.producto_a_cargar.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            datalist.appendChild(option);
        });
    }

    // --- CARGA INICIAL ---
    fetchAndRender();
});
</script>

<style>
    /* ESTILOS AÑADIDOS PARA EL INPUT EN LA TABLA */
    .editable-input {
        width: 100%;
        height: 100%;
        background-color: transparent !important;
        padding: 0.375rem 0.75rem; /* Ajusta el padding para que coincida con otras celdas */
    }
    .editable-input:focus {
        background-color: #e9ecef !important;
    }
    
    /* ESTILOS PARA FILTROS */
    #filter-row th {
        padding: 8px;
        background-color: #f8f9fa;
    }
    .filter-input {
        width: 100%;
        border: 1px solid #dee2e6;
    }
    .filter-input::placeholder {
        color: #adb5bd;
        font-style: italic;
    }

    /* ESTILOS PARA LA COLUMNA FIJA DE ESTADO */
    .sticky-col {
        position: -webkit-sticky;
        position: sticky;
        right: 0;
        z-index: 2;
    }
    .table tbody .sticky-col {
        background-color: #f8f9fa; 
        border-left: 2px solid #e9ecef;
    }
    .table thead .sticky-col {
        background: linear-gradient(135deg, #2c3e50, #4a6491);
    }
    .table tbody tr[data-estado="CARGANDO"] .sticky-col { background-color: #fff3cd !important; }
    .table tbody tr[data-estado="DESPACHADO"] .sticky-col { background-color: #d4edda !important; }

    /* ESTILOS PARA ESTADOS DE FILA */
    .table tbody tr[data-estado="PROGRAMADO"] { background-color: #f8f9fa !important; }
    .table tbody tr[data-estado="CARGANDO"] td { background-color: #fff3cd !important; }
    .table tbody tr[data-estado="DESPACHADO"] td { background-color: #d4edda !important; }

    /* ESTILO ESPECIAL PARA PRECINTOS */
    td[data-field="precintos"] {
        font-family: 'Courier New', monospace;
    }

    /* ESTILOS GENERALES DE LA TABLA */
    .table-responsive-lg {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
    }
    .table thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #2c3e50, #4a6491);
        color: white;
        z-index: 10;
        font-size: 0.75rem;
        padding: 12px 15px;
        text-align: left;
        text-transform: uppercase;
    }
    #filter-row {
        top: 45px;
        z-index: 10;
        position: sticky;
    }
    .table td {
        vertical-align: middle;
        padding: 0; /* Se quita el padding para que los inputs/texto interno lo manejen */
        font-size: 0.85rem;
        color: #495057;
        background-color: white;
    }
    .table td[contenteditable="true"] {
        padding: 12px 15px; /* Se mantiene el padding para celdas editables normales */
    }
    .table tbody tr:hover td { background-color: #f8fafc; }

    /* ESTILO PARA CELDAS EDITABLES */
    .editable-cell {
        background-color: rgba(13, 110, 253, 0.05);
        transition: all 0.2s ease;
        border-radius: 4px;
        cursor: pointer;
    }
    .editable-cell:focus {
        background-color: rgba(13, 110, 253, 0.1);
        outline: 2px solid rgba(13, 110, 253, 0.3);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
        cursor: text;
    }
    .btn-xs {
        --bs-btn-padding-y: .1rem;
        --bs-btn-padding-x: .4rem;
        --bs-btn-font-size: .75rem;
    }
</style>
{% endblock %}