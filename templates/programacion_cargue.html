{% extends "base.html" %}
{% block title %}Programación de Cargue{% endblock %}
{% block container_class %}container-fluid p-0{% endblock %}

{% block content %}
<div class="container-fluid mt-2 px-2 programacion-cargue-page" style="max-width: 100%;">
    <style>
        :root {
            --sticky-bg-header: #f8f9fa;
            --sticky-bg-filter: #fff;
            --sticky-bg-cell: #f8f9fc;
            --sticky-border: #ced4da;
            --ctx-menu-bg: #ffffff;
            --ctx-menu-text: #495057;
            --ctx-menu-hover: #f0f7f4;
            --ctx-icon: #adb5bd;
            --ctx-divider: #e9ecef;
        }

        html.dark-mode {
            --sticky-bg-header: #14242c;
            --sticky-bg-filter: #1a262e;
            --sticky-bg-cell: #1f2d35;
            --sticky-border: #2f3d47;
            --ctx-menu-bg: #1a262e;
            --ctx-menu-text: #e5e7eb;
            --ctx-menu-hover: #2f3d47;
            --ctx-icon: #6c757d;
            --ctx-divider: #2f3d47;
        }

        .programacion-cargue-page .table-modern th {
            font-size: 0.95rem !important;
            padding: 12px 10px !important;
        }

        .programacion-cargue-page .table-modern td {
            font-size: 0.95rem !important;
            padding: 10px 10px !important;
        }

        .programacion-cargue-page .table-modern .form-control-sm,
        .programacion-cargue-page .table-modern .form-select-sm,
        .programacion-cargue-page .table-modern .btn-xs {
            font-size: 0.9rem !important;
        }

        /* Menú Contextual Moderno */
        .custom-context-menu {
            display: none;
            position: fixed;
            z-index: 10000;
            width: 220px;
            background-color: var(--ctx-menu-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
            padding: 5px;
            animation: menuFadeIn 0.15s ease-out;
        }

        html.dark-mode .custom-context-menu {
            border-color: #2f3d47;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        @keyframes menuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .custom-context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .custom-context-menu li {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: var(--ctx-menu-text);
            border-radius: 8px;
            transition: all 0.2s;
            margin-bottom: 2px;
        }

        .custom-context-menu li:hover {
            background-color: var(--ctx-menu-hover);
            /* Tono verde suave */
            color: #0a7c5d;
            /* Primary color */
            transform: translateX(3px);
        }

        .custom-context-menu li i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            color: var(--ctx-icon);
        }

        .custom-context-menu li:hover i {
            color: #0a7c5d;
        }

        .custom-context-menu li.delete-option:hover {
            background-color: #fff5f5;
            color: #dc3545;
        }

        html.dark-mode .custom-context-menu li.delete-option:hover {
            background-color: rgba(220, 53, 69, 0.15);
        }

        .custom-context-menu li.delete-option:hover i {
            color: #dc3545;
        }

        .custom-context-menu .menu-divider {
            height: 1px;
            background-color: var(--ctx-divider);
            margin: 4px 0;
        }

        /* ========================================
   MEJORAS DE USABILIDAD Y DISEÑO
   ======================================== */

        /* Botón + más visible y accesible */
        .btn-add-new-item {
            position: absolute !important;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.35rem 0.5rem !important;
            border-radius: 0.35rem !important;
            background: white !important;
            border: 2px solid #28a745 !important;
            color: #28a745 !important;
            font-size: 0.875rem !important;
            font-weight: 700 !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2) !important;
            z-index: 10 !important;
        }

        .btn-add-new-item:hover {
            background: #28a745 !important;
            color: white !important;
            transform: translateY(-50%) scale(1.1) !important;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4) !important;
        }

        .btn-add-new-item i {
            font-size: 0.9rem;
        }

        /* Input con espacio para el botón + */
        td[data-field="nombre_conductor"] .input-group input,
        td[data-field="cliente"] .input-group input,
        td[data-field="placa"] .input-group input,
        td[data-field="cedula_conductor"] .input-group input {
            padding-right: 45px !important;
        }

        /* Mejorar contraste de inputs editables */
        .editable-input {
            border: 1px solid transparent !important;
            background: rgba(11, 133, 82, 0.03) !important;
        }

        .editable-input:hover {
            background: rgba(11, 133, 82, 0.06) !important;
            border-color: rgba(11, 133, 82, 0.15) !important;
        }

        .editable-input:focus {
            background: white !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(11, 133, 82, 0.1) !important;
        }

        /* Placeholder más visible */
        .editable-input::placeholder {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Resaltar celdas editables al pasar el mouse */
        .editable-cell:hover,
        td[data-field] .input-group:hover {
            background: rgba(11, 133, 82, 0.08) !important;
        }

        /* Indicador visual de campo editable */
        .editable-cell::before,
        td[data-field]:has(.editable-input)::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .editable-cell:hover::before,
        td[data-field]:has(.editable-input):hover::before {
            opacity: 0.5;
        }

        /* Mejorar tabla responsive */
        .table-responsive-modern {
            border: 2px solid #e3e6f0;
            border-radius: 0.75rem;
        }

        /* Header de tabla más compacto y legible */
        .thead-modern th {
            font-size: 0.8rem !important;
            padding: 0.875rem 0.75rem !important;
            white-space: nowrap;
        }

        /* Mejor espaciado de celdas */
        .tbody-modern td {
            padding: 0.5rem !important;
        }

        /* Input group sin borde visible */
        .input-group.border-0 {
            background: transparent;
        }

        /* Tooltip mejorado para botones */
        .btn-xs[title] {
            position: relative;
        }

        .btn-xs[title]:hover::before {
            content: attr(title);
            position: absolute;
            bottom: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            padding: 0.4rem 0.75rem;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Animación para el botón + cuando aparece */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translateY(-50%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
        }

        .btn-add-new-item[style*="display: block"],
        .btn-add-new-item[style*="display:block"] {
            animation: fadeInScale 0.2s ease !important;
        }

        /* Mejorar selectores (tipo_guia, estado) */
        .editable-select {
            background: rgba(11, 133, 82, 0.03) !important;
            border: 1px solid rgba(11, 133, 82, 0.1) !important;
            cursor: pointer !important;
        }

        .editable-select:hover {
            background: rgba(11, 133, 82, 0.08) !important;
            border-color: rgba(11, 133, 82, 0.2) !important;
        }

        .editable-select:focus {
            background: white !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(11, 133, 82, 0.1) !important;
        }

        /* Mejorar legibilidad de números */
        td[data-field="galones"] .cell-editor,
        td[data-field="barriles"] .cell-editor,
        td[data-field="temperatura"] .cell-editor,
        td[data-field="api_obs"] .cell-editor,
        td[data-field="api_corregido"] .cell-editor {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Resaltar campos importantes */
        td[data-field="placa"],
        td[data-field="producto_a_cargar"],
        td[data-field="cliente"] {
            font-weight: 500;
        }

        /* Icono de información en headers */
        .thead-modern th[title] {
            cursor: help;
        }

        /* Responsive mejorado */
        @media (max-width: 992px) {
            .thead-modern th {
                font-size: 0.7rem !important;
                padding: 0.75rem 0.5rem !important;
            }

            .btn-add-new-item {
                padding: 0.25rem 0.4rem !important;
                font-size: 0.8rem !important;
            }
        }

        /* Loading state para inputs */
        .editable-input.loading {
            background: repeating-linear-gradient(90deg,
                    rgba(11, 133, 82, 0.05),
                    rgba(11, 133, 82, 0.05) 10px,
                    rgba(11, 133, 82, 0.08) 10px,
                    rgba(11, 133, 82, 0.08) 20px);
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% {
                background-position: -100px 0;
            }

            100% {
                background-position: 100px 0;
            }
        }
    </style>
    <!-- Header Mejorado -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-lg-6 mb-3 mb-lg-0">
                <div class="page-title-box">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-gradient-primary">
                            <i class="fas fa-truck-loading"></i>
                        </div>
                        <div class="ms-3">
                            <h2 class="page-title mb-0">Programación de Cargue</h2>
                            <p class="page-subtitle mb-0">Gestión de Vehículos y Despachos</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="d-flex justify-content-lg-end align-items-center flex-wrap gap-2">
                    <button class="btn btn-modern btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#uploadExcelModal">
                        <i class="fas fa-file-upload me-2"></i>
                        <span>Importar</span>
                    </button>
                    <div class="btn-group shadow-sm" role="group">
                        <button type="button" class="btn btn-modern btn-outline-success export-btn"
                            data-bs-toggle="modal" data-bs-target="#reportModal" data-format="excel">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                        <button type="button" class="btn btn-modern btn-outline-danger export-btn"
                            data-bs-toggle="modal" data-bs-target="#reportModal" data-format="pdf">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </button>
                    </div>
                    <a href="{{ url_for('reporte_grafico_despachos') }}" class="btn btn-modern btn-warning">
                        <i class="fas fa-chart-bar me-2"></i>
                        <span>Reportes</span>
                    </a>

                </div>
            </div>
        </div>
    </div>

    <!-- Card Principal con Diseño Mejorado -->
    <div class="card card-modern">
        <div class="card-header-modern">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="header-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="card-title-modern mb-0">Registros de Programación</h5>
                            <small class="text-muted">Gestiona y visualiza todas las programaciones</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end mt-3 mt-md-0">
                    <div class="d-flex justify-content-md-end align-items-center gap-2 flex-nowrap">
                        <span class="badge badge-modern badge-primary">
                            <i class="fas fa-user-shield me-1"></i>{{ rol_usuario }}
                        </span>
                        <button id="toggle-activity-panel" class="btn btn-sm btn-modern btn-outline-info" type="button"
                            title="Ver actividad en tiempo real">
                            <i class="fas fa-users me-1"></i>
                            <span class="badge bg-success rounded-circle" id="users-online-count"
                                style="font-size: 0.6rem; padding: 0.2rem 0.4rem;">0</span>
                        </button>
                        <button id="toggle-historial-btn" class="btn btn-sm btn-modern btn-outline-secondary"
                            type="button">
                            <i class="fas fa-history me-1"></i>Ver historial
                        </button>
                        <button id="btn-sort-estado" class="btn btn-sm btn-modern btn-outline-secondary" type="button"
                            title="Ordenar por estado">
                            <i class="fas fa-sort-amount-down me-1"></i>Ordenar estados
                        </button>
                        <button id="btn-add-row" class="btn btn-sm btn-modern btn-primary" type="button"
                            title="Agregar nueva programación">
                            <i class="fas fa-plus me-1"></i>Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive-modern">
                <table class="table table-modern align-middle mb-0">
                    <thead class="thead-modern">
                    </thead>
                    <tbody id="schedule-table-body" class="tbody-modern">
                    </tbody>
                </table>
                <datalist id="productos-lista">
                </datalist>
            </div>
        </div>
    </div>

    <!-- Panel de Estado Refinery - Flotante -->
    <div id="refinery-status-panel" class="refinery-status-panel">
        <div class="refinery-panel-header">
            <i class="fas fa-oil-can me-2"></i>
            <span>Estado Refinery</span>
            <button class="btn-close-panel"
                onclick="document.getElementById('refinery-status-panel').style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="refinery-panel-body" id="refinery-panel-content">
            <p class="text-muted text-center py-3">Cargando...</p>
        </div>
    </div>

    <!-- Panel de Actividad en Tiempo Real -->
    <div id="activity-panel" class="activity-panel" style="display: none;">
        <div class="activity-panel-header">
            <i class="fas fa-users me-2"></i>
            <span>Usuarios Activos</span>
            <button class="btn-close-panel" onclick="document.getElementById('activity-panel').style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="activity-panel-body" id="activity-panel-content">
            <div id="active-users-list" class="active-users-list">
                <p class="text-muted text-center py-3">Sin usuarios activos</p>
            </div>
        </div>
    </div>

    <!-- Botón Flotante WhatsApp -->
    <button id="btn-whatsapp-notify" class="btn-whatsapp-float" style="display: none;" title="Compartir por WhatsApp">
        <i class="fab fa-whatsapp"></i>
        <span class="whatsapp-badge">0</span>
    </button>

    <!-- Botón Flotante para mostrar panel de estado -->
    <button id="btn-toggle-refinery-panel" class="btn-refinery-panel-toggle" title="Ver estado Refinery">
        <i class="fas fa-clipboard-check"></i>
        <span class="refinery-panel-badge" style="display: none;">0</span>
    </button>
</div>

<!-- Modal Upload Excel -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Importar Programación (.xlsx)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-upload-programacion">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Archivo Excel</label>
                        <input type="file" name="excel_file" accept=".xlsx" class="form-control" required />
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="replaceExisting" />
                        <label class="form-check-label" for="replaceExisting">Reemplazar todos los registros
                            existentes</label>
                    </div>
                    <div class="alert alert-info small">
                        Columnas soportadas: fecha_programacion, empresa_transportadora, placa, tanque,
                        nombre_conductor, cedula_conductor, celular_conductor, hora_llegada_estimada, producto_a_cargar,
                        destino, cliente, estado, galones, barriles, temperatura, api_obs, api_corregido, precintos,
                        fecha_despacho, numero_guia.<br>
                        Si falta barriles y existe galones se calculará automáticamente.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="btn-upload-excel" class="btn btn-primary"><i
                        class="fas fa-cloud-upload-alt me-1"></i>Subir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Historial Completo -->
<div class="modal fade" id="historialModal" tabindex="-1" aria-labelledby="historialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-history me-3 fs-4"></i>
                    <div>
                        <h5 class="modal-title mb-0" id="historialModalLabel">Historial Completo de Programación</h5>
                        <small class="opacity-75">Últimos 500 registros ordenados por fecha</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Barra de filtros -->
                <div class="historial-filters-bar">
                    <div class="container-fluid py-3">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label small fw-semibold mb-1">
                                    <i class="fas fa-calendar-plus me-1"></i>Seleccionar Fechas
                                </label>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="filter-fecha-selector" class="form-control form-control-sm">
                                    <button id="btn-add-fecha" class="btn btn-outline-primary btn-sm" type="button">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="fechas-seleccionadas-container" class="mt-2 d-flex flex-wrap gap-1">
                                    <!-- Aquí se agregarán los badges de fechas -->
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-semibold mb-1">Estado</label>
                                <select id="filter-estado" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                    <option value="PROGRAMADO">Programado</option>
                                    <option value="CARGANDO">Cargando</option>
                                    <option value="DESPACHADO">Despachado</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-semibold mb-1">Producto</label>
                                <select id="filter-producto" class="form-select form-select-sm">
                                    <option value="">Todos</option>
                                    <option value="FUEL OIL 4">FUEL OIL 4</option>
                                    <option value="FUEL OIL 6">FUEL OIL 6</option>
                                    <option value="DILUYENTE">DILUYENTE</option>
                                    <option value="MGO">MGO</option>
                                    <option value="DIESEL MARINO">DIESEL MARINO</option>
                                    <option value="VLSFO">VLSFO</option>
                                    <option value="CRUDO">CRUDO</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-semibold mb-1">Buscar Placa/Conductor</label>
                                <input type="text" id="filter-search" class="form-control form-control-sm"
                                    placeholder="Buscar...">
                            </div>
                            <div class="col-md-2">
                                <button id="btn-apply-historial-filters" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-filter me-1"></i>Filtrar
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="d-flex align-items-center gap-3">
                                    <span class="badge bg-secondary" id="historial-total-badge">Total: 0
                                        registros</span>
                                    <button id="btn-clear-historial-filters"
                                        class="btn btn-link btn-sm text-decoration-none">
                                        <i class="fas fa-times me-1"></i>Limpiar filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de tabla con scroll -->
                <div class="historial-table-container">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-bordered mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th style="width: 100px;">Fecha Prog</th>
                                    <th style="width: 120px;">Producto</th>
                                    <th style="width: 80px;">Tipo Guía</th>
                                    <th style="width: 150px;">Empresa Trans.</th>
                                    <th style="width: 90px;">Placa</th>
                                    <th style="width: 80px;">Tanque</th>
                                    <th style="width: 150px;">Conductor</th>
                                    <th style="width: 120px;">Cédula</th>
                                    <th style="width: 120px;">Celular</th>
                                    <th style="width: 70px;">Hora Llegada</th>
                                    <th style="width: 150px;">Destino</th>
                                    <th style="width: 120px;">Cliente</th>
                                    <th style="width: 100px;">Estado</th>
                                    <th style="width: 90px;" class="text-end">Galones</th>
                                    <th style="width: 90px;" class="text-end">Barriles</th>
                                    <th style="width: 90px;" class="text-end">Temperatura</th>
                                    <th style="width: 90px;" class="text-end">API Obs</th>
                                    <th style="width: 90px;" class="text-end">API Corregido</th>
                                    <th style="width: 150px;">Precintos</th>
                                    <th style="width: 100px;">Fecha Desp</th>
                                    <th style="width: 120px;">N° Guía</th>
                                    <th style="width: 150px;" class="sticky-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historial-table-body">
                                <tr>
                                    <td colspan="23" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Cargando historial...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Paginación -->
                <div class="historial-pagination-bar">
                    <div class="container-fluid py-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <span class="text-muted small">Mostrando <span
                                        id="historial-showing-from">0</span>-<span id="historial-showing-to">0</span> de
                                    <span id="historial-showing-total">0</span></span>
                            </div>
                            <div class="col-md-8 text-end">
                                <div class="btn-group" role="group">
                                    <button id="btn-historial-first" class="btn btn-outline-secondary btn-sm"
                                        title="Primera página">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button id="btn-historial-prev" class="btn btn-outline-secondary btn-sm"
                                        title="Página anterior">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" disabled>
                                        Página <span id="historial-current-page">1</span> de <span
                                            id="historial-total-pages">1</span>
                                    </button>
                                    <button id="btn-historial-next" class="btn btn-outline-secondary btn-sm"
                                        title="Página siguiente">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button id="btn-historial-last" class="btn btn-outline-secondary btn-sm"
                                        title="Última página">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-file-export me-2"></i>Opciones del Reporte
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    Selecciona un rango de fechas para generar tu reporte. Si dejas los campos vacíos, se exportarán
                    todos los registros.
                </p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="fecha_inicio" class="form-label fw-semibold">Fecha de Inicio:</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i
                                    class="far fa-calendar-alt text-primary"></i></span>
                            <input type="date" class="form-control" id="fecha_inicio">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="fecha_fin" class="form-label fw-semibold">Fecha de Fin:</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i
                                    class="far fa-calendar-alt text-primary"></i></span>
                            <input type="date" class="form-control" id="fecha_fin">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-2 px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary rounded-2 px-4" id="btn-generate-report">
                    <i class="fas fa-file-export me-1"></i> Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver imagen de guía -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="fas fa-image me-2"></i>Imagen de Guía de Transporte
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="modal-viewer" class="viewer-container"></div>
            </div>
            <div class="modal-footer border-0">
                <a id="btn-download-image" href="#" download="guia_transporte.png"
                    class="btn btn-success rounded-2 px-4">
                    <i class="fas fa-download me-1"></i> Descargar
                </a>
                <button type="button" class="btn btn-outline-secondary rounded-2 px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Input oculto para subir imagen -->
<input type="file" id="hidden-image-input" accept="image/*,application/pdf" style="display: none;">

<!-- Menú Contextual Oculto -->
<div id="row-context-menu" class="custom-context-menu">
    <ul>
        <li data-action="print"><i class="fas fa-print"></i> Imprimir Guía</li>
        <div class="menu-divider"></div>
        <li data-action="upload"><i class="fas fa-upload"></i> Subir Guía</li>
        <li data-action="import"><i class="fas fa-cloud-download-alt"></i> Importar SharePoint</li>
        <li data-action="view"><i class="fas fa-image"></i> Ver Guía</li>
        <li data-action="delete-img"><i class="fas fa-times"></i> Eliminar Imagen</li>
        <div class="menu-divider"></div>
        <li data-action="delete-row" class="delete-option"><i class="fas fa-trash-alt"></i> Eliminar Registro</li>
    </ul>
</div>

<!-- Modales para Gestión de Clientes y Conductores -->
<div class="modal fade" id="modalAgregarCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarCliente">
                    <div class="mb-3">
                        <label for="nombreNuevoCliente" class="form-label">Nombre del Cliente</label>
                        <input type="text" class="form-control" id="nombreNuevoCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="direccionNuevoCliente" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccionNuevoCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="ciudadNuevoCliente" class="form-label">Ciudad y Departamento</label>
                        <input type="text" class="form-control" id="ciudadNuevoCliente" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarCliente">Guardar Cliente</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAgregarConductor" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Nuevo Conductor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarConductor">
                    <div class="mb-3">
                        <label for="nombreNuevoConductor" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="nombreNuevoConductor" required>
                    </div>
                    <div class="mb-3">
                        <label for="cedulaNuevoConductor" class="form-label">Cédula</label>
                        <input type="text" class="form-control" id="cedulaNuevoConductor" required>
                    </div>
                    <div class="mb-3">
                        <label for="placaNuevoConductor" class="form-label">Placa del Cabezote</label>
                        <input type="text" class="form-control" id="placaNuevoConductor" required>
                    </div>
                    <div class="mb-3">
                        <label for="placaTanqueConductor" class="form-label">Placa del Tanque</label>
                        <input type="text" class="form-control" id="placaTanqueConductor">
                    </div>
                    <div class="mb-3">
                        <label for="empresaConductor" class="form-label">Empresa Transportadora</label>
                        <input type="text" class="form-control" id="empresaConductor">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarConductor">Guardar Conductor</button>
            </div>
        </div>
    </div>
</div>

<!-- Datalists para autocompletado en tabla -->
<datalist id="datalist-clientes"></datalist>
<datalist id="datalist-conductores"></datalist>
<datalist id="datalist-cedulas"></datalist>
<datalist id="datalist-placas"></datalist>

{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- VARIABLES Y CONFIGURACIÓN ---
        const userEmail = "{{ email_usuario }}";
        const userRol = "{{ rol_usuario }}";
        const userName = "{{ nombre }}";
        // Solo estos usuarios pueden eliminar (Juliana, Ignacio y Samantha)
        const canDelete = ['ops@conquerstrading.com', 'production@conquerstrading.com', 'logistic@conquerstrading.com'].includes(userEmail);
        const tbody = document.getElementById('schedule-table-body');
        const thead = document.querySelector('table thead');
        const btnAddRow = document.getElementById('btn-add-row');

        // --- NUEVO: Botón para alternar historial ---
        const toggleHistorialBtn = document.getElementById('toggle-historial-btn');
        let mostrandoHistorialCompleto = false;

        const DESPACHADO_LOCK_DELAY_MS = 30 * 60 * 1000;
        const DESPACHADO_OVERRIDE_EMAIL = 'logistic@conquerstrading.com';
        const isDespachadoOverride = userEmail === DESPACHADO_OVERRIDE_EMAIL;
        const despachadoLockTimers = new Map();

        const permissions = {
            'ops@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'tipo_guia', 'numero_guia', 'destino', 'cliente', 'fecha_despacho', 'estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'],
            'logistic@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'tipo_guia', 'numero_guia', 'destino', 'cliente', 'fecha_despacho', 'estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'],
            'oci@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'tipo_guia', 'numero_guia', 'destino', 'cliente', 'fecha_despacho', 'estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'],
            'amariagallo@conquerstrading.com': ['destino', 'cliente'],
            'refinery.control@conquerstrading.com': ['galones', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'],
            // Ignacio ahora con todos los campos como Samantha/logistic
            'production@conquerstrading.com': ['fecha_programacion', 'empresa_transportadora', 'placa', 'tanque', 'nombre_conductor', 'cedula_conductor', 'celular_conductor', 'hora_llegada_estimada', 'producto_a_cargar', 'tipo_guia', 'numero_guia', 'destino', 'cliente', 'fecha_despacho', 'estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'],
            'qualitycontrol@conquerstrading.com': ['estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos']
        };

        const columnsConfig = {
            'fecha_programacion': { width: '130px', type: 'date' },
            'producto_a_cargar': {
                width: '160px',
                type: 'datalist',
                options: ['FUEL OIL 4', 'FUEL OIL 6', 'DILUYENTE', 'MGO', 'DIESEL MARINO', 'VLSFO', 'CRUDO'],
                normalize: true  // Activar normalización automática
            },
            'tipo_guia': {
                width: '120px',
                type: 'select',
                options: ['Física', 'Digital']
            },
            'cliente': { width: '220px' },
            'destino': { width: '180px' },
            'hora_llegada_estimada': { width: '100px', type: 'time' },
            'placa': { width: '150px' },
            'tanque': { width: '100px' },
            'empresa_transportadora': { width: '180px' },
            'nombre_conductor': { width: '350px' },
            'cedula_conductor': { width: '160px' },
            'celular_conductor': { width: '140px' },
            'estado': { width: '150px', type: 'select', options: ['PROGRAMADO', 'CARGANDO', 'DESPACHADO'] },
            'galones': { width: '120px', type: 'number' },
            'barriles': { width: '120px', type: 'number', readonly: true },
            'temperatura': { width: '120px', type: 'number' },
            'api_obs': { width: '120px', type: 'number' },
            'api_corregido': { width: '140px', type: 'number' },
            'precintos': { width: '280px', type: 'text' },
            'fecha_despacho': { width: '140px', type: 'date' },
            'numero_guia': { width: '180px' }
        };
        const reportModal = document.getElementById('reportModal');

        // --- INICIALIZAR DRAG-TO-SCROLL Y BOTONES FLOTANTES ---
        const tableContainer = document.querySelector('.table-responsive-modern');
        if (tableContainer) {
            // Agregar botones de scroll si no existen
            if (!tableContainer.querySelector('.table-scroll-btn.scroll-left')) {
                const btnLeft = document.createElement('div');
                btnLeft.className = 'table-scroll-btn scroll-left';
                btnLeft.innerHTML = '<i class="fas fa-chevron-left"></i>';
                btnLeft.onclick = () => {
                    tableContainer.scrollBy({ left: -300, behavior: 'smooth' });
                };
                tableContainer.appendChild(btnLeft);

                const btnRight = document.createElement('div');
                btnRight.className = 'table-scroll-btn scroll-right';
                btnRight.innerHTML = '<i class="fas fa-chevron-right"></i>';
                btnRight.onclick = () => {
                    tableContainer.scrollBy({ left: 300, behavior: 'smooth' });
                };
                tableContainer.appendChild(btnRight);
            }

            // Lógica Drag-to-Scroll
            let isDown = false;
            let startX;
            let scrollLeft;

            tableContainer.classList.add('grab-cursor');

            tableContainer.addEventListener('mousedown', (e) => {
                // No activar si se clickea en inputs o botones
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.closest('button')) return;

                isDown = true;
                tableContainer.classList.add('grabbing-cursor');
                startX = e.pageX - tableContainer.offsetLeft;
                scrollLeft = tableContainer.scrollLeft;
            });

            tableContainer.addEventListener('mouseleave', () => {
                isDown = false;
                tableContainer.classList.remove('grabbing-cursor');
            });

            tableContainer.addEventListener('mouseup', () => {
                isDown = false;
                tableContainer.classList.remove('grabbing-cursor');
            });

            tableContainer.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - tableContainer.offsetLeft;
                const walk = (x - startX) * 1.5; // Velocidad de scroll
                tableContainer.scrollLeft = scrollLeft - walk;
            });

            // Actualizar visibilidad de indicadores y botones
            const updateScrollIndicators = () => {
                const maxScrollLeft = tableContainer.scrollWidth - tableContainer.clientWidth;
                if (maxScrollLeft > 0 && tableContainer.scrollLeft < maxScrollLeft - 10) {
                    tableContainer.classList.add('can-scroll-right');
                    // Mostrar btn derecho
                    const btnRight = tableContainer.querySelector('.scroll-right');
                    if (btnRight) btnRight.style.display = 'flex';
                } else {
                    tableContainer.classList.remove('can-scroll-right');
                    const btnRight = tableContainer.querySelector('.scroll-right');
                    if (btnRight) btnRight.style.display = 'none';
                }

                // Botón izquierdo
                const btnLeft = tableContainer.querySelector('.scroll-left');
                if (btnLeft) {
                    btnLeft.style.display = tableContainer.scrollLeft > 10 ? 'flex' : 'none';
                }
            };

            tableContainer.addEventListener('scroll', updateScrollIndicators);
            window.addEventListener('resize', updateScrollIndicators);
            // Check inicial
            setTimeout(updateScrollIndicators, 1000); // Esperar renderizado
        }
        let exportFormat = ''; // Variable para guardar si es 'excel' o 'pdf'

        // Cuando el modal se está por abrir, guardamos el formato del botón que se presionó.
        reportModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            exportFormat = button.getAttribute('data-format');
        });

        // Cuando se hace clic en "Generar Reporte" dentro del modal.
        document.getElementById('btn-generate-report').addEventListener('click', function () {
            const fechaInicio = document.getElementById('fecha_inicio').value;
            const fechaFin = document.getElementById('fecha_fin').value;

            // Construimos la URL base para la exportación.
            let url = `/exportar_programacion_cargue/${exportFormat}`;

            // Añadimos las fechas como parámetros a la URL.
            const params = new URLSearchParams();
            if (fechaInicio) {
                params.append('fecha_inicio', fechaInicio);
            }
            if (fechaFin) {
                params.append('fecha_fin', fechaFin);
            }

            // Si hay parámetros, los añadimos a la URL.
            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            // Cerramos el modal y abrimos la URL para descargar el archivo.
            const modalInstance = bootstrap.Modal.getInstance(reportModal);
            modalInstance.hide();
            window.location.href = url;
        });

        const allColumns = Object.keys(columnsConfig);
        const userPermissions = permissions[userEmail] || [];
        const isAdmin = userRol === 'admin';
        let originalData = [];

        // --- DATOS GLOBALES INYECTADOS ---
        let conductores = {{ lista_conductores | default ([]) | tojson | safe
    }};

    // --- Nuevo: Guardar Conductor ---
    const btnGuardarConductor = document.getElementById('btnGuardarConductor');
    if (btnGuardarConductor) {
        btnGuardarConductor.addEventListener('click', function () {
            const nombre = document.getElementById('nombreNuevoConductor').value.trim();
            const cedula = document.getElementById('cedulaNuevoConductor').value.trim();
            const placa = document.getElementById('placaNuevoConductor').value.trim();
            const tanque = document.getElementById('placaTanqueConductor').value.trim();
            const empresa = document.getElementById('empresaConductor').value.trim();

            if (!nombre || !cedula) {
                showToast('warning', 'Nombre y Cédula son obligatorios');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

            fetch('/api/conductores', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, cedula, placa, tanque, empresa })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Conductor guardado correctamente');
                        const nuevo = {
                            "NOMBRE CONDUCTOR": nombre.toUpperCase(),
                            "N° DOCUMENTO": cedula,
                            "PLACA": placa.toUpperCase(),
                            "PLACA REMOLQUE": tanque.toUpperCase(),
                            "EMPRESA": empresa.toUpperCase(),
                            "CELULAR": ""
                        };
                        conductores.push(nuevo);
                        const modalEl = document.getElementById('modalAgregarConductor');
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) modalInstance.hide();
                        document.getElementById('formAgregarConductor').reset();
                    } else {
                        showToast('danger', data.message || 'Error al guardar');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('danger', 'Error de conexión');
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = 'Guardar Conductor';
                });
        });
    }
    let clientes = {{ lista_clientes | default ([]) | tojson | safe }};
    let productos = [], empresas = [];

    // --- FUNCIONES DE CARGA Y ACTUALIZACIÓN ---
    async function cargarDatos() {
        const cargarJson = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) return [];
                return await response.json();
            } catch (error) {
                console.error(`Fallo al cargar ${url}:`, error);
                return [];
            }
        };

        // Cargar productos y empresas (estáticos)
        try {
            const results = await Promise.all([
                cargarJson("{{ url_for('static', filename='Producto.json') }}"),
                cargarJson("{{ url_for('static', filename='EmpresasTransportadoras.json') }}")
            ]);
            productos = results[0] || [];
            empresas = results[1] || [];
        } catch (e) {
            console.error("Error cargando productos/empresas:", e);
        }

        // Llenar datalists de la tabla
        actualizarDatalistConductores();
        actualizarDatalistClientes();

        // Llenar dropdowns de los modales de gestión
        actualizarDropdownEmpresas();
        // actualizarDropdownClientes(); // Esta funcion puede estar definida mas abajo o necesitar ser redefinida

        // Llenar productoSelect si existe
        const prodSel = document.getElementById('productoSelect');
        if (prodSel) {
            prodSel.innerHTML = '';
            productos.forEach(p => prodSel.insertAdjacentHTML('beforeend', `<option value="${p.PRODUCTO}">${p.PRODUCTO}</option>`));
        }
    }

    function actualizarDatalistConductores() {
        // Optimización: No cargar 6000 registros al inicio para evitar bloqueo del navegador.
        // Se llenará dinámicamente al escribir (evento input).
        const dl = document.getElementById('datalist-conductores');
        if (dl) dl.innerHTML = '';
    }

    function actualizarDatalistClientes() {
        const dl = document.getElementById('datalist-clientes');
        if (dl) {
            const options = clientes.map(c => {
                return `<option value="${c.NOMBRE_CLIENTE}">${c.CIUDAD_DEPARTAMENTO || ''} - ${c.DIRECCION || ''}</option>`;
            });
            dl.innerHTML = options.join('');
        }
    }

    function actualizarDropdownEmpresas() {
        // Lista para datalist de empresas si se implementa, o select
        // Por ahora dejo placeholder si no hay elemento especifico
    }

    // Llamada inicial
    cargarDatos();

    // --- NUEVO: Filtrado Dinámico para Rendimiento (Typeahead) ---
    tbody.addEventListener('input', function (e) {
        const input = e.target;
        if (!input.classList.contains('editable-input')) return;

        const field = input.dataset.col;

        // Aplicar solo a conductores por ahora (dataset grande)
        if (field === 'nombre_conductor') {
            const val = input.value.trim().toUpperCase();
            const dl = document.getElementById('datalist-conductores');

            // Si el texto es corto, vaciar para no estorbar
            if (val.length < 1) {
                if (dl) dl.innerHTML = '';
                return;
            }

            // Filtrar en memoria (rápido en JS) y tomar solo primeros 20
            const maxResults = 20;
            let count = 0;
            let optionsHtml = '';

            // Usar for simple para mayor velocidad y break
            for (let i = 0; i < conductores.length; i++) {
                const c = conductores[i];
                const n = (c["NOMBRE CONDUCTOR"] || '').toString().toUpperCase();
                const ced = (c["N° DOCUMENTO"] || '').toString().toUpperCase();
                const pla = (c["PLACA"] || '').toString().toUpperCase();

                // Buscar coincidencia en cualquiera de los campos clave
                if (n.includes(val) || ced.includes(val) || pla.includes(val)) {
                    const compositeValue = `${c["NOMBRE CONDUCTOR"]} | CC:${c["N° DOCUMENTO"]} | PL:${c["PLACA"]}`;
                    optionsHtml += `<option value="${compositeValue}"></option>`;
                    count++;
                    if (count >= maxResults) break;
                }
            }
            if (dl) dl.innerHTML = optionsHtml;
        }

        // --- NUEVO: Lógica similar para sugerencias en Placa y Cédula ---
        else if (field === 'placa' || field === 'cedula_conductor') {
            const val = input.value.trim().toUpperCase();
            // Determinar qué datalist usar
            const dlId = field === 'placa' ? 'datalist-placas' : 'datalist-cedulas';
            const dl = document.getElementById(dlId);

            if (val.length < 1) {
                if (dl) dl.innerHTML = '';
                return;
            }

            const maxResults = 20;
            let count = 0;
            let optionsHtml = '';

            for (let i = 0; i < conductores.length; i++) {
                const c = conductores[i];
                // Convertir a string para búsqueda segura
                const targetVal = field === 'placa' ? (c["PLACA"] || '') : (c["N° DOCUMENTO"] || '');
                const strVal = String(targetVal).toUpperCase();

                if (strVal.includes(val)) {
                    // Para estos campos, sugerimos el valor exacto que va en la celda
                    // Pero podemos mostrar info extra en un label si se quisiera (Chrome no siempre lo muestra bien en datalist simple)
                    // Usar el valor directo es más seguro para la selección.
                    // Ojo: Chrome muestra value y label.
                    optionsHtml += `<option value="${targetVal}">Conductor: ${c["NOMBRE CONDUCTOR"]}</option>`;
                    count++;
                    if (count >= maxResults) break;
                }
            }
            if (dl) dl.innerHTML = optionsHtml;
        }
    });

    // --- Lógica para mostrar botón '+' si no existe ---
    tbody.addEventListener('input', function (e) {
        const input = e.target;
        if (!input.classList.contains('editable-input')) return;

        const field = input.dataset.col;
        const val = input.value.trim().toUpperCase();
        const td = input.closest('td');
        const btnAdd = td.querySelector('.btn-add-new-item');

        if (!btnAdd) return;

        let exists = false;

        if (field === 'cliente') {
            exists = clientes.some(c => (c.NOMBRE_CLIENTE || '').toUpperCase() === val);
        } else if (field === 'nombre_conductor') {
            // Búsqueda flexible: nombre, cédula o placa
            exists = conductores.some(c =>
                (c["NOMBRE CONDUCTOR"] || '').toUpperCase() === val ||
                String(c["N° DOCUMENTO"] || '').toUpperCase() === val ||
                (c["PLACA"] || '').toUpperCase() === val
            );
        } else if (field === 'placa') {
            exists = conductores.some(c => (c["PLACA"] || '').toUpperCase() === val);
        } else if (field === 'cedula_conductor') {
            exists = conductores.some(c => String(c["N° DOCUMENTO"] || '').trim().toUpperCase() === val);
        }

        // Mostrar botón solo si hay texto y NO existe coincidencia
        if (val.length > 0 && !exists) {
            btnAdd.style.display = 'block';
        } else {
            btnAdd.style.display = 'none';
        }
    });

    // --- Click en el botón '+' ---
    tbody.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-add-new-item');
        if (!btn) return;

        const td = btn.closest('td');
        const input = td.querySelector('input');
        const field = input.dataset.col;
        const val = input.value.trim(); // Mantener capitalización original para pre-llenar forms

        if (field === 'cliente') {
            const modalEl = document.getElementById('modalAgregarCliente');
            const form = document.getElementById('formAgregarCliente');
            form.reset();
            document.getElementById('nombreNuevoCliente').value = val;
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        } else {
            // Es conductor (nombre, placa o cédula)
            const modalEl = document.getElementById('modalAgregarConductor');
            const form = document.getElementById('formAgregarConductor');
            form.reset();

            if (field === 'nombre_conductor') {
                document.getElementById('nombreNuevoConductor').value = val;
            } else if (field === 'placa') {
                document.getElementById('placaNuevoConductor').value = val;
            } else if (field === 'cedula_conductor') {
                document.getElementById('cedulaNuevoConductor').value = val;
            }

            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    });

    // Autocompletado inteligente al seleccionar
    tbody.addEventListener('change', function (e) {
        const input = e.target;
        // Verificar si es un input editable dentro de la tabla
        if (!input.classList.contains('editable-input')) return;

        const tr = input.closest('tr');
        if (!tr) return;

        const field = input.dataset.col;
        let val = input.value.trim().toUpperCase();

        // Función helper para actualizar celda y guardar
        const updateAndSave = (campo, valor) => {
            const td = tr.querySelector(`td[data-field="${campo}"]`);
            if (td && valor) {
                const inp = td.querySelector('input');
                const span = td.querySelector('.cell-editor');
                if (inp) inp.value = valor;
                else if (span) span.textContent = valor;
                else td.textContent = valor;

                // Guardar cambio
                autosaveCell(td);
            }
        };

        if (field === 'nombre_conductor') {
            // 1. Limpieza de valor compuesto (si viene del datalist con formato "NOMBRE | CC:...")
            if (val.includes('|')) {
                const parts = val.split('|');
                const realName = parts[0].trim();
                input.value = realName; // Visualmente solo el nombre
                val = realName.toUpperCase(); // Actualizar variable val para búsqueda

                // Disparar guardado del nombre limpio
                const td = input.closest('td');
                if (td) autosaveCell(td);
            }

            // Búsqueda flexible: Nombre -> Cédula -> Placa
            let match = conductores.find(c => (c["NOMBRE CONDUCTOR"] || '').toUpperCase() === val);
            if (!match) {
                // Intentar buscar por Cédula exacta
                match = conductores.find(c => String(c["N° DOCUMENTO"] || '').toUpperCase() === val);
            }
            if (!match) {
                // Intentar buscar por Placa
                match = conductores.find(c => (c["PLACA"] || '').toUpperCase() === val);
            }

            if (match) {
                // Si el usuario escribió cedula/placa, actualizamos el campo nombre
                if (input.value.toUpperCase() !== (match["NOMBRE CONDUCTOR"] || '').toUpperCase()) {
                    input.value = match["NOMBRE CONDUCTOR"];
                }

                if (match["N° DOCUMENTO"]) updateAndSave('cedula_conductor', match["N° DOCUMENTO"]);
                if (match.PLACA) updateAndSave('placa', match.PLACA);
                if (match["PLACA REMOLQUE"]) updateAndSave('tanque', match["PLACA REMOLQUE"]);
                if (match.CELULAR) updateAndSave('celular_conductor', match.CELULAR);
                // Empresa opcional
                if (match.EMPRESA) updateAndSave('empresa_transportadora', match.EMPRESA);
            }
        } else if (field === 'placa') {
            // Buscar conductor por Placa
            const match = conductores.find(c => (c.PLACA || '').toUpperCase() === val);
            if (match) {
                // **REEMPLAZO TOTAL**: Actualizar TODOS los campos
                if (match["NOMBRE CONDUCTOR"]) updateAndSave('nombre_conductor', match["NOMBRE CONDUCTOR"]);
                if (match["N° DOCUMENTO"]) updateAndSave('cedula_conductor', match["N° DOCUMENTO"]);
                if (match["PLACA REMOLQUE"]) updateAndSave('tanque', match["PLACA REMOLQUE"]);
                if (match.CELULAR) updateAndSave('celular_conductor', match.CELULAR);
                if (match.EMPRESA) updateAndSave('empresa_transportadora', match.EMPRESA);
            }
            // Si el string no está vacío y NO hubo match, es un dato nuevo. 
            // El usuario quiere que "si busco otro se reemplace". Si NO hay match, 
            // se queda lo que escribió y NO se autocompleta nada (comportamiento correcto para nuevos).
            // Pero si estaba editando una celda llena, borró y escribió algo nuevo, 
            // los otros campos se deben quedar o borrar? Normalmente en estos sistemas, 
            // si cambias la llave (placa), deberías limpiar los dependientes si no hay match nuevo.
            // Pero como puede ser crear uno nuevo, mejor NO borrar automáticamente salvo que sea explícito.
            // Lo crítico era que al haber match, NO estaba actualizando todo. Ahora con el bloque de arriba SÍ lo hace.
        } else if (field === 'cedula_conductor') {
            // Buscar conductor por Cédula
            const match = conductores.find(c => String(c["N° DOCUMENTO"] || '').trim() === val);
            if (match) {
                // **REEMPLAZO TOTAL**: Actualizar TODOS los campos
                if (match["NOMBRE CONDUCTOR"]) updateAndSave('nombre_conductor', match["NOMBRE CONDUCTOR"]);
                if (match["PLACA"]) updateAndSave('placa', match["PLACA"]);
                if (match["PLACA REMOLQUE"]) updateAndSave('tanque', match["PLACA REMOLQUE"]);
                if (match.CELULAR) updateAndSave('celular_conductor', match.CELULAR);
                if (match.EMPRESA) updateAndSave('empresa_transportadora', match.EMPRESA);
            }
        } else if (field === 'cliente') {
            const cliente = clientes.find(c => (c.NOMBRE_CLIENTE || '').toUpperCase() === val);
            if (cliente) {
                // Sugerir destino si está disponible
                if (cliente.CIUDAD_DEPARTAMENTO) updateAndSave('destino', cliente.CIUDAD_DEPARTAMENTO);
            }
        }
    });

    // --- FUNCIONES DE RENDERIZADO Y FILTRADO ---
    function fetchAndRender(historialCompleto = false) {
        let url = "{{ url_for('handle_programacion') }}";
        if (historialCompleto) {
            url += '?all=1';
        }
        fetch(url)
            .then(res => res.ok ? res.json() : Promise.reject('Error de red'))
            .then(data => {
                // Guardar datos traídos desde el servidor
                originalData = data;
                // Si el usuario está editando (fila con clase editing-row o elemento activo dentro del tbody),
                // no re-renderizamos para evitar perder datos en edición. Dejamos los datos en memoria para aplicar luego.
                const currentlyEditing = tbody.querySelector('.editing-row') || tbody.contains(document.activeElement);
                if (currentlyEditing) {
                    // marcar que hay una actualización pendiente (se usa para que el usuario aplique el orden manualmente)
                    const sortBtn = document.getElementById('btn-sort-estado');
                    if (sortBtn) sortBtn.classList.add('btn-warning');
                    return;
                }

                renderTable(data);
            })
            .catch(error => {
                console.error('Error en fetchAndRender:', error);
                thead.innerHTML = '';
                tbody.innerHTML = `<tr><td colspan="100%" class="text-center text-danger py-3">Error al cargar la información.</td></tr>`;
            });
    }

    function renderTable(data) {
        renderHeader();
        renderBody(data);
    }

    function renderHeader() {
        let headerHtml = '<tr class="align-middle">';
        let filterHtml = '<tr id="filter-row" class="align-middle">';
        // 1. Número (#) - Sticky Left 0
        headerHtml += `<th style="width: 70px; min-width: 70px; position: sticky; left: 0; z-index: 20; background-color: var(--sticky-bg-header);" class="text-center th-shadow">#</th>`;
        filterHtml += '<th style="position: sticky; left: 0; z-index: 21; background-color: var(--sticky-bg-filter);" class="text-center">#</th>';

        allColumns.forEach(col => {
            const config = columnsConfig[col];
            headerHtml += `<th style="width: ${config.width}; min-width: ${config.width}" class="text-nowrap">${formatColumnName(col)}</th>`;
            filterHtml += `<th><input type="text" class="form-control form-control-sm filter-input" data-filter-col="${col}" placeholder="Buscar..."></th>`;
        });

        // 2. Acciones - Normal al final (Revertido sticky)
        headerHtml += '<th style="width: 160px; min-width: 160px; z-index: 10;" class="text-center sticky-col">Acciones</th>';
        filterHtml += '<th class="sticky-col"></th>';

        headerHtml += '</tr>';
        filterHtml += '</tr>';
        thead.innerHTML = headerHtml + filterHtml;
        thead.querySelector('#filter-row').addEventListener('input', applyFilters);
    }

    // --- FUNCIÓN MODIFICADA PARA RENDERIZAR EL INPUT ---
    function renderBody(data) {
        Array.from(despachadoLockTimers.keys()).forEach(cancelDespachadoTimer);
        tbody.innerHTML = '';
        // Ordenar por estado: PROGRAMADO (blanco) arriba, CARGANDO (amarillo) segundo, DESPACHADO (verde) último
        const estadoOrder = { 'PROGRAMADO': 0, 'CARGANDO': 1, 'DESPACHADO': 2 };
        const sortedData = data.slice().map((r, i) => ({ _origIndex: i, _row: r })).sort((a, b) => {
            const ea = (a._row.estado || 'PROGRAMADO').toUpperCase();
            const eb = (b._row.estado || 'PROGRAMADO').toUpperCase();
            const oa = estadoOrder.hasOwnProperty(ea) ? estadoOrder[ea] : 3;
            const ob = estadoOrder.hasOwnProperty(eb) ? estadoOrder[eb] : 3;
            if (oa !== ob) return oa - ob;
            // Mantener orden original entre mismos estados
            return a._origIndex - b._origIndex;
        }).map(x => x._row);
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${allColumns.length + 2}" class="text-center py-4 text-muted">No hay programaciones que coincidan con los filtros.</td></tr>`;
            return;
        }

        sortedData.forEach((row, index) => {
            const despachadoDesdeAttr = row.despachado_bloqueado_desde || '';
            const despachadoBloqueadoAttr = row.despachado_bloqueado ? '1' : '0';

            // Calcular estado de completitud de Refinery
            const refineriaCamposConfig = {
                'estado': 'Estado',
                'galones': 'Galones',
                'barriles': 'Barriles',
                'temperatura': 'Temperatura',
                'api_obs': 'API Obs',
                'api_corregido': 'API Corregido',
                'precintos': 'Precintos',
                'fecha_despacho': 'Fecha Despacho'
            };
            const refineriaCampos = Object.keys(refineriaCamposConfig);
            const camposFaltantes = refineriaCampos.filter(campo => !row[campo] || row[campo] === '' || row[campo] === 0);
            const camposCompletos = refineriaCampos.length - camposFaltantes.length;
            const totalCampos = refineriaCampos.length;
            const refineriaCompleto = camposFaltantes.length === 0;

            // Crear tooltip con campos faltantes
            let tooltipText = '';
            if (refineriaCompleto) {
                tooltipText = '✅ Refinery completó todos sus campos';
            } else if (camposFaltantes.length > 0) {
                tooltipText = `⏳ Faltan ${camposFaltantes.length} campo(s):\n`;
                camposFaltantes.forEach(campo => {
                    tooltipText += `• ${refineriaCamposConfig[campo]}\n`;
                });
            }

            let rowHtml = `<tr data-id="${row.id}" data-estado="${row.estado || 'PROGRAMADO'}" data-despachado-desde="${despachadoDesdeAttr}" data-despachado-bloqueado="${despachadoBloqueadoAttr}" data-refinery-completo="${refineriaCompleto}" class="align-middle">`;

            // Agregar número de fila con badge discreto de Refinery
            let refineryBadge = '';
            if (refineriaCompleto) {
                refineryBadge = '<span class="refinery-badge-complete" title="✅ Refinery completó todos sus campos"><i class="fas fa-check-circle"></i></span>';
            } else if (camposFaltantes.length > 0) {
                // Badge informativo con tooltip
                refineryBadge = `<span class="refinery-badge-pending" data-bs-toggle="tooltip" data-bs-html="true" title="${tooltipText.replace(/\n/g, '<br>')}" data-bs-placement="right">
                    <i class="fas fa-info-circle"></i>
                    <span class="badge bg-warning text-dark badge-mini">${camposFaltantes.length}</span>
                </span>`;
            }

            // Determinar qué número mostrar: si viene del historial, usar ese número, sino usar índice+1
            const numeroMostrar = row._numeroFilaHistorial || (index + 1);

            // Celda 1: Número (Sticky Left 0)
            rowHtml += `<td class="text-center fw-bold number-cell" style="min-width: 70px; width:70px; background: #f8f9fc; border-right: 2px solid #ced4da; position: sticky; left: 0; z-index: 15;">
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <span class="text-primary">${numeroMostrar}</span>
                                ${refineryBadge}
                            </div>
                        </td>`;



            allColumns.forEach(col => {
                const config = columnsConfig[col];
                const isEditable = !config.readonly && (isAdmin || userPermissions.includes(col));
                const value = row[col] || '';
                // Si el usuario es refinería y el registro está bloqueado, no permitir edición de sus campos
                const refineriaBlocked = row.refineria_bloqueado && userEmail === 'refinery.control@conquerstrading.com' && ['estado', 'galones', 'barriles', 'temperatura', 'api_obs', 'api_corregido', 'precintos', 'fecha_despacho'].includes(col);
                let finalEditable = isEditable && !refineriaBlocked;
                const lockBadge = '';
                if (config.type === 'datalist' && finalEditable) {
                    rowHtml += `<td data-field="${col}" data-type="datalist" class="position-relative">
                                    ${lockBadge}
                                    <input list="productos-lista" class="form-control form-control-sm border-0 bg-transparent editable-input" value="${value}" data-col="${col}">
                                </td>`;
                } else if (config.type === 'select' && finalEditable) {
                    // Renderizar un SELECT para tipo_guia y otros campos select
                    const options = config.options || [];
                    let selectHtml = `<select class="form-select form-select-sm border-0 bg-transparent editable-select" data-col="${col}">`;
                    selectHtml += `<option value="">Seleccionar...</option>`;
                    options.forEach(opt => {
                        const selected = value === opt ? 'selected' : '';
                        selectHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });
                    selectHtml += '</select>';
                    rowHtml += `<td data-field="${col}" data-type="select" class="position-relative">
                                    ${lockBadge}
                                    ${selectHtml}
                                </td>`;
                } else if (col === 'cliente' && finalEditable) {
                    rowHtml += `<td data-field="${col}" data-type="text" class="position-relative">
                                    ${lockBadge}
                                    <div class="input-group input-group-sm border-0">
                                        <input list="datalist-clientes" class="form-control border-0 bg-transparent editable-input" value="${value}" data-col="${col}" placeholder="Buscar cliente...">
                                        <button class="btn btn-outline-success btn-xs btn-add-new-item" style="display:none; z-index: 5;" type="button" title="Agregar Nuevo Cliente"><i class="fas fa-plus"></i></button>
                                    </div>
                                </td>`;
                } else if (col === 'nombre_conductor' && finalEditable) {
                    rowHtml += `<td data-field="${col}" data-type="text" class="position-relative">
                                    ${lockBadge}
                                    <div class="input-group input-group-sm border-0">
                                        <input list="datalist-conductores" class="form-control border-0 bg-transparent editable-input" value="${value}" data-col="${col}" placeholder="Buscar conductor...">
                                        <button class="btn btn-outline-success btn-xs btn-add-new-item" style="display:none; z-index: 5;" type="button" title="Agregar Nuevo Conductor"><i class="fas fa-plus"></i></button>
                                    </div>
                                </td>`;
                } else if (col === 'cedula_conductor' && finalEditable) {
                    rowHtml += `<td data-field="${col}" data-type="text" class="position-relative">
                                    ${lockBadge}
                                    <div class="input-group input-group-sm border-0">
                                        <input type="text" list="datalist-cedulas" class="form-control border-0 bg-transparent editable-input" value="${value}" data-col="${col}" placeholder="Buscar CC...">
                                        <button class="btn btn-outline-success btn-xs btn-add-new-item" style="display:none; z-index: 5;" type="button" title="Agregar Nuevo"><i class="fas fa-plus"></i></button>
                                    </div>
                                </td>`;
                } else if (col === 'placa' && finalEditable) {
                    rowHtml += `<td data-field="${col}" data-type="text" class="position-relative">
                                    ${lockBadge}
                                    <div class="input-group input-group-sm border-0">
                                        <input type="text" list="datalist-placas" class="form-control border-0 bg-transparent editable-input" value="${value}" data-col="${col}" placeholder="Buscar placa...">
                                        <button class="btn btn-outline-success btn-xs btn-add-new-item" style="display:none; z-index: 5;" type="button" title="Agregar Nuevo"><i class="fas fa-plus"></i></button>
                                    </div>
                                </td>`;
                } else {
                    if (finalEditable) {
                        rowHtml += `<td data-field="${col}" data-type="${config.type || 'text'}" class="editable-cell ${config.type === 'number' ? 'text-end' : ''} position-relative ${refineriaBlocked ? 'opacity-75' : ''}" style="min-width: ${config.width}"><span class="cell-editor" contenteditable="true" data-col="${col}">${formatCellValue(value, config)}</span></td>`;
                    } else {
                        rowHtml += `<td data-field="${col}" data-type="${config.type || 'text'}" class="${config.type === 'number' ? 'text-end' : ''} position-relative ${refineriaBlocked ? 'opacity-75' : ''}" style="min-width: ${config.width}">${formatCellValue(value, config)}</td>`;
                    }
                }
            });
            // Celda Acciones: Normal al final (Sticky removido)
            rowHtml += `<td class="text-center save-status-cell sticky-col" data-id="${row.id}" style="min-width: 160px;">
                            <div class="action-buttons-container">
                                <div class="d-flex justify-content-center align-items-center mb-1">
                                    <span class="save-indicator me-2" style="width: 16px; height: 16px;"></span>
                                </div>
                                <div class="btn-group btn-group-sm flex-wrap justify-content-center" role="group">
                                    <button class="btn btn-outline-info btn-xs btn-print-guide" title="Imprimir" style="padding: 0.15rem 0.4rem;">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    ${canDelete ? `<button class\="btn btn-outline-danger btn-xs btn-delete-row\" title\="Eliminar\" style\="padding: 0.15rem 0.4rem;"><i class\="fas fa-trash-alt"></i></button>` : ''}
                                    ${!row.imagen_guia ? `
                                    <button class="btn btn-outline-success btn-xs btn-upload-image" title="Subir" style="padding: 0.15rem 0.4rem;">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-xs btn-import-sharepoint" title="Importar SP" ${!row.numero_guia ? 'disabled' : ''} style="padding: 0.15rem 0.4rem;">
                                        <i class="fas fa-cloud-download-alt"></i>
                                    </button>
                                    ` : ''}
                                    ${row.imagen_guia ? `
                                    <button class="btn btn-outline-primary btn-xs btn-view-image" title="Ver" style="padding: 0.15rem 0.4rem;">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-xs btn-delete-image" title="Borrar img" style="padding: 0.15rem 0.4rem;">
                                        <i class="fas fa-times"></i>
                                    </button>` : ''}
                                </div>
                            </div>
                        </td>`;

            rowHtml += `</tr>`;
            tbody.innerHTML += rowHtml;
        });

        Array.from(tbody.querySelectorAll('tr')).forEach(initializeDespachadoLock);
    }

    // --- LOGICA DEL MENU CONTEXTUAL ---
    const contextMenu = document.getElementById('row-context-menu');
    let activeRowId = null;

    document.addEventListener('click', () => contextMenu.style.display = 'none');

    tbody.addEventListener('contextmenu', function (e) {
        const tr = e.target.closest('tr');
        if (!tr) return;

        e.preventDefault();
        activeRowId = tr.dataset.id;

        // Determinar qué opciones mostrar basado en el estado de la fila (tiene imagen?)
        const hasImage = tr.querySelector('.btn-view-image') !== null;
        const menuItems = contextMenu.querySelectorAll('li');

        menuItems.forEach(item => {
            const action = item.dataset.action;
            if (action === 'upload' || action === 'import') item.style.display = hasImage ? 'none' : 'flex';
            if (action === 'view' || action === 'delete-img') item.style.display = hasImage ? 'flex' : 'none';
        });

        // Posicionar menú
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${e.pageX}px`;
        contextMenu.style.top = `${e.pageY}px`;
    });

    contextMenu.addEventListener('click', function (e) {
        const li = e.target.closest('li');
        if (!li || !activeRowId) return;

        const action = li.dataset.action;
        const tr = tbody.querySelector(`tr[data-id="${activeRowId}"]`);
        if (!tr) return;

        // Simular clic en el botón correspondiente de la fila
        const actionMap = {
            'print': '.btn-print-guide',
            'upload': '.btn-upload-image',
            'import': '.btn-import-sharepoint',
            'view': '.btn-view-image',
            'delete-img': '.btn-delete-image',
            'delete-row': '.btn-delete-row'
        };

        const btnSelector = actionMap[action];
        if (btnSelector) {
            const btn = tr.querySelector(btnSelector);
            if (btn) {
                btn.click();
            } else {
                showToast('warning', 'Esta acción no está disponible para este registro actualmente.');
            }
        }
    });



    function applyFilters() {
        const filters = Array.from(thead.querySelectorAll('.filter-input')).reduce((acc, input) => {
            if (input.value) { acc[input.dataset.filterCol] = input.value.toLowerCase(); }
            return acc;
        }, {});
        const filteredData = originalData.filter(row => {
            return Object.keys(filters).every(col => {
                return String(row[col] || '').toLowerCase().includes(filters[col]);
            });
        });
        renderBody(filteredData);
    }

    function formatColumnName(colName) {
        const abbreviations = {
            'hora_llegada_estimada': 'HORA LLEG',
            'empresa_transportadora': 'EMPRESA TRANSP',
            'fecha_programacion': 'FECHA PROG',
            'fecha_despacho': 'FECHA DESP',
            'numero_guia': 'N° GUIA',
            'producto_a_cargar': 'PRODUCTO',
            'nombre_conductor': 'CONDUCTOR',
            'tipo_guia': 'TIPO GUIA',
            'cedula_conductor': 'CÉDULA',
            'celular_conductor': 'CELULAR',
            'api_corregido': 'API CORR'
        };
        if (abbreviations[colName]) return abbreviations[colName];
        return colName.replace(/_/g, ' ').toUpperCase();
    }

    function formatCellValue(value, config) {
        if (value === null || value === undefined || value === '') return '';
        switch (config.type) {
            case 'date':
                return new Date(value + 'T00:00:00').toLocaleDateString('es-CO', { timeZone: 'UTC' });
            case 'time':
                return value.slice(0, 5);
            case 'number':
                return Number(value).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            default:
                return value;
        }
    }

    // --- MANEJADORES DE EVENTOS ---
    btnAddRow.addEventListener('click', function () {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> Procesando...';
        fetch("{{ url_for('handle_programacion') }}", { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Nueva programación creada');
                    fetchAndRender();
                } else {
                    showToast('danger', 'Error: ' + data.message);
                }
            })
            .catch(error => showToast('danger', 'Error de conexión'))
            .finally(() => {
                this.disabled = false;
                this.innerHTML = `<i class="fas fa-plus me-1"></i>Agregar`;
            });
    });

    tbody.addEventListener('input', function (e) {
        const cell = e.target.closest('td[data-field]');
        if (!cell) return;

        if (cell.dataset.field === 'galones' && e.target.classList.contains('cell-editor')) {
            const row = cell.closest('tr');
            const barrilesCell = row.querySelector('[data-field="barriles"]');
            const galonesValue = parseFloat(e.target.textContent.replace(/\./g, '').replace(',', '.')) || 0;
            const barrilesValue = galonesValue / 42;
            barrilesCell.textContent = barrilesValue.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        // ...existing code...
    });

    tbody.addEventListener('blur', function (e) {
        if (e.target.classList.contains('cell-editor') || e.target.classList.contains('editable-input')) {
            const td = e.target.closest('td[data-field]');
            autosaveCell(td);
            liberarLock(td);
        }
    }, true);

    // Guardar automáticamente cuando cambia un select (tipo_guia, estado, etc.)
    tbody.addEventListener('change', function (e) {
        if (e.target.classList.contains('editable-select')) {
            const td = e.target.closest('td[data-field]');
            autosaveCell(td);
        }
    });

    // Quitar resaltado de fila cuando se pierde el foco
    tbody.addEventListener('focusout', function (e) {
        const td = e.target.closest('td[data-field]');
        if (!td) return;
        const row = td.closest('tr');
        // Verificar si aún hay algún elemento en la fila con foco
        setTimeout(() => {
            if (!row.contains(document.activeElement)) {
                row.classList.remove('editing-row');
                hideRowContextInfo();
            }
        }, 100);
    });

    // Función para mostrar información contextual de la fila
    function showRowContextInfo(row) {
        const placa = row.querySelector('td[data-field="placa"] .cell-editor')?.textContent ||
            row.querySelector('td[data-field="placa"]')?.textContent || 'N/A';
        const conductor = row.querySelector('td[data-field="nombre_conductor"] .cell-editor')?.textContent ||
            row.querySelector('td[data-field="nombre_conductor"]')?.textContent || 'N/A';
        // producto_a_cargar usa un input en lugar de cell-editor, necesitamos obtener su value
        const productoInput = row.querySelector('td[data-field="producto_a_cargar"] .editable-input');
        const producto = productoInput ? productoInput.value :
            (row.querySelector('td[data-field="producto_a_cargar"]')?.textContent || 'N/A');
        const estado = row.querySelector('td[data-field="estado"] .cell-editor')?.textContent ||
            row.querySelector('td[data-field="estado"]')?.textContent || 'PROGRAMADO';

        let contextInfo = document.getElementById('row-context-info');
        if (!contextInfo) {
            contextInfo = document.createElement('div');
            contextInfo.id = 'row-context-info';
            contextInfo.className = 'row-context-info';
            document.body.appendChild(contextInfo);
        }

        contextInfo.innerHTML = `
            <div class="context-header">
                <i class="fas fa-edit"></i>
                <span>Editando Fila</span>
            </div>
            <div class="context-details">
                <div class="context-item">
                    <i class="fas fa-truck"></i>
                    <span><strong>Placa:</strong> ${placa.trim()}</span>
                </div>
                <div class="context-item">
                    <i class="fas fa-user"></i>
                    <span><strong>Conductor:</strong> ${conductor.trim()}</span>
                </div>
                <div class="context-item">
                    <i class="fas fa-oil-can"></i>
                    <span><strong>Producto:</strong> ${producto.trim()}</span>
                </div>
                <div class="context-item">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>Estado:</strong> ${estado.trim()}</span>
                </div>
            </div>
        `;
        contextInfo.style.display = 'block';
    }

    // Función para ocultar información contextual
    function hideRowContextInfo() {
        const contextInfo = document.getElementById('row-context-info');
        if (contextInfo) {
            contextInfo.style.display = 'none';
        }
    }

    // Locks: al enfocar pedir lock
    tbody.addEventListener('focusin', function (e) {
        const td = e.target.closest('td[data-field]');
        if (!td) return;
        const row = td.closest('tr');
        // Resaltar fila activa
        row.classList.add('editing-row');
        // Mostrar información contextual de la fila
        showRowContextInfo(row);
        fetch('/api/programacion/lock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ registro_id: row.dataset.id, campo: td.dataset.field })
        }).then(r => r.json()).then(resp => {
            if (!resp.success) {
                const badge = td.querySelector('.lock-indicator');
                if (badge) {
                    badge.style.display = 'block';
                    // Mensaje de error del lock (mantenemos tal cual si viene con 'Editando:' del backend)
                    badge.textContent = resp.message.replace(/^Editando:\s*/, '');
                    badge.classList.add('bg-danger', 'text-white');
                }
                if (td.querySelector('.editable-input')) td.querySelector('.editable-input').blur(); else td.blur();
            } else {
                const badge = td.querySelector('.lock-indicator');
                if (badge) {
                    // Mostrar nuestro propio indicador solo si hay contenido (para no "manchar" celdas vacías)
                    const hasContent = (() => {
                        const input = td.querySelector('input.editable-input');
                        const val = input ? input.value : td.textContent;
                        return val.trim().length > 0;
                    })();
                    if (hasContent) {
                        badge.style.display = 'block';
                        if (badge.textContent !== userName) badge.textContent = userName; // solo badge
                        badge.classList.remove('bg-danger', 'text-white');
                    } else {
                        badge.style.display = 'none';
                        badge.textContent = '';
                    }
                    // Mover el cursor al final del contenido real de la celda (evitar caret en el badge)
                    const editor = td.querySelector('.cell-editor');
                    if (editor) {
                        requestAnimationFrame(() => {
                            const range = document.createRange();
                            range.selectNodeContents(editor);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        });
                    }
                }
            }
        }).catch(() => { });
    });

    tbody.addEventListener('focusout', function (e) {
        const td = e.target.closest('td[data-field]');
        if (!td) return;

        // Diferir levemente para verificar el nuevo foco
        setTimeout(() => {
            const activeEl = document.activeElement;
            if (!td.contains(activeEl)) {
                // El foco salió de la celda -> guardar y liberar lock
                const input = td.querySelector('input.editable-input');
                const select = td.querySelector('select.editable-select');
                const span = td.querySelector('.cell-editor');

                if (input || select || span) {
                    // Llamar a autosave
                    autosaveCell(td);
                }
                liberarLock(td);

                // Quitar resaltado de fila
                const row = td.closest('tr');
                if (row) {
                    row.classList.remove('editing-row');
                    // Ocultar info contextual
                    const contextInfo = document.getElementById('row-context-info');
                    if (contextInfo) contextInfo.style.display = 'none';
                }
            }
        }, 100);
    });

    function liberarLock(td) {
        if (!td) return;
        const row = td.closest('tr');
        if (!row) return;

        // Ocultar indicador si existe
        const badge = td.querySelector('.lock-indicator');
        if (badge) badge.style.display = 'none';

        fetch(`/api/programacion/lock?registro_id=${row.dataset.id}&campo=${td.dataset.field}`, { method: 'DELETE' });
    }

    // ...eliminada colaboración en tiempo real...

    // ...eliminada funcionalidad de live edit...

    tbody.addEventListener('click', function (e) {
        const printButton = e.target.closest('.btn-print-guide');
        if (printButton) {
            const row = printButton.closest('tr');
            const url = new URL("{{ url_for('guia_transporte') }}", window.location.origin);
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.dataset.field;
                let value;
                const input = cell.querySelector('input.editable-input');
                if (input) {
                    value = input.value.trim();
                } else {
                    value = cell.textContent.trim();
                }
                if (cell.dataset.type === 'number' && value) {
                    value = value.replace(/\./g, '').replace(',', '.');
                }
                if (value && value !== '-') {
                    url.searchParams.append(field, value);
                    if (field === 'tanque') {
                        url.searchParams.append('placa_tanque', value);
                    }
                }
            });
            window.location.href = url.href;
        }

        // Botón eliminar fila (solo si canDelete true en render)
        const deleteButton = e.target.closest('.btn-delete-row');
        if (deleteButton) {
            if (!canDelete) { return; }
            const row = deleteButton.closest('tr');
            const id = row.dataset.id;
            if (confirm('¿Seguro que deseas eliminar esta programación?')) {
                fetch(`/api/programacion/${id}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast('success', 'Fila eliminada correctamente');
                            fetchAndRender();
                        } else {
                            showToast('danger', 'Error al eliminar: ' + (data.message || ''));
                        }
                    })
                    .catch(() => showToast('danger', 'Error de conexión'));
            }
        }

        // Botón subir imagen de guía
        const uploadButton = e.target.closest('.btn-upload-image');
        if (uploadButton) {
            const row = uploadButton.closest('tr');
            const id = row.dataset.id;

            // Guardar el ID en el input oculto para usarlo después
            const hiddenInput = document.getElementById('hidden-image-input');
            hiddenInput.dataset.registroId = id;
            hiddenInput.click();
        }

        // Botón ver imagen/PDF de guía
        const viewButton = e.target.closest('.btn-view-image');
        if (viewButton) {
            const row = viewButton.closest('tr');
            const id = row.dataset.id;

            // Obtener el archivo (imagen o PDF) del servidor
            fetch(`/api/programacion/${id}/image`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const viewer = document.getElementById('modal-viewer');
                        const downloadBtn = document.getElementById('btn-download-image');

                        // Limpiar el viewer
                        viewer.innerHTML = '';

                        // Usar la fuente y el MIME entregados por el servidor
                        const src = data.imagen; // puede ser URL o data URI
                        const mimeType = (data.mime || '').toLowerCase();

                        // Preparar botón de descarga
                        let extension = 'png';
                        if (mimeType.includes('pdf')) extension = 'pdf';
                        else if (mimeType.includes('jpeg') || mimeType.includes('jpg')) extension = 'jpg';
                        else if (mimeType.includes('gif')) extension = 'gif';
                        else if (mimeType.includes('png')) extension = 'png';
                        else {
                            // Último recurso: deducir por extensión de la URL si aplica
                            try {
                                const u = new URL(src, window.location.href);
                                const path = u.pathname || '';
                                const ext = (path.split('.').pop() || '').toLowerCase();
                                if (['pdf', 'png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
                                    extension = ext === 'jpeg' ? 'jpg' : ext;
                                }
                            } catch (e) { /* ignore */ }
                        }
                        downloadBtn.href = src;
                        downloadBtn.download = `guia_transporte_${id}.${extension}`;

                        // Render según tipo
                        if (mimeType.includes('pdf')) {
                            const embed = document.createElement('embed');
                            embed.type = 'application/pdf';
                            // Añadir parámetros para mostrar toolbar del visor PDF del navegador
                            embed.src = src + '#toolbar=1&navpanes=0&scrollbar=1';
                            embed.style.width = '100%';
                            embed.style.height = '70vh';
                            embed.style.border = '0';
                            viewer.appendChild(embed);
                        } else {
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'Imagen de guía';
                            img.style.maxWidth = '100%';
                            img.style.maxHeight = '70vh';
                            img.style.borderRadius = '8px';
                            viewer.appendChild(img);
                        }

                        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                        imageModal.show();
                    } else {
                        showToast('danger', 'No se pudo cargar el archivo: ' + (data.message || ''));
                    }
                })
                .catch(() => showToast('danger', 'Error al cargar el archivo'));
        }

        // Botón eliminar imagen de guía
        const deleteImageButton = e.target.closest('.btn-delete-image');
        if (deleteImageButton) {
            const row = deleteImageButton.closest('tr');
            const id = row.dataset.id;

            // Confirmar antes de eliminar
            if (confirm('¿Estás seguro de que deseas eliminar esta imagen de guía?')) {
                // Eliminar la imagen del servidor
                fetch(`/api/programacion/${id}/image`, {
                    method: 'DELETE'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast('success', 'Imagen eliminada correctamente');
                            // Recargar la tabla para actualizar los botones
                            fetchAndRender();
                        } else {
                            showToast('danger', 'Error al eliminar: ' + (data.message || ''));
                        }
                    })
                    .catch(() => showToast('danger', 'Error al eliminar la imagen'));
            }
        }

        // Botón Importar desde SharePoint
        const importButton = e.target.closest('.btn-import-sharepoint');
        if (importButton) {
            const row = importButton.closest('tr');
            const id = row.dataset.id;
            const statusIndicator = row.querySelector('.save-indicator');

            const guiaCell = row.querySelector('td[data-field="numero_guia"]');
            let numeroGuia = '';
            if (guiaCell) {
                const input = guiaCell.querySelector('input.editable-input');
                const span = guiaCell.querySelector('.cell-editor');
                if (input) {
                    numeroGuia = input.value;
                } else if (span) {
                    numeroGuia = span.textContent;
                } else {
                    numeroGuia = guiaCell.textContent;
                }
            }
            numeroGuia = numeroGuia.trim();

            if (!numeroGuia) {
                showToast('danger', 'No hay un número de guía en esta fila para importar.');
                return;
            }

            if (!confirm(`¿Estás seguro de que deseas importar la guía "${numeroGuia}.pdf" desde SharePoint? Esto sobrescribirá cualquier archivo de guía existente.`)) {
                return;
            }

            statusIndicator.innerHTML = '<span class="spinner-border spinner-border-sm text-primary" role="status"></span>';
            importButton.disabled = true;

            fetch(`/api/programacion/${id}/importar-sharepoint`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero_guia: numeroGuia })
            })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        showToast('success', data.message || 'Guía importada exitosamente.');
                        fetchAndRender(mostrandoHistorialCompleto);
                    } else {
                        showToast('danger', `Error al importar: ${data.message || 'Error desconocido'}`);
                        statusIndicator.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
                        setTimeout(() => { statusIndicator.innerHTML = ''; }, 3000);
                    }
                })
                .catch(() => {
                    showToast('danger', 'Error de red al importar.');
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    setTimeout(() => { statusIndicator.innerHTML = ''; }, 3000);
                })
                .finally(() => {
                    // La tabla se recargará cuando corresponda; mantener el estado controlado aquí.
                });
        }

        const estadoCell = e.target.closest('td[data-field="estado"].editable-cell');
        if (estadoCell && !estadoCell.querySelector('select')) {
            const originalValue = estadoCell.textContent.trim();
            const config = columnsConfig['estado'];
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm shadow-sm';
            config.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (opt === originalValue) option.selected = true;
                select.appendChild(option);
            });
            estadoCell.innerHTML = '';
            estadoCell.appendChild(select);
            select.focus();
            const handleSelectChange = () => {
                estadoCell.textContent = select.value;
                autosaveCell(estadoCell);
                select.removeEventListener('blur', handleSelectChange);
                select.removeEventListener('change', handleSelectChange);
            };
            select.addEventListener('blur', handleSelectChange);
            select.addEventListener('change', handleSelectChange);
        }
    });

    // --- FUNCIÓN MODIFICADA PARA GUARDAR DESDE EL INPUT ---
    function autosaveCell(cell) {
        const row = cell.closest('tr');
        const id = row.dataset.id;
        const field = cell.dataset.field;
        const config = columnsConfig[field];
        let value;

        const input = cell.querySelector('input.editable-input');
        const select = cell.querySelector('select.editable-select');
        const span = cell.querySelector('.cell-editor');
        if (input) {
            value = input.value.trim();
        } else if (select) {
            value = select.value;
        } else if (span) {
            value = span.textContent.trim();
        } else {
            value = cell.textContent.trim();
        }

        if (value === '' || value === '-') {
            value = null;
        } else if (config.type === 'date' && value) {
            const parts = value.split('/');
            if (parts.length === 3) value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        } else if (config.type === 'number' && value) {
            value = parseFloat(value.replace(/\./g, '').replace(',', '.')) || null;
        }

        const updatedData = { [field]: value };

        if (field === 'galones') {
            updatedData.barriles = (value || 0) / 42;
            // Actualizar visual inmediatamente si existe celda barriles editable o no
            const barrilesCell = row.querySelector('[data-field="barriles"] .cell-editor, [data-field="barriles"]');
            if (barrilesCell) {
                const formatted = ((value || 0) / 42).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (barrilesCell.classList && barrilesCell.classList.contains('cell-editor'))
                    barrilesCell.textContent = formatted;
                else
                    barrilesCell.textContent = formatted;
            }
        }

        const statusIndicator = row.querySelector('.save-indicator');
        statusIndicator.innerHTML = '<span class="spinner-border spinner-border-sm text-primary" role="status"></span>';

        fetch(`/api/programacion/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        })
            .then(res => res.json().then(data => ({ ok: res.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle text-success"></i>';

                    // Actualizar el color de la fila automáticamente si cambió el estado
                    if (field === 'estado' && value) {
                        const estadoActual = value.toUpperCase();
                        row.dataset.estado = estadoActual;
                        updateRowColors(row, estadoActual);
                        if (estadoActual === 'DESPACHADO') {
                            row.dataset.despachadoDesde = new Date().toISOString();
                            row.dataset.despachadoBloqueado = '0';
                        } else {
                            row.dataset.despachadoDesde = '';
                            row.dataset.despachadoBloqueado = '0';
                            releaseRowBlock(row);
                        }
                        initializeDespachadoLock(row);
                    }
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
                    showToast('danger', `Error en ${field}: ` + (data.message || 'Error'));
                    if (field === 'estado') {
                        fetchAndRender(mostrandoHistorialCompleto);
                    }
                }
            })
            .catch(error => {
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                showToast('danger', 'Error de conexión');
            })
            .finally(() => {
                setTimeout(() => { statusIndicator.innerHTML = ''; }, 3000);
            });
    }

    function cancelDespachadoTimer(id) {
        if (!id) return;
        const timerId = despachadoLockTimers.get(id);
        if (timerId) {
            clearTimeout(timerId);
            despachadoLockTimers.delete(id);
        }
    }

    function applyRowBlock(row) {
        if (!row || isDespachadoOverride) return;
        row.dataset.despachadoBloqueado = '1';
        row.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.classList.contains('blocked-field')) {
                el.dataset.originalDisabled = el.disabled ? '1' : '0';
            }
            el.disabled = true;
            el.classList.add('blocked-field');
        });
        row.querySelectorAll('.cell-editor').forEach(el => {
            if (!el.classList.contains('blocked-field')) {
                const original = el.getAttribute('contenteditable');
                el.dataset.originalContentEditable = original !== null ? original : '';
            }
            el.setAttribute('contenteditable', 'false');
            el.classList.add('blocked-field');
        });
        row.classList.add('row-blocked');
    }

    function releaseRowBlock(row) {
        if (!row) return;
        cancelDespachadoTimer(row.dataset.id);
        row.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.classList.contains('blocked-field')) return;
            const originalDisabled = el.dataset.originalDisabled;
            if (originalDisabled === '0') {
                el.disabled = false;
            }
            el.classList.remove('blocked-field');
            delete el.dataset.originalDisabled;
        });
        row.querySelectorAll('.cell-editor').forEach(el => {
            if (!el.classList.contains('blocked-field')) return;
            const originalEditable = el.dataset.originalContentEditable;
            if (originalEditable === '') {
                el.removeAttribute('contenteditable');
            } else if (originalEditable !== undefined) {
                el.setAttribute('contenteditable', originalEditable);
            }
            el.classList.remove('blocked-field');
            delete el.dataset.originalContentEditable;
        });
        row.classList.remove('row-blocked');
        if (row.dataset.despachadoBloqueado === '1') {
            row.dataset.despachadoBloqueado = '0';
        }
    }

    function initializeDespachadoLock(row) {
        if (!row) return;
        const id = row.dataset.id;
        if (!id) return;
        cancelDespachadoTimer(id);

        if (isDespachadoOverride) {
            releaseRowBlock(row);
            return;
        }

        const estadoActual = (row.dataset.estado || '').toUpperCase();
        if (estadoActual !== 'DESPACHADO') {
            releaseRowBlock(row);
            return;
        }

        const startIso = row.dataset.despachadoDesde;
        const yaBloqueado = row.dataset.despachadoBloqueado === '1';
        if (!startIso) {
            if (yaBloqueado) {
                applyRowBlock(row);
            } else {
                releaseRowBlock(row);
            }
            return;
        }

        const isoWithTz = /Z$|[+-]\d{2}:?\d{2}$/.test(startIso) ? startIso : `${startIso}Z`;
        const startTime = Date.parse(isoWithTz);
        if (Number.isNaN(startTime)) {
            releaseRowBlock(row);
            return;
        }

        const elapsed = Date.now() - startTime;
        const remaining = DESPACHADO_LOCK_DELAY_MS - elapsed;

        if (remaining <= 0 || yaBloqueado) {
            applyRowBlock(row);
            return;
        }

        releaseRowBlock(row);
        const timerId = setTimeout(() => {
            applyRowBlock(row);
            despachadoLockTimers.delete(id);
        }, remaining);
        despachadoLockTimers.set(id, timerId);
    }

    // Función para actualizar los colores de la fila según el estado
    function updateRowColors(row, estado) {
        // Actualizar el atributo data-estado
        row.setAttribute('data-estado', estado);

        // Obtener todas las celdas de la fila
        const cells = row.querySelectorAll('td');
        const stickyCol = row.querySelector('td.sticky-col');

        // Limpiar estilos previos
        cells.forEach(cell => {
            cell.style.background = '';
            cell.style.borderLeft = '';
        });

        if (stickyCol) {
            stickyCol.style.background = '';
        }

        // Aplicar nuevos estilos según el estado
        if (estado === 'CARGANDO') {
            cells.forEach(cell => {
                cell.style.background = '#fff8e1';
                if (cell !== stickyCol) {
                    cell.style.borderLeft = '4px solid #ffc107';
                }
            });
            if (stickyCol) {
                stickyCol.style.background = '#fffaeb';
            }
        } else if (estado === 'DESPACHADO') {
            cells.forEach(cell => {
                cell.style.background = '#e8f5e9';
                if (cell !== stickyCol) {
                    cell.style.borderLeft = '4px solid #0B8552';
                }
            });
            if (stickyCol) {
                stickyCol.style.background = '#ecf7ef';
            }
        } else {
            // PROGRAMADO o cualquier otro estado - fondo blanco
            cells.forEach(cell => {
                cell.style.background = 'white';
            });
            if (stickyCol) {
                stickyCol.style.background = '#fafbfc';
            }
        }

        // Agregar animación de transición suave
        row.style.transition = 'all 0.3s ease';

        // Mostrar toast de confirmación
        const estadoTexto = estado === 'CARGANDO' ? 'En Cargue' :
            estado === 'DESPACHADO' ? 'Despachado' : 'Programado';
        showToast('success', `Estado actualizado a: ${estadoTexto}`);
    }

    function showToast(type, message) {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type} border-0`;
        toast.innerHTML = `<div class="d-flex"><div class="toast-body"><i class="${type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'} me-2"></i>${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1100';
        document.body.appendChild(container);
        return container;
    }

    // --- CÓDIGO AÑADIDO PARA POBLAR LA LISTA DE PRODUCTOS ---
    const datalist = document.getElementById('productos-lista');
    if (datalist && columnsConfig.producto_a_cargar.options) {
        columnsConfig.producto_a_cargar.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            datalist.appendChild(option);
        });
    }

    // Función para ordenar las filas ya cargadas en el DOM por estado (sin re-fetch)
    function sortTableRows() {
        const rows = Array.from(tbody.querySelectorAll('tr[data-id]'));
        if (rows.length === 0) return;
        const estadoOrder = { 'PROGRAMADO': 0, 'CARGANDO': 1, 'DESPACHADO': 2 };
        rows.sort((a, b) => {
            const ea = (a.dataset.estado || 'PROGRAMADO').toUpperCase();
            const eb = (b.dataset.estado || 'PROGRAMADO').toUpperCase();
            const oa = estadoOrder.hasOwnProperty(ea) ? estadoOrder[ea] : 3;
            const ob = estadoOrder.hasOwnProperty(eb) ? estadoOrder[eb] : 3;
            if (oa !== ob) return oa - ob;
            // fallback: conservar orden actual
            return 0;
        });
        // Reinserta en el tbody en el nuevo orden
        rows.forEach(r => tbody.appendChild(r));
        // Quitar indicador de pendiente
        const sortBtn = document.getElementById('btn-sort-estado');
        if (sortBtn) sortBtn.classList.remove('btn-warning');
    }

    // Conectar botón de ordenar
    const btnSortEstado = document.getElementById('btn-sort-estado');
    if (btnSortEstado) {
        btnSortEstado.addEventListener('click', function () {
            // Si hay datos en memoria (originalData) y no hay filas, renderizamos primero
            const hasRows = tbody.querySelectorAll('tr[data-id]').length > 0;
            if (!hasRows && originalData && originalData.length) {
                renderTable(originalData);
                return;
            }
            sortTableRows();
        });
    }

    // --- SISTEMA DE NOTIFICACIÓN REFINERY ---
    function actualizarEstadoRefinery() {
        const filasCompletas = [];
        const tbody = document.getElementById('schedule-table-body');
        const rows = tbody.querySelectorAll('tr[data-id]');

        rows.forEach(row => {
            // Verificar el atributo data-refinery-completo del tr
            const refineriaCompleto = row.dataset.refineriaCompleto === 'true';
            if (refineriaCompleto) {
                const id = row.dataset.id;
                // Mejorar obtención de placa
                const placaCell = row.querySelector('[data-field="placa"]');
                const placa = placaCell?.querySelector('.cell-editor')?.textContent.trim() ||
                    placaCell?.textContent.trim() || 'N/A';

                // Mejorar obtención de producto
                const productoCell = row.querySelector('[data-field="producto_a_cargar"]');
                const producto = productoCell?.querySelector('input')?.value ||
                    productoCell?.querySelector('.cell-editor')?.textContent.trim() ||
                    productoCell?.textContent.trim() || 'N/A';

                // Mejorar obtención de galones
                const galonesCell = row.querySelector('[data-field="galones"]');
                const galones = galonesCell?.querySelector('.cell-editor')?.textContent.trim() ||
                    galonesCell?.textContent.trim() || '0';
                filasCompletas.push({ id, placa, producto, galones });
            }
        });

        console.log('Filas completas detectadas:', filasCompletas.length, filasCompletas);

        // Actualizar badge del botón WhatsApp
        const btnWhatsApp = document.getElementById('btn-whatsapp-notify');
        const whatsappBadge = btnWhatsApp.querySelector('.whatsapp-badge');

        if (filasCompletas.length > 0) {
            btnWhatsApp.style.display = 'flex';
            whatsappBadge.textContent = filasCompletas.length;
        } else {
            btnWhatsApp.style.display = 'none';
        }

        // Actualizar badge del panel
        const btnPanel = document.getElementById('btn-toggle-refinery-panel');
        const panelBadge = btnPanel.querySelector('.refinery-panel-badge');
        if (filasCompletas.length > 0) {
            panelBadge.style.display = 'block';
            panelBadge.textContent = filasCompletas.length;
        } else {
            panelBadge.style.display = 'none';
        }

        // Actualizar contenido del panel
        actualizarPanelRefinery(filasCompletas);

        // Guardar para uso en WhatsApp
        window.refineryFilasCompletas = filasCompletas;
    }

    function actualizarPanelRefinery(filasCompletas) {
        const panelContent = document.getElementById('refinery-panel-content');

        if (filasCompletas.length === 0) {
            panelContent.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>No hay registros completados por Refinery</p>';
            return;
        }

        let html = '<div class="refinery-items-list">';
        filasCompletas.forEach((fila, index) => {
            html += `
                <div class="refinery-item">
                    <div class="refinery-item-header">
                        <span class="refinery-item-number">#${index + 1}</span>
                        <span class="refinery-item-placa"><i class="fas fa-truck me-1"></i>${fila.placa}</span>
                    </div>
                    <div class="refinery-item-details">
                        <div><strong>Producto:</strong> ${fila.producto}</div>
                        <div><strong>Galones:</strong> ${fila.galones}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        panelContent.innerHTML = html;
    }

    function generarMensajeWhatsApp() {
        const filasCompletas = window.refineryFilasCompletas || [];

        if (filasCompletas.length === 0) {
            showToast('info', 'No hay registros completados para notificar');
            return;
        }

        let mensaje = '🔔 *Notificación Programación de Cargue*\n\n';
        mensaje += '✅ Refinery ha completado los siguientes registros:\n\n';

        filasCompletas.forEach((fila, index) => {
            mensaje += `${index + 1}. 🚛 *Placa:* ${fila.placa}\n`;
            mensaje += `   📦 *Producto:* ${fila.producto}\n`;
            mensaje += `   ⛽ *Galones:* ${fila.galones}\n\n`;
        });

        mensaje += `📊 *Total:* ${filasCompletas.length} vehículo(s) listo(s)\n`;
        mensaje += `🕐 *Fecha:* ${new Date().toLocaleString('es-CO')}\n\n`;
        mensaje += '_Sistema de Gestión Conquers Trading_';

        // Codificar mensaje para URL
        const mensajeCodificado = encodeURIComponent(mensaje);

        // Abrir WhatsApp Web con el mensaje pre-formateado
        const whatsappUrl = `https://wa.me/?text=${mensajeCodificado}`;
        window.open(whatsappUrl, '_blank');

        showToast('success', '¡Mensaje de WhatsApp preparado!');
    }

    // Event listener para botón de WhatsApp
    document.getElementById('btn-whatsapp-notify').addEventListener('click', generarMensajeWhatsApp);

    // Event listener para botón del panel
    document.getElementById('btn-toggle-refinery-panel').addEventListener('click', function () {
        const panel = document.getElementById('refinery-status-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    // Actualizar estado después de cada renderizado
    const originalRenderBody = renderBody;
    renderBody = function (data) {
        originalRenderBody(data);
        // Inicializar tooltips de Bootstrap
        setTimeout(() => {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            actualizarEstadoRefinery();
        }, 100);
    };

    // --- CARGA INICIAL ---
    fetchAndRender();

    // --- MODAL DE HISTORIAL ---
    let historialData = [];
    let historialFiltered = [];
    let historialCurrentPage = 1;
    const historialPageSize = 50;

    // Botón para alternar historial ahora abre el modal
    toggleHistorialBtn.addEventListener('click', function () {
        const modal = new bootstrap.Modal(document.getElementById('historialModal'));
        modal.show();
        cargarHistorialModal();
    });

    function cargarHistorialModal() {
        const tbody = document.getElementById('historial-table-body');
        tbody.innerHTML = `<tr><td colspan="12" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Cargando historial...</p>
        </td></tr>`;

        fetch("{{ url_for('handle_programacion') }}?all=1")
            .then(res => res.json())
            .then(data => {
                historialData = data;
                historialFiltered = data;
                historialCurrentPage = 1;
                renderHistorialTable();
            })
            .catch(error => {
                tbody.innerHTML = `<tr><td colspan="12" class="text-center py-3 text-danger">Error al cargar historial</td></tr>`;
            });
    }

    function renderHistorialTable() {
        const tbody = document.getElementById('historial-table-body');
        const start = (historialCurrentPage - 1) * historialPageSize;
        const end = start + historialPageSize;
        const pageData = historialFiltered.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="23" class="text-center py-4 text-muted">No hay registros que coincidan con los filtros</td></tr>';
        } else {
            tbody.innerHTML = '';
            pageData.forEach((row, index) => {
                const globalIndex = start + index + 1;
                const estadoClass = row.estado === 'DESPACHADO' ? 'bg-success-subtle' :
                    row.estado === 'CARGANDO' ? 'bg-warning-subtle' : '';
                const estadoBadge = row.estado === 'DESPACHADO' ? 'success' :
                    row.estado === 'CARGANDO' ? 'warning' : 'secondary';

                // Permitir editar todos los estados (PROGRAMADO, CARGANDO y DESPACHADO)
                const isEditable = true;

                const tr = document.createElement('tr');
                tr.className = estadoClass;
                tr.dataset.id = row.id;
                tr.innerHTML = `
                    <td class="text-center fw-bold">${globalIndex}</td>
                    <td>${row.fecha_programacion ? new Date(row.fecha_programacion + 'T00:00:00').toLocaleDateString('es-CO') : '-'}</td>
                    <td>${row.producto_a_cargar || '-'}</td>
                    <td>${row.tipo_guia || '-'}</td>
                    <td>${row.empresa_transportadora || '-'}</td>
                    <td>${row.placa || '-'}</td>
                    <td>${row.tanque || '-'}</td>
                    <td>${row.nombre_conductor || '-'}</td>
                    <td>${row.cedula_conductor || '-'}</td>
                    <td>${row.celular_conductor || '-'}</td>
                    <td>${row.hora_llegada_estimada || '-'}</td>
                    <td>${row.destino || '-'}</td>
                    <td>${row.cliente || '-'}</td>
                    <td><span class="badge bg-${estadoBadge}">${row.estado || 'PROGRAMADO'}</span></td>
                    <td class="text-end">${row.galones ? Number(row.galones).toLocaleString('es-CO', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td class="text-end">${row.barriles ? Number(row.barriles).toLocaleString('es-CO', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td class="text-end">${row.temperatura ? Number(row.temperatura).toLocaleString('es-CO', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td class="text-end">${row.api_obs ? Number(row.api_obs).toLocaleString('es-CO', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td class="text-end">${row.api_corregido ? Number(row.api_corregido).toLocaleString('es-CO', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td>${row.precintos || '-'}</td>
                    <td>${row.fecha_despacho ? new Date(row.fecha_despacho + 'T00:00:00').toLocaleDateString('es-CO') : '-'}</td>
                    <td>${row.numero_guia || '-'}</td>
                    <td class="sticky-right">
                        <div class="btn-group btn-group-sm" role="group">
                            ${isEditable ? `
                                <button class="btn btn-outline-primary btn-edit-historial" data-id="${row.id}" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-info btn-print-guide-historial" data-id="${row.id}" title="Imprimir Guía">
                                <i class="fas fa-print"></i>
                            </button>
                            ${row.imagen_guia ? `
                                <button class="btn btn-outline-success btn-view-image-historial" data-id="${row.id}" title="Ver archivo">
                                    <i class="fas fa-image"></i>
                                </button>
                            ` : `
                                <button class="btn btn-outline-secondary btn-upload-image-historial" data-id="${row.id}" title="Subir archivo">
                                    <i class="fas fa-upload"></i>
                                </button>
                            `}
                            ${canDelete ? `
                                <button class="btn btn-outline-danger btn-delete-historial" data-id="${row.id}" title="Eliminar">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Actualizar controles de paginación
        const totalPages = Math.ceil(historialFiltered.length / historialPageSize);
        document.getElementById('historial-current-page').textContent = historialCurrentPage;
        document.getElementById('historial-total-pages').textContent = totalPages;
        document.getElementById('historial-showing-from').textContent = historialFiltered.length > 0 ? start + 1 : 0;
        document.getElementById('historial-showing-to').textContent = Math.min(end, historialFiltered.length);
        document.getElementById('historial-showing-total').textContent = historialFiltered.length;
        document.getElementById('historial-total-badge').textContent = `Total: ${historialFiltered.length} registros`;

        // Habilitar/deshabilitar botones de paginación
        document.getElementById('btn-historial-first').disabled = historialCurrentPage === 1;
        document.getElementById('btn-historial-prev').disabled = historialCurrentPage === 1;
        document.getElementById('btn-historial-next').disabled = historialCurrentPage === totalPages || totalPages === 0;
        document.getElementById('btn-historial-last').disabled = historialCurrentPage === totalPages || totalPages === 0;
    }

    // Array para almacenar fechas seleccionadas
    let fechasSeleccionadas = [];

    // Agregar fecha al filtro
    document.getElementById('btn-add-fecha').addEventListener('click', function () {
        const fechaInput = document.getElementById('filter-fecha-selector');
        const fecha = fechaInput.value;

        if (!fecha) {
            showToast('warning', 'Selecciona una fecha');
            return;
        }

        if (fechasSeleccionadas.includes(fecha)) {
            showToast('info', 'Esta fecha ya está seleccionada');
            return;
        }

        fechasSeleccionadas.push(fecha);
        renderFechasSeleccionadas();
        fechaInput.value = '';
    });

    // Enter en el input de fecha también agrega
    document.getElementById('filter-fecha-selector').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            document.getElementById('btn-add-fecha').click();
        }
    });

    function renderFechasSeleccionadas() {
        const container = document.getElementById('fechas-seleccionadas-container');

        if (fechasSeleccionadas.length === 0) {
            container.innerHTML = '<small class="text-muted">Sin fechas seleccionadas</small>';
            return;
        }

        container.innerHTML = '';
        fechasSeleccionadas.forEach(fecha => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary d-flex align-items-center gap-1';
            badge.style.fontSize = '0.75rem';
            badge.innerHTML = `
                ${new Date(fecha + 'T00:00:00').toLocaleDateString('es-CO')}
                <i class="fas fa-times cursor-pointer" onclick="removeFecha('${fecha}')"></i>
            `;
            container.appendChild(badge);
        });
    }

    // Función global para remover fecha
    window.removeFecha = function (fecha) {
        fechasSeleccionadas = fechasSeleccionadas.filter(f => f !== fecha);
        renderFechasSeleccionadas();
    };

    // Aplicar filtros del historial
    document.getElementById('btn-apply-historial-filters').addEventListener('click', function () {
        const estado = document.getElementById('filter-estado').value;
        const producto = document.getElementById('filter-producto').value;
        const search = document.getElementById('filter-search').value.toLowerCase();

        historialFiltered = historialData.filter(row => {
            let match = true;

            // Filtro por fechas seleccionadas (si hay alguna)
            if (fechasSeleccionadas.length > 0 && row.fecha_programacion) {
                match = match && fechasSeleccionadas.includes(row.fecha_programacion);
            }

            if (estado) {
                match = match && (row.estado || 'PROGRAMADO') === estado;
            }
            if (producto) {
                match = match && row.producto_a_cargar === producto;
            }
            if (search) {
                const placa = (row.placa || '').toLowerCase();
                const conductor = (row.nombre_conductor || '').toLowerCase();
                match = match && (placa.includes(search) || conductor.includes(search));
            }

            return match;
        });

        historialCurrentPage = 1;
        renderHistorialTable();
    });

    // Limpiar filtros
    document.getElementById('btn-clear-historial-filters').addEventListener('click', function () {
        document.getElementById('filter-fecha-selector').value = '';
        fechasSeleccionadas = [];
        renderFechasSeleccionadas();
        document.getElementById('filter-estado').value = '';
        document.getElementById('filter-producto').value = '';
        document.getElementById('filter-search').value = '';
        historialFiltered = historialData;
        historialCurrentPage = 1;
        renderHistorialTable();
    });

    // Botones de paginación
    document.getElementById('btn-historial-first').addEventListener('click', function () {
        historialCurrentPage = 1;
        renderHistorialTable();
    });

    document.getElementById('btn-historial-prev').addEventListener('click', function () {
        if (historialCurrentPage > 1) {
            historialCurrentPage--;
            renderHistorialTable();
        }
    });

    document.getElementById('btn-historial-next').addEventListener('click', function () {
        const totalPages = Math.ceil(historialFiltered.length / historialPageSize);
        if (historialCurrentPage < totalPages) {
            historialCurrentPage++;
            renderHistorialTable();
        }
    });

    document.getElementById('btn-historial-last').addEventListener('click', function () {
        const totalPages = Math.ceil(historialFiltered.length / historialPageSize);
        historialCurrentPage = totalPages;
        renderHistorialTable();
    });

    // --- EVENT LISTENERS PARA BOTONES DEL HISTORIAL ---
    document.getElementById('historial-table-body').addEventListener('click', function (e) {
        // Botón Editar desde historial
        const btnEdit = e.target.closest('.btn-edit-historial');
        if (btnEdit) {
            const registroId = btnEdit.dataset.id;

            // Obtener información visual del registro desde el historial
            const filaHistorial = btnEdit.closest('tr');
            const numeroFila = filaHistorial ? filaHistorial.querySelector('td:first-child').textContent : '';

            // Cerrar el modal de historial y limpiar backdrop inmediatamente
            const historialModalEl = document.getElementById('historialModal');
            let historialModal = bootstrap.Modal.getInstance(historialModalEl);
            if (!historialModal) {
                historialModal = new bootstrap.Modal(historialModalEl);
            }
            historialModal.hide();
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');

            // Buscar el registro en los datos del historial (ya cargados)
            const registro = historialData.find(r => r.id == registroId);

            if (!registro) {
                showToast('warning', 'No se encontró el registro');
                return;
            }

            // Agregar el número de fila original al registro para mostrarlo
            registro._numeroFilaHistorial = numeroFila;

            // Mostrar SOLO la fila que se quiere editar
            originalData = [registro];

            // Re-renderizar la tabla con solo ese registro
            renderTable(originalData);

            // Scroll al inicio de la página
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Mensaje informativo
            const producto = registro.producto_a_cargar || 'Sin producto';
            const placa = registro.placa || 'Sin placa';
            const cliente = registro.cliente || 'Sin cliente';
            showToast('info', `📝 Editando fila #${numeroFila}: ${producto} - ${placa} - ${cliente}`, 4000);

            return;
        }

        // Botón Imprimir Guía desde historial
        const btnPrint = e.target.closest('.btn-print-guide-historial');
        if (btnPrint) {
            const registroId = btnPrint.dataset.id;
            const row = historialData.find(r => r.id == registroId);
            if (!row) return;

            const url = new URL("{{ url_for('guia_transporte') }}", window.location.href);
            allColumns.forEach(field => {
                let value = row[field] || '';
                if (value && value !== '-') {
                    url.searchParams.append(field, value);
                    if (field === 'tanque') {
                        url.searchParams.append('placa_tanque', value);
                    }
                }
            });
            window.location.href = url.href;
            return;
        }

        // Botón Ver imagen desde historial
        const btnViewImg = e.target.closest('.btn-view-image-historial');
        if (btnViewImg) {
            const registroId = btnViewImg.dataset.id;
            fetch(`/api/programacion/${registroId}/image`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const viewer = document.getElementById('modal-viewer');
                        const downloadBtn = document.getElementById('btn-download-image');
                        viewer.innerHTML = '';

                        const src = data.imagen;
                        const mimeType = (data.mime || '').toLowerCase();

                        let extension = 'png';
                        if (mimeType.includes('pdf')) extension = 'pdf';
                        else if (mimeType.includes('jpeg') || mimeType.includes('jpg')) extension = 'jpg';
                        else if (mimeType.includes('gif')) extension = 'gif';

                        downloadBtn.href = src;
                        downloadBtn.download = `guia_transporte_${registroId}.${extension}`;

                        if (mimeType.includes('pdf')) {
                            const embed = document.createElement('embed');
                            embed.type = 'application/pdf';
                            embed.src = src + '#toolbar=1&navpanes=0&scrollbar=1';
                            embed.style.width = '100%';
                            embed.style.height = '70vh';
                            embed.style.border = '0';
                            viewer.appendChild(embed);
                        } else {
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'Imagen de guía';
                            img.style.maxWidth = '100%';
                            img.style.maxHeight = '70vh';
                            img.style.borderRadius = '8px';
                            viewer.appendChild(img);
                        }

                        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                        imageModal.show();
                    } else {
                        showToast('danger', 'No se pudo cargar el archivo: ' + (data.message || ''));
                    }
                })
                .catch(() => showToast('danger', 'Error al cargar el archivo'));
            return;
        }

        // Botón Subir imagen desde historial
        const btnUploadImg = e.target.closest('.btn-upload-image-historial');
        if (btnUploadImg) {
            const registroId = btnUploadImg.dataset.id;
            const hiddenInput = document.getElementById('hidden-image-input');
            hiddenInput.dataset.registroId = registroId;
            hiddenInput.dataset.fromHistorial = 'true';
            hiddenInput.click();
            return;
        }

        // Botón Eliminar desde historial
        const btnDeleteHist = e.target.closest('.btn-delete-historial');
        if (btnDeleteHist) {
            if (!canDelete) return;
            const registroId = btnDeleteHist.dataset.id;
            if (confirm('¿Seguro que deseas eliminar esta programación?')) {
                fetch(`/api/programacion/${registroId}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showToast('success', 'Fila eliminada correctamente');
                            // Recargar historial
                            cargarHistorialModal();
                            // Recargar tabla principal
                            fetchAndRender();
                        } else {
                            showToast('danger', 'Error al eliminar: ' + (data.message || ''));
                        }
                    })
                    .catch(() => showToast('danger', 'Error de conexión'));
            }
            return;
        }
    });

    // --- SUBIDA EXCEL ---
    const btnUploadExcel = document.getElementById('btn-upload-excel');
    btnUploadExcel.addEventListener('click', function () {
        const form = document.getElementById('form-upload-programacion');
        const fileInput = form.querySelector('input[type="file"]');
        if (!fileInput.files.length) {
            showToast('danger', 'Seleccione un archivo');
            return;
        }
        const fd = new FormData();
        fd.append('excel_file', fileInput.files[0]);
        btnUploadExcel.disabled = true;
        btnUploadExcel.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Subiendo...';
        const replace = document.getElementById('replaceExisting').checked ? '1' : '0';
        fetch(`/api/programacion/upload_excel?replace=${replace}`, { method: 'POST', body: fd })
            .then(r => r.json().then(data => ({ ok: r.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    showToast('success', data.message);
                    fetchAndRender();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadExcelModal'));
                    modal.hide();
                    form.reset();
                } else {
                    showToast('danger', data.message || 'Error al subir');
                }
            })
            .catch(() => showToast('danger', 'Error de red'))
            .finally(() => {
                btnUploadExcel.disabled = false;
                btnUploadExcel.innerHTML = '<i class="fas fa-cloud-upload-alt me-1"></i>Subir';
            });
    });

    // --- EVENT LISTENER PARA SUBIR IMAGEN ---
    const hiddenImageInput = document.getElementById('hidden-image-input');
    hiddenImageInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const registroId = this.dataset.registroId;
        if (!registroId) {
            showToast('danger', 'Error: No se pudo identificar el registro');
            return;
        }

        // Validar tamaño (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showToast('danger', 'El archivo es demasiado grande. Máximo 5MB');
            this.value = ''; // Limpiar el input
            return;
        }

        // Crear FormData para enviar la imagen
        const formData = new FormData();
        formData.append('imagen', file);

        // Mostrar indicador de carga
        showToast('info', 'Subiendo imagen...');

        // Enviar al servidor
        fetch(`/api/programacion/${registroId}/upload_image`, {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Imagen subida correctamente');
                    // Recargar la tabla para mostrar el botón de ver imagen
                    fetchAndRender();
                    // Si se subió desde el historial, recargar también el historial
                    if (this.dataset.fromHistorial === 'true') {
                        cargarHistorialModal();
                    }
                } else {
                    showToast('danger', 'Error al subir: ' + (data.message || ''));
                }
            })
            .catch(() => showToast('danger', 'Error de conexión al subir imagen'))
            .finally(() => {
                // Limpiar el input para permitir subir la misma imagen de nuevo
                this.value = '';
                delete this.dataset.fromHistorial;
            });
    });

    // ==========================================
    // SISTEMA DE PRESENCIA EN TIEMPO REAL
    // ==========================================

    let activityPollingInterval = null;
    let isUserEditing = false;
    let currentEditingCell = null;
    let activeUsers = {};  // {username: {editing_row: id, editing_column: col, last_seen: timestamp}}

    // Toggle del panel de actividad
    const toggleActivityBtn = document.getElementById('toggle-activity-panel');
    const activityPanel = document.getElementById('activity-panel');

    toggleActivityBtn.addEventListener('click', function () {
        if (activityPanel.style.display === 'none' || !activityPanel.style.display) {
            activityPanel.style.display = 'block';
            updateActivityPanel();
        } else {
            activityPanel.style.display = 'none';
        }
    });

    // Prevenir edición de campos bloqueados
    tbody.addEventListener('click', function (e) {
        const td = e.target.closest('td');
        if (td && td.classList.contains('cell-locked')) {
            e.preventDefault();
            e.stopPropagation();
            const lockedBy = td.getAttribute('data-locked-by');
            const userName = Object.entries(activeUsers).find(([email, _]) => email === lockedBy)?.[1]?.name || 'Otro usuario';
            showToast('warning', `🔒 ${userName} está editando este campo. Espera a que termine.`);
            return false;
        }
    }, true);

    // Prevenir focus en campos bloqueados
    tbody.addEventListener('focusin', function (e) {
        const td = e.target.closest('td');
        if (td && td.classList.contains('cell-locked')) {
            e.preventDefault();
            e.target.blur();
            const lockedBy = td.getAttribute('data-locked-by');
            const userName = Object.entries(activeUsers).find(([email, _]) => email === lockedBy)?.[1]?.name || 'Otro usuario';
            showToast('warning', `🔒 ${userName} está editando este campo.`);
            return false;
        }
    }, true);

    // Throttle para no enviar cada tecla
    let presenceThrottle = null;

    // Detectar cuando el usuario está editando (evita actualizaciones)
    tbody.addEventListener('focusin', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.classList.contains('cell-editor')) {
            isUserEditing = true;
            currentEditingCell = e.target;

            // Enviar presencia al servidor
            const row = e.target.closest('tr');
            const col = e.target.dataset.col || e.target.closest('td')?.dataset.field;
            if (row && col) {
                updatePresence(row.dataset.id, col);
            }
        }
    });

    // Enviar contenido mientras se escribe (throttled a cada 300ms)
    tbody.addEventListener('input', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.classList.contains('cell-editor')) {
            const row = e.target.closest('tr');
            const col = e.target.dataset.col || e.target.closest('td')?.dataset.field;

            if (row && col) {
                // Cancelar throttle anterior
                if (presenceThrottle) clearTimeout(presenceThrottle);

                // Enviar después de 300ms sin escribir
                presenceThrottle = setTimeout(() => {
                    let currentValue = '';
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        currentValue = e.target.value;
                    } else if (e.target.classList.contains('cell-editor')) {
                        currentValue = e.target.textContent;
                    }
                    updatePresence(row.dataset.id, col, currentValue);
                }, 300);
            }
        }
    });

    // También para cambios en select
    tbody.addEventListener('change', function (e) {
        if (e.target.tagName === 'SELECT' && e.target.classList.contains('editable-select')) {
            const row = e.target.closest('tr');
            const col = e.target.dataset.col || e.target.closest('td')?.dataset.field;
            if (row && col) {
                updatePresence(row.dataset.id, col, e.target.value);
            }
        }
    });

    tbody.addEventListener('focusout', function (e) {
        if (e.target === currentEditingCell) {
            setTimeout(() => {
                // Solo marcar como no editando si realmente salió del tbody
                if (!tbody.contains(document.activeElement)) {
                    isUserEditing = false;
                    currentEditingCell = null;
                    updatePresence(null, null);  // Clear presence
                }
            }, 100);
        }
    });

    // Enviar presencia al servidor con el contenido actual
    function updatePresence(rowId, column, currentValue = null) {
        const data = {
            user: userName,
            email: userEmail,
            editing_row: rowId,
            editing_column: column,
            current_value: currentValue,
            timestamp: Date.now()
        };

        fetch('/api/programacion/presence', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).catch(err => console.log('Error updating presence:', err));
    }

    // Obtener presencia de otros usuarios
    function fetchPresence() {
        // Solo actualizar si el usuario NO está editando
        if (isUserEditing) {
            return;
        }

        fetch('/api/programacion/presence')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    activeUsers = data.users;
                    updateOnlineCount();
                    updateActivityPanel();
                    updateCellIndicators();
                }
            })
            .catch(err => console.log('Error fetching presence:', err));
    }

    // Actualizar contador de usuarios en línea
    function updateOnlineCount() {
        const count = Object.keys(activeUsers).length;
        const badge = document.getElementById('users-online-count');
        if (badge) {
            badge.textContent = count;
            badge.className = count > 0 ? 'badge bg-success rounded-circle' : 'badge bg-secondary rounded-circle';
        }
    }

    // Actualizar panel de actividad
    function updateActivityPanel() {
        const container = document.getElementById('active-users-list');
        if (!container) return;

        const users = Object.entries(activeUsers).filter(([email, _]) => email !== userEmail);

        if (users.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-3">Sin usuarios activos</p>';
            return;
        }

        let html = '';
        users.forEach(([email, info]) => {
            const initials = info.name ? info.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
            const editingText = info.editing_row && info.editing_column
                ? `Editando: ${formatColumnName(info.editing_column)}`
                : 'Navegando';

            // NUEVO: Mostrar preview del contenido
            const previewText = info.current_value && info.current_value.trim()
                ? `<div class="user-preview" title="Contenido actual">\ud83d\udcdd "${info.current_value}"</div>`
                : '';

            html += `
                <div class="active-user-item">
                    <div class="active-user-header">
                        <div class="user-avatar">${initials}</div>
                        <div class="user-info">
                            <div class="user-name">${info.name || email}</div>
                            <div class="user-editing">
                                ${info.editing_row ? '<span class="editing-indicator"></span>' : ''}
                                ${editingText}
                            </div>
                            ${previewText}
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Actualizar indicadores en las celdas y filas
    function updateCellIndicators() {
        // Remover indicadores existentes
        document.querySelectorAll('.cell-editing-indicator').forEach(el => el.remove());
        document.querySelectorAll('.row-editor-badge').forEach(el => el.remove());
        tbody.querySelectorAll('tr.row-being-edited').forEach(row => {
            row.classList.remove('row-being-edited');
        });

        // Primero desbloquear todas las celdas
        tbody.querySelectorAll('td[data-locked-by]').forEach(td => {
            td.removeAttribute('data-locked-by');
            td.classList.remove('cell-locked');
            const editableElement = td.querySelector('.cell-editor') ||
                td.querySelector('input.editable-input') ||
                td.querySelector('select.editable-select');
            if (editableElement) {
                if (editableElement.tagName === 'INPUT' || editableElement.tagName === 'TEXTAREA' || editableElement.tagName === 'SELECT') {
                    editableElement.disabled = false;
                } else if (editableElement.classList.contains('cell-editor')) {
                    editableElement.contentEditable = 'true';
                }
                editableElement.style.cursor = '';
                editableElement.style.opacity = '';
                editableElement.style.color = '';
                editableElement.style.fontWeight = '';
            }
        });

        // Agregar nuevos indicadores y bloqueos
        Object.entries(activeUsers).forEach(([email, info]) => {
            if (email === userEmail) return;  // No mostrar mi propia edición
            if (!info.editing_row || !info.editing_column) return;

            const row = tbody.querySelector(`tr[data-id="${info.editing_row}"]`);
            if (!row) return;

            // Marcar la fila completa como siendo editada
            row.classList.add('row-being-edited');

            // Agregar badge con nombre del usuario en la primera celda
            const firstCell = row.querySelector('td');
            if (firstCell && !row.querySelector('.row-editor-badge')) {
                const badge = document.createElement('div');
                badge.className = 'row-editor-badge';
                badge.innerHTML = `
                    <i class="fas fa-pen"></i>
                    <span>${info.name || 'Usuario'}</span>
                    <small style="opacity: 0.8">· ${formatColumnName(info.editing_column)}</small>
                `;
                badge.title = `${info.name || email} está editando ${formatColumnName(info.editing_column)}`;

                firstCell.style.position = 'relative';
                firstCell.appendChild(badge);
            }

            // Buscar la celda específica que está siendo editada
            const cell = row.querySelector(`[data-col="${info.editing_column}"]`);
            let targetTd = null;

            if (!cell) {
                targetTd = row.querySelector(`td[data-field="${info.editing_column}"]`);
            } else {
                targetTd = cell.closest('td');
            }

            if (targetTd && !targetTd.querySelector('.cell-editing-indicator')) {
                // Indicador de lápiz
                const indicator = document.createElement('div');
                indicator.className = 'cell-editing-indicator';
                indicator.innerHTML = `<i class="fas fa-lock" style="font-size: 0.6rem;"></i>`;
                indicator.title = `${info.name || email} está editando - Campo bloqueado`;

                targetTd.style.position = 'relative';
                targetTd.appendChild(indicator);

                // BLOQUEO PREVENTIVO: Deshabilitar el campo para otros usuarios
                targetTd.setAttribute('data-locked-by', email);
                targetTd.classList.add('cell-locked');

                const editableElement = targetTd.querySelector('.cell-editor') ||
                    targetTd.querySelector('input.editable-input') ||
                    targetTd.querySelector('select.editable-select');

                if (editableElement) {
                    // Deshabilitar el elemento
                    if (editableElement.tagName === 'INPUT' || editableElement.tagName === 'TEXTAREA' || editableElement.tagName === 'SELECT') {
                        editableElement.disabled = true;
                        editableElement.title = `🔒 ${info.name || 'Otro usuario'} está editando este campo`;
                    } else if (editableElement.classList.contains('cell-editor')) {
                        editableElement.contentEditable = 'false';
                        editableElement.title = `🔒 ${info.name || 'Otro usuario'} está editando este campo`;
                    }
                    editableElement.style.cursor = 'not-allowed';
                    editableElement.style.opacity = '0.7';

                    // Actualizar contenido en tiempo real
                    if (info.current_value !== null && info.current_value !== undefined) {
                        if (editableElement.tagName === 'INPUT' || editableElement.tagName === 'TEXTAREA') {
                            editableElement.value = info.current_value;
                        } else if (editableElement.tagName === 'SELECT') {
                            editableElement.value = info.current_value;
                        } else if (editableElement.classList.contains('cell-editor')) {
                            editableElement.textContent = info.current_value;
                        }
                        editableElement.style.color = '#667eea';
                        editableElement.style.fontWeight = '500';
                    }
                } else {
                    // Si no hay elemento editable, marcar la celda como bloqueada
                    targetTd.style.cursor = 'not-allowed';
                    targetTd.style.opacity = '0.7';
                    targetTd.title = `🔒 ${info.name || 'Otro usuario'} está editando este campo`;

                    // Actualizar contenido visual
                    if (info.current_value !== null && info.current_value !== undefined) {
                        const existingContent = targetTd.textContent.trim();
                        if (!targetTd.dataset.originalContent) {
                            targetTd.dataset.originalContent = existingContent;
                        }
                        targetTd.style.color = '#667eea';
                        targetTd.style.fontWeight = '500';
                        const textNode = Array.from(targetTd.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                        if (textNode) {
                            textNode.textContent = info.current_value;
                        }
                    }
                }
            }
        });

        // Restaurar contenido original de celdas que ya no están siendo editadas
        tbody.querySelectorAll('td[data-original-content]').forEach(td => {
            const isBeingEdited = Array.from(activeUsers.values()).some(info => {
                const row = td.closest('tr');
                return row && row.dataset.id === info.editing_row &&
                    td.dataset.field === info.editing_column;
            });

            if (!isBeingEdited) {
                td.style.color = '';
                td.style.fontWeight = '';
                td.style.cursor = '';
                td.style.opacity = '';
                const textNode = Array.from(td.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                if (textNode && td.dataset.originalContent) {
                    textNode.textContent = td.dataset.originalContent;
                }
                delete td.dataset.originalContent;
            }
        });
    }

    // Iniciar polling inteligente (solo cuando el usuario NO esté editando)
    function startPresencePolling() {
        // Detener cualquier polling anterior
        if (activityPollingInterval) {
            clearInterval(activityPollingInterval);
        }

        // Polling cada 5 segundos (no intrusivo)
        activityPollingInterval = setInterval(() => {
            fetchPresence();
        }, 5000);

        // Primera carga inmediata
        fetchPresence();
    }

    // Iniciar sistema de presencia
    startPresencePolling();

    // Limpiar presencia al salir de la página
    window.addEventListener('beforeunload', function () {
        updatePresence(null, null);
    });

    });
</script>

<style>
    /* ========================================
   DISEÑO PROFESIONAL - PROGRAMACIÓN CARGUE
   ======================================== */

    /* Variables CSS Personalizadas - Colores Corporativos Conquers */
    :root {
        --primary-color: #0B8552;
        --primary-dark: #096840;
        --primary-light: #0ea06a;
        --primary-gradient: linear-gradient(135deg, #0B8552 0%, #0ea06a 100%);
        --secondary-gradient: linear-gradient(135deg, #096840 0%, #0B8552 100%);
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        --dark-color: #2c3e50;
        --light-bg: #f8f9fc;
        --border-color: #e3e6f0;
        --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        --shadow-green: 0 0.5rem 1.5rem rgba(11, 133, 82, 0.35);
    }

    /* Contenedor Principal */
    .programacion-cargue-page {
        background: linear-gradient(180deg, #f4f6f9 0%, #ffffff 100%);
        min-height: 100vh;
        padding-bottom: 2rem;
    }

    /* ========================================
   HEADER DE PÁGINA - DISEÑO LIMPIO Y CLARO
   ======================================== */
    .page-header {
        background: white;
        border-radius: 1rem;
        padding: 1.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }

    .page-title-box {
        display: flex;
        align-items: center;
    }

    .icon-box {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        box-shadow: 0 4px 12px rgba(11, 133, 82, 0.25);
    }

    .bg-gradient-primary {
        background: var(--primary-gradient);
    }

    .page-title {
        font-size: 1.625rem;
        font-weight: 700;
        color: var(--dark-color);
        line-height: 1.3;
        margin-bottom: 0.25rem;
    }

    .page-subtitle {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 400;
        margin: 0;
    }

    /* ========================================
   BOTONES MODERNOS Y CLAROS
   ======================================== */
    .btn-modern {
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        text-transform: none;
        letter-spacing: 0.3px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-modern i {
        font-size: 1rem;
    }

    .btn-modern:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-modern:active {
        transform: translateY(0);
    }

    .btn-modern.btn-primary {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-modern.btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
        box-shadow: var(--shadow-green);
    }

    .btn-modern.btn-outline-primary {
        background: white;
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .btn-modern.btn-outline-primary:hover {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-green);
    }

    .btn-modern.btn-outline-success {
        background: white;
        border-color: var(--success-color);
        color: var(--success-color);
    }

    .btn-modern.btn-outline-success:hover {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    .btn-modern.btn-outline-danger {
        background: white;
        border-color: var(--danger-color);
        color: var(--danger-color);
    }

    .btn-modern.btn-outline-danger:hover {
        background: var(--danger-color);
        border-color: var(--danger-color);
        color: white;
    }

    .btn-modern.btn-warning {
        background: var(--warning-color);
        border-color: var(--warning-color);
        color: #1f2937;
    }

    .btn-modern.btn-warning:hover {
        background: #e0a800;
        border-color: #e0a800;
    }

    .btn-modern.btn-outline-secondary {
        background: white;
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-modern.btn-outline-secondary:hover {
        background: #6c757d;
        border-color: #6c757d;
        color: white;
    }

    /* ========================================
   CARD MODERNO - DISEÑO LIMPIO
   ======================================== */
    .card-modern {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        background: white;
    }

    .card-header-modern {
        background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
        border-bottom: 3px solid var(--primary-color);
        padding: 1.25rem 1.5rem;
    }

    .header-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(11, 133, 82, 0.1) 0%, rgba(11, 133, 82, 0.15) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-size: 1.15rem;
    }

    .card-title-modern {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0;
    }

    /* Badge Moderno */
    .badge-modern {
        padding: 0.45rem 0.9rem;
        border-radius: 1.5rem;
        font-weight: 600;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
    }

    .badge-primary {
        background: linear-gradient(135deg, rgba(11, 133, 82, 0.12) 0%, rgba(11, 133, 82, 0.2) 100%);
        color: var(--primary-color);
        border: 1px solid rgba(11, 133, 82, 0.25);
    }

    /* ========================================
   TABLA MODERNA - DISEÑO CLARO Y ORGANIZADO
   ======================================== */
    .table-responsive-modern {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
        overflow-x: auto;
        border-radius: 0 0 1rem 1rem;
    }

    /* Scrollbar personalizada con color corporativo */
    .table-responsive-modern::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .table-responsive-modern::-webkit-scrollbar-track {
        background: #f1f3f5;
        border-radius: 10px;
    }

    .table-responsive-modern::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
        border: 2px solid #f1f3f5;
    }

    .table-responsive-modern::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    .table-modern {
        margin-bottom: 0;
        font-size: 0.875rem;
    }

    /* Header de Tabla - Diseño Profesional */
    .thead-modern th {
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        z-index: 10;
        font-size: 0.75rem;
        padding: 1rem 0.875rem;
        text-align: center;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.8px;
        border: none;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
    }

    /* Fila de Filtros - Más Visible */
    #filter-row {
        position: sticky;
        top: 53px;
        z-index: 9;
        background: white;
    }

    #filter-row th {
        padding: 0.625rem;
        background: #f8f9fc;
        border-bottom: 3px solid var(--primary-color);
    }

    .filter-input {
        width: 100%;
        border: 2px solid #e0e3e8;
        border-radius: 0.5rem;
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
        transition: all 0.2s ease;
        background: white;
    }

    .filter-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(11, 133, 82, 0.15);
        outline: none;
        background: #fafbfc;
    }

    .filter-input::placeholder {
        color: #9ca3af;
        font-style: italic;
    }

    /* Body de Tabla - Diseño Limpio */
    .tbody-modern tr {
        border-bottom: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .tbody-modern tr:hover {
        background-color: #f8f9fc !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .tbody-modern td {
        padding: 0;
        vertical-align: middle;
        background-color: white;
        font-size: 0.875rem;
        color: #495057;
        transition: background 0.3s ease, border-left 0.3s ease;
    }

    /* Estados de Fila - Colores Claros y Distinguibles */
    .tbody-modern tr[data-estado="PROGRAMADO"] {
        background-color: #ffffff !important;
    }

    .tbody-modern tr[data-estado="CARGANDO"] td {
        background: #fff8e1 !important;
        border-left: 4px solid #ffc107;
    }

    .tbody-modern tr[data-estado="DESPACHADO"] td {
        background: #e8f5e9 !important;
        border-left: 4px solid #0B8552;
    }

    /* ========================================
   CELDAS EDITABLES - FÁCIL DE IDENTIFICAR
   ======================================== */
    .editable-input {
        width: 100%;
        height: 100%;
        background-color: transparent !important;
        padding: 0.75rem 0.875rem;
        border: none;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .editable-input:focus {
        background: rgba(11, 133, 82, 0.08) !important;
        outline: none;
    }

    /* Select editable para tipo_guia */
    .editable-select {
        width: 100%;
        height: 100%;
        background-color: transparent !important;
        padding: 0.5rem 0.75rem;
        border: none;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        cursor: pointer;
    }

    .editable-select:focus {
        background: rgba(11, 133, 82, 0.08) !important;
        outline: 2px solid #0B8552;
        outline-offset: -2px;
    }

    .editable-cell {
        background: rgba(11, 133, 82, 0.04);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .editable-cell .cell-editor {
        display: inline-block;
        min-width: 100%;
        padding: 0.75rem 0.875rem;
        outline: none;
        white-space: pre-wrap;
        font-size: 0.875rem;
    }

    .editable-cell:hover {
        background: rgba(11, 133, 82, 0.08);
    }

    .editable-cell:focus-within {
        background: rgba(11, 133, 82, 0.12);
        box-shadow: inset 0 0 0 2px var(--primary-color);
        cursor: text;
    }

    /* Fila en edición - Resaltado especial con color gris neutro */
    .editing-row {
        background: linear-gradient(90deg, rgba(108, 117, 125, 0.15) 0%, rgba(108, 117, 125, 0.08) 100%) !important;
        box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.4) !important;
        border: 2px solid #6c757d !important;
        z-index: 5 !important;
        position: relative;
    }

    .editing-row td {
        background: transparent !important;
    }

    .editing-row .sticky-col {
        background: rgba(108, 117, 125, 0.1) !important;
    }

    /* Campo de precintos - Resaltado */
    td[data-field="precintos"] {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--dark-color);
    }

    /* ========================================
   BADGE DISCRETO DE REFINERY - EN COLUMNA DE NÚMERO
   ======================================== */
    .refinery-badge-complete {
        color: #28a745;
        font-size: 1.1rem;
        animation: pulse-refinery 2s infinite;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    @keyframes pulse-refinery {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.15);
            opacity: 0.7;
        }
    }

    .refinery-badge-complete:hover {
        transform: scale(1.2);
        cursor: help;
    }

    .refinery-badge-pending {
        color: #ffc107;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 2px;
        cursor: help;
        position: relative;
        transition: all 0.2s ease;
    }

    .refinery-badge-pending:hover {
        transform: scale(1.1);
        color: #ff9800;
    }

    .refinery-badge-pending .badge-mini {
        font-size: 0.65rem;
        padding: 0.15rem 0.35rem;
        border-radius: 50%;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        position: absolute;
        top: -8px;
        right: -8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .number-cell {
        padding: 0.5rem !important;
    }

    /* ========================================
   MODAL DE HISTORIAL COMPLETO
   ======================================== */
    .historial-filters-bar {
        background: #f8f9fc;
        border-bottom: 2px solid #e3e6f0;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .cursor-pointer:hover {
        opacity: 0.7;
    }

    #fechas-seleccionadas-container {
        min-height: 28px;
    }

    #fechas-seleccionadas-container .badge {
        padding: 0.4rem 0.6rem;
        font-weight: 500;
    }

    #fechas-seleccionadas-container .badge i {
        font-size: 0.7rem;
        margin-left: 0.25rem;
    }

    .historial-table-container {
        height: calc(100vh - 350px);
        overflow-y: auto;
        background: white;
    }

    .historial-table-container table {
        font-size: 0.85rem;
    }

    .historial-table-container thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #2c3e50 !important;
        color: white !important;
        font-weight: 600;
        border-color: #1a252f !important;
    }

    .historial-pagination-bar {
        background: #f8f9fc;
        border-top: 2px solid #e3e6f0;
    }

    .bg-success-subtle {
        background-color: #d1f0dd !important;
    }

    .bg-warning-subtle {
        background-color: #fff8e1 !important;
    }

    /* ========================================
   COLUMNA DE ACCIONES STICKY - MÁS VISIBLE
   ======================================== */
    .sticky-col {
        position: static;
        /* quitar comportamiento sticky */
        right: auto;
        z-index: auto;
        box-shadow: none;
        /* sin sombra lateral fija */
        min-width: 180px !important;
        /* conservamos el ancho compacto */
    }

    .thead-modern .sticky-col {
        background: var(--primary-gradient);
        color: #fff;
        z-index: 11;
    }

    .tbody-modern .sticky-col {
        background-color: #fafbfc !important;
        border-left: 3px solid var(--primary-color);
        transition: background 0.3s ease;
    }

    .tbody-modern tr[data-estado="CARGANDO"] .sticky-col {
        background: #fffaeb !important;
    }

    .tbody-modern tr[data-estado="DESPACHADO"] .sticky-col {
        background: #ecf7ef !important;
    }

    .tbody-modern tr:hover .sticky-col {
        background: #f0f2f5 !important;
    }

    /* Sticky column para el historial */
    .sticky-right {
        position: sticky;
        right: 0;
        z-index: 10;
        background-color: #f8f9fa !important;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .table-dark .sticky-right {
        background-color: #212529 !important;
    }

    /* ========================================
   BOTONES DE ACCIÓN - CLAROS Y ORGANIZADOS
   ======================================== */
    .action-buttons-container {
        padding: 0.4rem 0.25rem;
        /* más compacto */
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .save-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
    }

    .btn-xs {
        padding: 0.25rem 0.45rem;
        /* botones más pequeños */
        font-size: 0.72rem;
        border-radius: 0.4rem;
        font-weight: 600;
        letter-spacing: 0.2px;
        transition: all 0.2s ease;
        border-width: 2px;
    }

    .btn-group {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .btn-group .btn {
        border-radius: 0 !important;
        border-right: 1px solid rgba(0, 0, 0, 0.08);
    }

    .btn-group .btn:last-child {
        border-right: none;
    }

    .btn-group .btn:first-child {
        border-top-left-radius: 0.5rem !important;
        border-bottom-left-radius: 0.5rem !important;
    }

    .btn-group .btn:last-child {
        border-top-right-radius: 0.5rem !important;
        border-bottom-right-radius: 0.5rem !important;
    }

    /* Efectos hover mejorados y claros */
    .btn-outline-info:hover,
    .btn-outline-primary:hover,
    .btn-outline-success:hover,
    .btn-outline-warning:hover,
    .btn-outline-danger:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
    }

    .btn-outline-info:active,
    .btn-outline-primary:active,
    .btn-outline-success:active,
    .btn-outline-warning:active,
    .btn-outline-danger:active {
        transform: translateY(0);
    }

    /* ========================================
   RESPONSIVE - OPTIMIZADO PARA MÓVILES
   ======================================== */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.25rem;
        }

        .icon-box {
            width: 48px;
            height: 48px;
            font-size: 1.25rem;
        }

        .page-title {
            font-size: 1.375rem;
        }

        .page-subtitle {
            font-size: 0.8125rem;
        }

        .btn-modern {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        .sticky-col {
            min-width: 150px !important;
        }

        .card-header-modern {
            padding: 1rem 1.25rem;
        }
    }

    /* ========================================
   ANIMACIONES SUTILES
   ======================================== */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .tbody-modern tr {
        animation: fadeIn 0.25s ease;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }
    }

    .save-indicator .spinner-border {
        animation: pulse 1s ease-in-out infinite;
    }

    .row-blocked {
        opacity: 0.85;
    }

    .row-blocked .editable-cell,
    .row-blocked .editable-input,
    .row-blocked .cell-editor {
        cursor: not-allowed !important;
    }

    .blocked-field {
        background-color: #f1f3f5 !important;
        color: #6c757d !important;
        cursor: not-allowed !important;
    }

    /* ========================================
   MEJORAS DE USABILIDAD
   ======================================== */

    /* Contenedor para visor de imagen/PDF en modal */
    .viewer-container {
        min-height: 60vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }

    /* Tooltip mejorado */
    .btn-xs[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.25rem 0.5rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        white-space: nowrap;
        pointer-events: none;
        z-index: 1000;
    }

    /* Indicador visual para celdas requeridas */
    .required-field::before {
        content: '*';
        color: var(--danger-color);
        margin-right: 0.25rem;
        font-weight: bold;
    }

    /* Loader personalizado */
    .spinner-border-sm.text-primary {
        color: var(--primary-color) !important;
        border-color: var(--primary-color);
        border-right-color: transparent;
    }

    /* Indicador contextual de fila en edición */
    .row-context-info {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 2px solid #6c757d;
        border-radius: 0.75rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        z-index: 1050;
        min-width: 280px;
        display: none;
        font-size: 0.875rem;
    }

    .context-header {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem 0.5rem 0 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .context-details {
        padding: 1rem;
    }

    .context-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }

    .context-item:last-child {
        margin-bottom: 0;
    }

    .context-item i {
        color: #6c757d;
        width: 16px;
        text-align: center;
    }

    .context-item span {
        flex: 1;
        line-height: 1.4;
    }

    /* Responsive para el indicador contextual */
    @media (max-width: 768px) {
        .row-context-info {
            top: 10px;
            right: 10px;
            left: 10px;
            min-width: auto;
            max-width: calc(100vw - 20px);
        }
    }

    /* ========================================
   SISTEMA DE NOTIFICACIÓN REFINERY
   ======================================== */

    /* Badge de completitud de refinery */
    .badge-refinery-complete {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
        border-radius: 0.5rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
        animation: pulse-success 2s infinite;
    }

    @keyframes pulse-success {

        0%,
        100% {
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
        }

        50% {
            box-shadow: 0 2px 12px rgba(40, 167, 69, 0.5);
        }
    }

    /* Botón flotante de WhatsApp */
    .btn-whatsapp-float {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 65px;
        height: 65px;
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        animation: bounce-whatsapp 2s infinite;
    }

    .btn-whatsapp-float:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 25px rgba(37, 211, 102, 0.6);
    }

    @keyframes bounce-whatsapp {

        0%,
        20%,
        50%,
        80%,
        100% {
            transform: translateY(0);
        }

        40% {
            transform: translateY(-10px);
        }

        60% {
            transform: translateY(-5px);
        }
    }

    .whatsapp-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    /* Botón flotante para panel de refinery */
    .btn-refinery-panel-toggle {
        position: fixed;
        bottom: 110px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0B8552 0%, #0ea06a 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(11, 133, 82, 0.4);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 999;
    }

    .btn-refinery-panel-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(11, 133, 82, 0.6);
    }

    .refinery-panel-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ffc107;
        color: #000;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    /* Panel flotante de estado refinery */
    .refinery-status-panel {
        position: fixed;
        bottom: 30px;
        right: 110px;
        width: 380px;
        max-height: 500px;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1001;
        overflow: hidden;
        animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .refinery-panel-header {
        background: linear-gradient(135deg, #0B8552 0%, #0ea06a 100%);
        color: white;
        padding: 1rem 1.25rem;
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .btn-close-panel {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

    .btn-close-panel:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .refinery-panel-body {
        padding: 1rem;
        max-height: 420px;
        overflow-y: auto;
    }

    .refinery-items-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .refinery-item {
        background: #f8f9fc;
        border-left: 4px solid #28a745;
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.2s;
    }

    .refinery-item:hover {
        background: #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .refinery-item-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .refinery-item-number {
        background: #28a745;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .refinery-item-placa {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
    }

    .refinery-item-details {
        font-size: 0.85rem;
        color: #6c757d;
        padding-left: 2rem;
    }

    .refinery-item-details div {
        margin-bottom: 0.25rem;
    }

    /* Panel de Actividad en Tiempo Real */
    .activity-panel {
        position: fixed;
        top: 80px;
        right: 20px;
        width: 320px;
        max-height: calc(100vh - 120px);
        background: white;
        border-radius: 1rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 1002;
        overflow: hidden;
        animation: slideInRight 0.3s ease;
    }

    .activity-panel-header {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 1rem 1.25rem;
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .activity-panel-body {
        padding: 1rem;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .active-users-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .active-user-item {
        background: #f8f9fc;
        border-left: 4px solid #17a2b8;
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.2s;
    }

    .active-user-item:hover {
        background: #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .active-user-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .user-info {
        flex: 1;
    }

    .user-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .user-editing {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .user-preview {
        font-size: 0.75rem;
        color: #667eea;
        margin-top: 0.35rem;
        padding: 0.3rem 0.6rem;
        background: rgba(102, 126, 234, 0.1);
        border-left: 2px solid #667eea;
        border-radius: 0.25rem;
        font-style: italic;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .editing-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        margin-right: 0.25rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.3;
        }
    }

    .cell-editing-indicator {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 20px;
        height: 20px;
        background: #17a2b8;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(23, 162, 184, 0.4);
        cursor: help;
        z-index: 10;
    }

    .cell-editing-indicator::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        border: 2px solid #17a2b8;
        border-radius: 50%;
        animation: ripple 1.5s infinite;
    }

    /* Preview del contenido en tiempo real - Texto dentro de la celda */
    .cell-preview-value {
        position: absolute;
        top: 50%;
        left: 30px;
        transform: translateY(-50%);
        color: #667eea;
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem;
        z-index: 5;
        animation: fadeIn 0.3s ease;
        pointer-events: none;
        max-width: calc(100% - 60px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Celda bloqueada por otro usuario */
    .cell-locked {
        background: repeating-linear-gradient(45deg,
                rgba(102, 126, 234, 0.05),
                rgba(102, 126, 234, 0.05) 10px,
                rgba(102, 126, 234, 0.08) 10px,
                rgba(102, 126, 234, 0.08) 20px);
        cursor: not-allowed !important;
    }

    .cell-locked * {
        cursor: not-allowed !important;
    }

    .cell-locked input,
    .cell-locked select,
    .cell-locked textarea,
    .cell-locked .cell-editor {
        pointer-events: none;
        user-select: none;
    }

    .preview-header {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.4rem;
        opacity: 0.9;
    }

    .preview-content {
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 0 0.5rem;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes ripple {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        100% {
            transform: translate(-50%, -50%) scale(1.8);
            opacity: 0;
        }
    }

    /* Fila siendo editada por otro usuario */
    tr.row-being-edited {
        background: linear-gradient(90deg, rgba(23, 162, 184, 0.08) 0%, rgba(23, 162, 184, 0.12) 50%, rgba(23, 162, 184, 0.08) 100%);
        border-left: 4px solid #17a2b8;
        animation: row-pulse 2s infinite;
    }

    @keyframes row-pulse {

        0%,
        100% {
            border-left-color: #17a2b8;
        }

        50% {
            border-left-color: #0d6efd;
        }
    }

    /* Badge de usuario editando en la fila */
    .row-editor-badge {
        position: absolute;
        left: -4px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 0.4rem 0.75rem;
        border-radius: 0 0.5rem 0.5rem 0;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(23, 162, 184, 0.4);
        display: flex;
        align-items: center;
        gap: 0.4rem;
        z-index: 100;
        white-space: nowrap;
        animation: slideInLeft 0.3s ease;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateY(-50%) translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }
    }

    .row-editor-badge i {
        animation: typing 1.5s infinite;
    }

    @keyframes typing {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }
    }

    /* Responsive para móviles */
    @media (max-width: 768px) {
        .btn-whatsapp-float {
            bottom: 20px;
            right: 20px;
            width: 55px;
            height: 55px;
            font-size: 24px;
        }

        .btn-refinery-panel-toggle {
            bottom: 90px;
            right: 20px;
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .refinery-status-panel {
            right: 20px;
            left: 20px;
            width: auto;
            bottom: 20px;
        }

        .activity-panel {
            right: 10px;
            left: 10px;
            width: auto;
            top: 70px;
        }
    }

    /* Estilos para Drag-to-Scroll + Botones Flotantes */
    .table-responsive-modern.grab-cursor {
        cursor: grab;
        /* Evitar selección de texto al arrastrar */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .table-responsive-modern.grabbing-cursor {
        cursor: grabbing;
    }

    /* Botones de navegación flotantes overlay para la tabla */
    .table-scroll-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.2s ease;
        color: #333;
        font-size: 1.2rem;
    }

    .table-responsive-modern:hover .table-scroll-btn {
        opacity: 1;
    }

    .table-scroll-btn:hover {
        background-color: var(--primary-color, #0a7c5d);
        color: white;
        transform: translateY(-50%) scale(1.1);
    }

    .table-scroll-btn.scroll-left {
        left: 80px;
        /* Separado del sticky left */
    }

    .table-scroll-btn.scroll-right {
        right: 20px;
    }

    /* Indicadores visuales de scroll */
    .table-responsive-modern::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 20px;
        background: linear-gradient(to left, rgba(0, 0, 0, 0.05), transparent);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .table-responsive-modern.can-scroll-right::after {
        opacity: 1;
    }
</style>
{% endblock %}